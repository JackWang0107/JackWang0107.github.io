<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Typora图床上传失败解决方案</title>
      <link href="/2021/12/29/typora-tu-chuang-shang-chuan-shi-bai-jie-jue-fang-an/"/>
      <url>/2021/12/29/typora-tu-chuang-shang-chuan-shi-bai-jie-jue-fang-an/</url>
      
        <content type="html"><![CDATA[<blockquote><p>本文主要介绍了Typora中使用图床上传图片失败的解决方案</p></blockquote><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211229233841511.png" alt="Typora 图床上传失败"></p><h1 id="Typora图床上传失败解决方案"><a href="#Typora图床上传失败解决方案" class="headerlink" title="Typora图床上传失败解决方案"></a>Typora图床上传失败解决方案</h1><p>我的博客的开发环境是Typora+Hexo+Matery主题，此外为了方便博客的部署，所有的图片使用的都是图床。然而在Typora中使用PicGO图床并不是一帆风顺的，因此本文主要介绍了Typora中PicGO图床出错的一些解决方法</p><h1 id="一、图片上传403错误"><a href="#一、图片上传403错误" class="headerlink" title="一、图片上传403错误"></a>一、图片上传403错误</h1><p>这个错误在我这里发生的现象是这样的，在之前的几个月的使用都是完全正常的，然而某次关机、切换成Windows之后再切换为Ubuntu，Typora的图床就无法使用了，上传图片会报错403。具体的如下图</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211229233841511.png" alt="上传图片403错误"></p><p>这个问题其实是由于时差的问题，因为我是windows和ubuntu双系统，因此开完Ubuntu之后开Windows，时间就会差八个小时，然后在Windows中把时间改对了，在Ubuntu中又会差八个小时。因此这个问题就发生在Ubuntu的事件不对。解决办法很简单，把时间改回来就行了。</p><p>在设置中搜索<code>时间</code>，然后修改即可</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211229154229847.png" alt="修改日期和时间"></p>]]></content>
      
      
      <categories>
          
          <category> 杂项 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Ubuntu </tag>
            
            <tag> Typora </tag>
            
            <tag> PicGo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>操作系统概念读书笔记-第一章：介绍-1 基础概念</title>
      <link href="/2021/12/29/cao-zuo-xi-tong-gai-nian-du-shu-bi-ji-di-yi-zhang-jie-shao/"/>
      <url>/2021/12/29/cao-zuo-xi-tong-gai-nian-du-shu-bi-ji-di-yi-zhang-jie-shao/</url>
      
        <content type="html"><![CDATA[<blockquote><p>本文是《操作系统概念（第九版）》的第一章的读书笔记第一部分，主要介绍了操作系统中的一些基础概念。</p><p>This blog is the first part of reading notes of  <em>Operating System Concepts (Ninth Edition)</em> chapter 1: Introduction, which tells  the basic ideas of Operating System</p></blockquote><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211228175748055.png" alt="Chapter 1: Introduction"></p><h1 id="Operating-System-Concepts-Chapter-1-Introduction-1-Basic-Concepts"><a href="#Operating-System-Concepts-Chapter-1-Introduction-1-Basic-Concepts" class="headerlink" title="Operating System Concepts-Chapter 1: Introduction-1 Basic Concepts"></a>Operating System Concepts-Chapter 1: Introduction-1 Basic Concepts</h1><p>操作系统概念第一部分是Overview，包括第一章和第二章。</p><p>本章和下一章一起，介绍了操作系统中一些基本概念和操作系统的发展历史。本章主要讲解了操作系统的一些基础概念</p><h2 id="1-What-is-Operating-System"><a href="#1-What-is-Operating-System" class="headerlink" title="1. What is Operating System?"></a>1. What is Operating System?</h2><p>要说明什么是操作系统，还得从什么是计算机说起</p><blockquote><p><strong>What is computer</strong>：</p><p>从硬件上来说，计算机就是一堆硬件，包括鼠标、显示器、CPU、显卡等等；而对于我们用户来说，计算机就是一个黑箱子，我们坐在计算机前面，通过鼠标、键盘等等方式为计算机输入数据，计算机计算后会通过显示屏把输出（图像）输出出来。</p></blockquote><p>然而就像我们去买显卡的时候一样，我们知道显卡可以用来进行图形渲染，带来更好的游戏体验。然而我们在买显卡的时候买到的却是一个硬件，我们也没有办法直接使用</p><p>因此，在我们和计算机的一堆硬件之间存在一个管理员，这个管理员帮助我们管理计算机的硬件，把我们的需求转换为对计算机硬件的调用，<strong>这个管理员就是操作系统</strong>。</p><h3 id="A-操作系统的概念"><a href="#A-操作系统的概念" class="headerlink" title="A. 操作系统的概念"></a>A. 操作系统的概念</h3><p>我们首先需要对操作系统有一个大的认知，即<code>操作系统是一个在用户和硬件之间的程序</code></p><h3 id="B-操作系统的目标"><a href="#B-操作系统的目标" class="headerlink" title="B. 操作系统的目标"></a>B. 操作系统的目标</h3><p>操作系统的目标如下：</p><ul><li>执行用户的程序，并能够简化用户解决问题的过程</li><li>让计算机更加易于使用</li><li>以高效的方式使用计算机的硬件，从而提高性能</li></ul><p>因此说白了，操作系统的目的其实就是两个：向下，<code>高效的使用硬件</code>；向上，<code>让计算机对用户更加易用</code></p><p>因此未来介绍的包括存储管理、内存管理等等都是为了更加易用这个目标，而存储管理则视为了高效的使用硬件</p><h2 id="2-Computer-System-Structure"><a href="#2-Computer-System-Structure" class="headerlink" title="2. Computer System Structure"></a>2. Computer System Structure</h2><p>当我们提到操作系统的时候，通常指的是操作系统这个软件，只不过这个软件和硬件结合的非常紧密。</p><p>而当我们提到计算机系统的时候，计算机系统不仅仅指硬件的集合，实际上还指包括硬件在内的，操作系统等软件的集合。因此计算机系统的结构从下到上如下：</p><ul><li><strong>硬件</strong>：我们的文档需要保存在硬盘中，我们的程序需要被CPU运行，显示器上的图像需要被显卡渲染，网络数据的收发需要网卡……硬件提供了最基础的计算机的资源</li><li><strong>操作系统</strong>：操作系统可以控制、管理各种各样的硬件，并且为多个用户的多种程序调度硬件资源</li><li><strong>应用程序</strong>：应用程序负责调用硬件资源，解决用户的需求，例如文芳编辑器、编译器、汇编器、数据库软件等等</li><li><strong>用户</strong>：用户通过调用引用程序解决他们的问题，用户可以是具体的人，也可以是其他的电脑前的用户（本机是运算发生的地方，而用户在的电脑负责产生运算请求并发到本机）等等</li></ul><p>具体的图示如下</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211229170838604.png" alt="计算机系统的结构图"></p><h2 id="3-Resource-in-Computer-System"><a href="#3-Resource-in-Computer-System" class="headerlink" title="3. Resource in Computer System"></a>3. Resource in Computer System</h2><p>根据上面的讲解，从应用程序的角度和用户的角度来看，计算机系统中的资源可以分为下面的两种：</p><ul><li>硬件资源（应用程序的角度向下看）<ul><li><strong>主机资源</strong>：包括CPU和内存</li><li><strong>外部设备资源</strong>：包括<ul><li>外部存储设备：U盘、固态/机械硬盘、光驱/光盘等等</li><li>外部输入输出设备：键盘（字符作为输入），显示器（图像作为输出），打印机（喷出的油墨作为输出），鼠标（位置作为输入）</li><li>其他设备：例如网线接头</li></ul></li></ul></li><li>软件资源（用户的角度向下看）<ul><li>系统程序：例如操作系统、编译器等等系统的软件</li><li>应用程序：MS Office套装、CAD软件以及用户自己开发的程序等等</li><li>工具软件</li></ul></li></ul><p>具体的结构图如下：</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211229173958594.png" alt="计算机系统具有的资源"></p><h2 id="4-Operating-System-Definition"><a href="#4-Operating-System-Definition" class="headerlink" title="4. Operating System Definition"></a>4. Operating System Definition</h2><p>操作系统的定义实际上非常多，从不同的角度能够给出操作系统不同的定义</p><h3 id="A-Resource-Allocator"><a href="#A-Resource-Allocator" class="headerlink" title="A. Resource Allocator"></a>A. Resource Allocator</h3><p>从资源管理的角度，操作系统就是一个资源分配器（包括软件、硬件）。而作为资源分配者，操作系统就需要满足以下的要求：</p><ul><li>管理所有的资源</li><li>兼顾公平与效率，即不同的用户、程序请求同一个资源的时候，系统要确保公平以及效率</li></ul><p>更加具体的，操作系统管理的硬件资源如下：</p><ul><li>CPU管理：CPU的分配和控制，即决定那个程序能用多久的CPU</li><li>内存管理：分配和回收内存空间，关于为什么要进行内存管理在后面会有更多的介绍</li><li>设备管理：分配和控制IO设备，例如把文档以怎么样的方式保存到磁盘上、键盘输入的字符该怎样的处理</li><li>文件管理：管理文件的权限，这个文件谁能看到、谁能修改……</li></ul><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211229200640120.png" alt="操作系统管理的硬件资源" style="zoom:50%;"><h3 id="B-Control-Program"><a href="#B-Control-Program" class="headerlink" title="B. Control Program"></a>B. Control Program</h3><p>另外一方面，从操作系统的功能来说，操作系统像一个管理程序，用于：</p><ul><li>防止错误的发生</li><li>阻止对计算机不正确的使用</li></ul><h3 id="C-More-Definition"><a href="#C-More-Definition" class="headerlink" title="C. More Definition"></a>C. More Definition</h3><p>其实操作系统目前并没有一个广泛通用的定义，维基百科上的定义如下</p><blockquote><p><strong>From Wikipedia</strong>：</p><p>操作系统（英语：Operating System，缩写：OS）是一组主管并控制计算机操作、运用和运行硬件、软件资源和提供公共服务来组织用户交互的相互关联的系统软件程序，同时也是计算机系统的内核与基石。操作系统需要处理如管理与配置内存、决定系统资源供需的优先次序、控制输入与输出设备、操作网络与管理文件系统等基本事务。操作系统也提供一个让用户与系统交互的操作界面。</p><p>操作系统的类型非常多样，不同机器安装的操作系统可从简单到复杂，可从移动电话的嵌入式系统到超级电脑的大型操作系统。许多操作系统制造者对它涵盖范畴的定义也不尽一致，例如有些操作系统集成了图形用户界面，而有些仅使用命令行界面，将图形用户界面视为一种非必要的应用程序。</p><p>操作系统理论在计算机科学中，为历史悠久而又活跃的分支；而操作系统的设计与实现则是软件工业的基础与内核。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211229201749524.png" alt="维基百科上对操作系统的定义"></p></blockquote><p>从外观上来描述操作系统，它的特点如下：</p><ul><li>买电脑时厂商附带的一切：Windows、MacOS、VMS、Multics</li><li>开机后一直在运行的程序</li></ul><h2 id="5-Dual-mode-of-Operating-System"><a href="#5-Dual-mode-of-Operating-System" class="headerlink" title="5. Dual-mode of Operating System"></a>5. Dual-mode of Operating System</h2><p>实际上操作系统在运行过程中具有两种状态：<strong>用户态（User Mode）</strong>和<strong>内核态（Kernel Mode）</strong></p><ul><li><p><strong>User Mode</strong>：处于用户态的程序仅仅可以执行非特权指令，例如1+1</p></li><li><p><strong>Kernel Mode</strong>：处于内核态的程序可以执行所有的指令，包括特权指令。</p></li></ul><p>通常来说，特权指令指的是一些如果操作不当可能会导致系统崩溃的指令，例如清除内存、重置时钟、读取磁盘等等。因此如果不对这些特权指令加以保护（即所有用户都可以使用），那么垃圾程序员写出来的烂代码很可能就会搞崩系统。</p><p>为了区分用户态和内核态的程序，在硬件（CPU）上通常会用一个比特位来进行标识，称为<strong>模式位（mode bit）</strong>。例如处于用户态的程序user mode bit是1，而处于内核态的程序的user mode bit是0。</p><h2 id="6-System-Call"><a href="#6-System-Call" class="headerlink" title="6. System Call"></a>6. System Call</h2><p>为了保护系统不会因为垃圾程序员导致的崩溃，系统通过不同的模式来保护一些高危的指令。例如对磁盘进行读写的指令如果使用不当可能会造成磁盘损坏，但由于我们在程序中经常会有读写文件的操作，例如C语言的fread、Python的open等等。而文件就保存在磁盘上，因此读写文件在计算机底层就一定会包含对磁盘进行操作的指令。</p><p>只是由于读写磁盘这些特权指令使用的非常频繁，经常在用户态的程序中被调用，因此就需要为用户态的程序提供仅可以在内核态运行的指令的接口/入口/函数API。**这些函数称为系统调用(System Call)**。</p><p>在系统调用的时候，我们的程序会取调用这些系统提供的函数，因此在执行这些函数的时候，程序的控制流会短暂的移交到系统提供的函数中。此时我们程序的模式位会改变为内核态。在内核提供的函数完成调用后，程序控制流会返回我们的程序，此时程序的模式位会改回我们原先的特权态。</p><p>称进行系统调用时，程序控制流转移到系统中为<strong>陷入内核（trap in kernel）</strong>。</p><p>因此一次系统调用的过程中我们程序的控制流和对应的状态位变化如下，横轴为时间。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211229211610111.png" alt="系统调用的时序图"></p><h2 id="7-Computer-Startup"><a href="#7-Computer-Startup" class="headerlink" title="7. Computer Startup"></a>7. Computer Startup</h2><p>正如前面所讲，操作系统本身也是一个软件，只不过这个软件和QQ、微信这类软件不同：QQ和微信是运行在操作系统上的软件，他们通过各种各样的系统调用来调用硬件资源，结合自己的逻辑控制与判断完成任务；而操作系统是直接运行在硬件上的，负责管理硬件以及提供各种各样的系统调用。因此尽管两者都是软件，两者所处的层级并不同，正如前面的计算机系统的结构图中展示的一样。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211229170838604.png" alt="计算机系统的结构图"></p><p>正是因为这份特殊性，系统这个软件的启动和QQ这类普通的软件启动的方式不同。QQ这类普通软件（Windows上的exe、Linux上的o）我们双击即可运行，这是因为操作系统在背后帮我们干了非常多的事情，例如：申请一块内存空间用来存放QQ这个程序的指令、把QQ这个程序的指令从磁盘中读取出来并放到申请到的内存的位置中去（加载）、调用CPU去解析、执行QQ程序中的指令……</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211229214549149.png" alt="操作系统也是一个软件"></p><p>但是系统的启动是完全基于一个裸的硬件的，因此在启动系统的时候并不会像启动QQ一样有操作系统为其准备好各种各样的环境。取而代之的是有一个叫做引导程序（Bootloader）为操作系统准备各种环境，引导程序会首先进行设备自检、初始化周边设备，然后加载操作系统，即从磁盘中读取操作系统内核可执行文件的指令序列，然后复制到内存中。</p><p>因此计算机启动的过程首先运行引导程序，然后由引导程序进行设备的自检，而后引导、初始化操作系统</p><h2 id="8-Computer-System-Organization"><a href="#8-Computer-System-Organization" class="headerlink" title="8. Computer System Organization"></a>8. Computer System Organization</h2><p>前面我们从层次上介绍了计算机系统的结构（Structure），下面从硬件的角度介绍计算机系统的组成（Organization）。</p><p>计算机系统的组成包含多种多样的设备，通常会有：</p><ul><li>一个或多个CPU</li><li>一个或多个磁盘</li><li>一个或多个USB设备</li><li>一个或多个显示器</li></ul><p>然而一个经典的CPU的执行流程是：用户通过键盘鼠标、磁盘等输入输出设备把数据输入（鼠标点击、键盘敲击、读取磁盘中的文件）到计算机，接下来数据被CPU计算得到结果，最后结果通过显示器或者磁盘输出（显示或者保存）。</p><p>而由于多种不同的设备读取到的数据的形式可能不同，而CPU只能够处理一种格式的数据，因此就需要在硬件上有控制器（Device Controller）或者适配器（Device Adapter），他们负责把从磁盘、鼠标、键盘读取到的原始数据处理转化为CPU可以直接处理的数据，然后让CPU进行处理，或者是把CPU处理之后的数据转换为显示器可以显示的数据。</p><p>此外，数据在电路中的传输是以分时的电信号的形式传输的，传播速度为光速，因此需要设备保存下数据，因此就有了存储器（Memory）。</p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211229221140892.png" alt="计算机系统的组成" style="zoom:150%;"><h2 id="9-Bus"><a href="#9-Bus" class="headerlink" title="9. Bus"></a>9. Bus</h2><p>上面说到，数据在不同的设备间传递，而每个设备都会有自己的Controller或者Adapter以实现和CPU的交互。数据的传输需要有实体，这个实体在计算机中实际上就是总线（Bus）。</p><p>通过总线我们就可以实现让不同的设备（买来的机器自带的设备还是我们自己外加的附加设备/周边设备/第三方设备）之间进行数据的交互。</p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211229221706606.png" alt="总线让内存和CPU之间进行交互" style="zoom:150%;"><h2 id="10-I-O-Operation"><a href="#10-I-O-Operation" class="headerlink" title="10. I/O Operation"></a>10. I/O Operation</h2><p>还是在上面说到，不同的设备每个设备都会有一个控制器/适配器，设备可以通过控制器/适配器和CPU进行数据间的交互。然而通常来说，每个控制器/适配器都会有一个自己的缓存（buffer），用来存储暂时的输入。</p><p>使用buffer的原因也很简单，就是因为设备读取输入的速度的问题。例如我们现在希望从磁盘中读取一个文本文件（例如，三国演义），然后让CPU把这个文本文件里的每个句子在句子末尾添加一个回车，接下来再把处理后的文本文件保存到磁盘中去。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211229223014684.png" alt="三国演绎的文本文件"></p><p>然而在读取三国演义的时候有一个问题就是磁盘的读取速度是有上限的，假设一毫秒只能读取文本文件的一半，而作为用户我们当然是希望文本文件一次性被读完，然后被CPU一次性处理完之后保存到磁盘中。</p><p>因此这个时候就是缓存的作用了，buffer可以暂时存储已经读取到的一半的文件，接下来等待后一半读取完了之后统一交给CPU处理。</p><p>其实同样的例子还发生在键盘上，假设我们现在写一个程序，读取用户输入的句子，并将输入的句子打印在屏幕上。那么由于键盘是一次一个字符的传输，因此我们如果希望能够完整的把一句话打印在屏幕上，就需要一个缓冲区来保存先前所有输入的字符，然后等待用户按下回车结束输入，再把缓冲区中的句子发送给CPU，让CPU处理完后交给屏幕显示。</p><p>因此对于CPU而言，CPU的操作就是把数据从内存中移入到某个设备的缓冲区，或者把数据从某个设备的缓冲区中移动到内存中。至于具体的数据在缓冲区的保存和从缓冲器移动到内存都是由设备控制器/适配器完成的。</p><p>称数据从内存到控制器缓冲区/从控制器缓冲区到内存中的一次操作为一次<strong>I/O操作（I/O Operation）</strong>。</p><p>由于I/O操作发生在内存和设备控制器/适配器之间，而每个设备都会有自己的控制器/适配器，因此实际上操作系统可以并发的(Concurrent)和多个设备之间进行I/O操作。</p><blockquote><p><strong>为什么需要内存/主存（内存又称为主存）</strong>：</p><p>我们上面的讲解中说道，各种控制器读取到的数据需要移入内存中才能够被CPU处理，而CPU处理完的数据也需要保存到内存中才能够被设备保存（输出到磁盘或者屏幕上）。</p><p>那么为什么数据需要经过内存/主存？原因就在于<strong>各种设备运行的速度/访问的时间不同</strong></p><p>借用_现代操作系统_中的图片，CPU从寄存器中获取需要处理的数据只需要1纳秒，从内存中获取需要处理的数据需要10纳秒，而从磁盘中获取数据则需要10毫秒，基本上$10^3$的数量级的差距。</p><p>因此如果CPU直接从设备中获取需要处理的数据，那么CPU就不得不等待这些设备，因此就会浪费大量的时间。所以提高CPU的利用率，降低等待时间/加快速度，所有的数据都需要被放到内存中去。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211229224334928.png" alt="各种设备的访问时间"></p></blockquote><h2 id="11-Interrupt"><a href="#11-Interrupt" class="headerlink" title="11. Interrupt"></a>11. Interrupt</h2><p>上面说道，I/O操作是内存和设备控制器的缓冲区之间的数据交换，这个过程的目的在于加快稍后CPU数据的获取（CPU可以直接从内存中获取数据而非等待设备控制器）。一个典型的CPU的I/O操作的流程其实如下（假设还是上面的读取文件后给每个句子后面添加回车）：</p><ul><li>CPU首先发出通知给控制器，要求控制器把数据放到内存中的某个位置上去</li><li>接下来CPU发出这样的指令给控制器后就继续去执行其他的程序的指令去了，而在CPU执行其他指令的这段时间，控制器就会去设备上获取数据（读取文件或者等待用户输入）</li><li>当控制器完成读取后，会发送消息给CPU，通知CPU读取已经完成。</li><li>CPU在收到控制器发来的消息后，会中止当前正在执行的指令，继续去每个句子后添加回车。</li></ul><p>具体的时序图如下：</p><pre class="line-numbers language-mermaid"><code class="language-mermaid">    sequenceDiagram    CPU->>USB Port 1: Fetch the data from file zzzzzz for me    USB Port 1 -->> Main Memory: Put data1： xxxxxxx on yyyyyyy    USB Port 1 -->> Main Memory: Put data2： xxxxxxx on yyyyyyy    USB Port 1 -->> Main Memory: .....    USB Port 1 -->> Main Memory: Put dataN： xxxxxxx on yyyyyyy    USB Port 1 -->> CPU: All data you need is put on yyyyyyy    CPU -->> Main Memory: I need data on yyyyyy    Main Memory -->> CPU: Here is your data: xxxxxxx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211230191239374.png" alt="CPU与控制器的交互"></p><p>因此，称在某些情况下计算机中止当前程序的运行，并转而去运行其他的程序的现象为**中断(Interruput)<strong>。上面的例子就是典型的I/O中断，即由于输入输出导致的中断。而导致中断发生的事件称为</strong>中断事件(Interrupt Event)**。</p><p>除了I/O中断以外，还有很多类型的中断，例如上面的执行系统调用（System Call），以及CPU执行用户程序时发生的运算错误，例如除0错误。</p><p>实际上中断是计算机系统中非常常用的机制，因为中断可以让原有的程序放弃CPU并且让CPU执行新的程序。</p><p>此外，中断分为两类，一类是<strong>可屏蔽的中断（Maskable Interrupt）</strong>，一类是<strong>不可屏蔽的中断（Non-Maskable Interruptable）</strong>。可屏蔽的中断表示中断事件导致的中断并不会立即中止当前程序的运行。CPU可能在稍后来响应这个中断事件，例如上面的把文件从磁盘读入到内存完成后，控制器向CPU发送的中断可能并不会立即让CPU中止运行当前的程序，来处理内存中的程序。因为CPU当前运行的程序可能是具有更高优先级的。例如在后面我们会讲到的同步。当前程序会特地的禁止CPU响应中断。</p><p>此外，CPU对可屏蔽的中断的另外一种响应就是忽略中断。</p><p>对于不可屏蔽的中断，CPU会立即中断当前运行的程序，然后处理中断。例如如果上面读取完成的事件发出的是不可屏蔽的中断的话，CPU就会立即处理这个中断，而处理中断的方式就是继续运行我们的文本处理程序。</p><p>根据中断发生的原因，中断可以分为三类：</p><ul><li><strong>程序产生的中断</strong>：程序产生的中断是用户的程序在运行的过程中，某些意外事件（中断事件）发生，导致向CPU发出了中断。常见的程序产生的中断有：除0中断、溢出中断、系统调用（虽然系统的函数被视为程序的一部分，但是系统的函数本身也可以视为一段程序，因此调用系统的函数就会”中止”我们的程序，而运行系统的程序（新的程序），因此在这个含义上，系统调用也可以视为中断）</li><li><strong>I/O中断</strong>：I/O中断即指由I/O设备产生的中断，常见的如上面的读取完成中断，此外还有文件不存在这类中断</li><li><strong>计时器中断</strong>：由计算机系统上的一个叫做计时器的硬件产生的中断（关于计时器稍后会讲）。</li></ul><h2 id="12-Timer"><a href="#12-Timer" class="headerlink" title="12. Timer"></a>12. Timer</h2><p>计时器本身是在计算机硬件系统上的一个硬件，类似于手表中的石英可以以固定的频率震动，计时器可以以固定的时间间隔（Unix中是1/60秒）发出一个中断。这个中断通常称为<strong>计时器中断（Timer Interrupt）</strong>。这个固定的时间间隔称为<strong>时间片（Time Share）</strong>。</p><p>不同于磁盘读取完成中断，计时器中断的意义不在于运行某个特定的中断处理程序，而在于通知操作系统（当前程序），他（你）已经占用CPU够久了，该把CPU让给别的程序来运行了。</p><p>因此计时器的目的其实就在于通过分时的CPU占用实现类似于并行的效果，提升多用户使用的体验（多道程序）。而之所以需要不断的中断的原因在于CPU（假设只有一个核心，虽然现在的CPU经常都是8核、16核）一次只能运行一个程序，因为一个程序被编译出来之后可能只有几百KB，但是在汇编层次的机器码而言，会有成千上万的指令。这些指令运行和解释起来就需要一个CPU（的核心）。</p><p>因此，操作系统中的计时器机制的特点如下：</p><ul><li>通过简单的计时 –&gt; 中断，避免了无穷循环和硬件资源的永久霸占</li><li>在一定的时间间隔后会发出一个中断</li><li>当中断发生后，当前进程可能会被kill掉，而其占用的资源会被释放，例如加锁的文件（文件加锁在后面会讲，但是目前只需要明白为了避免文件被两个程序同时修改导致的不同步，程序在修改文件的时候通常会给文件加锁，避免其他人同时修改文件）</li></ul><p>此外，计时器有的时候也被称为<strong>看门狗（Watch Dog Timer）</strong></p><p>虽然我们上面说计时器中断并不会类似文件读取完成中断一样，会调用我们指定的中断处理程序（我们的加回车程序）来处理中断。但是其实计时器中断也会去调用一个特殊的中断处理程序。这个中断处理程序是系统里已经写好的程序。这个程序的目的就是把当前程序的一些变量从寄存器中保存到内存中去，然后决定下一个需要运行的程序，接下来把下一个需要运行的程序的变量等内容从内存中加载到寄存器中去。</p><h2 id="13-Interrupt-Handling"><a href="#13-Interrupt-Handling" class="headerlink" title="13. Interrupt Handling"></a>13. Interrupt Handling</h2><p>当中断发生的时候（例如计时器中断），操作系统具体是如何完成整个中断的过程的？</p><p>首先我们需要明白，中断的定义就是中止运行当前程序，然后去运行新的程序。因此对中断的处理其实就包含两步，第一步就是中止当前程序的运行，第二步就是运行新的程序。</p><p>对于中止当前程序的运行，需要做的首先就是保存当前程序运算到中间得到的一些中间变量。例如我们让一个程序循环从1加到1000，例如：</p><pre class="line-numbers language-python"><code class="language-python">sum <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1001</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    sum <span class="token operator">+=</span> i<span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>那么在加到50的时候程序可能由于时间片用完了，导致程序需要被中断，CPU转而去运行别的程序。此时需要保存循环变量i。以及保存在寄存器的中间变量sum。</p><p>接下来第二步就是运行新的程序，即**中断处理程序(Interruput Handler或者Interrupt Service Routine，ISR)<strong>。在计算机内部，中断的表示是利用一个整数来表示的。而接下来去运行中断处理程序处理中断处理程序。由于中断可能会有很多种，因此中断处理程序也会有很多。为此需要指定一个中断 – &gt;中断处理程序的映射表，这个映射表称为</strong>中断表(Interrupt Table)**。一个典型的中断表如下</p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211230152940124.png" alt="中断表" style="zoom:50%;"><p>如果是上面假设的计时器中断（中断的目的就在于把CPU让给下一个程序）的话，那么就会去运行计时器中断处理程序，计时器中断处理程序会从CPU的就绪队列中挑去下一个需要执行CPU的进程，然后把这个进程的变量和程序计数器加载到寄存器中，从而开始运行下一个程序。</p><p>以上就是一个典型的中断处理的过程。</p><p>除了正常的中断处理意外，还有可能发生的一个情况就是中断冲突。</p><p>在一个操作系统中，中断发生的次数非常多，每秒可能就会有一百多次。由于中断发生的原因可能会非常多，例如上面的IO中断，那么就可能会出现一个现象就是系统正在处理一个中断的时候另外一个中断发生了。例如上面的磁盘读取完成中断发生后，正在运行我们后续的程序的时候（中断处理程序），另外一个中断事件发生了，例如时间片用完。此时就会发生中断的冲突。</p><p>因此为了处理多个中断冲突的情况，系统为不同的中断设定不同的优先级。高优先级的中断会中断掉低优先级的中断处理程序，而低优先级的中断会等待高优先级的中断完成。注意，中断冲突发生的情况一定是CPU当前正在运行一个中断的处理函数。</p><p>因此处理中断的时候就会有两种处理方式，第一种就是A图中的低优先级的Y中断的中断处理函数等待高优先级的X中断的中断处理程序完成，第二种就是B图中的高优先级的Y中断的中断处理程序中断了低优先级的X中断的中断处理程序。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211230144720338.png" alt="两种中断冲突处理方式"></p><h2 id="14-I-O-Processing"><a href="#14-I-O-Processing" class="headerlink" title="14. I/O Processing"></a>14. I/O Processing</h2><p>正如前面所说的，I/O指的是由CPU发起的，内存和I/O设备之间数据的交互。前面我们只是泛泛的说了一下系统是如何处理输入输出请求的。其实在真实的情境下，I/O的处理分为两种：</p><ul><li><strong>同步I/O（Synchronous）</strong>：同步I/O指的是当CPU向控制器发出I/O请求后，CPU会空转以等待控制器完成I/O。在此期间CPU不会运行其他的任何程序。</li><li><strong>异步I/O（Asynchronous）</strong>：异步I/O指的是当CPU先控制发出I/O请求后，CPU会立马中断发出I/O请求的程序（例如添加回车的程序），然后运行别的程序，一直直到控制读取完成后向CPU发出中断。当CPU收到中断之后就会中断其他的程序，转而继续运行添加回车的程序（当然这个取决于当前运行的程序和中断的优先级）。</li></ul><p>这两种I/O处理的方式如下图，A图中同步的I/O随着事件流逝，user占用的CPU会等待读取完成的中断。而B图中异步的I/O则是发出I/O请求后立即返回，同时user占用的CPU立刻去运行其他的程序。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211230154003231.png" alt="两种I/O处理方式"></p><p>此外，由于每个I/O设备都会有自己的控制器，因此每个I/O设备可能都会处于不同的状态（是否在响应I/O请求）。因此在系统中有一张表来维护每个设备的状态，这个表称为<strong>设备状态表(Device-Status Table)</strong></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211230160557297.png" alt="设备状态表"></p><h2 id="15-Storage-Structure"><a href="#15-Storage-Structure" class="headerlink" title="15. Storage Structure"></a>15. Storage Structure</h2><p>在计算机系统中，有不少硬件都可以进行数据的存储，例如寄存器、磁盘、内存(主存)，甚至包括控制器的缓冲区。但是计算机的存储结构通常指磁盘、内存这类专门用于存储的硬件在内的存储系统。</p><p>通常，计算机的存储结构中包含以下硬件：</p><ul><li><strong>内存/主存（Main Memory）</strong>：主存是唯一的CPU可以直接获取数据的设备。内存中的数据是<strong>易失性的（volatile）</strong>，即断电后数据会全部遗失。</li><li><strong>二级存储（Secondary Memory）</strong>：二级存储是对主存的扩展，其内部的数据是<strong>非易失性的（nonvolatile）</strong>。</li><li><strong>磁盘（Magnetic Disks）</strong>：磁盘是由可以保存磁场的材料制成的。数据在其内部以磁的形式保存<ul><li>通常而言，数据在磁盘上按照<strong>磁道（Track）</strong>、<strong>扇区（Sector）</strong>的形式记录在磁盘上。</li><li>磁盘上的**设备控制器(Disk Controller)**帮助完成计算机和磁盘之间的沟通，包括磁信号到电信号的转换。</li></ul></li></ul><p>通常在考虑存储器的选择的时候，会权衡速度、价格和容量三个方面的因素。一般而言速度越快、容量越大，价格就会越高。因此系统中存储器的分层结构（Storage-Device Hierarchy）如下图</p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211230163108041.png" alt="存储器的分层结构" style="zoom:150%;"><p>从上到下单位价格容量越来越低，而速度越来越慢。</p><p>在前面放过一张图，图中描述了CPU访问每个设备、获取到数据需要的时间。一般来说访问内存需要10纳秒左右的时间，虽然寄存器的访问速度非常快，但是CPU内板载的寄存器首先非常有限，其次价格非常高昂，因此退而求其次，就有了**高速缓存(Cache)**。</p><p>计算机中的二八定律指出80%的访问都是针对20%的数据的，因此可以把内存中一些经常被访问的数据加载到高速缓存中去，CPU每次要从内存中获取数据前先从高速缓存中去看看，如果高速缓存中有的话就直接获取数据即可，如果没有再去内存中获取数据。</p><p>因此如果绝大多数CPU需要的数据都在缓存中的话，系统的运行速度实际上可以有极大地提升。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211229224334928.png" alt="各种设备的访问时间"></p><h2 id="16-Multiprocessors"><a href="#16-Multiprocessors" class="headerlink" title="16. Multiprocessors"></a>16. Multiprocessors</h2><p>前面我们所有的讲解都是基于一个CPU，并且CPU中只有一个核心这个前提展开的，然而在现代的计算机中，有些系统可能不止有一个CPU，换而言之我们现在的计算机系统有些是多处理器的（Multiprocessors）的系统。</p><p>多处理器的系统有如下的好处：</p><ul><li><strong>大吞吐量（Increased Throughput）</strong></li><li><strong>便宜（Economy of scale）</strong></li><li><strong>更加可靠/容错更好（Graceful Degradation/fault tolerance）</strong></li></ul><p>通常来说，多处理器系统有两种架构：</p><ul><li><p><strong>非对称多处理器架构（Asymmetric Multiprocessing）</strong>：对称处理多处理架构指处理器之间是对称的，即在操作系统看来，没有多个处理器，只有一个处理器，所有的线程不加以区分，具体由那个处理器执行是随机的，所有处理器之间共享内存。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211230165903630.png" alt="对称多处理器架构"></p></li><li><p><strong>对称对处理器架构（Symmetric Multiprocessing）</strong>：非对称多处理架构指处理器与处理器之间是非对称的，有些处理器专注于处理用户的程序（线程），而有些处理器则专注于处理系统线程</p></li></ul><p>两者的对比图如下：</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211230170031905.png" alt="Asymmetric v.s. Symmetric"></p><h2 id="17-Multicore"><a href="#17-Multicore" class="headerlink" title="17. Multicore"></a>17. Multicore</h2><p>前面我们说了可能存在不止一个处理器的系统，其实现在的计算机中一个处理器有多个核心，类似于多处理器的系统架构，多核心的CPU的好处和多处理器的系统的好处是类似的。</p><p>多核心的CPU主要有三种设计：</p><ul><li><p><strong>共享缓存（Shared Cache）</strong>：共享缓存的CPU中的多个核心之间会共享cache，而运算则是独立的。知名的一些产品有：IBM POWER4/5 family、Sun UltraSPARC-IV、Fujitsu SPARC64-VI、Sun Niagara、Intel Yonah/Merom family</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211230170816531.png" alt="共享缓存的CPU设计"></p></li><li><p><strong>共享IO接口（Shared I/O Interface）</strong>：CPU可以通过总线和其他各个设备之间进行数据的交互，例如和内存。而共享I/O接口的多核处理器的设计则是两个处理器有单独的运算单元和缓存，只有I/O接口是共享的。一些知名的产品包括：Intel Itanium2、AMD dual-core Opteron </p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211230171118342.png" alt="共享I/O接口的CPU"></p></li><li><p><strong>共享外壳(?)（Shared data packet）</strong>：这种多核心CPU的设计两个核心基本上就是独立的CPU，我实在不知道怎么翻译data packet……</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211230171323203.png" alt="共享外壳的CPU"></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Operating System Concepts Reading Notes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 操作系统 </tag>
            
            <tag> Operating System </tag>
            
            <tag> Reading Notes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>操作系统概念读书笔记-第零章：概览.md</title>
      <link href="/2021/12/28/cao-zuo-xi-tong-gai-nian-du-shu-bi-ji-di-ling-zhang-gai-lan-md/"/>
      <url>/2021/12/28/cao-zuo-xi-tong-gai-nian-du-shu-bi-ji-di-ling-zhang-gai-lan-md/</url>
      
        <content type="html"><![CDATA[<blockquote><p>本文是《操作系统概念（第九版）》读书笔记系列的第一篇文章，主要讲述我为什会编写这一系列的文章以及本系列文章的规划。</p><p>This article is the overview of series article: <code>reading notes of  _Operating System Concepts (Ninth Edition)_</code>.</p></blockquote><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211229231836302.png" alt="操作系统概念"></p><h1 id="操作系统概念读书笔记-第零章：概览"><a href="#操作系统概念读书笔记-第零章：概览" class="headerlink" title="操作系统概念读书笔记-第零章：概览"></a>操作系统概念读书笔记-第零章：概览</h1><h2 id="1-Why-Learning-Operating-System"><a href="#1-Why-Learning-Operating-System" class="headerlink" title="1. Why Learning Operating System?"></a>1. Why Learning Operating System?</h2><h3 id="A-From-the-aspect-of-own-capability"><a href="#A-From-the-aspect-of-own-capability" class="headerlink" title="A. From the aspect of own capability."></a>A. From the aspect of own capability.</h3><p>操作系统是一种特殊的软件，它下可以沟通硬件，上可以为用户的程序提供服务，连接了人与硬件。操作系统。各种算法、优化、设计思想的集大成者，巨型工程的难得成功案例</p><p>学习操作系统本身就能够提升我们的代码水平，因为其实写代码的时候遇到的很多问题是与底层机制相关的，如果不学底层这些知识，就会在遇到问题的时候束手无策。因此为我们想要写出来更好的程序、更好的操作计算机就需要学习操作系统。</p><h3 id="B-From-the-aspect-of-school-courses"><a href="#B-From-the-aspect-of-school-courses" class="headerlink" title="B. From the aspect of school courses."></a>B. From the aspect of school courses.</h3><p>另外一方面，操作系统是计算机科学相关专业学生的必修课，我也不例外。因此学习操作系统的另外一方面就是要分数。虽然我不太喜欢内卷，但是基础的分数还是必要的。</p><h2 id="2-Why-this-series-of-blogs"><a href="#2-Why-this-series-of-blogs" class="headerlink" title="2. Why this series of blogs"></a>2. Why this series of blogs</h2><p>写这系列博客的原因其实有很多，首先是作为学习的笔记，在未来需要的时候可以快速的回忆起来。</p><p>其次是作为我学习过操作系统的证据，毕竟需要记录可以证明我曾经学习过这些东西，</p><h2 id="3-Why-Operating-System-Concepts"><a href="#3-Why-Operating-System-Concepts" class="headerlink" title="3. Why Operating System Concepts?"></a>3. Why <em>Operating System Concepts</em>?</h2><p>学习是需要媒介的，无论是通过视频（网课）、看书（PPT）还是上课。对于我来说，效率最高的方式就是看书，此外由于学校里的课程使用的教材是《操作系统概念》，因此就选择阅读这本书来进行学习。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211229231836302.png" alt="《操作系统概念》"></p><p>此外关于操作系统的书有两种，一种是面向新手的、零基础的介绍操作系统的概念的书，例如这本操作系统概念；另外一种是面向以及有经验的、面向开发的操作系统的书，例如Linux内核完全剖析。</p><p>第一次学习操作系统当然是要学基础的、介绍概念的书，未来提升自己、动手实现一个内核的时候再参考Linux内核完全剖析这类书。</p><h2 id="4-Overview-of-Operating-System-Concepts"><a href="#4-Overview-of-Operating-System-Concepts" class="headerlink" title="4. Overview of Operating System Concepts"></a>4. Overview of <em>Operating System Concepts</em></h2><p>操作系统概念这本书主要分为以下几个大部分：</p><ul><li>概述：Overview，1-2章</li><li>进程管理：Process Management，3-7章</li><li>内存管理：Memory Management，8-9章</li><li>存储管理：Storage Management，10-13章</li><li>保护和安全：Protection and Security，14-15章</li><li>高级话题：Advanced Topics，主要讲解了虚拟化技术和分布式系统，16-17章</li><li>案例分析：Case Study，讨论了MacOS、Linux、Windows 7、Free BSD这些操作系统，18-19章</li></ul><p>本系列文章也将根据这些内容进行展开。</p>]]></content>
      
      
      <categories>
          
          <category> Operating System Concepts Reading Notes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 操作系统 </tag>
            
            <tag> Operating System </tag>
            
            <tag> Reading Notes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu下QQ和微信解决方法</title>
      <link href="/2021/12/28/ubuntu-xia-qq-he-wei-xin-jie-jue-fang-fa/"/>
      <url>/2021/12/28/ubuntu-xia-qq-he-wei-xin-jie-jue-fang-fa/</url>
      
        <content type="html"><![CDATA[<blockquote><p>QQ和微信作为国民级的应用，无论是聊天还是传输文件都非常的方便。本文介绍了如何在类似Ubuntu这类的Linux平台上使用微信和QQ。</p></blockquote><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211229230820817.png" alt="最终效果图"></p><h1 id="Ubuntu-Linux下QQ和微信解决方法"><a href="#Ubuntu-Linux下QQ和微信解决方法" class="headerlink" title="Ubuntu/Linux下QQ和微信解决方法"></a>Ubuntu/Linux下QQ和微信解决方法</h1><p>作为一个开发者，通常在进行开发的时候往往会选择使用Ubuntu、CentOS等Linux发行版作为开发的平台。然而中国的开发者难以避开的就是QQ、微信等等应用。除了聊天以外，QQ、微信的一个重要的功能就是在多端设备之间传输文件（电脑–&gt;手机、平板–&gt;电脑）。然而QQ和微信都仅仅支持MacOS和Windows这两大平台，因此本文就介绍了在Ubuntu/Linux平台上使用QQ和微信的方法。</p><h2 id="方案一：虚拟机"><a href="#方案一：虚拟机" class="headerlink" title="方案一：虚拟机"></a>方案一：虚拟机</h2><p>微信和QQ都支持windows平台，因此使用虚拟机的话就是我们在ubuntu上安装一个windwos的虚拟机，然后在虚拟机中安装qq和微信。</p><p>使用虚拟机的原因在于使用docker和wine等方式使用QQ和微信都只是权宜之计，只能够解决某一个版本的QQ和微信的使用。此外一个API还会可能有问题，因此如果想到比较完美的使用体验就还是需要虚拟机。</p><h3 id="1-检查内存大小"><a href="#1-检查内存大小" class="headerlink" title="1. 检查内存大小"></a>1. 检查内存大小</h3><p>使用虚拟机的一个大问题就是需要电脑有足够大的内存，这样在运行windows虚拟机的时候就不会很卡。</p><p>由于我的机器的性能还是不错的，内存有32个G，因此对我来说最合适的解决方案就是安装一个Windows的虚拟机。</p><p>在后续的步骤前首先需要查看自己的机器的内存和交换空间的大小，使用下面的命令，就可以看到。</p><pre class="line-numbers language-shell"><code class="language-shell">watch free -h<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211228173025146.png" alt="我的机器的内存信息"></p><h3 id="2-安装Virtualbox虚拟机"><a href="#2-安装Virtualbox虚拟机" class="headerlink" title="2. 安装Virtualbox虚拟机"></a>2. 安装Virtualbox虚拟机</h3><p>目前运行比较流畅的虚拟机就是Oracle的VirtualBox和VMware公司的VMware两个软件。由于Virtualbox免费并且多平台适用的的特点（VMware收费），本文使用VirtualBox来作为虚拟机的软件。</p><p>安装VirtualBox虚拟机使用下面的命令就行，由于我已经安装过了，因此不会有任何反应</p><pre class="line-numbers language-shell"><code class="language-shell">sudo apt-get install virtualbox<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211228173626767.png" alt="安装VirtualBox"></p><p>安装完了之后我们就可以在命令行中通过virtualbox命令或者在应用程序图标里点击运行VirtualBox，这里继续使用命令行</p><pre class="line-numbers language-shell"><code class="language-shell">virtualbox<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然后我们就能够看到VirtualBox开始运行。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211228173825872.png" alt="image-20211228173825872"></p><h3 id="3-下载windows镜像"><a href="#3-下载windows镜像" class="headerlink" title="3. 下载windows镜像"></a>3. 下载windows镜像</h3><p>windows的镜像文件我们可以直接取<a href="https://www.microsoft.com/zh-cn/software-download/windows10ISO">windows的官网</a>上下载：<a href="https://www.microsoft.com/zh-cn/software-download/windows10ISO%E3%80%82%E8%80%83%E8%99%91%E5%88%B0%E6%B5%8F%E8%A7%88%E5%99%A8%E6%9C%AC%E8%BA%AB%E5%B0%B1%E4%BC%9A%E5%8D%A0%E7%94%A8%E5%BE%88%E5%A4%9A%E7%9A%84%E8%B5%84%E6%BA%90%EF%BC%8C%E5%BD%B1%E5%93%8D%E4%B8%8B%E8%BD%BD%E9%80%9F%E5%BA%A6%EF%BC%8C%E5%9B%A0%E6%AD%A4%E4%BD%BF%E7%94%A8wget%E4%BB%8E%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8A%A0%E9%80%9F%E4%B8%8B%E8%BD%BD%E3%80%82">https://www.microsoft.com/zh-cn/software-download/windows10ISO。考虑到浏览器本身就会占用很多的资源，影响下载速度，因此使用wget从命令行加速下载。</a></p><p>我们选择完windows版本之后会看到官网给出的两个下载链接，选择自己需要的版本然后复制链接即可</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211228174324033.png" alt="复制下载链接"></p><p>接下来在命令行中wget下载即可，注意复制来的网页链接中有<code>(</code>之类的shell的语法字符，因此需要用<code>""</code>把网址包围起来禁止转义</p><pre class="line-numbers language-shell"><code class="language-shell">wget -c "你的下载地址"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211228174604765.png" alt="下载Windows的镜像文件"></p><p>然后耐心等待即可。下载完大小5.5G左右</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211228190833912.png" alt="下载完成的镜像文件"></p><p>最后我们给这个文件改个名字，把后缀改成iso，因为稍后VirtualBox是根据后缀名来识别文件的</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211228192040466.png" alt="修改后的文件"></p><h3 id="4-创建虚拟机"><a href="#4-创建虚拟机" class="headerlink" title="4. 创建虚拟机"></a>4. 创建虚拟机</h3><p>点击右上角的<code>新建</code>，然后选择虚拟机文件的存储位置和对应的系统，完成后点下一步。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211228190934329.png" alt="虚拟机的基本设置"></p><p>接下来给虚拟机分配内存，这个就看个人了，我的内存比较大，所以就给虚拟机分配12G内存</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211228191153552.png" alt="内存分配"></p><p>接下来给虚拟机的文件分配大小，默认即可</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211228191420175.png" alt="为虚拟机分配磁盘1"></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211228191450549.png" alt="为虚拟机分配磁盘2"></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211228191511960.png" alt="为虚拟机分配磁盘2"></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211228191536355.png" alt="为虚拟机分配磁盘3"></p><h3 id="5-安装windows虚拟机"><a href="#5-安装windows虚拟机" class="headerlink" title="5. 安装windows虚拟机"></a>5. 安装windows虚拟机</h3><p>上面我们只是用VirtualBox创建好了所有需要的环境，接下来我们就是要把windows安装进去</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211228191700557.png" alt="点击设置"></p><p>然后在存储中点击盘片，选择windows的映像文件</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211228191834378.png" alt="选择windows的映像文件"></p><p>然后点击启动即可</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211228192121402.png" alt="点击启动"></p><p>然后按照指引进行安装即可</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211228192211784.png" alt="安装windows"></p><p>安装完之后的分辨率有点问题，因此我们还需要设置一下分辨率</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211228200126547.png" alt="有问题的分辨率"></p><p>点击<code>设备</code>–&gt;<code>安装增强功能</code>，然后按照提示安装即可</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211228200320807.png" alt="安装增强功能"></p><p>安装完成之后在C盘外有一个程序，点击运行即可</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211228201049520.png" alt="image-20211228201049520"></p><p>安装完之后重启，就可以在视图中进行设置，选择自动调整窗口大小即可</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211228202752076.png" alt="全屏显示"></p><p>最后在设置里设置双向剪贴板</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211228203017531.png" alt="设置共享剪切板"></p><h3 id="6-安装微信和QQ"><a href="#6-安装微信和QQ" class="headerlink" title="6. 安装微信和QQ"></a>6. 安装微信和QQ</h3><p>最后安装微信和QQ即可，最终效果图如下</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211229230820817.png"></p><p>此外，我们安装完的Windows实际上是未激活的的Windows，只能够使用一些有限的功能。为此，要么去微软官方买一个激活码，或者去淘宝买一个激活码即可。</p>]]></content>
      
      
      <categories>
          
          <category> 杂项 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Ubuntu </tag>
            
            <tag> QQ </tag>
            
            <tag> 微信 </tag>
            
            <tag> Wechat </tag>
            
            <tag> Linux </tag>
            
            <tag> Virtualbox </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>A*算法-Python实现</title>
      <link href="/2021/12/22/a-suan-fa-python-shi-xian/"/>
      <url>/2021/12/22/a-suan-fa-python-shi-xian/</url>
      
        <content type="html"><![CDATA[<blockquote><p>本文主要提供了Python版本的A*路径规划算法实现，并在此基础上提供了命令行和基于Matplotlib的GUI用户界面（User Interface）</p></blockquote><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/a_star.gif" alt="完整效果"></p><h1 id="A-算法-Python实现"><a href="#A-算法-Python实现" class="headerlink" title="A*算法-Python实现"></a>A*算法-Python实现</h1><p>路径规划算法是计算机届中非常重要的算法，在不少领域都能够看到路径规划算法的应用，最直接的应用例如打车软件为你规划出路径、迷宫问题的求解等等；而复杂一些的、不直接的应用如六自由度机械臂在空间中运动轨迹的规划可以看做是在六维空间的路径规划、火星车在火星表面的探索等等都可以视为路径规划问题，从而使用路径规划算法进行求解。</p><p>路径规划算法大体上可以分为两类：<strong>静态路径规划</strong>以及<strong>动态路径规划</strong>。所谓静态静态路径规划指的是提前已知全局地图的前提下进行路径规划；而动态路径规划则指的是预先并不知道全局地图或者仅知道全局地图的一部分，在此基础上对全局地图进行探索的同时动态的利用获取到的信息指导路径规划，最终达到终点。在我们的认知上，一般当然是动态路径规划算法会好很多，因为我们往往并不知道全局地图，而且对于我们人类来说，在一个陌生环境下进行路径规划、到达终点更是我们所希望的。然而在现实中在一些场景中确实全局地图是可以提前获得的，因此针对这些场景，开发出来资源占用更少、速度更快、路径更优的算法就还是有必要的。</p><p>其实动态路径规划更进一步，在探索的构建出来全局地图，那就成了SLAM问题了，即同时定位与建图（Simultaneous Localization And Mapping，SLAM）。关于SLAM本文就不再深入了。</p><p>本文将要介绍的A*算法就是属于静态路径规划算法的其中一种。在诸多的静态路径规划算法里，A*算法可以和暴力搜索（广度优先、深度优先）一样，获得最优的路径，并且资源消耗远远小于广度优先和深度优先。因此有广泛的应用。</p><p>本文将在介绍A*算法的基础上提供一种A*算法的Python实现，并在此基础上讲解实现的代码</p><h2 id="0-前言"><a href="#0-前言" class="headerlink" title="0. 前言"></a>0. 前言</h2><p>其实我现在是一个大二的计算机系学生，最近数据结构课程的配套实验要求学生从十四个题中选择四个来做。本篇博客就是对应的迷宫问题的求解代码。求解问题比较简单，但是这样就太没有意思了，所以在实现文本字符的迷宫求解基础上，我想为自己带来一些挑战，增加一些趣味性与难度。</p><p>因此在基础的求解迷宫问题的要求上，我利用Matplotlib中的Interactive Plotting Method将路径规划的过程以GUI的形式表达出来，并在此基础上提供地图绘制、地图保存等一系列功能，最后完成一个不错的程序。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211221220005902.png" alt="数据结构算法实验"></p><h2 id="1-A-算法"><a href="#1-A-算法" class="headerlink" title="1. A*算法"></a>1. A*算法</h2><p>其实关于A*算法并没有什么好说的，网上不少博客对A*算法都有了非常深入的介绍，因此我这里就不在赘述了，避免班门弄斧。</p><p>而对于A*算法，需要理解的关键之处就是在启发值的运用。启发值描述了当前点到终点的估计距离，因此相比于深度有限和广度优先，A*算法每次都会去寻找离终点距离比较近的点作为下一个点，从而避免了漫无目的、低效率的遍历。</p><p>此外，算法中的OpenList和CloseList其实指的就是已探索区域的边缘和已经探索区域的内部，因此每次进行下一次探索的时候从OpenList里面找出来点作为下一个探索的点即可。而一旦这个点被探索完毕，将其加入到CloseList中即可，即表示当前点已经被考虑过。</p><p>最后算法的结束条件就是当终点已经在CloseList中了，表示已经找到了一条路径，此时对CloseList中的点进行回溯即可找到路径，因为CloseList中的探索区域已经蕴含了路径的信息；此外还要注意找不到路径时候的结束条件，避免找不到路径而陷入死循环。</p><p>上面是我对于A*算法的理解，如果需要学习A*算法的话，其实B站上、知乎上有很多不错的讲解。这里就贴出来百度百科和维基百科的介绍</p><blockquote><p><strong>From Wikipedia</strong>：</p><p>A* (pronounced “A-star”) is a graph traversal and path search algorithm, which is often used in many fields of computer science due to its completeness, optimality, and optimal efficiency. One major practical drawback is its  $O(b^{d}$) space complexity, as it stores all generated nodes in memory. Thus, in practical travel-routing systems, it is generally outperformed by algorithms which can pre-process the graph to attain better performance, as well as memory-bounded approaches; however, A* is still the best solution in many cases.</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211222143802336.png" alt="维基百科上对A*算法的介绍"></p><p><strong>From BaiduBaike</strong>：</p><p>A*算法，A*（A-Star)算法是一种静态路网中求解最短路径最有效的直接搜索方法，也是解决许多搜索问题的有效算法。算法中的距离估算值与实际值越接近，最终搜索速度越快。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211222143914743.png" alt="百度百科上对A*算法的介绍"></p></blockquote><h2 id="2-实现思路"><a href="#2-实现思路" class="headerlink" title="2. 实现思路"></a>2. 实现思路</h2><p>针对不同的功能，整个程序的实现，主要分为三个层次（软件分层的思想）：</p><ol><li><strong>核心层</strong>：负责GUI的显示（地图的绘制与更新）、地图的加载与保存、键盘鼠标等事件对应的回调函数（信号处理函数）的绑定</li><li><strong>算法实现层</strong>：负责A*算法的实现</li><li><strong>用户界面层</strong>：负责提供命令行用户界面，从而实现<del>高级感</del>（逼格）</li></ol><h3 id="1-核心层"><a href="#1-核心层" class="headerlink" title="1. 核心层"></a>1. 核心层</h3><p>核心层的具体任务为维护全局地图以及进行地图的保存，因此代码也是围绕这两大内容进行编写的。</p><h4 id="1-地图的维护"><a href="#1-地图的维护" class="headerlink" title="1. 地图的维护"></a>1. 地图的维护</h4><p>对于路径规划问题，其核心维护对象就是全局地图地图，因为地图的保存、与加载；GUI的显示以及路径规划的实现都需要地图上区域的状态，因此在核心层首先需要实现的的就是地图。</p><ul><li>首先是关于地图的表示。对于地图本身而言，由于目前进行的是二维的路径规划，因此可以利用一个二维数组来表示。</li><li>其次是地图在磁盘上的表示。为了方便保存之后方便读取、加载以及人类的理解，可以将二维数组保存为csv文件从而序列化到磁盘上，而在加载地图的时候再从磁盘上反序列化csv文件到内存，从而读取出来地图。</li><li>最后是地图中障碍物的表示。由于地图中的区域会有多种状态，例如是否为障碍物（是否可行），其次在进行A*路径规划的时候也会为地图中的区域标记其状态（是否已经考虑过）。因此针对地图中不同的状态的区域，使用不同的数值表示当前区域的状态，例如inf表示障碍物，3表示最终规划得到的路径。</li></ul><h4 id="2-地图的显示"><a href="#2-地图的显示" class="headerlink" title="2. 地图的显示"></a>2. 地图的显示</h4><p>由于地图的显示涉及到图形的显示，因此需要了解一下图形在计算机中的显示。</p><blockquote><p>图形的显示有两种方式，分别是矢量图以及光栅图。</p><ul><li>对于矢量图，其内部的图形是由基本的几何图形构成的，因此在矢量图文件（例如.dot）文件中，只需要按照指定的格式描述图形的属性即可。例如Windows的.dot文件，我们按照其要求的语法对图形进行描述，然后对应的解析该语法，利用图形学的算法即可渲染出来图形，我们常见的PDF、SVG等等文件都是矢量图。例如下面的例子</li></ul><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211224005217273.png" alt="矢量图的一种：dot文件"></p><ul><li>而对于光栅图，其基本构成单位是像素，每个像素大小只有零点几个毫米，而每平方厘米都会有几百几千个像素。而每个像素都会有自己的数值，表现出来自己的颜色。因此我们通过几万个极小的、在人眼看来是点的像素组合起来就成了我们所看到的图像。因此这种图像又称为位图、点阵图、像素图。我们常见的JPG、PNG、BMP等等都是光栅图，例如下面的例子</li></ul><p><img src="https://bkimg.cdn.bcebos.com/pic/54fbb2fb43166d22356091ba4b2309f79052d28d?x-bce-process=image/watermark,image_d2F0ZXIvYmFpa2U4MA==,g_7,xp_5,yp_5/format,f_auto" alt="经典的光栅图"></p><p>矢量图最大的好处就在于由于其图形是完全利用数学公式描述的（例如圆相对于屏幕左上角的相对距离、圆相对于屏幕宽度的半径等等），因此针对不同的屏幕、不同的放大背书，矢量图片完全可以通过运算进行放大、适配。因此在我们用户看来就是矢量图是无论怎样放大边缘都不会模糊。例如下面的pdf</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211224010247748.png" alt="放大2.5倍的PDF文件"></p><p>aas</p><p>而光栅图的基本单位是像素，因此再怎么放大，像素都是不会变的，因此在放大一定的倍数就会模糊，这个时候即便有一些算法会做自适应，例如双线性插值、三线性插值等等增加像素的数量，但是他们会造成边缘的模糊</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211224010524045.png" alt="光栅图放大后可见的像素"></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211224010559551.png" alt="经过插值处理之后的图片会变的模糊"></p><p>因此在不同场景下有不同的取舍。一般而言，当图形比较好描述（都是规则的几何图形）的时候，就会选择用矢量图，而当图形不好描述的时候（例如自然景观），这个时候就会选择光栅图</p></blockquote><p>尽管地图都是规整的矩形和色块，使用矢量图非常容易描述，但是考虑到如果需要使用矢量图像的话还需要不少的学习成本来学习矢量图的描述语言，花费的时间比较多。而有考虑到Python中其实已经想Matplotlib、Seaborn、Plotly这类非常好的光栅图绘图库（当然他们可以绘制矢量图），因此最终决定使用光栅图来显示、绘制地图。</p><p>当然，其实Matplotlib、Plotly这些库最终调用的都是类似于cairo、gtk这些由C/C++开发出来的图形库</p><h4 id="3-地图动态显示"><a href="#3-地图动态显示" class="headerlink" title="3. 地图动态显示"></a>3. 地图动态显示</h4><p>地图的绘制与显示实际上是一个非常消耗资源的操作。上面的GIF和后面放出来的B站的演示视频里A*算法花了不少的时间最后才找到最终的路径，但是真正的纯A*算法的规划路径的速度才只有0.2秒左右，这还是我在100*100的地图上测试的。然而为了显示出A*的动态效果图，因此算法的每次试探都会进行地图的绘制。而每次绘图就需要占去0.2秒左右的时间（我读取系统时间做了benchmark）。因此只敢显示30*30的地图。</p><p>因此为了尽可能的的加快绘图的速度，在图形中对所有的Patch（即一个小方格）进行记录，每次只会重新绘制发生了变化的Patch而不会重新绘制整张地图，因此极大地加快了显示的速度。至少在我测试的50*50的场景下效果还是非常不错的。</p><h3 id="2-算法实现层"><a href="#2-算法实现层" class="headerlink" title="2. 算法实现层"></a>2. 算法实现层</h3><p>算法实现层负责实现A*算法。A*算法中使用使用OpenList以及CloseList维护已探索区域和边缘区域。此外为实现算法实现层与核心层解耦合，而二维地图的状 态的维护由核心层提供，因此在算法实现层只需要调用核心层提供的接口进行地图状态修改即可 </p><h3 id="3-用户界面层"><a href="#3-用户界面层" class="headerlink" title="3. 用户界面层"></a>3. 用户界面层</h3><p>用户界面层负责GUI的显示以及命令行用户界面。GUI部分通过Matplotlib内嵌的信号与槽机制实现用户鼠标、键盘事件的监听以及回调函数的绑定，进而响应用户事件，完成功能，例如：保存地图 。命令行用户界面负责根绝接收到不同的用户参数，运行不同的功能，例如绘制地图、开始路径规划……</p><h2 id="3-具体代码"><a href="#3-具体代码" class="headerlink" title="3. 具体代码"></a>3. 具体代码</h2><h3 id="1-导入库"><a href="#1-导入库" class="headerlink" title="1. 导入库"></a>1. 导入库</h3><p>导入Python中队列维护的库queue、路径处理库pathlib、二维数组维护库Numpy、csv序列化与反序列化Pandas库、绘图库Matplotlib以及命令行彩色字体库colorama</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> time<span class="token keyword">import</span> queue<span class="token keyword">import</span> pprint<span class="token keyword">import</span> argparse<span class="token keyword">from</span> typing <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">from</span> pathlib <span class="token keyword">import</span> Path<span class="token keyword">from</span> collections <span class="token keyword">import</span> namedtuple<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>backend_bases <span class="token keyword">as</span> bbase<span class="token keyword">from</span> colorama <span class="token keyword">import</span> Fore<span class="token punctuation">,</span> Style<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-核心对象"><a href="#2-核心对象" class="headerlink" title="2. 核心对象"></a>2. 核心对象</h3><p>_MapBase中维护的核心对象为map，程序所处的状态由一个有限状态机维护，不同的事件由不同的回调函数负责处理。</p><p>首先，__del__、new、update、add_patch实现了GUI图形的绘制以及更新</p><p>pandasfy与depandasfy负责将二维地图以csv文件格式保存至磁盘上</p><p>_btn_press_cb、_btn_release_cb、_move_cb、_keyboard_cb分别响应鼠标按下、松开、移动以及键盘按下事件</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">_MapBase</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Notes:        MapBase 用于可视化的地图创建    Args:        mapsize (tuple[int, int]): size of map        figsize (tuple[int, int]): size of figure    """</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> mapsize<span class="token punctuation">:</span> Tuple<span class="token punctuation">[</span>int<span class="token punctuation">,</span> int<span class="token punctuation">]</span><span class="token punctuation">,</span> figsize<span class="token punctuation">:</span> Tuple<span class="token punctuation">[</span>int<span class="token punctuation">,</span> int<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        super<span class="token punctuation">(</span>_MapBase<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># meta information</span>        self<span class="token punctuation">.</span>_mapsize<span class="token punctuation">:</span> Tuple<span class="token punctuation">[</span>int<span class="token punctuation">,</span> int<span class="token punctuation">]</span> <span class="token operator">=</span> mapsize        self<span class="token punctuation">.</span>_figsize<span class="token punctuation">:</span> Tuple<span class="token punctuation">[</span>int<span class="token punctuation">,</span> int<span class="token punctuation">]</span> <span class="token operator">=</span> figsize        <span class="token comment" spellcheck="true"># map, inf obstacle, 0 accessible, 1 in path</span>        self<span class="token punctuation">.</span>map<span class="token punctuation">:</span> np<span class="token punctuation">.</span>ndarray <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>shape<span class="token operator">=</span>mapsize<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>map_temp<span class="token punctuation">:</span> np<span class="token punctuation">.</span>ndarray <span class="token operator">=</span> None        <span class="token comment" spellcheck="true"># visualize core object</span>        self<span class="token punctuation">.</span>_figure<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_axes <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span>figsize<span class="token operator">=</span>figsize<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>_canvas <span class="token operator">=</span> self<span class="token punctuation">.</span>_figure<span class="token punctuation">.</span>canvas        self<span class="token punctuation">.</span>_title<span class="token punctuation">:</span> plt<span class="token punctuation">.</span>Text <span class="token operator">=</span> None        self<span class="token punctuation">.</span>_go_on<span class="token punctuation">:</span> bool <span class="token operator">=</span> <span class="token boolean">False</span>        <span class="token comment" spellcheck="true"># gui interaction, finite state machine to control plot</span>        self<span class="token punctuation">.</span>_on_press<span class="token punctuation">:</span> bool <span class="token operator">=</span> <span class="token boolean">False</span>        self<span class="token punctuation">.</span>_current_state <span class="token operator">=</span> <span class="token string">"add_obstacle"</span>        self<span class="token punctuation">.</span>btn_pressed_cid <span class="token operator">=</span> self<span class="token punctuation">.</span>_canvas<span class="token punctuation">.</span>mpl_connect<span class="token punctuation">(</span><span class="token string">"button_press_event"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>_btn_press_cb<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>btn_released_cid <span class="token operator">=</span> self<span class="token punctuation">.</span>_canvas<span class="token punctuation">.</span>mpl_connect<span class="token punctuation">(</span><span class="token string">"button_release_event"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>_btn_release_cb<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>mouse_move_cid <span class="token operator">=</span> self<span class="token punctuation">.</span>_canvas<span class="token punctuation">.</span>mpl_connect<span class="token punctuation">(</span><span class="token string">"motion_notify_event"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>_move_cb<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>keyboard_cid <span class="token operator">=</span> self<span class="token punctuation">.</span>_canvas<span class="token punctuation">.</span>mpl_connect<span class="token punctuation">(</span><span class="token string">"key_press_event"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>_keyboard_cb<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">__del__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        plt<span class="token punctuation">.</span>close<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_figure<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">start</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">assert</span> <span class="token boolean">False</span><span class="token punctuation">,</span> f<span class="token string">"This method should be overwritten by subclass"</span>    <span class="token keyword">def</span> <span class="token function">update</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>_canvas<span class="token punctuation">.</span>draw_idle<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">new</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> bool<span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        Notes:            new is used to clear the map. In practice, generate a new axes        Returns:            if_clear (bool): true if successfully clear the map        """</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            self<span class="token punctuation">.</span>map <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>shape<span class="token operator">=</span>self<span class="token punctuation">.</span>_mapsize<span class="token punctuation">)</span>            self<span class="token punctuation">.</span>_axes<span class="token punctuation">.</span>cla<span class="token punctuation">(</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>_axes<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>_axes<span class="token punctuation">.</span>set_xticks<span class="token punctuation">(</span>range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>_mapsize<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>_axes<span class="token punctuation">.</span>set_yticks<span class="token punctuation">(</span>range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>_mapsize<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>_axes<span class="token punctuation">.</span>set_xlim<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>_mapsize<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>_axes<span class="token punctuation">.</span>set_ylim<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>_mapsize<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>_title <span class="token operator">=</span> self<span class="token punctuation">.</span>_axes<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span>f<span class="token string">"Current State: {self._current_state}"</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>_axes<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">"s"</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">"red"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"goal"</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>_axes<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">"s"</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">"black"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"obstacle"</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>_axes<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">"s"</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">"green"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"start"</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>_axes<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">"s"</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">"blue"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"final path"</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>_axes<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">"s"</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">"gray"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"explored"</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>_axes<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">"s"</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">"cyan"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"frontier"</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>_axes<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1.01</span><span class="token punctuation">,</span> <span class="token number">0.85</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token boolean">True</span>        <span class="token keyword">except</span> KeyboardInterrupt <span class="token keyword">as</span> e<span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Keyboard interrupted"</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token boolean">False</span>    <span class="token keyword">def</span> <span class="token function">add_patch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">:</span> Union<span class="token punctuation">[</span>int<span class="token punctuation">,</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">,</span> list<span class="token punctuation">]</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> Union<span class="token punctuation">[</span>int<span class="token punctuation">,</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">,</span> list<span class="token punctuation">]</span><span class="token punctuation">,</span>                  patches<span class="token punctuation">:</span> Union<span class="token punctuation">[</span>str<span class="token punctuation">,</span> None<span class="token punctuation">]</span> <span class="token operator">=</span> None<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> bool<span class="token punctuation">:</span>        prompt <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token keyword">if</span> isinstance<span class="token punctuation">(</span>x<span class="token punctuation">,</span> int<span class="token punctuation">)</span> <span class="token keyword">else</span> list<span class="token punctuation">(</span>zip<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_current_state <span class="token operator">==</span> <span class="token string">"add_obstacle"</span><span class="token punctuation">:</span>            <span class="token keyword">try</span><span class="token punctuation">:</span>                self<span class="token punctuation">.</span>map<span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>inf            <span class="token keyword">except</span> IndexError<span class="token punctuation">:</span>                <span class="token keyword">pass</span>            self<span class="token punctuation">.</span>_axes<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">,</span> y <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">"s"</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">"black"</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"Add obstacle: {prompt}"</span><span class="token punctuation">)</span>        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>_current_state <span class="token operator">==</span> <span class="token string">"add_goal"</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>map <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>any<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"{Fore.YELLOW}Already have one goal!{Style.RESET_ALL}"</span><span class="token punctuation">)</span>                <span class="token keyword">return</span> <span class="token boolean">False</span>            self<span class="token punctuation">.</span>map<span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>            self<span class="token punctuation">.</span>_axes<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">,</span> y <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">"s"</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">"red"</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"Add goal: {prompt}"</span><span class="token punctuation">)</span>        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>_current_state <span class="token operator">==</span> <span class="token string">"add_start"</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>map <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>any<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"{Fore.YELLOW}Already have one start!{Style.RESET_ALL}"</span><span class="token punctuation">)</span>                <span class="token keyword">return</span> <span class="token boolean">False</span>            self<span class="token punctuation">.</span>map<span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2</span>            self<span class="token punctuation">.</span>_axes<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">,</span> y <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">"s"</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">"green"</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"Add start: {prompt}"</span><span class="token punctuation">)</span>        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>_current_state <span class="token operator">==</span> <span class="token string">"going_back"</span><span class="token punctuation">:</span>            self<span class="token punctuation">.</span>map<span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">3</span>            self<span class="token punctuation">.</span>_axes<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">,</span> y <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">"s"</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">"blue"</span><span class="token punctuation">)</span>        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>_current_state <span class="token operator">==</span> <span class="token string">"clear_patch"</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> self<span class="token punctuation">.</span>map<span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>                <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"{Fore.YELLOW}Not in use!{Style.RESET_ALL}"</span><span class="token punctuation">)</span>                <span class="token keyword">return</span> <span class="token boolean">False</span>            self<span class="token punctuation">.</span>map<span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>            self<span class="token punctuation">.</span>_axes<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">,</span> y <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">250</span><span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">"s"</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">"white"</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"Cleared: {prompt}"</span><span class="token punctuation">)</span>        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>_current_state <span class="token operator">==</span> <span class="token string">"searching"</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> patches <span class="token operator">==</span> <span class="token string">"explored"</span><span class="token punctuation">:</span>                <span class="token comment" spellcheck="true"># assert (0 &lt;= self.map[x, y] &lt;= 2).all(), f"{Fore.RED}Illegal Operation on map{Fore.RESET}"</span>                <span class="token comment" spellcheck="true"># self.map[x, y] = 1</span>                self<span class="token punctuation">.</span>_axes<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">,</span> y <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">"s"</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">"gray"</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token keyword">elif</span> patches <span class="token operator">==</span> <span class="token string">"frontier"</span><span class="token punctuation">:</span>                <span class="token comment" spellcheck="true"># assert (0 &lt;= self.map[x, y] &lt;= 2).all(), f"{Fore.RED}Illegal Operation on map{Fore.RESET}"</span>                <span class="token comment" spellcheck="true"># self.map[x, y] = 2</span>                self<span class="token punctuation">.</span>_axes<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">,</span> y <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">"s"</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">"cyan"</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">assert</span> <span class="token boolean">False</span><span class="token punctuation">,</span> F<span class="token string">"{Fore.RED}Invalid State: {self._current_state}"</span>        self<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">def</span> <span class="token function">pandasfy</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        Notes:            pandasfy will serialize current map from matplotlib to cvs file        Returns:            serialized_map (pd.Dataframe)        """</span>        pp<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>self<span class="token punctuation">.</span>map<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>T<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>str<span class="token punctuation">)</span>        pp<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"-1.0"</span><span class="token punctuation">,</span> <span class="token string">"GOAL"</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>        pp<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"-2.0"</span><span class="token punctuation">,</span> <span class="token string">"START"</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> pp    <span class="token keyword">def</span> <span class="token function">depandasfy</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> csv_path<span class="token punctuation">:</span> Path<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        Notes:            depandasfy will deserialized csv file map to matplotlib        Args:            csv_path (Path): path of csv file        Returns:            None        """</span>        df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>filepath_or_buffer<span class="token operator">=</span>csv_path<span class="token punctuation">,</span> index_col<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> header<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>        df<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"START"</span><span class="token punctuation">,</span> <span class="token string">"-2.0"</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>        df<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"GOAL"</span><span class="token punctuation">,</span> <span class="token string">"-1.0"</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token punctuation">)</span>        t <span class="token operator">=</span> df<span class="token punctuation">.</span>to_numpy<span class="token punctuation">(</span>dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float64<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>T        <span class="token comment" spellcheck="true"># self.map = df.to_numpy()</span>        xs<span class="token punctuation">,</span> ys <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>t <span class="token operator">==</span> np<span class="token punctuation">.</span>inf<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>_current_state <span class="token operator">=</span> <span class="token string">"add_obstacle"</span>        self<span class="token punctuation">.</span>add_patch<span class="token punctuation">(</span>xs<span class="token punctuation">,</span> ys<span class="token punctuation">)</span>        xs<span class="token punctuation">,</span> ys <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>_current_state <span class="token operator">=</span> <span class="token string">"add_goal"</span>        self<span class="token punctuation">.</span>add_patch<span class="token punctuation">(</span>xs<span class="token punctuation">,</span> ys<span class="token punctuation">)</span>        xs<span class="token punctuation">,</span> ys <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>_current_state <span class="token operator">=</span> <span class="token string">"add_start"</span>        self<span class="token punctuation">.</span>add_patch<span class="token punctuation">(</span>xs<span class="token punctuation">,</span> ys<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">_update_title</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> s<span class="token punctuation">:</span> str <span class="token operator">=</span> None<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> s <span class="token keyword">is</span> None<span class="token punctuation">:</span>            self<span class="token punctuation">.</span>_title<span class="token punctuation">.</span>set_text<span class="token punctuation">(</span>f<span class="token string">"Current State: {self._current_state}"</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            self<span class="token punctuation">.</span>_title<span class="token punctuation">.</span>set_text<span class="token punctuation">(</span>s<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">_btn_press_cb</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> event<span class="token punctuation">:</span> bbase<span class="token punctuation">.</span>MouseEvent<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> None<span class="token punctuation">:</span>        self<span class="token punctuation">.</span>_on_press <span class="token operator">=</span> <span class="token boolean">True</span>        <span class="token keyword">if</span> event<span class="token punctuation">.</span>inaxes<span class="token punctuation">:</span>            point <span class="token operator">=</span> <span class="token punctuation">(</span>int<span class="token punctuation">(</span>event<span class="token punctuation">.</span>xdata<span class="token punctuation">)</span><span class="token punctuation">,</span> int<span class="token punctuation">(</span>event<span class="token punctuation">.</span>ydata<span class="token punctuation">)</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>add_patch<span class="token punctuation">(</span><span class="token operator">*</span>point<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">_btn_release_cb</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> event<span class="token punctuation">:</span> bbase<span class="token punctuation">.</span>MouseEvent<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> None<span class="token punctuation">:</span>        self<span class="token punctuation">.</span>_on_press <span class="token operator">=</span> <span class="token boolean">False</span>    <span class="token keyword">def</span> <span class="token function">_move_cb</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> event<span class="token punctuation">:</span> bbase<span class="token punctuation">.</span>MouseEvent<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> None<span class="token punctuation">:</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_on_press<span class="token punctuation">:</span>            <span class="token keyword">if</span> event<span class="token punctuation">.</span>inaxes<span class="token punctuation">:</span>                point <span class="token operator">=</span> <span class="token punctuation">(</span>int<span class="token punctuation">(</span>event<span class="token punctuation">.</span>xdata<span class="token punctuation">)</span><span class="token punctuation">,</span> int<span class="token punctuation">(</span>event<span class="token punctuation">.</span>ydata<span class="token punctuation">)</span><span class="token punctuation">)</span>                self<span class="token punctuation">.</span>add_patch<span class="token punctuation">(</span><span class="token operator">*</span>point<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">_keyboard_cb</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> event<span class="token punctuation">:</span> bbase<span class="token punctuation">.</span>KeyEvent<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> event<span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token string">"c"</span><span class="token punctuation">:</span>            self<span class="token punctuation">.</span>_current_state <span class="token operator">=</span> <span class="token string">"add_obstacle"</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"{Fore.YELLOW}Clear all!{Style.RESET_ALL}"</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">elif</span> event<span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token string">"1"</span><span class="token punctuation">:</span>            self<span class="token punctuation">.</span>_current_state <span class="token operator">=</span> <span class="token string">"add_obstacle"</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"{Fore.GREEN}Switch to {self._current_state}{Style.RESET_ALL}"</span><span class="token punctuation">)</span>        <span class="token keyword">elif</span> event<span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token string">"2"</span><span class="token punctuation">:</span>            self<span class="token punctuation">.</span>_current_state <span class="token operator">=</span> <span class="token string">"add_goal"</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"{Fore.GREEN}Switch to {self._current_state}{Style.RESET_ALL}"</span><span class="token punctuation">)</span>        <span class="token keyword">elif</span> event<span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token string">"3"</span><span class="token punctuation">:</span>            self<span class="token punctuation">.</span>_current_state <span class="token operator">=</span> <span class="token string">"add_start"</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"{Fore.GREEN}Switch to {self._current_state}{Style.RESET_ALL}"</span><span class="token punctuation">)</span>        <span class="token keyword">elif</span> event<span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token string">"0"</span> <span class="token operator">or</span> event<span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token string">"d"</span><span class="token punctuation">:</span>            self<span class="token punctuation">.</span>_current_state <span class="token operator">=</span> <span class="token string">"clear_patch"</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"{Fore.GREEN}Switch to {self._current_state}{Style.RESET_ALL}"</span><span class="token punctuation">)</span>        <span class="token keyword">elif</span> event<span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token string">"r"</span><span class="token punctuation">:</span>            p <span class="token operator">=</span> self<span class="token punctuation">.</span>_current_state            self<span class="token punctuation">.</span>_current_state <span class="token operator">=</span> <span class="token string">"add_obstacle"</span>            xs <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>_mapsize<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token punctuation">(</span>n <span class="token punctuation">:</span><span class="token operator">=</span> self<span class="token punctuation">.</span>_mapsize<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>_mapsize<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">//</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            ys <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>_mapsize<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> size<span class="token operator">=</span>n<span class="token punctuation">)</span>            self<span class="token punctuation">.</span>add_patch<span class="token punctuation">(</span>xs<span class="token punctuation">,</span> ys<span class="token punctuation">)</span>            self<span class="token punctuation">.</span>_current_state <span class="token operator">=</span> p        <span class="token keyword">elif</span> event<span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token string">"w"</span><span class="token punctuation">:</span>            files <span class="token operator">=</span> <span class="token punctuation">[</span>i<span class="token punctuation">.</span>stem <span class="token keyword">for</span> i <span class="token keyword">in</span> Path<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">.</span>resolve<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>absolute<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">"map_*.csv"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>            <span class="token keyword">if</span> len<span class="token punctuation">(</span>files<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>                name <span class="token operator">=</span> f<span class="token string">"map_{int(max([f.split('_')[1] for f in files])) + 1}"</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                name <span class="token operator">=</span> <span class="token string">"map_0"</span>            self<span class="token punctuation">.</span>pandasfy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>p <span class="token punctuation">:</span><span class="token operator">=</span> Path<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">.</span>resolve<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span>f<span class="token string">"{name}.csv"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"{Fore.GREEN}Save current Map to {p}{Style.RESET_ALL}"</span><span class="token punctuation">)</span>        <span class="token keyword">elif</span> event<span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token string">"v"</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"{Fore.GREEN}Start finding goal{self._current_state}{Style.RESET_ALL}"</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>_go_on <span class="token operator">=</span> <span class="token boolean">True</span>            self<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>_update_title<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-算法实现"><a href="#3-算法实现" class="headerlink" title="3. 算法实现"></a>3. 算法实现</h3><p>算法实现由Astar类负责完成，其中由于在计算启发值时可以有多种算法，因此将启发值的计算以静态方法形式嵌入到类中</p><p>start方法为完整的A*算法实现，而plot4searching用于在路径规划时动态更新地图</p><p>此外OpenList和CloseList分别作为字典的键和值蕴含在came_from和cost_so_far两个字典中，因此不用单独开辟新的数组进行保存</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Astar</span><span class="token punctuation">(</span>_MapBase<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> load_path<span class="token punctuation">:</span> Union<span class="token punctuation">[</span>Path<span class="token punctuation">,</span> None<span class="token punctuation">]</span><span class="token punctuation">,</span> mapsize<span class="token punctuation">:</span> Tuple<span class="token punctuation">[</span>int<span class="token punctuation">,</span> int<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        super<span class="token punctuation">(</span>Astar<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>mapsize<span class="token operator">=</span>mapsize<span class="token punctuation">)</span>        <span class="token keyword">if</span> load_path <span class="token keyword">is</span> <span class="token operator">not</span> None<span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"{Fore.GREEN}Load from {load_path}{Style.RESET_ALL}"</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>depandasfy<span class="token punctuation">(</span>load_path<span class="token punctuation">)</span>            self<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">)</span>            t <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>self<span class="token punctuation">.</span>map <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>self<span class="token punctuation">.</span>map <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>start_point<span class="token punctuation">:</span> str <span class="token operator">=</span> f<span class="token string">"{t[0][0][0]},{t[0][1][0]}"</span>            self<span class="token punctuation">.</span>goal_point<span class="token punctuation">:</span> str <span class="token operator">=</span> f<span class="token string">"{t[1][0][0]},{t[1][1][0]}"</span>            <span class="token comment" spellcheck="true"># open list, but I think frontier is a better name</span>            <span class="token comment" spellcheck="true"># no need for close list for which has been represented as items of came_from or keys of cost_so_far</span>            self<span class="token punctuation">.</span>frontier <span class="token operator">=</span> queue<span class="token punctuation">.</span>PriorityQueue<span class="token punctuation">(</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>frontier<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>start_point<span class="token punctuation">)</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>came_from<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span>str<span class="token punctuation">,</span> Union<span class="token punctuation">[</span>str<span class="token punctuation">,</span> None<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>self<span class="token punctuation">.</span>start_point<span class="token punctuation">:</span> None<span class="token punctuation">}</span>            self<span class="token punctuation">.</span>cost_so_far<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span>str<span class="token punctuation">,</span> float<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>self<span class="token punctuation">.</span>start_point<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span>            self<span class="token punctuation">.</span>_last<span class="token punctuation">:</span> np<span class="token punctuation">.</span>ndarray <span class="token operator">=</span> None            plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"{Fore.GREEN}Start drawing map{Style.RESET_ALL}"</span><span class="token punctuation">)</span>            plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">start</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        Notes:            A* algorithm implementation        Returns:            None        """</span>        if_can_find_goal<span class="token punctuation">:</span> bool <span class="token operator">=</span> <span class="token boolean">False</span>        <span class="token comment" spellcheck="true"># get the closest point</span>        self<span class="token punctuation">.</span>_current_state <span class="token operator">=</span> <span class="token string">"searching"</span>        self<span class="token punctuation">.</span>_update_title<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">while</span> <span class="token operator">not</span> self<span class="token punctuation">.</span>frontier<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            current_p<span class="token punctuation">:</span> str <span class="token operator">=</span> self<span class="token punctuation">.</span>frontier<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>            <span class="token comment" spellcheck="true"># find the goal</span>            <span class="token keyword">if</span> current_p <span class="token operator">==</span> self<span class="token punctuation">.</span>goal_point<span class="token punctuation">:</span>                if_can_find_goal <span class="token operator">=</span> <span class="token boolean">True</span>                <span class="token keyword">break</span>            next_p<span class="token punctuation">:</span> str            <span class="token keyword">for</span> next_p <span class="token keyword">in</span> <span class="token punctuation">(</span>n <span class="token punctuation">:</span><span class="token operator">=</span> self<span class="token punctuation">.</span>_get_neighbor<span class="token punctuation">(</span>current_p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                new_cost <span class="token operator">=</span> self<span class="token punctuation">.</span>cost_so_far<span class="token punctuation">[</span>current_p<span class="token punctuation">]</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>_get_cost<span class="token punctuation">(</span>next_p<span class="token punctuation">,</span> current_p<span class="token punctuation">)</span>                <span class="token comment" spellcheck="true"># if next point has not been considered / next point in in undiscovered area</span>                <span class="token comment" spellcheck="true"># or there exists a nearer way to get to next point by passing current point</span>                <span class="token comment" spellcheck="true"># this also can help preventing going back</span>                <span class="token keyword">if</span> next_p <span class="token operator">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>cost_so_far<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">or</span> new_cost <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>cost_so_far<span class="token punctuation">[</span>next_p<span class="token punctuation">]</span><span class="token punctuation">:</span>                    self<span class="token punctuation">.</span>cost_so_far<span class="token punctuation">[</span>next_p<span class="token punctuation">]</span> <span class="token operator">=</span> new_cost                    priority <span class="token operator">=</span> new_cost <span class="token operator">+</span> self<span class="token punctuation">.</span>_get_cost<span class="token punctuation">(</span>next_p<span class="token punctuation">,</span> self<span class="token punctuation">.</span>goal_point<span class="token punctuation">)</span>                    self<span class="token punctuation">.</span>frontier<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token punctuation">(</span>priority<span class="token punctuation">,</span> next_p<span class="token punctuation">)</span><span class="token punctuation">)</span>                    current_pp <span class="token operator">=</span> <span class="token punctuation">[</span>int<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> current_p<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">]</span>                    self<span class="token punctuation">.</span>came_from<span class="token punctuation">[</span>next_p<span class="token punctuation">]</span> <span class="token operator">=</span> f<span class="token string">"{current_pp[0]},{current_pp[1]}"</span>                    self<span class="token punctuation">.</span>_plot4searching<span class="token punctuation">(</span><span class="token punctuation">)</span>                    plt<span class="token punctuation">.</span>pause<span class="token punctuation">(</span><span class="token number">0.0001</span><span class="token punctuation">)</span>                    self<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token operator">not</span> if_can_find_goal<span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"{Fore.RED}Cannot find the goal in current map{Style.RESET_ALL}"</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>_update_title<span class="token punctuation">(</span><span class="token string">"STOP: cannot find the path!"</span><span class="token punctuation">)</span>            <span class="token keyword">return</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token comment" spellcheck="true"># go back to find the path</span>            self<span class="token punctuation">.</span>_current_state <span class="token operator">=</span> <span class="token string">"add_goal"</span>            goal <span class="token operator">=</span> <span class="token punctuation">(</span>int<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> self<span class="token punctuation">.</span>goal_point<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>add_patch<span class="token punctuation">(</span><span class="token operator">*</span>goal<span class="token punctuation">)</span>            self<span class="token punctuation">.</span>_current_state <span class="token operator">=</span> <span class="token string">"going_back"</span>            self<span class="token punctuation">.</span>_update_title<span class="token punctuation">(</span><span class="token punctuation">)</span>            path <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>            current_p <span class="token operator">=</span> self<span class="token punctuation">.</span>goal_point            <span class="token keyword">while</span> current_p <span class="token operator">!=</span> self<span class="token punctuation">.</span>start_point<span class="token punctuation">:</span>                current_p <span class="token operator">=</span> self<span class="token punctuation">.</span>came_from<span class="token punctuation">[</span>current_p<span class="token punctuation">]</span>                p <span class="token operator">=</span> tuple<span class="token punctuation">(</span>int<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> current_p<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                path<span class="token punctuation">.</span>append<span class="token punctuation">(</span>p<span class="token punctuation">)</span>                self<span class="token punctuation">.</span>add_patch<span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span>            self<span class="token punctuation">.</span>_current_state <span class="token operator">=</span> <span class="token string">"add_start"</span>            start <span class="token operator">=</span> <span class="token punctuation">(</span>int<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> self<span class="token punctuation">.</span>start_point<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>add_patch<span class="token punctuation">(</span><span class="token operator">*</span>start<span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"{Fore.BLUE}{Style.BRIGHT}Success!{Style.RESET_ALL}"</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Path:"</span><span class="token punctuation">)</span>        pprint<span class="token punctuation">.</span>pprint<span class="token punctuation">(</span>path<span class="token punctuation">)</span>        <span class="token keyword">return</span> path    <span class="token keyword">def</span> <span class="token function">_get_neighbor</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> point<span class="token punctuation">:</span> str<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">from</span> itertools <span class="token keyword">import</span> product        x<span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token punctuation">[</span>int<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> point<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">]</span>        neighbor <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token keyword">for</span> i<span class="token punctuation">,</span> j <span class="token keyword">in</span> product<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> abs<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> abs<span class="token punctuation">(</span>j<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>                <span class="token keyword">continue</span>            <span class="token keyword">if</span> <span class="token number">0</span> <span class="token operator">&lt;=</span> <span class="token punctuation">(</span>dx <span class="token punctuation">:</span><span class="token operator">=</span> x <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> self<span class="token punctuation">.</span>_mapsize<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">and</span> <span class="token number">0</span> <span class="token operator">&lt;=</span> <span class="token punctuation">(</span>dy <span class="token punctuation">:</span><span class="token operator">=</span> y <span class="token operator">+</span> j<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> self<span class="token punctuation">.</span>_mapsize<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">and</span> \                    self<span class="token punctuation">.</span>map<span class="token punctuation">[</span>dx<span class="token punctuation">,</span> dy<span class="token punctuation">]</span> <span class="token operator">!=</span> np<span class="token punctuation">.</span>inf<span class="token punctuation">:</span>                neighbor<span class="token punctuation">.</span>append<span class="token punctuation">(</span>f<span class="token string">"{dx},{dy}"</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> neighbor    <span class="token keyword">def</span> <span class="token function">_get_cost</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> point1<span class="token punctuation">:</span> str<span class="token punctuation">,</span> point2<span class="token punctuation">:</span> str<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment" spellcheck="true"># x, y = [int(i) for i in point.split(",")]</span>        <span class="token comment" spellcheck="true"># return self.manhattan_distance(*[int(i) for i in point1.split(",")],</span>        <span class="token comment" spellcheck="true">#                                *[int(i) for i in point2.split(",")])</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>euler_distance<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span>int<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> point1<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                                   <span class="token operator">*</span><span class="token punctuation">[</span>int<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> point2<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">_plot4searching</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""Codes for plotting"""</span>        <span class="token comment" spellcheck="true"># update current map</span>        <span class="token comment" spellcheck="true"># explore area</span>        explored_ps <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> p<span class="token punctuation">,</span> parent <span class="token keyword">in</span> self<span class="token punctuation">.</span>came_from<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            pp <span class="token operator">=</span> <span class="token punctuation">[</span>int<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> p<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">]</span>            <span class="token keyword">if</span> parent <span class="token keyword">is</span> <span class="token operator">not</span> None<span class="token punctuation">:</span>                explored_ps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>pp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                explored_ps<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>pp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>map<span class="token punctuation">[</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>explored_ps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">(</span>explored_ps<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>        <span class="token comment" spellcheck="true"># frontier</span>        frontier_ps <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        t <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token keyword">while</span> <span class="token operator">not</span> self<span class="token punctuation">.</span>frontier<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            t<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>frontier<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> t<span class="token punctuation">:</span>            self<span class="token punctuation">.</span>frontier<span class="token punctuation">.</span>put<span class="token punctuation">(</span>i<span class="token punctuation">)</span>        <span class="token keyword">for</span> tt <span class="token keyword">in</span> t<span class="token punctuation">:</span>            <span class="token comment" spellcheck="true"># frontier_ps.append(t.get()[1])</span>            p <span class="token operator">=</span> <span class="token punctuation">[</span>int<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> tt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">]</span>            frontier_ps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>            frontier_ps<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># simply deepcopy locked object will raise an error</span>        <span class="token comment" spellcheck="true"># t = copy.deepcopy(self.frontier)</span>        self<span class="token punctuation">.</span>map<span class="token punctuation">[</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>frontier_ps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>frontier_ps<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>        <span class="token comment" spellcheck="true"># find difference</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_last <span class="token keyword">is</span> None<span class="token punctuation">:</span>            update_explored <span class="token operator">=</span> list<span class="token punctuation">(</span>zip<span class="token punctuation">(</span><span class="token operator">*</span>np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>self<span class="token punctuation">.</span>map <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            update_frontier <span class="token operator">=</span> list<span class="token punctuation">(</span>zip<span class="token punctuation">(</span><span class="token operator">*</span>np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>self<span class="token punctuation">.</span>map <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token comment" spellcheck="true"># update_frontier = [(i,j) for i, j in zip(*update_frontier)]</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            last_explored <span class="token operator">=</span> list<span class="token punctuation">(</span>zip<span class="token punctuation">(</span><span class="token operator">*</span>np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_last <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            last_frontier <span class="token operator">=</span> list<span class="token punctuation">(</span>zip<span class="token punctuation">(</span><span class="token operator">*</span>np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_last <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            current_explored <span class="token operator">=</span> list<span class="token punctuation">(</span>zip<span class="token punctuation">(</span><span class="token operator">*</span>np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>self<span class="token punctuation">.</span>map <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            current_frontier <span class="token operator">=</span> list<span class="token punctuation">(</span>zip<span class="token punctuation">(</span><span class="token operator">*</span>np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>self<span class="token punctuation">.</span>map <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            update_explored <span class="token operator">=</span> list<span class="token punctuation">(</span>set<span class="token punctuation">(</span>current_explored<span class="token punctuation">)</span> <span class="token operator">-</span> set<span class="token punctuation">(</span>last_explored<span class="token punctuation">)</span><span class="token punctuation">)</span>            update_frontier <span class="token operator">=</span> list<span class="token punctuation">(</span>set<span class="token punctuation">(</span>current_frontier<span class="token punctuation">)</span> <span class="token operator">-</span> set<span class="token punctuation">(</span>last_frontier<span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>_last <span class="token operator">=</span> self<span class="token punctuation">.</span>map<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># draw explored area</span>        <span class="token keyword">if</span> len<span class="token punctuation">(</span>update_explored<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>            self<span class="token punctuation">.</span>add_patch<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>i<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> update_explored<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>i<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> update_explored<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                           patches<span class="token operator">=</span><span class="token string">"explored"</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># draw frontier</span>        <span class="token keyword">if</span> len<span class="token punctuation">(</span>update_frontier<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>            self<span class="token punctuation">.</span>add_patch<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>i<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> update_frontier<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>i<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> update_frontier<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                           patches<span class="token operator">=</span><span class="token string">"frontier"</span><span class="token punctuation">)</span>    @staticmethod    <span class="token keyword">def</span> <span class="token function">manhattan_distance</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> abs<span class="token punctuation">(</span>x2 <span class="token operator">-</span> x1<span class="token punctuation">)</span> <span class="token operator">+</span> abs<span class="token punctuation">(</span>y2 <span class="token operator">-</span> y1<span class="token punctuation">)</span>    @staticmethod    <span class="token keyword">def</span> <span class="token function">euler_distance</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>d <span class="token punctuation">:</span><span class="token operator">=</span> abs<span class="token punctuation">(</span>x2 <span class="token operator">-</span> x1<span class="token punctuation">)</span> <span class="token operator">+</span> abs<span class="token punctuation">(</span>y2 <span class="token operator">-</span> y1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token number">1</span>        <span class="token keyword">elif</span> d <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token number">1.4</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> round<span class="token punctuation">(</span>np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token punctuation">(</span>x2 <span class="token operator">-</span> x1<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y2 <span class="token operator">-</span> y1<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ndigits<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-命令行参数解析"><a href="#4-命令行参数解析" class="headerlink" title="4. 命令行参数解析"></a>4. 命令行参数解析</h3><p>命令行参数解析由parse_arg函数负责完成，并返回Namespace对象</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">parse_arg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    parer <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>        description<span class="token operator">=</span>f<span class="token string">"{Fore.GREEN}{Style.BRIGHT}A* Algorithm, animated with matplotlib{Style.RESET_ALL}. "</span>                    f<span class="token string">"Author: {Fore.YELLOW}Jack Wang{Fore.RESET}. "</span>                    f<span class="token string">"Date: {Fore.YELLOW}2021-12-15{Style.RESET_ALL}."</span>                    <span class="token string">"This script provides A* algorithm illustration with the help of matplotlib\n"</span>                    f<span class="token string">"You can use this script either by {Fore.GREEN}command-line interface{Fore.RESET} "</span>                    f<span class="token string">"or {Fore.GREEN}python code interface{Fore.RESET}."</span>                    <span class="token string">"To use this script with command-line interface, call this script with -h option. "</span>                    <span class="token string">"To use this script in python code, "</span>                    <span class="token string">"simply calling Astar class to create an Astar object, then everything will be done. "</span>                    <span class="token string">"If load_path argument of Astar class are not specified (i.e. load_path=None), "</span>                    <span class="token string">"this program will create a blank"</span>                    <span class="token string">"map for you, else loading an existing map."</span>                    <span class="token string">"\n\n"</span>                    <span class="token string">"In the matplotlib GUI, press 1 to add obstacle, 2 to add goal, 3 to add start, w to save map, "</span>                    <span class="token string">"r to random generate obstacles, d to delete an grid and v to start path planning. "</span>                    f<span class="token string">"{Fore.YELLOW}Note: when call with -c, you can not press v to start path planning, -c is only "</span>                    f<span class="token string">"for drawing map. {Style.RESET_ALL}"</span><span class="token punctuation">)</span>    parer<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"-o"</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">"ok"</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">"store_true"</span><span class="token punctuation">,</span> help<span class="token operator">=</span><span class="token string">"must be added when calling the scripts to let me "</span>                                                                  <span class="token string">"know you understand how to use this program"</span><span class="token punctuation">)</span>    parer<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"-c"</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">"gen_map"</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">"store_true"</span><span class="token punctuation">,</span> help<span class="token operator">=</span><span class="token string">"create a new map"</span><span class="token punctuation">)</span>    parer<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"-l"</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">"load_num"</span><span class="token punctuation">,</span> type<span class="token operator">=</span>int<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> help<span class="token operator">=</span><span class="token string">"load a existing map"</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> parer<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-主程序"><a href="#5-主程序" class="headerlink" title="5. 主程序"></a>5. 主程序</h3><p>主程序中若不提供加载的地图路径则默认打开新的地图用于地图绘制</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    args <span class="token operator">=</span> parse_arg<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token operator">not</span> args<span class="token punctuation">.</span>ok<span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"{Fore.RED}Please read the help info with -h option the rerun the scripts with -o option{Fore.RESET}"</span><span class="token punctuation">)</span>        <span class="token keyword">return</span>    <span class="token keyword">if</span> args<span class="token punctuation">.</span>gen_map<span class="token punctuation">:</span>        Astar<span class="token punctuation">(</span>load_path<span class="token operator">=</span>None<span class="token punctuation">)</span>        <span class="token keyword">return</span>    <span class="token keyword">if</span> args<span class="token punctuation">.</span>load_num <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>        Astar<span class="token punctuation">(</span>load_path<span class="token operator">=</span>Path<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">.</span>resolve<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span>f<span class="token string">"map_{args.load_num}.csv"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># a = Astar(load_path=Path("./map_4.csv"))</span>    <span class="token comment" spellcheck="true"># a = Astar(load_path=Path(__file__).resolve().parent.joinpath("./map_1.csv"))</span>    main<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 数据结构与算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> DataStructure </tag>
            
            <tag> 数据结构 </tag>
            
            <tag> GUI </tag>
            
            <tag> A* </tag>
            
            <tag> PathPlanning </tag>
            
            <tag> Matplotlib </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>哈夫曼（Huffman Encoding）压缩算法-Python实现</title>
      <link href="/2021/12/21/ha-fu-man-ya-suo-suan-fa-python-shi-xian/"/>
      <url>/2021/12/21/ha-fu-man-ya-suo-suan-fa-python-shi-xian/</url>
      
        <content type="html"><![CDATA[<blockquote><p>本文主要提供了Python版本的哈夫曼压缩算法实现，并在此基础上提供了命令行和基于Qt的GUI用户界面（User Interface）</p></blockquote><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/all.gif" alt="完整效果"></p><h1 id="哈夫曼（Huffman-Encoding）压缩算法-Python实现"><a href="#哈夫曼（Huffman-Encoding）压缩算法-Python实现" class="headerlink" title="哈夫曼（Huffman Encoding）压缩算法-Python实现"></a>哈夫曼（Huffman Encoding）压缩算法-Python实现</h1><p>哈夫曼编码作为计算机届非常底层的算法，不少领域都会出现该算法的身影，例如在MPEG图片压缩算法中等等。因此掌握哈夫曼算法以及相关的哈弗曼编码、哈弗曼树实现还是比较必要的。</p><h2 id="0-前言"><a href="#0-前言" class="headerlink" title="0. 前言"></a>0. 前言</h2><p>我目前是一个大二的计算机系学生，最近数据结构课程的配套实验要求学生从十四个题中选择四个来做。刚好最近学习了PyQt的相关内容，于是本着学习的目的把我完成的成果记录下来，希望我的这篇博客能够帮助大家学习与理解。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211221220005902.png" alt="数据结构算法实验"></p><h2 id="1-编码"><a href="#1-编码" class="headerlink" title="1. 编码"></a>1. 编码</h2><p>所有的文件，包括MP3音频、MP4视频、PDF文档、乃至于可执行文件（Windows上的.EXE、Linux中的.O等ELF格式文件），对于计算机来说都是二进制数据流，即由0101的比特构成的流（Stream）。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211221222101136.png" alt="计算机底层以二进制形式存储文件"></p><p>然而二进制流对于计算机而言是有意义的，对人而言却没有多大的意义了，因为人看不懂二进制的字节流。于是为了解决这个问题，就出现了编码。所谓<strong>编码即指将信息从一种格式转换为另外一种格式而不改变其内容</strong>，更详细的介绍，参考下面百度百科和维基百科的介绍。</p><blockquote><p><strong>From Wikipedia</strong></p><p>编码是信息从一种形式或格式转换为另一种形式的过程；解码则是编码的逆过程。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211221221212302.png" alt="维基百科上对编码的介绍"></p><p><strong>From BaiduBaike</strong>:</p><p>编码是信息从一种形式或格式转换为另一种形式的过程，也称为计算机编程语言的代码简称编码。用预先规定的方法将文字、数字或其它对象编成数码，或将信息、数据转换成规定的电脉冲信号。编码在电子计算机、电视、遥控和通讯等方面广泛使用。编码是信息从一种形式或格式转换为另一种形式的过程。解码，是编码的逆过程。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211221221358810.png" alt="百度百科上对编码的介绍"></p></blockquote><p>因此，编码其实指的就是转变信息的形式而不改变信息的内容。之所以要进行编码与解码，就是因为对于不同的主体而言，不同编码方式的信息的阅读难度和理解难度不同。例如上面的三国演义，对于我们人而言，文字形式的三国演义易于理解而二进制形式的三国演义更利于计算机理解。</p><p>换个角度，其实语种之间的转换也是一种编码的转换。例如英语对于中文母语的人就不好理解。而翻译也是把信息从一种语言转换为另一种语言，其形式在变，但本质内涵的信息却没有变。<strong>所以究其根本，编码的目的在于方便信息的理解。</strong></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211221230110176.png" alt="英文版的三国演义"></p><p>话说回来，要进行编码，就需要一张编码表。例如学C语言时候的ASCII表。我们通过编码表构建了两种不同编码之间的映射关系，因此单纯的ASCII字符的转换，就是数值的映射关系，从而通过数值-字符的转换，实现了编码与解码。其实从语言的角度来看，语言的编码不仅仅是单词的映射，还涉及语法的转换等等更加复杂的关系。</p><p>然而单纯的使用ASCII编码或者UTF8这种编码方式其实虽然很不错，计算机能够理解，但是他们的问题就是太浪费空间了。例如针对ASCII编码，每一个字符需要8个比特位（0-255）。因此哈夫曼编码除了方便计算机理解以外，更大的好处是能够节约空间。</p><p>说了这么久，总算是说到了哈夫曼编码，哈夫曼编码其实就是一种编码，和ASCII编码在本质上没有区别的。</p><h2 id="2-哈夫曼算法-Huffman-Coding"><a href="#2-哈夫曼算法-Huffman-Coding" class="headerlink" title="2. 哈夫曼算法 / Huffman Coding"></a>2. 哈夫曼算法 / Huffman Coding</h2><p>关于哈夫曼编码和对应的哈夫曼算法就不赘述了，在数据结构的课本上其实讲得非常好也非常的透彻。下面就放一下百度百科和维基百科的介绍</p><blockquote><p><strong>From Wikipedia</strong>：</p><p>霍夫曼编码（英语：Huffman Coding），又译为哈夫曼编码、赫夫曼编码，是一种用于无损数据压缩的熵编码（权编码）算法。由美国计算机科学家大卫·霍夫曼（David Albert Huffman）在1952年发明。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211221231837051.png" alt="维基百科上哈夫曼编码的介绍"></p><p><strong>From BaiduBaike</strong>：</p><p>哈夫曼编码(Huffman Coding)，又称霍夫曼编码，是一种编码方式，哈夫曼编码是可变字长编码(VLC)的一种。Huffman于1952年提出一种编码方法，该方法完全依据字符出现概率来构造异字头的平均长度最短的码字，有时称之为最佳编码，一般就叫做Huffman编码（有时也称为霍夫曼编码）。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211221231927090.png" alt="百度百科上哈夫曼编码的介绍"></p></blockquote><h2 id="3-实现思路"><a href="#3-实现思路" class="headerlink" title="3. 实现思路"></a>3. 实现思路</h2><p>针对不同的功能，整个程序的实现，主要分为三个层面：</p><ol><li><strong>核心层</strong>：负责哈夫曼算法的实现</li><li><strong>数据存取层</strong>：负责任意形式数据的读取、保存</li><li><strong>用户界面层</strong>：负责提供命令行用户界面以及图形用户接口，从而实现<del>高级感</del>（逼格）</li></ol><h3 id="A-核心层"><a href="#A-核心层" class="headerlink" title="A. 核心层"></a>A. 核心层</h3><p>核心层的任务其实就是构建哈弗曼树、得到哈夫曼编码即可，主要算法其实在数据结构课本、B站视频、知乎上都有不少介绍。 </p><p>然而一个重要的问题就是课本上和B站中的不少介绍视频都是针对字符（字母）进行哈夫曼编码的。我们由于要对任意格式的文件进行编码，因此就要从数据的本源：字节，进行哈夫曼编码。因此我们哈弗曼树的叶子节点实际上是字节。我们以8位二进制作为一个单元（Symbol）。然后针对这个Symbol进行编码。因此我们编码的对象就从26个字母变成了256种八位二进制数字。换而言之我们是对0~255这256个数字进行编码。</p><p>然后根据得到的哈夫曼编码将原字节数据一个字节（八位比特）进行编码、转换为哈夫曼编码即可。</p><h3 id="B-数据存取层"><a href="#B-数据存取层" class="headerlink" title="B. 数据存取层"></a>B. 数据存取层</h3><p>在数据存取层，我们假设现在已经对原数据（raw data）构建出了哈弗曼树并且得到了原数据的哈弗曼编码，而且根据这些哈夫曼编码得到了原数据的哈夫曼编码字节流。我们在数据存取层需要做的就是</p><ol><li>保存转换后的新的哈夫曼编码的字节流</li><li>读取原始数据的二进制字节流</li><li>保存哈夫曼编码表</li></ol><p>读取原始数据的二进制字节流其实问题不大，Python中以rb（read byte）模式打开文件即可。而哈夫曼编码表的保存则可以利用Python的Pickle模块将Python中的对象保存到磁盘/从磁盘中加载（我们以字典/映射的形式保存编码表）</p><p>因此数据存取层的关键就在于如何保存编码后的哈夫曼编码字节流？这个问题看似简单，其实有一个问题，就是（二进制）数据在计算机外存（固态、硬盘）中的保存都是整字节整字节的保存的，读取也是整字节整字节读取的。而我们对原文件的二进制流进行哈夫曼编码后实际上其长度是不定的，不一定是整字节的。</p><p>因此保存的时候虽然我们可以强行以整字节整字节的保存编码后的二进制流，但是在最后一位由于不一定是一个整字节，因此实际上存在问题。为了处理这个问题，我们设定一个特殊的字符EOF，由于8位二进制能表示256个数字（Symbol），而这些数字都有可能出现在原字节流中，因此我们是不能直接选取一个数字来表示文件结尾的。为此，在Python中，通过一个特定的类来实现文件结尾的表示，即我们自定义的EOF。在大文件（几MB的文件）中，一共有1024*1024个字节，因此从0~255这256个数字出现的次数一定是远远大于1的，而EOF的出现次数永远为1，因此必然会拥有最长的编码。</p><p>在我们转换完所有的原数据之后，我们把EOF添加到末尾去，并且如果最后不满足8位的话在最后补0。而在读取的时候，我们只需要获取最长长度的编码的长度，然后对最后一个字节做截取即可得到正确的完整的带有EOF的编码的编码后的原数据的哈夫曼编码字节流。</p><h3 id="C-用户界面层"><a href="#C-用户界面层" class="headerlink" title="C. 用户界面层"></a>C. 用户界面层</h3><p>在用户界面层，不关心具体的哈夫曼编码的实现、数据的保存方式等这些具体的细节。相比，用户界面层仅关注如何提供一个用户友好的用户界面。例如在终端（Terminal）提供选项，让用户制定压缩、解压的文件。还会检查用户指定的文件是否存在、查找用户需要解码的文件对应的的哈弗曼编码表的文件位置。</p><p>当然，GUI使用会让程序显得非常高级，因此GUI部分是必须的。而完成GUI程序，则借助Qt来完成，即使用Qt的Python Binding。</p><p>当然，为了便于写代码管理与开发，需要注意GUI的代码要与完成功能的代码在逻辑和形式上分离，因此采取前面所说的分层的思想。</p><p>因此将GUI作为用户界面层的一个组件（另一个组件为终端命令行接口），调用由数据存取层提供的接口函数完成功能。</p><p>在GUI内部，进行在GUI窗口上发生的事件的监听，以及轮转调度、回调函数调用等等功能。</p><h2 id="4-具体代码"><a href="#4-具体代码" class="headerlink" title="4. 具体代码"></a>4. 具体代码</h2><p>本部分根据上面的讲解，对照代码进行详细的介绍。</p><p>项目结构如下</p><pre class="line-numbers language-shell"><code class="language-shell">(base) jack@Alienware:~/projects/data_structure/11_huffman$ tree -L 2.├── ErrorHuffman.py├── huff.py├── resources│&nbsp;&nbsp; ├── 三国演绎.txt│&nbsp;&nbsp; ├── D_Star_illustration.pptx│&nbsp;&nbsp; ├── ICRA2022.pdf│&nbsp;&nbsp; ├── romance_of_three_kingdoms.rar│&nbsp;&nbsp; ├── Song.mp3│&nbsp;&nbsp; ├── str.txt│&nbsp;&nbsp; └── test.mp4├── ui│&nbsp;&nbsp; └── main.ui└── Ui_main.py2 directories, 11 files<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其中：</p><ul><li>resource为项目资源文件夹，主要存放稍后用于验证压缩的资源，包括MP4、txt、MP3、rar、PDF等多种格式文件</li><li>ui为程序图形界面配置文件，负责设定界面大小、按钮位置等配置参数。而UI_main为具体的按钮等控件的实现代码</li><li>huff.py为最终的程序，内含所有完整代码；errHuff.py为先前写错的代码，问题出在了哈夫曼建树的时候得到的不是范式哈弗曼树，因此该程序遍历哈弗树得到哈夫曼编码的时候有问题，最后压缩出来的文件比源文件大了好几倍（反向压缩。。。应了刘某的反向抽烟XXX<span class="github-emoji"><span>😂</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>）</li></ul><h3 id="1-导入库"><a href="#1-导入库" class="headerlink" title="1. 导入库"></a>1. 导入库</h3><p>主要导入的库为命令行参数获取库argparse、Python对象序列化库Pickle、路径处理库pathlib、堆管理库heapq、GUI库PyQt以及为了更好的显示得到的哈夫曼编码表的pandas库与命令行彩色输出的colorama库。</p><p>最后定义了文件的私有变量设定作者和日期，以及将可能存在源代码的文件加入文件搜索路径（类似于Linux环境变量LD_LIBRARY_PATH）</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> sys<span class="token keyword">import</span> pickle<span class="token keyword">import</span> argparse<span class="token keyword">import</span> itertools<span class="token keyword">import</span> collections<span class="token keyword">from</span> pathlib <span class="token keyword">import</span> Path<span class="token keyword">from</span> heapq <span class="token keyword">import</span> heapify<span class="token punctuation">,</span> heappush<span class="token punctuation">,</span> heappop<span class="token keyword">from</span> typing <span class="token keyword">import</span> Union<span class="token punctuation">,</span> Any<span class="token punctuation">,</span> Dict<span class="token punctuation">,</span> List<span class="token punctuation">,</span> Tuple<span class="token keyword">from</span> PyQt5<span class="token punctuation">.</span>QtCore <span class="token keyword">import</span> QDir<span class="token keyword">import</span> pandas<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd<span class="token keyword">from</span> colorama <span class="token keyword">import</span> Fore<span class="token punctuation">,</span> Style<span class="token keyword">from</span> PyQt5<span class="token punctuation">.</span>QtWidgets <span class="token keyword">import</span> <span class="token operator">*</span>__author__ <span class="token operator">=</span> <span class="token string">"Jack Wang"</span>__date__ <span class="token operator">=</span> <span class="token string">"2021/12/19"</span>sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>append<span class="token punctuation">(</span>Path<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">.</span>resolve<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">"./ui"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__str__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-定义EOF符号"><a href="#2-定义EOF符号" class="headerlink" title="2. 定义EOF符号"></a>2. 定义EOF符号</h3><p>EOF符号由于和0-255个数字一样将在构建树的进行比较，因此需要重载如等于（__eq__）、大于(__gt__)、小于(__lt__)等运算符。在Python中重载运算符以魔术方法（double underline）实现。最后由于在序列化以及字典中保存符号-哈夫曼编码键值对的时候，符号作为字典的键需要时可哈希的对象（Hashable），因此重写__hash__方法，以实现作为字典的键。</p><p>注意，上面说过了EOF需要保证编码是最长的，因此当合别人比大的时候总是False，比小的时候总是True，并且只会等于同样是EOF的对象</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">_EOFSymbol</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Notes:        _EOFSymbol 是内置的文件结尾的类，用于在编码的时候标志文件的结尾。        由于在进行哈夫曼树的构建的时候需要选出来权最小的节点，因此需要重写比较的魔术方法。        默认文档结尾是频率最少的字符，因此和任何数字比较    """</span>    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"_EOF"</span>    <span class="token keyword">def</span> <span class="token function">__lt__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">def</span> <span class="token function">__gt__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span>    <span class="token keyword">def</span> <span class="token function">__eq__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__class__ <span class="token operator">==</span> other<span class="token punctuation">.</span>__class__    <span class="token keyword">def</span> <span class="token function">__hash__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> hash<span class="token punctuation">(</span>self<span class="token punctuation">.</span>__class__<span class="token punctuation">)</span>_EOF <span class="token operator">=</span> _EOFSymbol<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-哈夫曼编码"><a href="#3-哈夫曼编码" class="headerlink" title="3. 哈夫曼编码"></a>3. 哈夫曼编码</h3><p>采用工厂模式，实现哈夫曼编码与解码的核心对象为_HuffmanCoder，与用于构建_HuffmanCoder的HuffmanFactory类。</p><p>_HuffmanCoder类负责：</p><ul><li>输出/打印哈夫曼编码表：get_code_table方法、print_code_table方法</li><li>编码、解码字节流序列：_encode_streaming方法、_decode_streaming方法</li><li>为用户界面层提供统一接口：encode方法、decode方法</li><li>保存、加载哈夫曼编码表：save方法、load方法</li></ul><p>其初始化参数负责接受已经获得的编码表和符号的拼接方式以及eof符号定义</p><p>此外save方法通过Python内建的字典将类的元数据保存到字典中，并利用Python的Pickle模块序列化到磁盘上。而load方法则通过类方法，在通过Pickle加载通过save方法保存到磁盘上的数据后显示调用类的初始化方法以实现_HuffmanCoder类的重构。</p><p>此外，在保存的时候需要确保保存的文件的路径存在，因此编写ensure_dir函数，而_guess_concat_function则是为支持多种类型的Symbol（字符串、二进制流（串））在编码、解码时候拼接所写的函数，即根据输入的类型来获得拼接方法的函数。</p><p>HuffmanCoderFactory类负责：</p><ul><li>获得哈夫曼编码表：from_frequencies方法</li><li>创建_HuffmanCoder类：from_sequence方法、from_frequencies方法。</li></ul><p>其中from_frequencies接受符号-频数键值对并构建哈弗曼树、获得哈夫曼编码表；from_sequence负责统计序列中的符号的频数，由于需要对任意的数据进行压缩，因此符号即指一个字节。</p><p>在进行构建的时候，利用优先队列，以出现频率作为优先级进行排列，每次pop都会获得优先队列顶的元素，即出现频率最小的元素。</p><p>而队列中的每个元素，则是一个元组，元祖的第一个元素为权值（频率），<strong>第二个元素为以该节点为祖宗的叶子节点的二进制编码（以数字形式表现）和对应的比特位数（所处的哈弗曼树的层数/深度）对</strong>。使用数字是由于位移操作方便构建哈弗曼编码而记录比特位数则是为了记录开头为0的哈夫曼编码的总位数。</p><p>具体流程为只要队列（森林）中的节点多于1个，则首先弹出权值较小的子树a与权值较大的子树b，将子树a与b的频率相加作为新的子树的频率，而后将子树a的所有的叶子节点的深度+1（比特位数），然后在原二进制编码前加上0（维持不变）。而对子树b，将其所有的叶子节点的二进制编码前加上1（将1左移原有比特位数（原有深度），然后加上当前二进制编码），最后将其深度（比特位数）加1。即使用递归的方式完成哈弗曼树的构建与哈夫曼编码的同步获取。</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">_guess_concat_function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Notes:        To support multiple types of input, e.g., str, bytes, list, there must be a        function that return the needed concat function    Returns:        pass    """</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span>type<span class="token punctuation">(</span>u<span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span> u<span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">,</span> type<span class="token punctuation">(</span>b<span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span> bytes<span class="token punctuation">}</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>type<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">ensure_dir</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> Union<span class="token punctuation">[</span>str<span class="token punctuation">,</span> Path<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Path<span class="token punctuation">:</span>    path<span class="token punctuation">:</span> Path <span class="token operator">=</span> path <span class="token keyword">if</span> isinstance<span class="token punctuation">(</span>path<span class="token punctuation">,</span> Path<span class="token punctuation">)</span> <span class="token keyword">else</span> Path<span class="token punctuation">(</span>path<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token operator">not</span> path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        path<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    <span class="token keyword">assert</span> path<span class="token punctuation">.</span>is_dir<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> path<span class="token keyword">class</span> <span class="token class-name">_HuffmanCoder</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Notes:        _HuffmanCoder, which provide encode, decode, serialize, deserialize, save_code, load_code functionalities.    Args:    """</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> code_table<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span>Any<span class="token punctuation">,</span> Tuple<span class="token punctuation">[</span>int<span class="token punctuation">,</span> int<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> concat<span class="token operator">=</span>list<span class="token punctuation">,</span> check<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> eof<span class="token operator">=</span>_EOF<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        Notes:            initialize method of _HuffmanCoder with given code table        Args:            code_table (Dict[Any, Tuple[int, int]]): code table of all symbols in the encoding sequence, create automatically by                HuffmanCoderFactory, items are Tuple[Symbol, [depth, bit]]            concat: concat method of symbols, will be automatically determined in HuffmanCoderFactory            check: valid code table's format            eof: eof symbol, leave it alone        """</span>        self<span class="token punctuation">.</span>_table <span class="token operator">=</span> code_table        self<span class="token punctuation">.</span>_concat <span class="token operator">=</span> concat        self<span class="token punctuation">.</span>_eof <span class="token operator">=</span> eof        <span class="token keyword">if</span> check<span class="token punctuation">:</span>            <span class="token keyword">assert</span> isinstance<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_table<span class="token punctuation">,</span> dict<span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token string">"{Fore.RED}Code table need to be a dict!{Style.RESET_ALL}"</span>            <span class="token keyword">assert</span> all<span class="token punctuation">(</span>                isinstance<span class="token punctuation">(</span>b<span class="token punctuation">,</span> int<span class="token punctuation">)</span> <span class="token operator">and</span> b <span class="token operator">>=</span> <span class="token number">1</span> <span class="token operator">and</span> isinstance<span class="token punctuation">(</span>v<span class="token punctuation">,</span> int<span class="token punctuation">)</span> <span class="token operator">and</span> v <span class="token operator">>=</span> <span class="token number">0</span> <span class="token keyword">for</span> <span class="token punctuation">(</span>b<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>_table<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token string">"{Fore.RED}Code table internal format Error!{Style.RESET_ALL}"</span>    <span class="token keyword">def</span> <span class="token function">get_code_table</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Dict<span class="token punctuation">[</span>Any<span class="token punctuation">,</span> Tuple<span class="token punctuation">[</span>int<span class="token punctuation">,</span> int<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        Notes:            get_code_table returns code table of input sequence        Returns:            self._table        """</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_table    <span class="token keyword">def</span> <span class="token function">print_code_table</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> pandas<span class="token punctuation">.</span>DataFrame<span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        Notes:            print_code_table is used to print code table        Args:            verbose (bool): if True, then print the table in a pretty format        Returns:            pd.DataFrame        """</span>        pd<span class="token punctuation">.</span>options<span class="token punctuation">.</span>display<span class="token punctuation">.</span>max_rows <span class="token operator">=</span> None        columns <span class="token operator">=</span> list<span class="token punctuation">(</span>zip<span class="token punctuation">(</span><span class="token operator">*</span>list<span class="token punctuation">(</span>zip<span class="token punctuation">(</span><span class="token operator">*</span>itertools<span class="token punctuation">.</span>chain<span class="token punctuation">(</span>            <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"Symbol"</span><span class="token punctuation">,</span> <span class="token string">"Huff Code"</span><span class="token punctuation">,</span> <span class="token string">"BitSize"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>                <span class="token punctuation">(</span>repr<span class="token punctuation">(</span>symbol<span class="token punctuation">)</span><span class="token punctuation">,</span> bin<span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span>bits<span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>bits<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token keyword">for</span> symbol<span class="token punctuation">,</span> <span class="token punctuation">(</span>bits<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>_table<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>columns<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> columns<span class="token operator">=</span>columns<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> verbose<span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span>        <span class="token keyword">return</span> df    <span class="token keyword">def</span> <span class="token function">_encode_streaming</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> raw_sequence<span class="token punctuation">)</span><span class="token punctuation">:</span>        size <span class="token operator">=</span> <span class="token number">0</span>        buffer <span class="token operator">=</span> <span class="token number">0</span>        <span class="token keyword">for</span> s <span class="token keyword">in</span> raw_sequence<span class="token punctuation">:</span>            bits<span class="token punctuation">,</span> values <span class="token operator">=</span> self<span class="token punctuation">.</span>_table<span class="token punctuation">[</span>s<span class="token punctuation">]</span>            buffer <span class="token operator">=</span> <span class="token punctuation">(</span>buffer <span class="token operator">&lt;&lt;</span> bits<span class="token punctuation">)</span> <span class="token operator">+</span> values            size <span class="token operator">+=</span> bits            <span class="token keyword">while</span> size <span class="token operator">>=</span> <span class="token number">8</span><span class="token punctuation">:</span>                byte <span class="token operator">=</span> buffer <span class="token operator">>></span> <span class="token punctuation">(</span>size <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span>                <span class="token keyword">yield</span> byte                buffer <span class="token operator">=</span> buffer <span class="token operator">-</span> <span class="token punctuation">(</span>byte <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>size <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                size <span class="token operator">-=</span> <span class="token number">8</span>        <span class="token keyword">if</span> size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>            bit<span class="token punctuation">,</span> value <span class="token operator">=</span> self<span class="token punctuation">.</span>_table<span class="token punctuation">[</span>self<span class="token punctuation">.</span>_eof<span class="token punctuation">]</span>            buffer <span class="token operator">=</span> <span class="token punctuation">(</span>buffer <span class="token operator">&lt;&lt;</span> bit<span class="token punctuation">)</span> <span class="token operator">+</span> value            size <span class="token operator">+=</span> bit            <span class="token keyword">if</span> size <span class="token operator">></span> <span class="token number">8</span><span class="token punctuation">:</span>                byte <span class="token operator">=</span> buffer <span class="token operator">>></span> <span class="token punctuation">(</span>size <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                byte <span class="token operator">=</span> buffer <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">-</span> size<span class="token punctuation">)</span>            <span class="token keyword">yield</span> byte    <span class="token keyword">def</span> <span class="token function">_decode_streaming</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> encoded_sequence<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment" spellcheck="true"># Reverse lookup table: map (bitsize, value) to symbols</span>        lookup <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">:</span> s <span class="token keyword">for</span> s<span class="token punctuation">,</span> <span class="token punctuation">(</span>b<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>_table<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>        buffer <span class="token operator">=</span> <span class="token number">0</span>        size <span class="token operator">=</span> <span class="token number">0</span>        <span class="token keyword">for</span> byte <span class="token keyword">in</span> encoded_sequence<span class="token punctuation">:</span>            <span class="token keyword">for</span> m <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>                buffer <span class="token operator">=</span> <span class="token punctuation">(</span>buffer <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> bool<span class="token punctuation">(</span>byte <span class="token operator">&amp;</span> m<span class="token punctuation">)</span>                size <span class="token operator">+=</span> <span class="token number">1</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>size<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span> <span class="token keyword">in</span> lookup<span class="token punctuation">:</span>                    symbol <span class="token operator">=</span> lookup<span class="token punctuation">[</span>size<span class="token punctuation">,</span> buffer<span class="token punctuation">]</span>                    <span class="token keyword">if</span> symbol <span class="token operator">==</span> self<span class="token punctuation">.</span>_eof<span class="token punctuation">:</span>                        <span class="token keyword">return</span>                    <span class="token keyword">yield</span> symbol                    buffer <span class="token operator">=</span> <span class="token number">0</span>                    size <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">def</span> <span class="token function">encode</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> raw_seq<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        Notes:            encode is used to encode the sequence that build the huffman tree        Args:            raw_seq: sequence that build the huffman tree        Returns:            bytes        """</span>        <span class="token keyword">return</span> bytes<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_encode_streaming<span class="token punctuation">(</span>raw_seq<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">decode</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> encoded_seq<span class="token punctuation">,</span> concat<span class="token operator">=</span>None<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>concat <span class="token operator">or</span> self<span class="token punctuation">.</span>_concat<span class="token punctuation">)</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_decode_streaming<span class="token punctuation">(</span>encoded_seq<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">save</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">:</span> Union<span class="token punctuation">[</span>str<span class="token punctuation">,</span> Path<span class="token punctuation">]</span><span class="token punctuation">,</span> metadata<span class="token punctuation">:</span> Any <span class="token operator">=</span> None<span class="token punctuation">)</span><span class="token punctuation">:</span>        code_table <span class="token operator">=</span> self<span class="token punctuation">.</span>get_code_table<span class="token punctuation">(</span><span class="token punctuation">)</span>        data <span class="token operator">=</span> <span class="token punctuation">{</span>            <span class="token string">"code_table"</span><span class="token punctuation">:</span> code_table<span class="token punctuation">,</span>            <span class="token string">"type"</span><span class="token punctuation">:</span> type<span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token string">"concat"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_concat<span class="token punctuation">,</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> metadata<span class="token punctuation">:</span>            data<span class="token punctuation">[</span><span class="token string">'metadata'</span><span class="token punctuation">]</span> <span class="token operator">=</span> metadata        path <span class="token operator">=</span> Path<span class="token punctuation">(</span>path<span class="token punctuation">)</span>        ensure_dir<span class="token punctuation">(</span>path<span class="token punctuation">.</span>parent<span class="token punctuation">)</span>        <span class="token keyword">with</span> path<span class="token punctuation">.</span>open<span class="token punctuation">(</span>mode<span class="token operator">=</span><span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>            pickle<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>data<span class="token punctuation">,</span> file<span class="token operator">=</span>f<span class="token punctuation">)</span>    @staticmethod    <span class="token keyword">def</span> <span class="token function">load</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> Union<span class="token punctuation">[</span>str<span class="token punctuation">,</span> Path<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token string">'_HuffmanCoder'</span><span class="token punctuation">:</span>        path <span class="token operator">=</span> Path<span class="token punctuation">(</span>path<span class="token punctuation">)</span>        <span class="token keyword">with</span> path<span class="token punctuation">.</span>open<span class="token punctuation">(</span>mode<span class="token operator">=</span><span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>            data <span class="token operator">=</span> pickle<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>        cls <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span>        <span class="token keyword">assert</span> issubclass<span class="token punctuation">(</span>cls<span class="token punctuation">,</span> _HuffmanCoder<span class="token punctuation">)</span>        code_table <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'code_table'</span><span class="token punctuation">]</span>        <span class="token keyword">return</span> cls<span class="token punctuation">(</span>code_table<span class="token punctuation">,</span> concat<span class="token operator">=</span>data<span class="token punctuation">[</span><span class="token string">'concat'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">HuffmanCoderFactory</span><span class="token punctuation">(</span>_HuffmanCoder<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Notes:        HuffmanCodecFactory is the class that create HuffmanCoder from different type of inputs    Methods:        from_frequencies: create HuffmanCoder from frequency table    """</span>    @classmethod    <span class="token keyword">def</span> <span class="token function">from_frequencies</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> frequencies<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span>Any<span class="token punctuation">,</span> int<span class="token punctuation">]</span><span class="token punctuation">,</span> concat<span class="token operator">=</span>None<span class="token punctuation">,</span> eof<span class="token operator">=</span>_EOF<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        Notes:            from_frequencies creates huffman codec by symbol-frequency table/mapping.        Args:            frequencies (Dict[Any, int]): Symbols and its frequency, symbols can be str, bytes or int, etc.            concat (Union[None]): concat method of symbols, will be determined by the function if argument is not                specified            eof (_EOFSymbol): leave it alone.        Returns:            __HuffmanCoder        Examples:            >>> huf_coder = HuffmanCoderFactory.from_frequencies({"a":29, "b":10, "c": 5})            >>> type(huf_coder)        """</span>        concat_function <span class="token operator">=</span> concat <span class="token keyword">if</span> concat <span class="token keyword">is</span> <span class="token operator">not</span> None <span class="token keyword">else</span> _guess_concat_function<span class="token punctuation">(</span>next<span class="token punctuation">(</span>iter<span class="token punctuation">(</span>frequencies<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># build huffman tree node heap</span>        <span class="token comment" spellcheck="true"># each item: (frequency, [(symbol, (bitsize, value))], value equals which layer of the tree</span>        heap<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span>int<span class="token punctuation">,</span> List<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span>Any<span class="token punctuation">,</span> Tuple<span class="token punctuation">[</span>int<span class="token punctuation">,</span> int<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>freq<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> symbol<span class="token punctuation">,</span> freq <span class="token keyword">in</span>                                                                     frequencies<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>        <span class="token comment" spellcheck="true"># add eof</span>        <span class="token keyword">if</span> eof <span class="token operator">not</span> <span class="token keyword">in</span> frequencies<span class="token punctuation">:</span>            heap<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>eof<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        heapify<span class="token punctuation">(</span>heap<span class="token punctuation">)</span>        <span class="token keyword">while</span> len<span class="token punctuation">(</span>heap<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">:</span>            <span class="token comment" spellcheck="true"># get first 2 min as left and right child tree</span>            a<span class="token punctuation">:</span> Tuple<span class="token punctuation">[</span>int<span class="token punctuation">,</span> List<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span>Any<span class="token punctuation">,</span> Tuple<span class="token punctuation">[</span>int<span class="token punctuation">,</span> int<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> heappop<span class="token punctuation">(</span>heap<span class="token punctuation">)</span>            b<span class="token punctuation">:</span> Tuple<span class="token punctuation">[</span>int<span class="token punctuation">,</span> List<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span>Any<span class="token punctuation">,</span> Tuple<span class="token punctuation">[</span>int<span class="token punctuation">,</span> int<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> heappop<span class="token punctuation">(</span>heap<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true"># merge child to form parent</span>            <span class="token comment" spellcheck="true"># parent frequencies adds together, left child add 0 ahead (do nothing) of previous bits</span>            <span class="token comment" spellcheck="true"># right add 1 ahead of previous bits</span>            merged <span class="token operator">=</span> <span class="token punctuation">(</span>                a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                <span class="token punctuation">[</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">(</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">(</span>n<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">in</span> a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">(</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> n<span class="token punctuation">)</span> <span class="token operator">+</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">(</span>n<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">in</span> b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>            <span class="token punctuation">)</span>            heappush<span class="token punctuation">(</span>heap<span class="token punctuation">,</span> merged<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># code table is root</span>        table <span class="token operator">=</span> dict<span class="token punctuation">(</span>heappop<span class="token punctuation">(</span>heap<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> cls<span class="token punctuation">(</span>table<span class="token punctuation">,</span> concat<span class="token operator">=</span>concat<span class="token punctuation">,</span> check<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> eof<span class="token operator">=</span>eof<span class="token punctuation">)</span>    @classmethod    <span class="token keyword">def</span> <span class="token function">from_sequence</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> sequence<span class="token punctuation">:</span> Union<span class="token punctuation">[</span>List<span class="token punctuation">[</span>Any<span class="token punctuation">]</span><span class="token punctuation">,</span> Tuple<span class="token punctuation">[</span>Any<span class="token punctuation">]</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> bytes<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        Notes:            from_sequence will build a huffman tree from a sequence of symbol        Args:            sequence (Union[List, Tuple][Any]):        Returns:            __HuffmanCoder        Examples:            >>> seq = "a"*100 + "b"*29 + "c"*32            >>> coder = HuffmanCoderFactory.from_sequence(seq)        """</span>        frequencies <span class="token operator">=</span> collections<span class="token punctuation">.</span>Counter<span class="token punctuation">(</span>sequence<span class="token punctuation">)</span>        <span class="token keyword">return</span> cls<span class="token punctuation">.</span>from_frequencies<span class="token punctuation">(</span>frequencies<span class="token punctuation">,</span> concat<span class="token operator">=</span>_guess_concat_function<span class="token punctuation">(</span>sequence<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-哈夫曼编码层接口"><a href="#4-哈夫曼编码层接口" class="headerlink" title="4. 哈夫曼编码层接口"></a>4. 哈夫曼编码层接口</h3><p>为实现GUI与哈弗曼编码解耦，在前面哈夫曼编码的核心类的基础上，编写哈弗曼编码接口函数，完成编码、解码一步到位</p><p>其中：</p><ul><li>encode负责读取文件的二进制流、压缩、输出压缩时的摘要信息</li><li>decode负责读取文件的二进制流、解压、输出解压时的摘要信息</li></ul><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">encode</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> Union<span class="token punctuation">[</span>str<span class="token punctuation">,</span> Path<span class="token punctuation">]</span><span class="token punctuation">,</span> verbose<span class="token punctuation">:</span> bool<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">assert</span> <span class="token punctuation">(</span>path <span class="token punctuation">:</span><span class="token operator">=</span> Path<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token string">"{Fore.RED}{path} not exists!{Style.RESET_ALL}"</span>    <span class="token keyword">with</span> path<span class="token punctuation">.</span>open<span class="token punctuation">(</span>mode<span class="token operator">=</span><span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        content <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>    coder <span class="token operator">=</span> HuffmanCoderFactory<span class="token punctuation">.</span>from_sequence<span class="token punctuation">(</span>content<span class="token punctuation">)</span>    byte <span class="token operator">=</span> coder<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>content<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token punctuation">(</span>out_fd <span class="token punctuation">:</span><span class="token operator">=</span> path<span class="token punctuation">.</span>resolve<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>parent <span class="token operator">/</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>stem <span class="token operator">+</span> <span class="token string">"_huf"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        out_fd<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    <span class="token keyword">with</span> <span class="token punctuation">(</span>main_path <span class="token punctuation">:</span><span class="token operator">=</span> out_fd<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span>path<span class="token punctuation">.</span>stem <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> path<span class="token punctuation">.</span>suffix<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">".huf"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>open<span class="token punctuation">(</span><span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>byte<span class="token punctuation">)</span>    coder<span class="token punctuation">.</span>save<span class="token punctuation">(</span>coder_path <span class="token punctuation">:</span><span class="token operator">=</span> out_fd<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span>path<span class="token punctuation">.</span>stem <span class="token operator">+</span> <span class="token string">"_coder.huf"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    b1 <span class="token operator">=</span> path<span class="token punctuation">.</span>stat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>st_size    b2 <span class="token operator">=</span> main_path<span class="token punctuation">.</span>stat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>st_size    b3 <span class="token operator">=</span> coder_path<span class="token punctuation">.</span>stat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>st_size    summary1<span class="token punctuation">,</span> summary2<span class="token punctuation">,</span> summary3<span class="token punctuation">,</span> summary4 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">4</span>    <span class="token keyword">if</span> verbose<span class="token punctuation">:</span>        summary1 <span class="token operator">=</span> f<span class="token string">"Origin file: {path.stem}{path.suffix}, byte size: {b1}"</span>        summary2 <span class="token operator">=</span> f<span class="token string">"Compressed file: {main_path.stem}{main_path.suffix}, byte size: {b2}"</span>        summary3 <span class="token operator">=</span> f<span class="token string">"HuffCoder file: {coder_path.stem}{coder_path.suffix}, byte size: {b3}"</span>        summary4 <span class="token operator">=</span> f<span class="token string">"{Fore.GREEN}Compression rate {b2}/{b1}={Style.BRIGHT}{round(b2/b1, 4)*100}%{Style.NORMAL}"</span> <span class="token operator">+</span>\                f<span class="token string">", saved {Style.BRIGHT}{b1-b2}{Style.RESET_ALL} bytes"</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>s <span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"Summary"</span><span class="token punctuation">.</span>center<span class="token punctuation">(</span>max<span class="token punctuation">(</span><span class="token punctuation">[</span>len<span class="token punctuation">(</span>summary1<span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>summary2<span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>summary3<span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>summary4<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"="</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">(</span>summary1<span class="token punctuation">,</span> summary2<span class="token punctuation">,</span> summary3<span class="token punctuation">,</span> summary4<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span>len<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> b1<span class="token punctuation">,</span> b2<span class="token punctuation">,</span> b3<span class="token punctuation">,</span> coder<span class="token keyword">def</span> <span class="token function">decode</span><span class="token punctuation">(</span>huf_path<span class="token punctuation">:</span> Union<span class="token punctuation">[</span>Path<span class="token punctuation">,</span> str<span class="token punctuation">]</span><span class="token punctuation">,</span> coder_path<span class="token punctuation">:</span> Union<span class="token punctuation">[</span>Path<span class="token punctuation">,</span> str<span class="token punctuation">]</span><span class="token punctuation">,</span> verbose<span class="token punctuation">:</span> bool<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    huf_path<span class="token punctuation">,</span> coder_path <span class="token operator">=</span> Path<span class="token punctuation">(</span>huf_path<span class="token punctuation">)</span><span class="token punctuation">,</span> Path<span class="token punctuation">(</span>coder_path<span class="token punctuation">)</span>    coder <span class="token operator">=</span> _HuffmanCoder<span class="token punctuation">.</span>load<span class="token punctuation">(</span>coder_path<span class="token punctuation">)</span>    <span class="token keyword">with</span> huf_path<span class="token punctuation">.</span>open<span class="token punctuation">(</span>mode<span class="token operator">=</span><span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        content <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>    decoded <span class="token operator">=</span> coder<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>content<span class="token punctuation">)</span>    <span class="token keyword">with</span> <span class="token punctuation">(</span>dec_path <span class="token punctuation">:</span><span class="token operator">=</span> huf_path<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token punctuation">:</span><span class="token operator">=</span> huf_path<span class="token punctuation">.</span>stem<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> f<span class="token string">"_decode.{s[1]}"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>open<span class="token punctuation">(</span>mode<span class="token operator">=</span><span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>decoded<span class="token punctuation">)</span>        b1 <span class="token operator">=</span> huf_path<span class="token punctuation">.</span>stat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>st_size    b2 <span class="token operator">=</span> coder_path<span class="token punctuation">.</span>stat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>st_size    b3 <span class="token operator">=</span> dec_path<span class="token punctuation">.</span>stat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>st_size    <span class="token keyword">if</span> verbose<span class="token punctuation">:</span>        summary1 <span class="token operator">=</span> f<span class="token string">"Origin file: {huf_path.stem}{huf_path.suffix}, byte size: {b1}"</span>        summary2 <span class="token operator">=</span> f<span class="token string">"Coder file: {coder_path.stem}{coder_path.suffix}, byte size: {b2}"</span>        summary3 <span class="token operator">=</span> f<span class="token string">"Decompressed file: {dec_path.stem}{dec_path.suffix}, byte size: {b3}"</span>        summary4 <span class="token operator">=</span> f<span class="token string">"{Fore.GREEN}Decompression rate {b3}/{b1}={Style.BRIGHT}{round(b3/b1, 4)*100}%{Style.NORMAL}"</span> <span class="token operator">+</span>\                f<span class="token string">", lost {Style.BRIGHT}{b3-b1}{Style.RESET_ALL} bytes"</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>s <span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"Summary"</span><span class="token punctuation">.</span>center<span class="token punctuation">(</span>max<span class="token punctuation">(</span><span class="token punctuation">[</span>len<span class="token punctuation">(</span>summary1<span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>summary2<span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>summary3<span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>summary4<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"="</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">(</span>summary1<span class="token punctuation">,</span> summary2<span class="token punctuation">,</span> summary3<span class="token punctuation">,</span> summary4<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span>len<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> b1<span class="token punctuation">,</span> b2<span class="token punctuation">,</span> b3<span class="token punctuation">,</span> coder<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-用户接口层"><a href="#5-用户接口层" class="headerlink" title="5. 用户接口层"></a>5. 用户接口层</h3><p>用户接口层负责提供命令行用户界面以及GUI用户界面</p><h4 id="A-GUI用户界面"><a href="#A-GUI用户界面" class="headerlink" title="A. GUI用户界面"></a>A. GUI用户界面</h4><p>GUI用户界面由于会接管程序流的控制，因此以类的形式进行封装。</p><p>其中：</p><ul><li>initUI方法负责窗口的UI设计、按钮等控件的信号对应的槽函数（信号处理函数）的绑定</li><li>fileDialog方法负责暂时接管程序流，以GUI的形式帮助用户进行文件的选择，以Dialog的形式暂时接管程序运行</li><li>compress方法作为压缩按钮的槽函数，负责文件的压缩，在进行文件路径检查（文件存在）之后，调用哈夫曼编码层提供的接口函数进行压缩，并将摘要信息输出到程序显示框内</li><li>decompress方法作为解压按钮的槽函数，负责文件的解压，在进行文件路径检查（压缩文件以及哈夫曼编码表文件均存在）之后，调用哈夫曼编码层提供的接口函数进行解压，并将摘要信息输出到程序显示框内</li></ul><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">QtGUIHuff</span><span class="token punctuation">(</span>QMainWindow<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> None<span class="token punctuation">:</span>        super<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>initUI<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">initUI</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">from</span> Ui_main <span class="token keyword">import</span> Ui_Form        self<span class="token punctuation">.</span>ui <span class="token operator">=</span> Ui_Form<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>setupUi<span class="token punctuation">(</span>self<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>setWindowTitle<span class="token punctuation">(</span><span class="token string">"哈夫曼压缩/解压缩程序"</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>compress<span class="token punctuation">.</span>clicked<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>self<span class="token punctuation">.</span>compress<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>decompress<span class="token punctuation">.</span>clicked<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>self<span class="token punctuation">.</span>decompress<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">fileDialog</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        dialog <span class="token operator">=</span> QFileDialog<span class="token punctuation">(</span><span class="token punctuation">)</span>        dialog<span class="token punctuation">.</span>setFileMode<span class="token punctuation">(</span>QFileDialog<span class="token punctuation">.</span>AnyFile<span class="token punctuation">)</span>        dialog<span class="token punctuation">.</span>setFilter<span class="token punctuation">(</span>QDir<span class="token punctuation">.</span>Files<span class="token punctuation">)</span>        <span class="token keyword">if</span> dialog<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            filename <span class="token operator">=</span> dialog<span class="token punctuation">.</span>selectedFiles<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> Path<span class="token punctuation">(</span>filename<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token boolean">False</span>    <span class="token keyword">def</span> <span class="token function">compress</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        f_path <span class="token operator">=</span> self<span class="token punctuation">.</span>fileDialog<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>textEdit<span class="token punctuation">.</span>setReadOnly<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>        s <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"开始压缩"</span><span class="token punctuation">]</span>        self<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>textEdit<span class="token punctuation">.</span>setText<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>        result <span class="token operator">=</span> encode<span class="token punctuation">(</span>f_path<span class="token punctuation">)</span>        summary1 <span class="token operator">=</span> f<span class="token string">"Origin file: {f_path.stem}{f_path.suffix}, byte size: {result[0]}"</span>        summary2 <span class="token operator">=</span> f<span class="token string">"Compressed file:  byte size: {result[1]}"</span>        summary3 <span class="token operator">=</span> f<span class="token string">"HuffCoder file: , byte size: {result[2]}"</span>        summary4 <span class="token operator">=</span> f<span class="token string">"Compression rate {result[1]}/{result[0]}={round(result[1]/result[0], 4)*100}%"</span> <span class="token operator">+</span> \                f<span class="token string">", saved {result[0] - result[1]} bytes"</span>        self<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>textEdit<span class="token punctuation">.</span>setText<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">*</span>s<span class="token punctuation">,</span> summary1<span class="token punctuation">,</span> summary2<span class="token punctuation">,</span> summary3<span class="token punctuation">,</span> summary4<span class="token punctuation">,</span> <span class="token string">"压缩结束"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>textEdit_2<span class="token punctuation">.</span>setText<span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>print_code_table<span class="token punctuation">(</span>verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__str__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">decompress</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        f_path <span class="token operator">=</span> self<span class="token punctuation">.</span>fileDialog<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> f_path<span class="token punctuation">.</span>suffix <span class="token operator">!=</span> <span class="token string">".huf"</span><span class="token punctuation">:</span>            QMessageBox<span class="token punctuation">.</span>warning<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"警告"</span><span class="token punctuation">,</span> <span class="token string">"请选择正确的压缩文件路径"</span><span class="token punctuation">,</span> QMessageBox<span class="token punctuation">.</span>Yes<span class="token punctuation">,</span> QMessageBox<span class="token punctuation">.</span>Yes<span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token boolean">False</span>                <span class="token keyword">if</span> len<span class="token punctuation">(</span>ps <span class="token punctuation">:</span><span class="token operator">=</span> list<span class="token punctuation">(</span>Path<span class="token punctuation">(</span>f_path<span class="token punctuation">)</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">"*.huf"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span>            <span class="token keyword">for</span> p_idx <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">if</span> <span class="token string">"coder"</span> <span class="token keyword">in</span> ps<span class="token punctuation">[</span>p_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>stem<span class="token punctuation">:</span>                    cp_idx <span class="token operator">=</span> p_idx        <span class="token keyword">else</span><span class="token punctuation">:</span>            QMessageBox<span class="token punctuation">.</span>warning<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"警告"</span><span class="token punctuation">,</span> <span class="token string">"缺少必要的解压缩文件"</span><span class="token punctuation">,</span> QMessageBox<span class="token punctuation">.</span>Yes<span class="token punctuation">,</span> QMessageBox<span class="token punctuation">.</span>Yes<span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token boolean">False</span>        s <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"开始解压"</span><span class="token punctuation">]</span>        <span class="token keyword">import</span> time        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>textEdit<span class="token punctuation">.</span>setText<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>        result <span class="token operator">=</span> decode<span class="token punctuation">(</span>huf_path<span class="token punctuation">:</span><span class="token operator">=</span>ps<span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">-</span>cp_idx<span class="token punctuation">]</span><span class="token punctuation">,</span> coder_path<span class="token punctuation">:</span><span class="token operator">=</span>ps<span class="token punctuation">[</span>cp_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>        summary1 <span class="token operator">=</span> f<span class="token string">"Origin file: {huf_path.stem}{huf_path.suffix}, byte size: {result[0]}"</span>        summary2 <span class="token operator">=</span> f<span class="token string">"Coder file: {coder_path.stem}{coder_path.suffix}, byte size: {result[1]}"</span>        summary3 <span class="token operator">=</span> f<span class="token string">"Decompressed file: byte size: {result[2]}"</span>        summary4 <span class="token operator">=</span> f<span class="token string">"Decompression rate {result[2]}/{result[0]}={round(result[2]/result[0], 4)*100}%"</span> <span class="token operator">+</span>\                f<span class="token string">", lost {result[2] - result[0]} bytes"</span>        self<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>textEdit<span class="token punctuation">.</span>setText<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">*</span>s<span class="token punctuation">,</span> summary1<span class="token punctuation">,</span> summary2<span class="token punctuation">,</span> summary3<span class="token punctuation">,</span> summary4<span class="token punctuation">,</span> <span class="token string">"解压结束"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>textEdit_2<span class="token punctuation">.</span>setText<span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>print_code_table<span class="token punctuation">(</span>verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__str__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="B-Terminal用户界面"><a href="#B-Terminal用户界面" class="headerlink" title="B. Terminal用户界面"></a>B. Terminal用户界面</h4><p>Terminal用户界面则是以argparse库中的ArgumentParser对象完成命令行参数的接受，稍后在主程序中配合完成用户界面。设定了-h参数输出帮助信息、-s对指定路径的文件进行压缩、-t对指定路径的文件进行解压、-g以GUI用户界面运行程序，-v将压缩/解压摘要输出到命令行窗口</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">parse_args</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> argparse<span class="token punctuation">.</span>Namespace<span class="token punctuation">:</span>    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>        description<span class="token operator">=</span><span class="token string">"哈夫曼压缩算法Python实现，可以对任意文件进行压缩，提供命令行以及GUI用户界面。作者：Jack Wang"</span>    <span class="token punctuation">)</span>    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"-s"</span><span class="token punctuation">,</span> <span class="token string">"--src"</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">"src_path"</span><span class="token punctuation">,</span> type<span class="token operator">=</span>str<span class="token punctuation">,</span> default<span class="token operator">=</span>None<span class="token punctuation">,</span> help<span class="token operator">=</span><span class="token string">"需要压缩的文件路径"</span><span class="token punctuation">)</span>    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"-t"</span><span class="token punctuation">,</span> <span class="token string">"--target"</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">"target_path"</span><span class="token punctuation">,</span> type<span class="token operator">=</span>str<span class="token punctuation">,</span> default<span class="token operator">=</span>None<span class="token punctuation">,</span> help<span class="token operator">=</span><span class="token string">"需要解压文件所在的文件夹的路径"</span><span class="token punctuation">)</span>    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"-v"</span><span class="token punctuation">,</span> <span class="token string">"--verbose"</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">"v"</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">"store_true"</span><span class="token punctuation">,</span> help<span class="token operator">=</span><span class="token string">"是否显示压缩的摘要信息"</span><span class="token punctuation">)</span>    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"-g"</span><span class="token punctuation">,</span> <span class="token string">"--gui"</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">"gui"</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">"store_true"</span><span class="token punctuation">,</span> help<span class="token operator">=</span><span class="token string">"是否以GUI方式显示"</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="6-主程序"><a href="#6-主程序" class="headerlink" title="6. 主程序"></a>6. 主程序</h3><p>主程序很简单，根据接受的命令行参数调用不同的接口即可</p><p>在非图形界面的运行的时候，程序的主控制流以程序为主，而以GUI方式运行的时候，程序的控制流则在Qt框架下，用户级线程调度、事件监听、信号分发、槽函数（信号处理函数）唤醒等均由框架负责。</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token punctuation">:</span> argparse<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token operator">not</span> args<span class="token punctuation">.</span>gui<span class="token punctuation">:</span>        <span class="token keyword">assert</span> <span class="token number">0</span> <span class="token operator">&lt;</span> int<span class="token punctuation">(</span>args<span class="token punctuation">.</span>src_path <span class="token keyword">is</span> <span class="token operator">not</span> None<span class="token punctuation">)</span> <span class="token operator">+</span> int<span class="token punctuation">(</span>args<span class="token punctuation">.</span>target_path <span class="token keyword">is</span> <span class="token operator">not</span> None<span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token string">"{Fore.RED}请选择压缩或者解压，使用-h查询用法{Style.RESET_ALL}"</span>    <span class="token keyword">if</span> <span class="token operator">not</span> args<span class="token punctuation">.</span>gui<span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"{Fore.GREEN}命令行工作模式{Style.RESET_ALL}"</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> args<span class="token punctuation">.</span>src_path <span class="token keyword">is</span> <span class="token operator">not</span> None<span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"开始压缩 {args.src_path}"</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> args<span class="token punctuation">.</span>v<span class="token punctuation">:</span>                <span class="token keyword">print</span><span class="token punctuation">(</span>encode<span class="token punctuation">(</span>Path<span class="token punctuation">(</span>args<span class="token punctuation">.</span>src_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>print_code_table<span class="token punctuation">(</span>verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                encode<span class="token punctuation">(</span>Path<span class="token punctuation">(</span>args<span class="token punctuation">.</span>src_path<span class="token punctuation">)</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"压缩完成"</span><span class="token punctuation">)</span>        <span class="token keyword">elif</span> args<span class="token punctuation">.</span>target_path <span class="token keyword">is</span> <span class="token operator">not</span> None<span class="token punctuation">:</span>            <span class="token keyword">if</span> len<span class="token punctuation">(</span>ps <span class="token punctuation">:</span><span class="token operator">=</span> list<span class="token punctuation">(</span>Path<span class="token punctuation">(</span>args<span class="token punctuation">.</span>target_path<span class="token punctuation">)</span><span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">"*.huf"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>                <span class="token keyword">print</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span>                <span class="token keyword">for</span> p_idx <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                    <span class="token keyword">if</span> <span class="token string">"coder"</span> <span class="token keyword">in</span> ps<span class="token punctuation">[</span>p_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>stem<span class="token punctuation">:</span>                        cp_idx <span class="token operator">=</span> p_idx            <span class="token keyword">else</span><span class="token punctuation">:</span>                <span class="token keyword">assert</span> <span class="token boolean">False</span><span class="token punctuation">,</span> f<span class="token string">"{Fore.RED}无效的路径，没有找到压缩文件{Style.RESET_ALL}"</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"开始解压 {args.target_path}"</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> args<span class="token punctuation">.</span>v<span class="token punctuation">:</span>                <span class="token keyword">print</span><span class="token punctuation">(</span>decode<span class="token punctuation">(</span>huf_path<span class="token operator">=</span>ps<span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">-</span>cp_idx<span class="token punctuation">]</span><span class="token punctuation">,</span> coder_path<span class="token operator">=</span>ps<span class="token punctuation">[</span>cp_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>print_code_table<span class="token punctuation">(</span>verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                decode<span class="token punctuation">(</span>huf_path<span class="token operator">=</span>ps<span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">-</span>cp_idx<span class="token punctuation">]</span><span class="token punctuation">,</span> coder_path<span class="token operator">=</span>ps<span class="token punctuation">[</span>cp_idx<span class="token punctuation">]</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"解压完成"</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        app <span class="token operator">=</span> QApplication<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span>        m <span class="token operator">=</span> QtGUIHuff<span class="token punctuation">(</span><span class="token punctuation">)</span>        m<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>app<span class="token punctuation">.</span>exec_<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    main<span class="token punctuation">(</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5-运行实例"><a href="#5-运行实例" class="headerlink" title="5. 运行实例"></a>5. 运行实例</h2><h3 id="A-GIF版演示"><a href="#A-GIF版演示" class="headerlink" title="A. GIF版演示"></a>A. GIF版演示</h3><p> 这里先放一个gif图片（比较大，44兆，不知道能不能加载出来），高清版本去下面的B站视频里看看</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/%E5%93%88%E5%A4%AB%E6%9B%BC%E7%AE%97%E6%B3%95%E5%8E%8B%E7%BC%A9%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E6%BC%94%E7%A4%BA.gif"></p><h3 id="B-B站高清版"><a href="#B-B站高清版" class="headerlink" title="B. B站高清版"></a>B. B站高清版</h3><p><a href="https://www.bilibili.com/video/BV1cL41177zL/">视频链接</a>：<a href="https://www.bilibili.com/video/BV1cL41177zL/">https://www.bilibili.com/video/BV1cL41177zL/</a></p><iframe src="//player.bilibili.com/player.html?aid=465019836&amp;bvid=BV1cL41177zL&amp;cid=465905780&amp;page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe><h2 id="6-完整代码"><a href="#6-完整代码" class="headerlink" title="6. 完整代码"></a>6. 完整代码</h2><p>完整代码如下</p><h3 id="A-huff-py"><a href="#A-huff-py" class="headerlink" title="A. huff.py"></a>A. huff.py</h3><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> sys<span class="token keyword">import</span> pickle<span class="token keyword">import</span> argparse<span class="token keyword">import</span> itertools<span class="token keyword">import</span> collections<span class="token keyword">from</span> pathlib <span class="token keyword">import</span> Path<span class="token keyword">from</span> heapq <span class="token keyword">import</span> heapify<span class="token punctuation">,</span> heappush<span class="token punctuation">,</span> heappop<span class="token keyword">from</span> typing <span class="token keyword">import</span> Union<span class="token punctuation">,</span> Any<span class="token punctuation">,</span> Dict<span class="token punctuation">,</span> List<span class="token punctuation">,</span> Tuple<span class="token keyword">from</span> PyQt5<span class="token punctuation">.</span>QtCore <span class="token keyword">import</span> QDir<span class="token keyword">import</span> pandas<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd<span class="token keyword">from</span> colorama <span class="token keyword">import</span> Fore<span class="token punctuation">,</span> Style<span class="token keyword">from</span> PyQt5<span class="token punctuation">.</span>QtWidgets <span class="token keyword">import</span> <span class="token operator">*</span>__author__ <span class="token operator">=</span> <span class="token string">"Jack Wang"</span>__date__ <span class="token operator">=</span> <span class="token string">"2021/12/19"</span>sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>append<span class="token punctuation">(</span>Path<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">.</span>resolve<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">"./ui"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__str__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">_EOFSymbol</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Notes:        _EOFSymbol 是内置的文件结尾的类，用于在编码的时候标志文件的结尾。        由于在进行哈夫曼树的构建的时候需要选出来权最小的节点，因此需要重写比较的魔术方法。        默认文档结尾是频率最少的字符，因此和任何数字比较    """</span>    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"_EOF"</span>    <span class="token keyword">def</span> <span class="token function">__lt__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">def</span> <span class="token function">__gt__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span>    <span class="token keyword">def</span> <span class="token function">__eq__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__class__ <span class="token operator">==</span> other<span class="token punctuation">.</span>__class__    <span class="token keyword">def</span> <span class="token function">__hash__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> hash<span class="token punctuation">(</span>self<span class="token punctuation">.</span>__class__<span class="token punctuation">)</span>_EOF <span class="token operator">=</span> _EOFSymbol<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">_guess_concat_function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Notes:        To support multiple types of input, e.g., str, bytes, list, there must be a        function that return the needed concat function    Returns:        pass    """</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span>type<span class="token punctuation">(</span>u<span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span> u<span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">,</span> type<span class="token punctuation">(</span>b<span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span> bytes<span class="token punctuation">}</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>type<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">ensure_dir</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> Union<span class="token punctuation">[</span>str<span class="token punctuation">,</span> Path<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Path<span class="token punctuation">:</span>    path<span class="token punctuation">:</span> Path <span class="token operator">=</span> path <span class="token keyword">if</span> isinstance<span class="token punctuation">(</span>path<span class="token punctuation">,</span> Path<span class="token punctuation">)</span> <span class="token keyword">else</span> Path<span class="token punctuation">(</span>path<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token operator">not</span> path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        path<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    <span class="token keyword">assert</span> path<span class="token punctuation">.</span>is_dir<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> path<span class="token keyword">class</span> <span class="token class-name">_HuffmanCoder</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Notes:        _HuffmanCoder, which provide encode, decode, serialize, deserialize, save_code, load_code functionalities.    Args:    """</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> code_table<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span>Any<span class="token punctuation">,</span> Tuple<span class="token punctuation">[</span>int<span class="token punctuation">,</span> int<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> concat<span class="token operator">=</span>list<span class="token punctuation">,</span> check<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> eof<span class="token operator">=</span>_EOF<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        Notes:            initialize method of _HuffmanCoder with given code table        Args:            code_table (Dict[Any, Tuple[int, int]]): code table of all symbols in the encoding sequence, create automatically by                HuffmanCoderFactory, items are Tuple[Symbol, [depth, bit]]            concat: concat method of symbols, will be automatically determined in HuffmanCoderFactory            check: valid code table's format            eof: eof symbol, leave it alone        """</span>        self<span class="token punctuation">.</span>_table <span class="token operator">=</span> code_table        self<span class="token punctuation">.</span>_concat <span class="token operator">=</span> concat        self<span class="token punctuation">.</span>_eof <span class="token operator">=</span> eof        <span class="token keyword">if</span> check<span class="token punctuation">:</span>            <span class="token keyword">assert</span> isinstance<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_table<span class="token punctuation">,</span> dict<span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token string">"{Fore.RED}Code table need to be a dict!{Style.RESET_ALL}"</span>            <span class="token keyword">assert</span> all<span class="token punctuation">(</span>                isinstance<span class="token punctuation">(</span>b<span class="token punctuation">,</span> int<span class="token punctuation">)</span> <span class="token operator">and</span> b <span class="token operator">>=</span> <span class="token number">1</span> <span class="token operator">and</span> isinstance<span class="token punctuation">(</span>v<span class="token punctuation">,</span> int<span class="token punctuation">)</span> <span class="token operator">and</span> v <span class="token operator">>=</span> <span class="token number">0</span> <span class="token keyword">for</span> <span class="token punctuation">(</span>b<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>_table<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token string">"{Fore.RED}Code table internal format Error!{Style.RESET_ALL}"</span>    <span class="token keyword">def</span> <span class="token function">get_code_table</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Dict<span class="token punctuation">[</span>Any<span class="token punctuation">,</span> Tuple<span class="token punctuation">[</span>int<span class="token punctuation">,</span> int<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        Notes:            get_code_table returns code table of input sequence        Returns:            self._table        """</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_table    <span class="token keyword">def</span> <span class="token function">print_code_table</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> pandas<span class="token punctuation">.</span>DataFrame<span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        Notes:            print_code_table is used to print code table        Args:            verbose (bool): if True, then print the table in a pretty format        Returns:            pd.DataFrame        """</span>        pd<span class="token punctuation">.</span>options<span class="token punctuation">.</span>display<span class="token punctuation">.</span>max_rows <span class="token operator">=</span> None        columns <span class="token operator">=</span> list<span class="token punctuation">(</span>zip<span class="token punctuation">(</span><span class="token operator">*</span>list<span class="token punctuation">(</span>zip<span class="token punctuation">(</span><span class="token operator">*</span>itertools<span class="token punctuation">.</span>chain<span class="token punctuation">(</span>            <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"Symbol"</span><span class="token punctuation">,</span> <span class="token string">"Huff Code"</span><span class="token punctuation">,</span> <span class="token string">"BitSize"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>                <span class="token punctuation">(</span>repr<span class="token punctuation">(</span>symbol<span class="token punctuation">)</span><span class="token punctuation">,</span> bin<span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span>bits<span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>bits<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token keyword">for</span> symbol<span class="token punctuation">,</span> <span class="token punctuation">(</span>bits<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>_table<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>columns<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> columns<span class="token operator">=</span>columns<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> verbose<span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span>        <span class="token keyword">return</span> df    <span class="token keyword">def</span> <span class="token function">_encode_streaming</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> raw_sequence<span class="token punctuation">)</span><span class="token punctuation">:</span>        size <span class="token operator">=</span> <span class="token number">0</span>        buffer <span class="token operator">=</span> <span class="token number">0</span>        <span class="token keyword">for</span> s <span class="token keyword">in</span> raw_sequence<span class="token punctuation">:</span>            bits<span class="token punctuation">,</span> values <span class="token operator">=</span> self<span class="token punctuation">.</span>_table<span class="token punctuation">[</span>s<span class="token punctuation">]</span>            buffer <span class="token operator">=</span> <span class="token punctuation">(</span>buffer <span class="token operator">&lt;&lt;</span> bits<span class="token punctuation">)</span> <span class="token operator">+</span> values            size <span class="token operator">+=</span> bits            <span class="token keyword">while</span> size <span class="token operator">>=</span> <span class="token number">8</span><span class="token punctuation">:</span>                byte <span class="token operator">=</span> buffer <span class="token operator">>></span> <span class="token punctuation">(</span>size <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span>                <span class="token keyword">yield</span> byte                buffer <span class="token operator">=</span> buffer <span class="token operator">-</span> <span class="token punctuation">(</span>byte <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>size <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                size <span class="token operator">-=</span> <span class="token number">8</span>        <span class="token keyword">if</span> size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>            bit<span class="token punctuation">,</span> value <span class="token operator">=</span> self<span class="token punctuation">.</span>_table<span class="token punctuation">[</span>self<span class="token punctuation">.</span>_eof<span class="token punctuation">]</span>            buffer <span class="token operator">=</span> <span class="token punctuation">(</span>buffer <span class="token operator">&lt;&lt;</span> bit<span class="token punctuation">)</span> <span class="token operator">+</span> value            size <span class="token operator">+=</span> bit            <span class="token keyword">if</span> size <span class="token operator">></span> <span class="token number">8</span><span class="token punctuation">:</span>                byte <span class="token operator">=</span> buffer <span class="token operator">>></span> <span class="token punctuation">(</span>size <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                byte <span class="token operator">=</span> buffer <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">-</span> size<span class="token punctuation">)</span>            <span class="token keyword">yield</span> byte    <span class="token keyword">def</span> <span class="token function">_decode_streaming</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> encoded_sequence<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment" spellcheck="true"># Reverse lookup table: map (bitsize, value) to symbols</span>        lookup <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">:</span> s <span class="token keyword">for</span> s<span class="token punctuation">,</span> <span class="token punctuation">(</span>b<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>_table<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>        buffer <span class="token operator">=</span> <span class="token number">0</span>        size <span class="token operator">=</span> <span class="token number">0</span>        <span class="token keyword">for</span> byte <span class="token keyword">in</span> encoded_sequence<span class="token punctuation">:</span>            <span class="token keyword">for</span> m <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>                buffer <span class="token operator">=</span> <span class="token punctuation">(</span>buffer <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> bool<span class="token punctuation">(</span>byte <span class="token operator">&amp;</span> m<span class="token punctuation">)</span>                size <span class="token operator">+=</span> <span class="token number">1</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>size<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span> <span class="token keyword">in</span> lookup<span class="token punctuation">:</span>                    symbol <span class="token operator">=</span> lookup<span class="token punctuation">[</span>size<span class="token punctuation">,</span> buffer<span class="token punctuation">]</span>                    <span class="token keyword">if</span> symbol <span class="token operator">==</span> self<span class="token punctuation">.</span>_eof<span class="token punctuation">:</span>                        <span class="token keyword">return</span>                    <span class="token keyword">yield</span> symbol                    buffer <span class="token operator">=</span> <span class="token number">0</span>                    size <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">def</span> <span class="token function">encode</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> raw_seq<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        Notes:            encode is used to encode the sequence that build the huffman tree        Args:            raw_seq: sequence that build the huffman tree        Returns:            bytes        """</span>        <span class="token keyword">return</span> bytes<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_encode_streaming<span class="token punctuation">(</span>raw_seq<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">decode</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> encoded_seq<span class="token punctuation">,</span> concat<span class="token operator">=</span>None<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>concat <span class="token operator">or</span> self<span class="token punctuation">.</span>_concat<span class="token punctuation">)</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_decode_streaming<span class="token punctuation">(</span>encoded_seq<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">save</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">:</span> Union<span class="token punctuation">[</span>str<span class="token punctuation">,</span> Path<span class="token punctuation">]</span><span class="token punctuation">,</span> metadata<span class="token punctuation">:</span> Any <span class="token operator">=</span> None<span class="token punctuation">)</span><span class="token punctuation">:</span>        code_table <span class="token operator">=</span> self<span class="token punctuation">.</span>get_code_table<span class="token punctuation">(</span><span class="token punctuation">)</span>        data <span class="token operator">=</span> <span class="token punctuation">{</span>            <span class="token string">"code_table"</span><span class="token punctuation">:</span> code_table<span class="token punctuation">,</span>            <span class="token string">"type"</span><span class="token punctuation">:</span> type<span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token string">"concat"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_concat<span class="token punctuation">,</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> metadata<span class="token punctuation">:</span>            data<span class="token punctuation">[</span><span class="token string">'metadata'</span><span class="token punctuation">]</span> <span class="token operator">=</span> metadata        path <span class="token operator">=</span> Path<span class="token punctuation">(</span>path<span class="token punctuation">)</span>        ensure_dir<span class="token punctuation">(</span>path<span class="token punctuation">.</span>parent<span class="token punctuation">)</span>        <span class="token keyword">with</span> path<span class="token punctuation">.</span>open<span class="token punctuation">(</span>mode<span class="token operator">=</span><span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>            pickle<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>data<span class="token punctuation">,</span> file<span class="token operator">=</span>f<span class="token punctuation">)</span>    @staticmethod    <span class="token keyword">def</span> <span class="token function">load</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> Union<span class="token punctuation">[</span>str<span class="token punctuation">,</span> Path<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token string">'_HuffmanCoder'</span><span class="token punctuation">:</span>        path <span class="token operator">=</span> Path<span class="token punctuation">(</span>path<span class="token punctuation">)</span>        <span class="token keyword">with</span> path<span class="token punctuation">.</span>open<span class="token punctuation">(</span>mode<span class="token operator">=</span><span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>            data <span class="token operator">=</span> pickle<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>        cls <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span>        <span class="token keyword">assert</span> issubclass<span class="token punctuation">(</span>cls<span class="token punctuation">,</span> _HuffmanCoder<span class="token punctuation">)</span>        code_table <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'code_table'</span><span class="token punctuation">]</span>        <span class="token keyword">return</span> cls<span class="token punctuation">(</span>code_table<span class="token punctuation">,</span> concat<span class="token operator">=</span>data<span class="token punctuation">[</span><span class="token string">'concat'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">HuffmanCoderFactory</span><span class="token punctuation">(</span>_HuffmanCoder<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Notes:        HuffmanCodecFactory is the class that create HuffmanCoder from different type of inputs    Methods:        from_frequencies: create HuffmanCoder from frequency table    """</span>    @classmethod    <span class="token keyword">def</span> <span class="token function">from_frequencies</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> frequencies<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span>Any<span class="token punctuation">,</span> int<span class="token punctuation">]</span><span class="token punctuation">,</span> concat<span class="token operator">=</span>None<span class="token punctuation">,</span> eof<span class="token operator">=</span>_EOF<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        Notes:            from_frequencies creates huffman codec by symbol-frequency table/mapping.        Args:            frequencies (Dict[Any, int]): Symbols and its frequency, symbols can be str, bytes or int, etc.            concat (Union[None]): concat method of symbols, will be determined by the function if argument is not                specified            eof (_EOFSymbol): leave it alone.        Returns:            __HuffmanCoder        Examples:            >>> huf_coder = HuffmanCoderFactory.from_frequencies({"a":29, "b":10, "c": 5})            >>> type(huf_coder)        """</span>        concat_function <span class="token operator">=</span> concat <span class="token keyword">if</span> concat <span class="token keyword">is</span> <span class="token operator">not</span> None <span class="token keyword">else</span> _guess_concat_function<span class="token punctuation">(</span>next<span class="token punctuation">(</span>iter<span class="token punctuation">(</span>frequencies<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># build huffman tree node heap</span>        <span class="token comment" spellcheck="true"># each item: (frequency, [(symbol, (bitsize, value))], value equals which layer of the tree</span>        heap<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span>int<span class="token punctuation">,</span> List<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span>Any<span class="token punctuation">,</span> Tuple<span class="token punctuation">[</span>int<span class="token punctuation">,</span> int<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>freq<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> symbol<span class="token punctuation">,</span> freq <span class="token keyword">in</span>                                                                     frequencies<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>        <span class="token comment" spellcheck="true"># add eof</span>        <span class="token keyword">if</span> eof <span class="token operator">not</span> <span class="token keyword">in</span> frequencies<span class="token punctuation">:</span>            heap<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>eof<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        heapify<span class="token punctuation">(</span>heap<span class="token punctuation">)</span>        <span class="token keyword">while</span> len<span class="token punctuation">(</span>heap<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">:</span>            <span class="token comment" spellcheck="true"># get first 2 min as left and right child tree</span>            a<span class="token punctuation">:</span> Tuple<span class="token punctuation">[</span>int<span class="token punctuation">,</span> List<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span>Any<span class="token punctuation">,</span> Tuple<span class="token punctuation">[</span>int<span class="token punctuation">,</span> int<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> heappop<span class="token punctuation">(</span>heap<span class="token punctuation">)</span>            b<span class="token punctuation">:</span> Tuple<span class="token punctuation">[</span>int<span class="token punctuation">,</span> List<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span>Any<span class="token punctuation">,</span> Tuple<span class="token punctuation">[</span>int<span class="token punctuation">,</span> int<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> heappop<span class="token punctuation">(</span>heap<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true"># merge child to form parent</span>            <span class="token comment" spellcheck="true"># parent frequencies adds together, left child add 0 ahead (do nothing) of previous bits</span>            <span class="token comment" spellcheck="true"># right add 1 ahead of previous bits</span>            merged <span class="token operator">=</span> <span class="token punctuation">(</span>                a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                <span class="token punctuation">[</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">(</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">(</span>n<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">in</span> a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">(</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> n<span class="token punctuation">)</span> <span class="token operator">+</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">(</span>n<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">in</span> b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>            <span class="token punctuation">)</span>            heappush<span class="token punctuation">(</span>heap<span class="token punctuation">,</span> merged<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># code table is root</span>        table <span class="token operator">=</span> dict<span class="token punctuation">(</span>heappop<span class="token punctuation">(</span>heap<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> cls<span class="token punctuation">(</span>table<span class="token punctuation">,</span> concat<span class="token operator">=</span>concat<span class="token punctuation">,</span> check<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> eof<span class="token operator">=</span>eof<span class="token punctuation">)</span>    @classmethod    <span class="token keyword">def</span> <span class="token function">from_sequence</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> sequence<span class="token punctuation">:</span> Union<span class="token punctuation">[</span>List<span class="token punctuation">[</span>Any<span class="token punctuation">]</span><span class="token punctuation">,</span> Tuple<span class="token punctuation">[</span>Any<span class="token punctuation">]</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> bytes<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        Notes:            from_sequence will build a huffman tree from a sequence of symbol        Args:            sequence (Union[List, Tuple][Any]):        Returns:            __HuffmanCoder        Examples:            >>> seq = "a"*100 + "b"*29 + "c"*32            >>> coder = HuffmanCoderFactory.from_sequence(seq)        """</span>        frequencies <span class="token operator">=</span> collections<span class="token punctuation">.</span>Counter<span class="token punctuation">(</span>sequence<span class="token punctuation">)</span>        <span class="token keyword">return</span> cls<span class="token punctuation">.</span>from_frequencies<span class="token punctuation">(</span>frequencies<span class="token punctuation">,</span> concat<span class="token operator">=</span>_guess_concat_function<span class="token punctuation">(</span>sequence<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">encode</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> Union<span class="token punctuation">[</span>str<span class="token punctuation">,</span> Path<span class="token punctuation">]</span><span class="token punctuation">,</span> verbose<span class="token punctuation">:</span> bool<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">assert</span> <span class="token punctuation">(</span>path <span class="token punctuation">:</span><span class="token operator">=</span> Path<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token string">"{Fore.RED}{path} not exists!{Style.RESET_ALL}"</span>    <span class="token keyword">with</span> path<span class="token punctuation">.</span>open<span class="token punctuation">(</span>mode<span class="token operator">=</span><span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        content <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>    coder <span class="token operator">=</span> HuffmanCoderFactory<span class="token punctuation">.</span>from_sequence<span class="token punctuation">(</span>content<span class="token punctuation">)</span>    byte <span class="token operator">=</span> coder<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>content<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token punctuation">(</span>out_fd <span class="token punctuation">:</span><span class="token operator">=</span> path<span class="token punctuation">.</span>resolve<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>parent <span class="token operator">/</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>stem <span class="token operator">+</span> <span class="token string">"_huf"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        out_fd<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    <span class="token keyword">with</span> <span class="token punctuation">(</span>main_path <span class="token punctuation">:</span><span class="token operator">=</span> out_fd<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span>path<span class="token punctuation">.</span>stem <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> path<span class="token punctuation">.</span>suffix<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">".huf"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>open<span class="token punctuation">(</span><span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>byte<span class="token punctuation">)</span>    coder<span class="token punctuation">.</span>save<span class="token punctuation">(</span>coder_path <span class="token punctuation">:</span><span class="token operator">=</span> out_fd<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span>path<span class="token punctuation">.</span>stem <span class="token operator">+</span> <span class="token string">"_coder.huf"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    b1 <span class="token operator">=</span> path<span class="token punctuation">.</span>stat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>st_size    b2 <span class="token operator">=</span> main_path<span class="token punctuation">.</span>stat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>st_size    b3 <span class="token operator">=</span> coder_path<span class="token punctuation">.</span>stat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>st_size    summary1<span class="token punctuation">,</span> summary2<span class="token punctuation">,</span> summary3<span class="token punctuation">,</span> summary4 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">4</span>    <span class="token keyword">if</span> verbose<span class="token punctuation">:</span>        summary1 <span class="token operator">=</span> f<span class="token string">"Origin file: {path.stem}{path.suffix}, byte size: {b1}"</span>        summary2 <span class="token operator">=</span> f<span class="token string">"Compressed file: {main_path.stem}{main_path.suffix}, byte size: {b2}"</span>        summary3 <span class="token operator">=</span> f<span class="token string">"HuffCoder file: {coder_path.stem}{coder_path.suffix}, byte size: {b3}"</span>        summary4 <span class="token operator">=</span> f<span class="token string">"{Fore.GREEN}Compression rate {b2}/{b1}={Style.BRIGHT}{round(b2/b1, 4)*100}%{Style.NORMAL}"</span> <span class="token operator">+</span>\                f<span class="token string">", saved {Style.BRIGHT}{b1-b2}{Style.RESET_ALL} bytes"</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>s <span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"Summary"</span><span class="token punctuation">.</span>center<span class="token punctuation">(</span>max<span class="token punctuation">(</span><span class="token punctuation">[</span>len<span class="token punctuation">(</span>summary1<span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>summary2<span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>summary3<span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>summary4<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"="</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">(</span>summary1<span class="token punctuation">,</span> summary2<span class="token punctuation">,</span> summary3<span class="token punctuation">,</span> summary4<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span>len<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> b1<span class="token punctuation">,</span> b2<span class="token punctuation">,</span> b3<span class="token punctuation">,</span> coder<span class="token keyword">def</span> <span class="token function">decode</span><span class="token punctuation">(</span>huf_path<span class="token punctuation">:</span> Union<span class="token punctuation">[</span>Path<span class="token punctuation">,</span> str<span class="token punctuation">]</span><span class="token punctuation">,</span> coder_path<span class="token punctuation">:</span> Union<span class="token punctuation">[</span>Path<span class="token punctuation">,</span> str<span class="token punctuation">]</span><span class="token punctuation">,</span> verbose<span class="token punctuation">:</span> bool<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    huf_path<span class="token punctuation">,</span> coder_path <span class="token operator">=</span> Path<span class="token punctuation">(</span>huf_path<span class="token punctuation">)</span><span class="token punctuation">,</span> Path<span class="token punctuation">(</span>coder_path<span class="token punctuation">)</span>    coder <span class="token operator">=</span> _HuffmanCoder<span class="token punctuation">.</span>load<span class="token punctuation">(</span>coder_path<span class="token punctuation">)</span>    <span class="token keyword">with</span> huf_path<span class="token punctuation">.</span>open<span class="token punctuation">(</span>mode<span class="token operator">=</span><span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        content <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>    decoded <span class="token operator">=</span> coder<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>content<span class="token punctuation">)</span>    <span class="token keyword">with</span> <span class="token punctuation">(</span>dec_path <span class="token punctuation">:</span><span class="token operator">=</span> huf_path<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token punctuation">:</span><span class="token operator">=</span> huf_path<span class="token punctuation">.</span>stem<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> f<span class="token string">"_decode.{s[1]}"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>open<span class="token punctuation">(</span>mode<span class="token operator">=</span><span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>decoded<span class="token punctuation">)</span>        b1 <span class="token operator">=</span> huf_path<span class="token punctuation">.</span>stat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>st_size    b2 <span class="token operator">=</span> coder_path<span class="token punctuation">.</span>stat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>st_size    b3 <span class="token operator">=</span> dec_path<span class="token punctuation">.</span>stat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>st_size    <span class="token keyword">if</span> verbose<span class="token punctuation">:</span>        summary1 <span class="token operator">=</span> f<span class="token string">"Origin file: {huf_path.stem}{huf_path.suffix}, byte size: {b1}"</span>        summary2 <span class="token operator">=</span> f<span class="token string">"Coder file: {coder_path.stem}{coder_path.suffix}, byte size: {b2}"</span>        summary3 <span class="token operator">=</span> f<span class="token string">"Decompressed file: {dec_path.stem}{dec_path.suffix}, byte size: {b3}"</span>        summary4 <span class="token operator">=</span> f<span class="token string">"{Fore.GREEN}Decompression rate {b3}/{b1}={Style.BRIGHT}{round(b3/b1, 4)*100}%{Style.NORMAL}"</span> <span class="token operator">+</span>\                f<span class="token string">", lost {Style.BRIGHT}{b3-b1}{Style.RESET_ALL} bytes"</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>s <span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"Summary"</span><span class="token punctuation">.</span>center<span class="token punctuation">(</span>max<span class="token punctuation">(</span><span class="token punctuation">[</span>len<span class="token punctuation">(</span>summary1<span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>summary2<span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>summary3<span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>summary4<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"="</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">(</span>summary1<span class="token punctuation">,</span> summary2<span class="token punctuation">,</span> summary3<span class="token punctuation">,</span> summary4<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span>len<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> b1<span class="token punctuation">,</span> b2<span class="token punctuation">,</span> b3<span class="token punctuation">,</span> coder<span class="token keyword">def</span> <span class="token function">parse_args</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> argparse<span class="token punctuation">.</span>Namespace<span class="token punctuation">:</span>    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>        description<span class="token operator">=</span><span class="token string">"哈夫曼压缩算法Python实现，可以对任意文件进行压缩，提供命令行以及GUI用户界面。作者：Jack Wang"</span>    <span class="token punctuation">)</span>    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"-s"</span><span class="token punctuation">,</span> <span class="token string">"--src"</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">"src_path"</span><span class="token punctuation">,</span> type<span class="token operator">=</span>str<span class="token punctuation">,</span> default<span class="token operator">=</span>None<span class="token punctuation">,</span> help<span class="token operator">=</span><span class="token string">"需要压缩的文件路径"</span><span class="token punctuation">)</span>    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"-t"</span><span class="token punctuation">,</span> <span class="token string">"--target"</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">"target_path"</span><span class="token punctuation">,</span> type<span class="token operator">=</span>str<span class="token punctuation">,</span> default<span class="token operator">=</span>None<span class="token punctuation">,</span> help<span class="token operator">=</span><span class="token string">"需要解压文件所在的文件夹的路径"</span><span class="token punctuation">)</span>    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"-v"</span><span class="token punctuation">,</span> <span class="token string">"--verbose"</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">"v"</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">"store_true"</span><span class="token punctuation">,</span> help<span class="token operator">=</span><span class="token string">"是否显示压缩的摘要信息"</span><span class="token punctuation">)</span>    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"-g"</span><span class="token punctuation">,</span> <span class="token string">"--gui"</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">"gui"</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">"store_true"</span><span class="token punctuation">,</span> help<span class="token operator">=</span><span class="token string">"是否以GUI方式显示"</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">QtGUIHuff</span><span class="token punctuation">(</span>QMainWindow<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> None<span class="token punctuation">:</span>        super<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>initUI<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">initUI</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">from</span> Ui_main <span class="token keyword">import</span> Ui_Form        self<span class="token punctuation">.</span>ui <span class="token operator">=</span> Ui_Form<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>setupUi<span class="token punctuation">(</span>self<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>setWindowTitle<span class="token punctuation">(</span><span class="token string">"哈夫曼压缩/解压缩程序"</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>compress<span class="token punctuation">.</span>clicked<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>self<span class="token punctuation">.</span>compress<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>decompress<span class="token punctuation">.</span>clicked<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>self<span class="token punctuation">.</span>decompress<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">fileDialog</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        dialog <span class="token operator">=</span> QFileDialog<span class="token punctuation">(</span><span class="token punctuation">)</span>        dialog<span class="token punctuation">.</span>setFileMode<span class="token punctuation">(</span>QFileDialog<span class="token punctuation">.</span>AnyFile<span class="token punctuation">)</span>        dialog<span class="token punctuation">.</span>setFilter<span class="token punctuation">(</span>QDir<span class="token punctuation">.</span>Files<span class="token punctuation">)</span>        <span class="token keyword">if</span> dialog<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            filename <span class="token operator">=</span> dialog<span class="token punctuation">.</span>selectedFiles<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> Path<span class="token punctuation">(</span>filename<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token boolean">False</span>    <span class="token keyword">def</span> <span class="token function">compress</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        f_path <span class="token operator">=</span> self<span class="token punctuation">.</span>fileDialog<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>textEdit<span class="token punctuation">.</span>setReadOnly<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>        s <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"开始压缩"</span><span class="token punctuation">]</span>        self<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>textEdit<span class="token punctuation">.</span>setText<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>        result <span class="token operator">=</span> encode<span class="token punctuation">(</span>f_path<span class="token punctuation">)</span>        summary1 <span class="token operator">=</span> f<span class="token string">"Origin file: {f_path.stem}{f_path.suffix}, byte size: {result[0]}"</span>        summary2 <span class="token operator">=</span> f<span class="token string">"Compressed file:  byte size: {result[1]}"</span>        summary3 <span class="token operator">=</span> f<span class="token string">"HuffCoder file: , byte size: {result[2]}"</span>        summary4 <span class="token operator">=</span> f<span class="token string">"Compression rate {result[1]}/{result[0]}={round(result[1]/result[0], 4)*100}%"</span> <span class="token operator">+</span> \                f<span class="token string">", saved {result[0] - result[1]} bytes"</span>        self<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>textEdit<span class="token punctuation">.</span>setText<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">*</span>s<span class="token punctuation">,</span> summary1<span class="token punctuation">,</span> summary2<span class="token punctuation">,</span> summary3<span class="token punctuation">,</span> summary4<span class="token punctuation">,</span> <span class="token string">"压缩结束"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>textEdit_2<span class="token punctuation">.</span>setText<span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>print_code_table<span class="token punctuation">(</span>verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__str__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">decompress</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        f_path <span class="token operator">=</span> self<span class="token punctuation">.</span>fileDialog<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> f_path<span class="token punctuation">.</span>suffix <span class="token operator">!=</span> <span class="token string">".huf"</span><span class="token punctuation">:</span>            QMessageBox<span class="token punctuation">.</span>warning<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"警告"</span><span class="token punctuation">,</span> <span class="token string">"请选择正确的压缩文件路径"</span><span class="token punctuation">,</span> QMessageBox<span class="token punctuation">.</span>Yes<span class="token punctuation">,</span> QMessageBox<span class="token punctuation">.</span>Yes<span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token boolean">False</span>                <span class="token keyword">if</span> len<span class="token punctuation">(</span>ps <span class="token punctuation">:</span><span class="token operator">=</span> list<span class="token punctuation">(</span>Path<span class="token punctuation">(</span>f_path<span class="token punctuation">)</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">"*.huf"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span>            <span class="token keyword">for</span> p_idx <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">if</span> <span class="token string">"coder"</span> <span class="token keyword">in</span> ps<span class="token punctuation">[</span>p_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>stem<span class="token punctuation">:</span>                    cp_idx <span class="token operator">=</span> p_idx        <span class="token keyword">else</span><span class="token punctuation">:</span>            QMessageBox<span class="token punctuation">.</span>warning<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"警告"</span><span class="token punctuation">,</span> <span class="token string">"缺少必要的解压缩文件"</span><span class="token punctuation">,</span> QMessageBox<span class="token punctuation">.</span>Yes<span class="token punctuation">,</span> QMessageBox<span class="token punctuation">.</span>Yes<span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token boolean">False</span>        s <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"开始解压"</span><span class="token punctuation">]</span>        <span class="token keyword">import</span> time        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>textEdit<span class="token punctuation">.</span>setText<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>        result <span class="token operator">=</span> decode<span class="token punctuation">(</span>huf_path<span class="token punctuation">:</span><span class="token operator">=</span>ps<span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">-</span>cp_idx<span class="token punctuation">]</span><span class="token punctuation">,</span> coder_path<span class="token punctuation">:</span><span class="token operator">=</span>ps<span class="token punctuation">[</span>cp_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>        summary1 <span class="token operator">=</span> f<span class="token string">"Origin file: {huf_path.stem}{huf_path.suffix}, byte size: {result[0]}"</span>        summary2 <span class="token operator">=</span> f<span class="token string">"Coder file: {coder_path.stem}{coder_path.suffix}, byte size: {result[1]}"</span>        summary3 <span class="token operator">=</span> f<span class="token string">"Decompressed file: byte size: {result[2]}"</span>        summary4 <span class="token operator">=</span> f<span class="token string">"Decompression rate {result[2]}/{result[0]}={round(result[2]/result[0], 4)*100}%"</span> <span class="token operator">+</span>\                f<span class="token string">", lost {result[2] - result[0]} bytes"</span>        self<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>textEdit<span class="token punctuation">.</span>setText<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">*</span>s<span class="token punctuation">,</span> summary1<span class="token punctuation">,</span> summary2<span class="token punctuation">,</span> summary3<span class="token punctuation">,</span> summary4<span class="token punctuation">,</span> <span class="token string">"解压结束"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>textEdit_2<span class="token punctuation">.</span>setText<span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>print_code_table<span class="token punctuation">(</span>verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__str__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token punctuation">:</span> argparse<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token operator">not</span> args<span class="token punctuation">.</span>gui<span class="token punctuation">:</span>        <span class="token keyword">assert</span> <span class="token number">0</span> <span class="token operator">&lt;</span> int<span class="token punctuation">(</span>args<span class="token punctuation">.</span>src_path <span class="token keyword">is</span> <span class="token operator">not</span> None<span class="token punctuation">)</span> <span class="token operator">+</span> int<span class="token punctuation">(</span>args<span class="token punctuation">.</span>target_path <span class="token keyword">is</span> <span class="token operator">not</span> None<span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token string">"{Fore.RED}请选择压缩或者解压，使用-h查询用法{Style.RESET_ALL}"</span>    <span class="token keyword">if</span> <span class="token operator">not</span> args<span class="token punctuation">.</span>gui<span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"{Fore.GREEN}命令行工作模式{Style.RESET_ALL}"</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> args<span class="token punctuation">.</span>src_path <span class="token keyword">is</span> <span class="token operator">not</span> None<span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"开始压缩 {args.src_path}"</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> args<span class="token punctuation">.</span>v<span class="token punctuation">:</span>                <span class="token keyword">print</span><span class="token punctuation">(</span>encode<span class="token punctuation">(</span>Path<span class="token punctuation">(</span>args<span class="token punctuation">.</span>src_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>print_code_table<span class="token punctuation">(</span>verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                encode<span class="token punctuation">(</span>Path<span class="token punctuation">(</span>args<span class="token punctuation">.</span>src_path<span class="token punctuation">)</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"压缩完成"</span><span class="token punctuation">)</span>        <span class="token keyword">elif</span> args<span class="token punctuation">.</span>target_path <span class="token keyword">is</span> <span class="token operator">not</span> None<span class="token punctuation">:</span>            <span class="token keyword">if</span> len<span class="token punctuation">(</span>ps <span class="token punctuation">:</span><span class="token operator">=</span> list<span class="token punctuation">(</span>Path<span class="token punctuation">(</span>args<span class="token punctuation">.</span>target_path<span class="token punctuation">)</span><span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">"*.huf"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>                <span class="token keyword">print</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span>                <span class="token keyword">for</span> p_idx <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                    <span class="token keyword">if</span> <span class="token string">"coder"</span> <span class="token keyword">in</span> ps<span class="token punctuation">[</span>p_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>stem<span class="token punctuation">:</span>                        cp_idx <span class="token operator">=</span> p_idx            <span class="token keyword">else</span><span class="token punctuation">:</span>                <span class="token keyword">assert</span> <span class="token boolean">False</span><span class="token punctuation">,</span> f<span class="token string">"{Fore.RED}无效的路径，没有找到压缩文件{Style.RESET_ALL}"</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"开始解压 {args.target_path}"</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> args<span class="token punctuation">.</span>v<span class="token punctuation">:</span>                <span class="token keyword">print</span><span class="token punctuation">(</span>decode<span class="token punctuation">(</span>huf_path<span class="token operator">=</span>ps<span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">-</span>cp_idx<span class="token punctuation">]</span><span class="token punctuation">,</span> coder_path<span class="token operator">=</span>ps<span class="token punctuation">[</span>cp_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>print_code_table<span class="token punctuation">(</span>verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                decode<span class="token punctuation">(</span>huf_path<span class="token operator">=</span>ps<span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">-</span>cp_idx<span class="token punctuation">]</span><span class="token punctuation">,</span> coder_path<span class="token operator">=</span>ps<span class="token punctuation">[</span>cp_idx<span class="token punctuation">]</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"解压完成"</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        app <span class="token operator">=</span> QApplication<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span>        m <span class="token operator">=</span> QtGUIHuff<span class="token punctuation">(</span><span class="token punctuation">)</span>        m<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>app<span class="token punctuation">.</span>exec_<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    main<span class="token punctuation">(</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-Ui-main-py"><a href="#2-Ui-main-py" class="headerlink" title="2. Ui_main.py"></a>2. Ui_main.py</h3><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># -*- coding: utf-8 -*-</span><span class="token comment" spellcheck="true"># Form implementation generated from reading ui file '/media/jack/JackCode/project/data_structure/11_huffman/ui/main.ui'</span><span class="token comment" spellcheck="true">#</span><span class="token comment" spellcheck="true"># Created by: PyQt5 UI code generator 5.9.2</span><span class="token comment" spellcheck="true">#</span><span class="token comment" spellcheck="true"># WARNING! All changes made in this file will be lost!</span><span class="token keyword">from</span> PyQt5 <span class="token keyword">import</span> QtCore<span class="token punctuation">,</span> QtGui<span class="token punctuation">,</span> QtWidgets<span class="token keyword">class</span> <span class="token class-name">Ui_Form</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">setupUi</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> Form<span class="token punctuation">)</span><span class="token punctuation">:</span>        Form<span class="token punctuation">.</span>setObjectName<span class="token punctuation">(</span><span class="token string">"Form"</span><span class="token punctuation">)</span>        Form<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token number">751</span><span class="token punctuation">,</span> <span class="token number">374</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>layoutWidget <span class="token operator">=</span> QtWidgets<span class="token punctuation">.</span>QWidget<span class="token punctuation">(</span>Form<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>layoutWidget<span class="token punctuation">.</span>setGeometry<span class="token punctuation">(</span>QtCore<span class="token punctuation">.</span>QRect<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">641</span><span class="token punctuation">,</span> <span class="token number">321</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>layoutWidget<span class="token punctuation">.</span>setObjectName<span class="token punctuation">(</span><span class="token string">"layoutWidget"</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>horizontalLayout_2 <span class="token operator">=</span> QtWidgets<span class="token punctuation">.</span>QHBoxLayout<span class="token punctuation">(</span>self<span class="token punctuation">.</span>layoutWidget<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>horizontalLayout_2<span class="token punctuation">.</span>setContentsMargins<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>horizontalLayout_2<span class="token punctuation">.</span>setObjectName<span class="token punctuation">(</span><span class="token string">"horizontalLayout_2"</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>verticalLayout <span class="token operator">=</span> QtWidgets<span class="token punctuation">.</span>QVBoxLayout<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>verticalLayout<span class="token punctuation">.</span>setObjectName<span class="token punctuation">(</span><span class="token string">"verticalLayout"</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>horizontalLayout <span class="token operator">=</span> QtWidgets<span class="token punctuation">.</span>QHBoxLayout<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>horizontalLayout<span class="token punctuation">.</span>setObjectName<span class="token punctuation">(</span><span class="token string">"horizontalLayout"</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>compress <span class="token operator">=</span> QtWidgets<span class="token punctuation">.</span>QPushButton<span class="token punctuation">(</span>self<span class="token punctuation">.</span>layoutWidget<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>compress<span class="token punctuation">.</span>setObjectName<span class="token punctuation">(</span><span class="token string">"compress"</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>horizontalLayout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>compress<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>decompress <span class="token operator">=</span> QtWidgets<span class="token punctuation">.</span>QPushButton<span class="token punctuation">(</span>self<span class="token punctuation">.</span>layoutWidget<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>decompress<span class="token punctuation">.</span>setObjectName<span class="token punctuation">(</span><span class="token string">"decompress"</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>horizontalLayout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>decompress<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>verticalLayout<span class="token punctuation">.</span>addLayout<span class="token punctuation">(</span>self<span class="token punctuation">.</span>horizontalLayout<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>label <span class="token operator">=</span> QtWidgets<span class="token punctuation">.</span>QLabel<span class="token punctuation">(</span>self<span class="token punctuation">.</span>layoutWidget<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>label<span class="token punctuation">.</span>setAlignment<span class="token punctuation">(</span>QtCore<span class="token punctuation">.</span>Qt<span class="token punctuation">.</span>AlignCenter<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>label<span class="token punctuation">.</span>setObjectName<span class="token punctuation">(</span><span class="token string">"label"</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>verticalLayout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>label<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>textEdit <span class="token operator">=</span> QtWidgets<span class="token punctuation">.</span>QTextEdit<span class="token punctuation">(</span>self<span class="token punctuation">.</span>layoutWidget<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>textEdit<span class="token punctuation">.</span>setObjectName<span class="token punctuation">(</span><span class="token string">"textEdit"</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>verticalLayout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>textEdit<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>horizontalLayout_2<span class="token punctuation">.</span>addLayout<span class="token punctuation">(</span>self<span class="token punctuation">.</span>verticalLayout<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>verticalLayout_2 <span class="token operator">=</span> QtWidgets<span class="token punctuation">.</span>QVBoxLayout<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>verticalLayout_2<span class="token punctuation">.</span>setObjectName<span class="token punctuation">(</span><span class="token string">"verticalLayout_2"</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>label_2 <span class="token operator">=</span> QtWidgets<span class="token punctuation">.</span>QLabel<span class="token punctuation">(</span>self<span class="token punctuation">.</span>layoutWidget<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>label_2<span class="token punctuation">.</span>setAlignment<span class="token punctuation">(</span>QtCore<span class="token punctuation">.</span>Qt<span class="token punctuation">.</span>AlignCenter<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>label_2<span class="token punctuation">.</span>setObjectName<span class="token punctuation">(</span><span class="token string">"label_2"</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>verticalLayout_2<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>label_2<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>textEdit_2 <span class="token operator">=</span> QtWidgets<span class="token punctuation">.</span>QTextEdit<span class="token punctuation">(</span>self<span class="token punctuation">.</span>layoutWidget<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>textEdit_2<span class="token punctuation">.</span>setObjectName<span class="token punctuation">(</span><span class="token string">"textEdit_2"</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>verticalLayout_2<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>textEdit_2<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>horizontalLayout_2<span class="token punctuation">.</span>addLayout<span class="token punctuation">(</span>self<span class="token punctuation">.</span>verticalLayout_2<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>retranslateUi<span class="token punctuation">(</span>Form<span class="token punctuation">)</span>        QtCore<span class="token punctuation">.</span>QMetaObject<span class="token punctuation">.</span>connectSlotsByName<span class="token punctuation">(</span>Form<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">retranslateUi</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> Form<span class="token punctuation">)</span><span class="token punctuation">:</span>        _translate <span class="token operator">=</span> QtCore<span class="token punctuation">.</span>QCoreApplication<span class="token punctuation">.</span>translate        Form<span class="token punctuation">.</span>setWindowTitle<span class="token punctuation">(</span>_translate<span class="token punctuation">(</span><span class="token string">"Form"</span><span class="token punctuation">,</span> <span class="token string">"Form"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>compress<span class="token punctuation">.</span>setText<span class="token punctuation">(</span>_translate<span class="token punctuation">(</span><span class="token string">"Form"</span><span class="token punctuation">,</span> <span class="token string">"压缩"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>decompress<span class="token punctuation">.</span>setText<span class="token punctuation">(</span>_translate<span class="token punctuation">(</span><span class="token string">"Form"</span><span class="token punctuation">,</span> <span class="token string">"解压"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>label<span class="token punctuation">.</span>setText<span class="token punctuation">(</span>_translate<span class="token punctuation">(</span><span class="token string">"Form"</span><span class="token punctuation">,</span> <span class="token string">"Compress/Decompress Log"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>label_2<span class="token punctuation">.</span>setText<span class="token punctuation">(</span>_translate<span class="token punctuation">(</span><span class="token string">"Form"</span><span class="token punctuation">,</span> <span class="token string">"Huffman Tree"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 数据结构与算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> PyQt </tag>
            
            <tag> DataStructure </tag>
            
            <tag> 数据结构 </tag>
            
            <tag> HuffmanEncode </tag>
            
            <tag> HuffmanAlgorithm </tag>
            
            <tag> GUI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PyQt5学习笔记 Chapter 0-Introduction： Part 3.第一个Qt程序</title>
      <link href="/2021/12/20/pyqt5-xue-xi-bi-ji-3-di-yi-ge-qt-cheng-xu/"/>
      <url>/2021/12/20/pyqt5-xue-xi-bi-ji-3-di-yi-ge-qt-cheng-xu/</url>
      
        <content type="html"><![CDATA[<blockquote><p>本讲作为Introduction的最后一讲，实现了一个简单的Qt的GUI程序</p></blockquote><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211220145356314.png" alt="第一个Qt Gui程序"></p><h1 id="PyQt5学习笔记-Chapter-0-Introduction：-Part-3-第一个Qt程序"><a href="#PyQt5学习笔记-Chapter-0-Introduction：-Part-3-第一个Qt程序" class="headerlink" title="PyQt5学习笔记 Chapter 0-Introduction： Part 3.第一个Qt程序"></a>PyQt5学习笔记 Chapter 0-Introduction： Part 3.第一个Qt程序</h1><p>在Introduction章节中，我们介绍了什么是Qt、PyQt以及Qt中的一些基本概念。本文作为Introduction的终节，展示一个Qt程序。</p><h2 id="1-Qt程序"><a href="#1-Qt程序" class="headerlink" title="1. Qt程序"></a>1. Qt程序</h2><p>上面的Qt GUI程序的代码如下</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> sys<span class="token keyword">from</span> PyQt5<span class="token punctuation">.</span>QtWidgets <span class="token keyword">import</span> QApplication<span class="token punctuation">,</span> QMainWindow<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    app <span class="token operator">=</span> QApplication<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span>    w <span class="token operator">=</span> QMainWindow<span class="token punctuation">(</span><span class="token punctuation">)</span>    w<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">)</span>    w<span class="token punctuation">.</span>move<span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span>    w<span class="token punctuation">.</span>setWindowTitle<span class="token punctuation">(</span><span class="token string">"第一个Qt应用"</span><span class="token punctuation">)</span>    w<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 运行主循环，循环扫描窗口上的事件，并分发给对应的回调函数</span>    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>app<span class="token punctuation">.</span>exec_<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们运行之后就会弹出来一个窗口。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211220145739135.png" alt="弹出来的窗口"></p><h2 id="2-程序解释"><a href="#2-程序解释" class="headerlink" title="2. 程序解释"></a>2. 程序解释</h2><p>在上面，我们写了一个极简的Qt GUI程序，下面我们对他进行讲解。</p><ol><li>Qt5本身有非常多的功能，例如网络引擎、蓝牙设备管理等等。因此在Qt5中，一个功能就是一个模块。我们这里的QtWidgets模块中包含了所有的Qt常见的功能。例如按钮、窗口、程序等等。</li><li>首先正如前面所讲，我们实例化一个QApplication类</li><li>接下来我们实例化了一个窗口。并将这个窗口大小设置为300像素宽、150像素高；将窗口锚点（左上角点）移动到距离屏幕左上角宽300像素、高300像素的位置；设置窗口名称为第一个Qt应用；最后显示窗口。</li><li>最后我们运行这个程序，并将程序运行的结果（返回值）作为参数传给sys.exit</li></ol><p>其实从上面我们能够看到，一个窗口本身并不是整个程序，而是程序的一部分。这也是Qt的设计思想之一，即功能和显示分离。我们目前只是利用一些对象进行了显示，而功能的实现需要稍后面介绍的信号与槽机制。</p>]]></content>
      
      
      <categories>
          
          <category> PyQt5 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> GUI开发 </tag>
            
            <tag> PyQt </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PyQt5学习笔记 Chapter 0-Introduction： Part 2.QApplication与QObject</title>
      <link href="/2021/12/17/pyqt5-xue-xi-bi-ji-2-qt-ji-chu-qapplication-yu-qobject/"/>
      <url>/2021/12/17/pyqt5-xue-xi-bi-ji-2-qt-ji-chu-qapplication-yu-qobject/</url>
      
        <content type="html"><![CDATA[<blockquote><p>本文主要讲解了Qt中的核心对象：QApplication与QObject</p></blockquote><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211222112408341.png" alt="Qt可以制作出的高端界面"></p><h1 id="PyQt5学习笔记-Chapter-0-Introduction：-Part-2-QApplication与QObject"><a href="#PyQt5学习笔记-Chapter-0-Introduction：-Part-2-QApplication与QObject" class="headerlink" title="PyQt5学习笔记 Chapter 0-Introduction： Part 2.QApplication与QObject"></a>PyQt5学习笔记 Chapter 0-Introduction： Part 2.QApplication与QObject</h1><p>想要学好Qt，我们就需要掌握Qt的设计与架构，单纯的为掌握API是徒劳的，没有理解终究会忘记。本文作为基础，首先介绍了Qt中的QApplication与QObject。</p><h2 id="1-QObject"><a href="#1-QObject" class="headerlink" title="1. QObject"></a>1. QObject</h2><p>前面我们介绍过，Qt是一个面向对象的应用程序框架。因此在Qt中的一起都是对象，例如我们看到的窗口、按钮等等都是对象，甚至连整个应用程序都是对象。不同的对象有不同的属性和方法，例如对于窗口，窗口大小和锚点（左上角点）的位置就是其属性，窗口移动到某个位置就是其方法。而针对按钮，按钮也可以将按钮的大小作为其属性，而将点击作为其方法。</p><p>因此针对所有的对象，Qt提供了QObject作为所有类的基类，所有的类都是QObject的基类。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211222112125225.png" alt="Qt官方对QObject的介绍"></p><p>在未来，随着我们逐步的深入，我们会了解到诸如信号与槽、定时器等机制。而这些机制其实都是由QObject所提供的。</p><p>现在我们只需要记住，Qt所写的GUI程序中的一切都是对象即可</p><h2 id="2-QApplication"><a href="#2-QApplication" class="headerlink" title="2. QApplication"></a>2. QApplication</h2><p>前面我们说了，Qt中一切都是对象，Qt甚至将程序本身也抽象成了一个类。这个类就是QApplication。</p><p><strong>QApplication接管GUI程序的主控制流</strong>，具体包括：线程的管理，事件的分发（例如鼠标点击按钮后由谁来处理），回调函数的唤醒等等。因此我们使用Qt开发程序的时候必须要有一个QApplication对象。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211222112030842.png" alt="Qt官方的文档"></p><p>程序可以开启也可以关闭，因此QApplication对象就有运行和关闭等功能。而由于运行程序和结束程序是QApplication对象最常见的功能，因此因此我们在未来不断地一段时间内都只会用到QApplication的运行和结束方法。在未来我们会介绍线程等内容。</p><p>现在我们只需要知道，使用Qt写程序的时候必须要有一个QApplication，而程序开始运行则需要调用QApplication对象的运行方法</p>]]></content>
      
      
      <categories>
          
          <category> PyQt5 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> GUI开发 </tag>
            
            <tag> PyQt </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于hexo的个人技术博客搭建-Part-5-Hexo本地编写技巧</title>
      <link href="/2021/12/17/ji-yu-hexo-de-ge-ren-ji-zhu-bo-ke-da-jian-part-5-hexo-ben-di-bian-xie-ji-qiao/"/>
      <url>/2021/12/17/ji-yu-hexo-de-ge-ren-ji-zhu-bo-ke-da-jian-part-5-hexo-ben-di-bian-xie-ji-qiao/</url>
      
        <content type="html"><![CDATA[<blockquote><p>前面我们成功的在本地搭建出了Hexo博客网站的环境以及完成了Typora编辑器的设置。本文将讲解如何使用Hexo在本地创建文章以及设置为草稿、密码阅读等技巧</p></blockquote><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211217131946247.png" alt="Hexo 博客编写技巧"></p><h1 id="基于Hexo的个人技术博客搭建-——-Hexo本地编写技巧"><a href="#基于Hexo的个人技术博客搭建-——-Hexo本地编写技巧" class="headerlink" title="基于Hexo的个人技术博客搭建 ——  Hexo本地编写技巧"></a>基于Hexo的个人技术博客搭建 ——  Hexo本地编写技巧</h1><p>前面我们已经设置好了本地的Hexo博客环境，以及本地的编辑器环境。本文将讲解如何通过Hexo来创建新的博客文章，并且设置文章为草稿（不可见）以及加密（密码阅读等功能）。</p><p>前面我们讲过Hexo中博客其实是Markdown文件。针对Markdown，Hexo可以根据我们预先设置好的模板来渲染、生成对应的HTML文件。那么我们要开始编写博客，其实就是开始编写Markdown文档。</p><p>然而在我们使用Typora开始编写前，自然就需要创建出来这个Markdown文件。然后在创建的Markdown文件的基础上，我们为这个Markdown文件设置文章的标题、日期等等元信息（mate-information，类比于HTML中的header）。</p><p>进一步，有了文章我们有的时候不希望一些文章被人看到，比如写了一半的草稿；也有一些文章，我们希望有访问权限得人（有密码的人）才能阅读，例如你的简历。</p><p>因此针对这些功能，Hexo都进行了设置。</p><h2 id="1-Hexo的博客原理"><a href="#1-Hexo的博客原理" class="headerlink" title="1. Hexo的博客原理"></a>1. Hexo的博客原理</h2><h3 id="1-Markdown的Front-Formatter"><a href="#1-Markdown的Front-Formatter" class="headerlink" title="1. Markdown的Front-Formatter"></a>1. Markdown的Front-Formatter</h3><p>首先针对文章的标题、日期、是否加密等信息都是在Markdown开头的Header区设定，由于设定之后会影响到文章的外观（在稍后会看到），因此这个区域成为Front-Formatter。以我之前写好的一篇文章为例，我们能够看到文章的标题、创建日期、封面图像、所属目录、分类等等信息都在Header区设定。</p><p>其实包括后面的密码验证文章也在这里设置。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211217130309720.png" alt="Markdown的Header"></p><h3 id="2-Hexo中的草稿与正式发布文章"><a href="#2-Hexo中的草稿与正式发布文章" class="headerlink" title="2. Hexo中的草稿与正式发布文章"></a>2. Hexo中的草稿与正式发布文章</h3><p>由于Hexo是通过Markdown文件来生成文章，因此我们写的草稿和正式要发布的文章其实对于Hexo来说是完全等价的。要区分两者。Hexo实际上是通过文件所处的文件夹来进行的。我们所有的要发布的文章都在<code>source/_post</code>文件夹中，而所有的草稿都在<code>source/_draft</code>中</p><pre class="line-numbers language-shell"><code class="language-shell">(base) jack@jack-Alienware-m15-R3:/media/jack/JackCode/project/hexo-blogs$ tree -d -L 2 source/(base) jack@jack-Alienware-m15-R3:/media/jack/JackCode/project/hexo-blogs$ ls source/_posts/(base) jack@jack-Alienware-m15-R3:/media/jack/JackCode/project/hexo-blogs$ ls source/_drafts/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>原谅我因为博客要在不同的机器上编写，所以放在了硬盘上，导致文件权限很呆滞<span class="github-emoji"><span>🤔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211217130820741.png" alt="Hexo中的草稿与发布文章的文件夹"></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211217131004765.png" alt="具体的草稿与发布的文章"></p><p>因此用的来说，我们写博客时候需要掌握的技巧就是文章在草稿（文件夹）与正式发布（文件夹）之间的左右横跳与单篇文章内的信息设置。</p><h2 id="2-Hexo文章草稿与正式发布的博客"><a href="#2-Hexo文章草稿与正式发布的博客" class="headerlink" title="2. Hexo文章草稿与正式发布的博客"></a>2. Hexo文章草稿与正式发布的博客</h2><h3 id="1-草稿"><a href="#1-草稿" class="headerlink" title="1. 草稿"></a>1. 草稿</h3><h4 id="1-创建草稿"><a href="#1-创建草稿" class="headerlink" title="1. 创建草稿"></a>1. 创建草稿</h4><p>我们通过hexo new的时候指定使用的模板是draft即可，此时创建的文章会被自动放到_draft文件夹下面</p><pre class="line-numbers language-shell"><code class="language-shell">hexo new draft <title><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>例如：</p><pre class="line-numbers language-shell"><code class="language-shell">(base) jack@jack-Alienware-m15-R3:/media/jack/JackCode/project/hexo-blogs$ hexo new draft draft_test(base) jack@jack-Alienware-m15-R3:/media/jack/JackCode/project/hexo-blogs$ ls source/_drafts/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211217134454739.png" alt="Hexo创建草稿"></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211217134547721.png" alt="所有草稿文章"></p><p>然后我们hexo gen生成文章，再使用hexo server来查看本地文章的时候，并不会看到这些草稿文章</p><h4 id="2-发布草稿"><a href="#2-发布草稿" class="headerlink" title="2. 发布草稿"></a>2. 发布草稿</h4><p>当我们完成了草稿文章之后想要发布的时候，使用下面的命令来进行发布</p><pre class="line-numbers language-shell"><code class="language-shell">hexo publish <title><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>需要注意的是，Hexo是一个轻量级的博客，因此不存在像记录草稿、已发布的文章这样的数据库。所有的操作都是基于文件的，因此上面的命令就是把文章从_draft中移动到_post中。我们直接手动mv也是可以的</p><pre class="line-numbers language-shell"><code class="language-shell">(base) jack@jack-Alienware-m15-R3:/media/jack/JackCode/project/hexo-blogs$ hexo publish draft-test(base) jack@jack-Alienware-m15-R3:/media/jack/JackCode/project/hexo-blogs$ ls source/_posts/ | grep dra<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211217135305343.png" alt="发布文章"></p><h3 id="2-正式发布文章"><a href="#2-正式发布文章" class="headerlink" title="2. 正式发布文章"></a>2. 正式发布文章</h3><h4 id="1-创建正式发布的文章"><a href="#1-创建正式发布的文章" class="headerlink" title="1. 创建正式发布的文章"></a>1. 创建正式发布的文章</h4><p>直接hexo new就完事，或者自己在_post下面创建，略</p><h4 id="2-改发布文章为草稿"><a href="#2-改发布文章为草稿" class="headerlink" title="2. 改发布文章为草稿"></a>2. 改发布文章为草稿</h4><p>没啥好说的，mv就完事了</p><h2 id="3-Hexo文章Front-Formatter设置"><a href="#3-Hexo文章Front-Formatter设置" class="headerlink" title="3. Hexo文章Front-Formatter设置"></a>3. Hexo文章Front-Formatter设置</h2><p>事实上对于Hexo文章的Front-Formatter而言，Hexo本身支持的Front-Formatter是有限的，需要通过第三方的主题进行扩展。幸运的是，我们前面使用的Matery主题以及有所考虑，支持非常多的Front-Formatter。</p><p>由于Matery主题的Front-Formatter在<a href="https://blinkfox.github.io/2018/09/28/qian-duan/hexo-bo-ke-zhu-ti-zhi-hexo-theme-matery-de-jie-shao/#toc-heading-19">闪烁之狐对Matery主题介绍的博客</a>中已经有了非常详尽的介绍，本文只对一些需要配置的功能进行介绍，一些只需要在Front-Formatter中添加对应的项即可显示的设置就不在介绍，请参考Matery主题闪烁之狐的介绍</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211217131946247.png" alt="Front-Formatter闪烁之狐的介绍"></p><h3 id="1-密码设置"><a href="#1-密码设置" class="headerlink" title="1. 密码设置"></a>1. 密码设置</h3><p>对文章进行密码设置功能并不是Hexo的功能，而是Matery主题中的功能，因此我们需要在Matery主题的配置中进行设置</p><p>具体路径为<code>themes/hexo-theme-matery</code>下的<code>_config.yml</code>，然后找到<code>verifyPassword</code>这一项，将其设置为True，然后修改提示语即可</p><pre class="line-numbers language-shell"><code class="language-shell">(base) jack@jack-Alienware-m15-R3:/media/jack/JackCode/project/hexo-blogs$ vim themes/hexo-theme-matery/_config.yml <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211217132432259.png" alt="设置主题，开启文章加密功能"></p><p>需要注意的是，Matery主题中的验证密码方式是通过内置的SHA256算法对访问者输入的密码加密之后和我们在文章的Front-Formatter中设置的经过SHA256 加密的 password 的值进行对比得到的。因此我们首先可以通过一下网站来获得密码对应的值。</p><ul><li><a href="https://tool.oschina.net/encrypt?type=2">开源中国</a></li><li><a href="http://encode.chahuo.com/">chahuo</a></li><li><a href="http://tool.chinaz.com/tools/hash.aspx">站长工具</a></li></ul><p>例如我们使用开源中国来进行值的获取，注意选择SHA256算法。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211217133017741.png" alt="生成加密后的密码的值"></p><p>然后我们新建一篇文章来进行测试。</p><pre class="line-numbers language-shell"><code class="language-shell">(base) jack@jack-Alienware-m15-R3:/media/jack/JackCode/project/hexo-blogs$ hexo new passwd-test<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然后我们在里面设置password这一项，随便写一点内容</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211217133315175.png" alt="设置文章密码"></p><p>然后我们使用hexo gen来生成文章看看效果</p><pre class="line-numbers language-shell"><code class="language-shell">(base) jack@jack-Alienware-m15-R3:/media/jack/JackCode/project/hexo-blogs$ hexo gen(base) jack@jack-Alienware-m15-R3:/media/jack/JackCode/project/hexo-blogs$ hexo s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>接下来我们就能够在首页看到这个加密的文章了</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211217133600366.png" alt="加密的文章"></p><p>我们一旦点进去访问，就需要我们输入密码</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211217133650320.png" alt="输入密码"></p><p>我们输入正确之后进去就能够看到了</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211217133745568.png" alt="输入正确之后可以看到文章"></p><p>而一旦输入错误就会返回主页</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211217133827160.png" alt="输入错误之后返回主页"></p>]]></content>
      
      
      <categories>
          
          <category> Hexo博客搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PyQt5学习笔记 Chapter 0-Introduction： Part 1.Qt、PyQt与PySide</title>
      <link href="/2021/12/16/pyqt5-xue-xi-bi-ji-1-qt-pyqt-yu-pyside/"/>
      <url>/2021/12/16/pyqt5-xue-xi-bi-ji-1-qt-pyqt-yu-pyside/</url>
      
        <content type="html"><![CDATA[<blockquote><p>Before learn something, you’d better know what it is. </p><p>本文介绍了Qt、PyQt与PySide间的关系。</p></blockquote><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/pyqt_vs_pyside.png" alt="PyQt vs PySide"></p><h1 id="PyQt5学习笔记-Chapter-0-Introduction：-Part-1-Qt、PyQt与PySide"><a href="#PyQt5学习笔记-Chapter-0-Introduction：-Part-1-Qt、PyQt与PySide" class="headerlink" title="PyQt5学习笔记 Chapter 0-Introduction： Part 1.Qt、PyQt与PySide"></a>PyQt5学习笔记 Chapter 0-Introduction： Part 1.Qt、PyQt与PySide</h1><p>在学习一个东西之前，我们需要首先明白这个东西是什么。</p><h2 id="0-库与框架"><a href="#0-库与框架" class="headerlink" title="0. 库与框架"></a>0. 库与框架</h2><p>在介绍Qt前，我们需要明白什么是库，什么是框架。</p><p>以下内容参考知乎问题<a href="https://www.zhihu.com/question/29643471">库，框架，架构，平台，有什么明确的区别？</a>博主<a href="https://www.zhihu.com/people/aton">苏莉安的回答</a>与<a href="https://www.zhihu.com/people/ze.ran">ze ran的回答</a>以及<a href="https://www.zhihu.com/people/morgancheng">程墨Morgan的回答</a></p><h3 id="1-库-Library"><a href="#1-库-Library" class="headerlink" title="1. 库 Library"></a>1. 库 Library</h3><p>库可以理解成一个工具箱，工具箱里提供了很多的工具来帮助我们进行工作。</p><p>例如我们在淘宝上买了一个书架，快递发过来的是书架的零件，我们需要自己去进行组装。而在组装架子的时候，我们会用螺丝刀。而自己手动拧螺丝刀则会拧到手痛。所以这个时候我们就会去买一个电动螺丝刀。利用这个电动螺丝刀，我们的效率马上会有极大地提升。我们的生产力也会有极大地进步。</p><p>而无论螺丝刀还是电动螺丝刀，都是不同的工具。</p><p>对应的，库里提供了很多的函数来帮助我们进行工作。利用这些函数，我们的效率马上会翻几倍。</p><p>螺丝刀和电动螺丝刀则是完成同一个工作的不同的库，库与库之间也会存在差异。</p><p><strong>然而库之于程序就像工具之于人，是人决定怎么用工具，工具在哪里用；库也是程序（我们程序员）决定在哪里使用、怎样使用；库只是提供了便利，不需要我们自己手动实现，而且在一些情况下高效率的库（e.g., numpy）能够避免我们自己手动低效率的实现（e.g., for 循环）</strong></p><p>所以说，<strong>库</strong>（Library）是一系列预先编写好的代码集合，供开发者在编程中调用，大大减少重复工作量。我们自己写一个字符串处理函数，包装好之后调用，也是库。</p><p>库的概念很宽泛。程序员第一次输出hello world用的printf就来自C语言标准库；各种SDK都是库；从npm、Maven、Nuget下载的包都是库；pip中绝大部分也是库</p><p><strong>对于库而言，最重要的一点就是程序的主控制流在我们的程序中；或者说是我们的程序在调用库</strong></p><h3 id="2-框架-FrameWork"><a href="#2-框架-FrameWork" class="headerlink" title="2. 框架 FrameWork"></a>2. 框架 FrameWork</h3><p><strong>框架</strong>（Framework）可以理解成是库的进阶版。很多人会把框架和普通库的区别仅仅理解为规模和复杂度，其实不然。</p><p><strong>框架最大的特点就是会接管程序的主控制流；或者说框架在调用我们的代码</strong></p><p>我们只需要编写业务的逻辑代码，具体的工作执行（例如后面要说的GUI框架Qt中的图形显示、信号处理/槽函数调用；未来会出的网页程序框架Flask的服务器运行等等）都是由框架执行的。</p><p>框架是一个半成品的应用，和库的最大区别是框架直接左右了应用怎么来写。</p><hr><h2 id="1-What-is-Qt"><a href="#1-What-is-Qt" class="headerlink" title="1. What is Qt"></a>1. What is Qt</h2><p>在前面介绍完库与框架的区别之后，我们就可以正式的开始介绍Qt了。</p><p>简单的来说，<strong>Qt是一个C++的应用程序开发框架</strong>；更具体的介绍，则看看下面维基百科和百度百科的介绍</p><blockquote><p><strong>From Wikipedia</strong>：</p><p>Qt（/ˈkjuːt/，发音同“cute”）是一个跨平台的C++应用程序开发框架。广泛用于开发GUI程序，这种情况下又被称为部件工具箱。也可用于开发非GUI程序，例如控制台工具和服务器。Qt被用于OPIE、Skype、VLC media player、Adobe Photoshop Elements、VirtualBox与Mathematica以及被Autodesk 、欧洲空间局、梦工厂、Google、HP、KDE、卢卡斯影业、西门子公司、沃尔沃集团, 华特迪士尼动画制作公司、三星集团、飞利浦、Panasonic所使用。</p><p>它是Digia公司的产品。Qt使用标准的C++和特殊的代码生成扩展（称为元对象编译器（Meta Object Compiler, moc））以及一些宏。通过语言绑定，其他的编程语言也可以使用Qt。</p><p>Qt是自由且开放源代码的软件，在GNU宽通用公共许可证（LGPL）条款下发布。所有版本都支持广泛的编译器，包括GCC的C++编译器和Visual Studio。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211217102149620.png" alt="Qt的维基百科介绍"></p></blockquote><blockquote><p><strong>From Baidubaike</strong>：</p><p>Qt 是一个1991年由Qt Company开发的跨平台C++图形用户界面应用程序开发框架。它既可以开发GUI程序，也可用于开发非GUI程序，比如控制台工具和服务器。Qt是面向对象的框架，使用特殊的代码生成扩展（称为元对象编译器(Meta Object Compiler, moc)）以及一些宏，Qt很容易扩展，并且允许真正地组件编程。<br>2008年，Qt Company科技被诺基亚公司收购，Qt也因此成为诺基亚旗下的编程语言工具。2012年，Qt被Digia收购。<br>2014年4月，跨平台集成开发环境Qt Creator 3.1.0正式发布，实现了对于iOS的完全支持，新增WinRT、Beautifier等插件，废弃了无Python接口的GDB调试支持，集成了基于Clang的C/C++代码模块，并对Android支持做出了调整，至此实现了全面支持iOS、Android、WP,它提供给应用程序开发者建立艺术级的图形用户界面所需的所有功能。基本上，Qt 同 X Window 上的 Motif，Openwin，GTK 等图形界面库和 Windows 平台上的 MFC，OWL，VCL，ATL 是同类型的东西。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211217102306283.png" alt="Qt的百度百科介绍"></p></blockquote><p>关于Qt，我们需要知道的重要的点如下：</p><ol><li><strong>Qt是一个C++的框架</strong>。因此使用C++进行Qt开发是很舒服的，而Python解释器中Python基金会官方提供的解释器本身是由C语言写的，因此直接动态加载C++的库（挖个坑，后面会将Python调用C++的库）。因此，我们能够早Python中调用Qt</li><li><strong>Qt是一个应用程序框架，而非仅仅是一个带图形界面的应用程序框架（GUI应用程序框架）</strong>。因此在Qt看来，GUI只是Qt的一个部分，而不是全部。对于一个成熟的应用来说，涉及到的内容用：进程/线程/协程管理、网络编程、蓝牙/影响等设备管理、GUI图形显示等等功能。因此Qt作为一个应用程序框架，对于这些内容都是可以胜任的。因此Qt不仅仅是GUI的库，而是一个应用程序框架。更加具体的来说，Qt是因为他的GUI出名，但不仅仅只有GUI。</li></ol><p>针对第一个点，我们稍后就会讲解什么是PyQt，什么是PySide。而针对第二个点，我们明白了未来要怎么样学习Qt，即分模块学习。因此在未来的有的文章会关注PyQt的GUI部分，有的部分会关注PyQt的多线程管理，而有的部分会关注PyQt的网络编程。</p><h2 id="2-What-is-Python-Language-Binding"><a href="#2-What-is-Python-Language-Binding" class="headerlink" title="2. What is Python/Language Binding"></a>2. What is Python/Language Binding</h2><p>在进一步介绍之前，我们需要知道什么是Python Binding，什么是Language Binding。</p><p>从概念上来说，Language Binding是Python Binding的父类/超集。而具体来说，Language Binding指的是某种语言中可以让该语言调用其他语言或者一些系统服务的该语言的代码，这些代码成为胶水代码（glue code）。</p><p>关于Language Binding，百度百科上没有介绍，因此只有维基百科的英文介绍</p><blockquote><p><strong>From Wikipedia</strong>:</p><p>In programming and software design, binding is an application programming interface (API) that provides glue code specifically made to allow a programming language to use a foreign library or operating system service (one that is not native to that language).</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211217104203893.png" alt="Introduction of Language Binding in Wikipedia"></p></blockquote><p>因此对于Python来说，Python Binding即指能够让Python调用由其他语言开发的库或者是系统提供的功能（系统调用）的Python代码。</p><p>事实上，得益于Python官方的CPython解释器是由C语言开发的，因此Python具有的直接调用C/C++库的这个能力，Python中的不少库都是C++的库，然后提供了Python Binding，从而使得在Python中能够调用这些库。最著名的一个例子就是OpenCV了。</p><p>我们可以用mlocate查一下</p><pre class="line-numbers language-shell"><code class="language-shell">(base) jack@jack-Alienware-m15-R3:~$ locate *opencv*.so<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>我们其实就能够看到，Python的opencv库里没有opencv的so，所有的共享库文件都放在了C++源码编译时候安装的位置了，而Python的OpenCV库里本身只是提供了一些OpenCV 的Python Binding代码，真正的功能还得看预编译好的so文件。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211217110010408.png" alt="查询结果"></p><h2 id="3-What-is-PyQt-amp-PySide"><a href="#3-What-is-PyQt-amp-PySide" class="headerlink" title="3. What is PyQt &amp; PySide"></a>3. What is PyQt &amp; PySide</h2><p>我们前面说道Qt是一个C++的应用程序框架，因此PyQt和PySide其实是两种不同的Qt的Python Binding。两者之间的区别在很多时候都只是<code>from xxx.yyy import zzz</code>中的<code>xxx</code>不同，毕竟底层调用的Qt的so都是一样的，Binding 本身只是为Qt编译成so之后里面的API提供Python的类或者函数的签名。</p><p>因此其实我们学习的时候两者任意选一个就行了。但是PyQt由于推出的早，因此资料比较全，而PySide则虽然推出的晚，但是Qt公司的产品，因此两者在学习的时候我们推荐学习PyQt，因为资料会很全。未来PySide也期待他会变得更好。</p><p>注意在未来我们的系列教程中更加关注Qt的Python Binding，而非具体的PyQt、PySide之争。两者在API上的区别正如上面所说，往往是非常小的。</p><p>关于PyQt与PySide其实在技术上的介绍以及结束了，但是我们不禁会想问为什么一个Qt会有PyQt与PySide两套Binding？</p><p>为了解决这个问题，<del>我们就要介绍一下PyQt与PySide的历史了</del>（吃瓜）</p><p>注：以下关于PyQt、PySide的历史参考知乎问题：<a href="https://www.zhihu.com/question/306793447/answer/560109210">如何评价Qt官方推出的Qt for Python(PySide)？</a>中<a href="https://www.zhihu.com/people/phantask93">饶锦蒙的回答</a></p><h3 id="1-PyQt-PyQt5"><a href="#1-PyQt-PyQt5" class="headerlink" title="1. PyQt / PyQt5"></a>1. PyQt / PyQt5</h3><p>PyQt本身Riverbank Computing这家英国公司在2005年以前的时候开发的，那个时候Python刚刚开始流行。</p><p>前面介绍过，Qt身GPL V3协议下的一个项目，因此当使用PyQt程序就被要求需要强制开源，因此PyQt对商业软件的开发就非常不友好。而Qt本身所属的公司在零几年被诺基亚收购之后就成了诺基亚的一个项目。那个时候诺基亚就与Riverbank Computing展开了多轮磋商，希望PyQt能够支持对商业更加友好的LGPL协议，即开源项目在商业软件中被使用了之后，商业软件不需要强制进行开源。因此LGPL对商业更加友好。</p><p>然而PyQt所属的母公司Riverbank Computing十动然拒，最后诺基亚就和Riverbank Computing谈崩了。</p><p>因此从PyQt的角度来看，PyQt是最早支持Qt的Python Binding的库，在发展上也是非常顺利的。</p><p>因此针对不同的Qt版本（Qt4，Qt5），PyQt就有不同的版本支持PyQt4、PyQt5</p><h3 id="2-PySide-Pyside2"><a href="#2-PySide-Pyside2" class="headerlink" title="2. PySide / Pyside2"></a>2. PySide / Pyside2</h3><p>前面我们说到，诺基亚和Riverbank Computing谈崩之后，诺基亚手握Qt的版权，又不忍放过Python中Qt的商业运用，因此2009年一气之下最终决定自己从头单干，重新开发一套Qt的Python Binding，即PySide。</p><p>然而诺基亚后面的故事我们都很熟悉了，2009年PySide发布了同时支持GPL和LGPL的PySide之后，就芜湖了。因此PySide项目就一度搁浅。</p><p>直到2012年，诺基亚把包括PySide在内的所有有关Qt的全部内容卖给了Digia公司。Digia公司在收购了Qt之后，决定大力支持Qt的全方位发展，因此在2014年9月将Qt分拆成一家独立全资子公司The Qt Company。</p><p>虽说加大了投入，该补的课也绕不开，C++的Qt在Digia收购Qt之后就推出了Qt5版本，PySide对Qt5提供支持的计划从2014年才开始筹备，也就是2015年上马的Qt for Python项目，该项目开发的模块命名为PySide2，以表示与老一代PySide的不同。然而反观PyQt，在Qt5出来不到半年时间就支持了PyQt5。</p><p>PySide2在Qt公司和Qt社区开发者的共同努力下，也只在2018年6月才正式发布了第一个版本，稳定性还是个问题。不过从0到1是最难的，后面就容易了。到今天为止，PySide2已经日趋完善，又是亲生的，还有LGPL的加持，今后PySide2有足够的理由变得越来越好。</p><h2 id="4-Which-Version-of-Qt-to-Use？"><a href="#4-Which-Version-of-Qt-to-Use？" class="headerlink" title="4. Which Version of Qt to Use？"></a>4. Which Version of Qt to Use？</h2><p>其实经过前面的介绍，我们也应该知道了Qt5的版本在2012年推出的，Qt4就更早了。虽然最近也推出了Qt6，但是目前市场、社区里的还是Qt5居多，因此我们直接使用Qt5的Python Binding即可。即PyQt5与PySide2</p><p>正如前面所强调的，在未来的文章中我们不会过分强调PyQt5与PySide2，只有在两者API差异比较大的时候我们才会特地的注明到底每一个是怎么样的。</p>]]></content>
      
      
      <categories>
          
          <category> PyQt5 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> GUI开发 </tag>
            
            <tag> PyQt </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PyQt5学习笔记 Chapter 0-Introduction： Part 0.初心</title>
      <link href="/2021/12/16/pyqt5-xue-xi-bi-ji-0-chu-xin/"/>
      <url>/2021/12/16/pyqt5-xue-xi-bi-ji-0-chu-xin/</url>
      
        <content type="html"><![CDATA[<blockquote><p>本文作为PyQt系列学习笔记的第一篇，记录了我为什么要学习PyQt，以及本系列文章的组织形式</p></blockquote><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211216205416019.png" alt="Qt的Python绑定：PySide"></p><h1 id="PyQt5学习笔记：-Part-0-初心"><a href="#PyQt5学习笔记：-Part-0-初心" class="headerlink" title="PyQt5学习笔记： Part 0-初心"></a>PyQt5学习笔记： Part 0-初心</h1><p>作为系列文章的第一篇，本文将讲解我为什么要学习PyQt、本系列文章的目标以及未来文章的组织形势</p><h2 id="1-为什么要学习PyQt"><a href="#1-为什么要学习PyQt" class="headerlink" title="1. 为什么要学习PyQt"></a>1. 为什么要学习PyQt</h2><h3 id="1-What-is-User-Interface"><a href="#1-What-is-User-Interface" class="headerlink" title="1. What is User Interface"></a>1. What is User Interface</h3><p>一般来说，我们写出的程序都是直接运行的，通常与用户只有有限的交互（例如input等待用户输入），这样的程序在程序员看来就以及很可以了。然而从用户的角度来说，这样的程序体验非常差。因为用户无法与程序进行交互。</p><p>而对于提供了用户界面（User Interface）的程序用户体验就会好很多，而且看起来就会非常高级。</p><p>例如下面有了文字用户界面，用户就可以指定不同的参数和选项，从而实现不同的功能。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/Fdedit.png" alt="用户界面之一：图形文字界面文件管理器（Text User Interface File Manager)"></p><h3 id="2-Classification-of-User-Interface"><a href="#2-Classification-of-User-Interface" class="headerlink" title="2. Classification of User Interface"></a>2. Classification of User Interface</h3><p>一般来说，用户界面分为两种，一种是<strong>文字用户界面</strong>，另外一种就是<strong>图形用户界面</strong>。</p><h4 id="1-Text-based-User-Interface-（TUI）"><a href="#1-Text-based-User-Interface-（TUI）" class="headerlink" title="1. Text(-based) User Interface （TUI）"></a>1. Text(-based) User Interface （TUI）</h4><p>文字用户界面即指程序与用户的交互界面就是由文本构成的，即用文本模拟出来的界面。例如我们上面看到的<strong>FreeDOS Edit</strong>。</p><p>很多程序都提看TUI，例如make。有些程序源码中在Makefile中提供了menuconfig规则，我们使用make来利用这个规则进行编译时配置的时候就会看到TUI界面。如下图我们进行内核编译参数配置的时候使用menuconfig。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211216214559133.png" alt="TUI编译内核"></p><p>然后我们就能看到TUI界面</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211216214636804.png" alt="Menuconfig的TUI界面"></p><p>可以看到TUI的界面其实就是把文本背景设置为不同的颜色，以此来表达出界面。</p><h4 id="2-Graphic-based-User-Interface"><a href="#2-Graphic-based-User-Interface" class="headerlink" title="2. Graphic(-based) User Interface"></a>2. Graphic(-based) User Interface</h4><p>图形用户界面则是现在程序的标配，我们在Windows上用的QQ、微信等等都是GUI程序。在Linux上，所谓的桌面也是一个GUI程序。</p><p><img src="https://upload.wikimedia.org/wikipedia/commons/4/48/Linux_Mint_19.1_%22Tessa%22_(Cinnamon).png" alt="Linux Mint的桌面"></p><p>所以话说回来，我们学习PyQt的目的其实就非常明确了，我们就是想要能够做出来一个GUI程序，即类似于QQ、微信这样的程序。</p><h2 id="2-本系列文章的组织形式"><a href="#2-本系列文章的组织形式" class="headerlink" title="2. 本系列文章的组织形式"></a>2. 本系列文章的组织形式</h2><p>本系列文章将从0开始，记录我学习PyQt的过程，同时也将作为PyQt的教程。</p><p>由于需要学习得内容比较多，因此类似于一本书，全书将会分为多个章节。每个章节围绕一个主题进行讲解。</p><p>讲解内容包括Qt Designer、Layout、Signal与Slot等等内容</p>]]></content>
      
      
      <categories>
          
          <category> PyQt5 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> GUI开发 </tag>
            
            <tag> PyQt </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>李宏毅ML2021-Spring-hw1：Covid19 Cases Prediction</title>
      <link href="/2021/12/11/li-hong-yi-ml2021-spring-hw1-covid19-cases-prediction-md/"/>
      <url>/2021/12/11/li-hong-yi-ml2021-spring-hw1-covid19-cases-prediction-md/</url>
      
        <content type="html"><![CDATA[<blockquote><p>本文主要讲解李宏毅ML2021 Spring的Homework1： Covid19 Cases Prediction</p></blockquote><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211207150639649.png" alt="作业一：COVID-19 Cases Prediction"></p><h1 id="李宏毅ML2021-Spring-hw1：Covid19-Cases-Prediction"><a href="#李宏毅ML2021-Spring-hw1：Covid19-Cases-Prediction" class="headerlink" title="李宏毅ML2021-Spring-hw1：Covid19 Cases Prediction"></a>李宏毅ML2021-Spring-hw1：Covid19 Cases Prediction</h1><h2 id="1-Homework-Objectives"><a href="#1-Homework-Objectives" class="headerlink" title="1. Homework Objectives"></a>1. Homework Objectives</h2><p>作业一的目的在于：</p><ul><li>明白如何使用DNN解决Regression问题</li><li>掌握基本的DNN训练技术：调参、特征选择、正则化</li><li>熟悉Pytorch的使用</li></ul><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211207151013750.png" alt="Objectives of Homework1"></p><h2 id="2-Task-Description"><a href="#2-Task-Description" class="headerlink" title="2. Task Description"></a>2. Task Description</h2><p>本次任务要求我们对每日的新冠肺炎的确诊人数进行预测。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211207151406811.png" alt="Task Description"></p><h3 id="1-Survey-Methods"><a href="#1-Survey-Methods" class="headerlink" title="1. Survey Methods"></a>1. Survey Methods</h3><p>数据集的来源是CMU的研究员在社交媒体上发布调查问卷，问卷的内容包括了心理健康状态、流感类似症状疾病患者人数。而后根据受访者居住的地区来监测美国所有州的所有城市的情况。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211211163552345.png" alt="Survey Method"></p><h3 id="2-Data-Inspection"><a href="#2-Data-Inspection" class="headerlink" title="2. Data Inspection"></a>2. Data Inspection</h3><p>本次任务的数据集是csv文件</p><p>在训练数据中，训练数据的csv文件中每一行就是一个example。example的前40维是对于城市的one-hot编码，然后每一个样本会给出来三天的调查情况。</p><p>其中，<strong>前两天的确诊人数是我们的training的一个feature，而第三天的确诊人数则是我们需要预测的label</strong></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211207151633099.png" alt="Training Data Inspection"></p><p>而对于测试数据，则只有前面的feature，没有最后的label，最后我们需要将生成的label以csv文件的形式提交</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211211164704231.png" alt="Testing Data Inspection"></p><h3 id="3-Evaluation-Metrics"><a href="#3-Evaluation-Metrics" class="headerlink" title="3. Evaluation Metrics"></a>3. Evaluation Metrics</h3><p>针对本次任务，使用的衡量标准是Rooted Mean Square Error（RMSE），所以最后在kaggle上得到的分数是越低越好。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211207152032106.png" alt="Evaluation Metric"></p><h3 id="4-Baselines"><a href="#4-Baselines" class="headerlink" title="4. Baselines"></a>4. Baselines</h3><p>这次任务有三个BaseLine</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211207151811659.png" alt="Task Baseline"></p><h2 id="3-My-Solution"><a href="#3-My-Solution" class="headerlink" title="3. My Solution"></a>3. My Solution</h2><p>下面是我关于本次任务的理解和更新</p><h3 id="1-Thoughs"><a href="#1-Thoughs" class="headerlink" title="1. Thoughs"></a>1. Thoughs</h3><p>这个是一个regression的任务，最后的输出是一个数字，所以网络最后一层out_feature是1即可</p><p>然后这些特征之间有可能有一些特征是和确诊人数的确相关的，有一些是和确诊人数完全无关的，甚至是random的，所以这一些特征可能会影响最后的判断，所以后面需要进行特征选择或者让模型自己选出来重要的特征，然后给重要的特征大的权重。类似于attention</p><p>然后可以试试generative的方法，让模型在训练一段时间之后自己生成，即训练判断模型的基础上再生成一个生成模型。生成模型用GAN去生成数据，然后让判断模型去学习。</p><p>最后可以试试不确定性的方法。</p><h3 id="2-Updates"><a href="#2-Updates" class="headerlink" title="2. Updates"></a>2. Updates</h3><h4 id="2021-12-11：完成了基本框架"><a href="#2021-12-11：完成了基本框架" class="headerlink" title="2021-12-11：完成了基本框架"></a>2021-12-11：完成了基本框架</h4><ul><li><strong>进展</strong>：完成了基本的框架的搭建，明天开始训练。完成的框架包括训练代码，网络的定义，dataset和得到提交文件的代码</li></ul><pre class="line-numbers language-shell"><code class="language-shell">(torch) jack@jack-Alienware-m15-R3:/media/jack/JackCode/project/deeplearning/hw1_1-regression$ tree src/src/├── dataset.py├── gen_submission.py├── networks.py├── pathconfig.py└── train.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2021-12-12-update1：训练时loss不下降-cry"><a href="#2021-12-12-update1：训练时loss不下降-cry" class="headerlink" title="2021-12-12 update1：训练时loss不下降:cry:"></a>2021-12-12 update1：训练时loss不下降<span class="github-emoji"><span>😢</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f622.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></h4><ul><li><p><strong>问题</strong>：开始训练，但是训练的时候遇到了一些问题，训练的时候loss一直没有下降，例如下面这张图<img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211212115234546.png" alt="loss没有下降"></p></li><li><p>解决办法：最后经过检查，是batchsize的问题，dataloader的忘记设置batchsize和shuffle了，所以出了问题，这个数据集里单个样本随机波动太大，不像图像是比较通用的，随机波动小，单个example也能学到东西。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211212115505406.png" alt="出问题的代码"><br>最后修改掉之后就可以正常训练了，以后一定要注意小batchsize带来的小样本梯度随机波动问题<br><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211212115710477.png" alt="修改之后的代码"></p><p>最后可以正常训练<img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211212115901900.png" alt="正常开始训练"></p><p>最后在379个epoch时候停下来了，提交一发<img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211212120026808.png" alt="最后的训练结果"></p></li></ul><h4 id="2021-12-12-update2-提交分数起飞-boom"><a href="#2021-12-12-update2-提交分数起飞-boom" class="headerlink" title="2021-12-12 update2: 提交分数起飞:boom:"></a>2021-12-12 update2: 提交分数起飞<span class="github-emoji"><span>💥</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a5.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></h4><ul><li><p><strong>问题</strong>：接上一个问题，完成了之后提交结果，分数很烂</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211212140536683.png" alt="分数很低"></p></li><li><p><strong>解决办法</strong>：最后经过检查，是网络在训练的时候，对训练数据的feature和label都进行了正则化，使其服从均值为0，标准差为1的分布，这样在训练过程中的梯度的分布也会更加均匀。但是这样做的问题就是网络预测的进过标准化之后的label，所以使用测试数据生成结果的时候得到的也是标准化之后的结果，需要加上label的均值和标准差，但是由于是测试数据，所以没有标准差和均值，而<strong>测试数据和训练数据不是独立同分布的</strong>。所以不能直接加上测试数据的标准差和方差</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211212143542126.png" alt="修改前的错误代码，对label也做了标准化"></p><p>修改之后不给label做标准化，再训练一次然后提交</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211212151141477.png" alt="修改后不对label做标准化"></p><p>再进行一次训练</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211212151509152.png" alt="修改后的训练"></p><p>最后提交的结果，相比于一开始有了很大的进步</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211212151837238.png" alt="提交结果"></p></li></ul><h4 id="2021-12-12-update3-Simple-baseline-triangular-flag-on-post"><a href="#2021-12-12-update3-Simple-baseline-triangular-flag-on-post" class="headerlink" title="2021-12-12 update3:  Simple baseline:triangular_flag_on_post:"></a>2021-12-12 update3:  Simple baseline<span class="github-emoji"><span>🚩</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6a9.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></h4><p>大胜利<span class="github-emoji"><span>🎉</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f389.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p><ul><li><p><strong>思路</strong>：尝试了一下仅仅使用前两天的确诊人数作为feature来训练，最后提升巨大，由于我在代码里预留了dim2use，所以直接加上前两的确诊人数的feature和州，一共42个dimension再来一次</p><p><strong>所以前面的猜想确实成立，即存在一些和确诊人数完全无关的特征，这些特征会极大地影响模型的表现</strong></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211212155208705.png" alt="加上前两天的确诊人数"></p></li><li><p><strong>效果</strong>：</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211212155232450.png" alt="巨大的进步"></p></li></ul><h4 id="2021-12-12-update4-特征选择的思考-Medium-Baseline-triangular-flag-on-post"><a href="#2021-12-12-update4-特征选择的思考-Medium-Baseline-triangular-flag-on-post" class="headerlink" title="2021-12-12 update4: 特征选择的思考 Medium Baseline :triangular_flag_on_post:"></a>2021-12-12 update4: 特征选择的思考 Medium Baseline <span class="github-emoji"><span>🚩</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6a9.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></h4><ul><li><p><strong>想法</strong>：因为在前面使用了州和前两天，得到的分数非常的高，所以利用了特征选择的手段，试了一下不同的特征，得到的结果如下</p><ul><li><p><strong>使用了州和前两天</strong></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211212163655980.png" alt="使用州和前两天"></p></li><li><p><strong>使用了得分前15的特征</strong></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211212163737608.png" alt="得分前15的特征"></p></li><li><p><strong>使用了得分大于500的特征</strong></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211212163814031.png" alt="得分大于500的特征"></p></li><li><p><strong>只使用前两天得病的人数</strong></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211212163858827.png" alt="只使用前两天得病的人数"></p></li></ul><p>而特征选择时候前90个特征的得分如下，可以看到，前两个特征（前两天确诊的人数）的分数是远远大于剩下的特征，也就难怪训练出来最后一个的得分最高</p><pre class="line-numbers language-shell"><code class="language-shell">                    Specs          Score76       tested_positive.1  148069.65827858         tested_positive   69603.87259143            hh_cmnty_cli    9235.49209461          hh_cmnty_cli.1    9209.01955879          hh_cmnty_cli.2    9097.37517244          nohh_cmnty_cli    8395.42130062        nohh_cmnty_cli.1    8343.25592780        nohh_cmnty_cli.2    8208.17643541                     cli    6388.90684959                   cli.1    6374.54800077                   cli.2    6250.00870242                     ili    5998.92288060                   ili.1    5937.58857678                   ili.2    5796.94767293      worried_finances.2     833.61319175      worried_finances.1     811.91646057        worried_finances     788.07693188        public_transit.2     686.73653970        public_transit.1     681.56290252          public_transit     678.83478984                  shop.2     561.76405166                  shop.1     553.87672748                    shop     546.5533950                       id     328.68231192    worried_become_ill.2     208.12264718                      MA     205.67260374    worried_become_ill.1     203.47307256      worried_become_ill     199.19546186            spent_time.2     193.92668968            spent_time.1     188.76375150              spent_time     183.14522921                      MS     164.45080730                      OK     160.7761357                       CT     146.60954017                      MD     123.5469725                       CA     122.36156229                      OH      92.60376324                      NV      86.48058110                      ID      85.60427553                 anxious      83.53223222                      MO      80.57186136                      UT      76.09237971               anxious.1      75.0735223                       AZ      72.80367685            restaurant.2      71.04775467            restaurant.1      70.08674323                      NE      69.08267649              restaurant      69.02759335                      TX      68.60934789               anxious.2      64.5877442                       AK      64.39624232                      PA      63.0960936                       CO      47.44609615                      KY      43.15197213                      IA      42.0966008                       FL      39.97677827                      NY      38.26168438                      WA      35.19877531                      OR      30.42481982  travel_outside_state.2      29.42480819                      MI      27.61129464  travel_outside_state.1      27.47727446    travel_outside_state      25.78825114                      KS      18.69999455           felt_isolated      18.34572833                      RI      18.22380073         felt_isolated.1      18.05009891         felt_isolated.2      17.89572034                      SC      15.17410045            wearing_mask      13.10686263          wearing_mask.1      11.66081520                      MN      11.13468587           large_event.2      10.9953231                       AL      10.91595281          wearing_mask.2      10.42354439                      WV       9.40700369           large_event.1       9.13166925                      NJ       8.63782437                      VA       8.32844951             large_event       7.4492279                       GA       7.30044783     work_outside_home.2       4.17440465     work_outside_home.1       3.88715654               depressed       3.83787911                      IL       3.83412347       work_outside_home       3.28351372             depressed.1       2.96797128                      NC       2.8773594                       AR       2.54622390             depressed.2       2.362492Int64Index([76, 58, 43, 61, 79, 44, 62, 80, 41, 59, 77, 42, 60, 78, 93, 75, 57,            88, 70, 52, 84, 66, 48,  0, 92, 18, 74, 56, 86, 68, 50, 21, 30,  7,            17,  5, 29, 24, 10, 53, 22, 36, 71,  3, 85, 67, 23, 49, 35, 89,  2,            32,  6, 15, 13,  8, 27, 38, 31, 82, 19, 64, 46, 14, 55, 33, 73, 91,            34, 45, 63, 20, 87,  1, 81, 39, 69, 25, 37, 51,  9, 83, 65, 54, 11,            47, 72, 28,  4, 90],           dtype='int64')<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="2021-12-12-update5-大进步-tada"><a href="#2021-12-12-update5-大进步-tada" class="headerlink" title="2021-12-12 update5: 大进步:tada:"></a>2021-12-12 update5: 大进步<span class="github-emoji"><span>🎉</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f389.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></h4><ul><li><p><strong>思路</strong>：因为前面实验了一下使用不同的特征，发现只有前两个特征，所以我感觉特征选择可能走到了头，需要新的思路来进一步提升模型的表现。因此从模型本身下手，更换了网络模型，从助教的baseline换成了残差模型，同样还是只有两个特征</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211212170623668.png" alt="网络模型"></p></li><li><p><strong>效果</strong>：最后的效果的提升还是巨大的</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211212170744439.png" alt="提交后的结果"></p></li></ul><h4 id="2021-12-12-update6-关于优化器"><a href="#2021-12-12-update6-关于优化器" class="headerlink" title="2021-12-12 update6: 关于优化器"></a>2021-12-12 update6: 关于优化器</h4><ul><li><p><strong>思路</strong>：前面改了一下网络结构，使得精度有了不错的提升。我在特征选择后面又想到了一个思路，就是换一个优化器，所以在实验完网络结构之后我又实验了一下优化器，看看优化器会不会对训练又帮助，所以把SGD换成了AdamW，AdamW比Adam少了对bias的求导，所以方向避免出错。</p><p>换优化器其实我也是实验了不少次，因为使用SGD的时候，不管超参数怎么变，总会在51个epoch的时候出现一次最优值。虽然有的超参数经过比较长的epoch之后会有新的最优值，但是51这个epoch常常会出现，不管我怎么变超参数。</p><p>所以我怀疑51个epoch的时候对于SGD优化器，已经到了一个比较wide的谷底，这个时候很难跳出去，所以有的时候会直接在这里停下来。</p><p>作为弥补我换了一个优化器，换成了AdamW，因为AdamW跳出saddle point的能力要强不少</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211212173038313.png" alt="一些训练轮次"></p></li><li><p><strong>结果</strong>：更换优化器之后，训练轮次要长很多，而且最初的十多个epoch会有震荡，还在loss 空间的高处</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/train_log.png" alt="AdamW的训练过程"></p><p>上面的图其实看不太出来，因为横轴30000多个step，但是SGD的训练图在开始部分是直线下冲的</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/train_log1.png" alt="train_log1"></p><p>最后的结果是成功冲进了1分以内的误差</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211212173834843.png" alt="1分以内"></p></li></ul><h4 id="2012-12-12-update7-关于正则化"><a href="#2012-12-12-update7-关于正则化" class="headerlink" title="2012-12-12 update7: 关于正则化"></a>2012-12-12 update7: 关于正则化</h4><ul><li><p><strong>思路</strong>：前面在想的时候其实还想到了第三个思路，就是在网络中加入正则化方法，一个是加入dropout，一个是加入batch normalization，因为目前这两个是公认的不错的的正则化方法。而使用正则化方法能够帮助加速训练、提高收敛精度。然而在训练时候却发现不太对劲。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211212175933758.png" alt="不太对劲的正则化"></p><p>可以看到，使用batch norm 和 dropout，收敛速度不降反升。这个和大家的公认有所差别，我百思不得其解<span class="github-emoji"><span>😕</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f615.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p><p>最后怀疑是AdamW优化器的问题。因为AdamW优化器中有限制梯度的项，而dropout会mask掉一些神经元，导致梯度在这里为0，而batch norm则是炸平梯度空间。所以怀疑问题出在这里，优化器换回SGD，好家伙，这个速度，比纯SGD快多了（下面的图第一个日志写错了，应该是batch norm）</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211212180324925.png" alt="使用AdamW的训练记录"></p></li></ul><h4 id="2021-12-13-update1-Strong-Network，More-Complex-data"><a href="#2021-12-13-update1-Strong-Network，More-Complex-data" class="headerlink" title="2021-12-13 update1: Strong Network，More Complex data"></a>2021-12-13 update1: Strong Network，More Complex data</h4><ul><li><p><strong>问题</strong>：昨天在最后使用adam优化器和residual模块的配合，训练阶段使用特征选择选出来的前两天的确诊人数，一共2个dimension的feature作为输入进行训练，最后得到的精度0.98左右。昨天的炼丹就到此为止了。昨天晚上在复盘的时候想到，老师上课讲过的模型训练攻略里说的内容。</p><ol><li>而在复盘的时候想起来，昨天的炼丹过程其实提升最大的有两段，第一段就是在一开始使用助教的baseline的时候，使用特征抽取选取了前两天的特征，loss在training data上的损失就收敛到1.x左右了。可是使用baseline在这之后不管怎么样都始终无法进入到0.x的大关。而关于Optimization中也实验过了正则化、调参、换优化器等等手段。但是模型的表现还是没有下降。</li><li>第二个阶段就是换了residual的模型，性能立马又有了提升。但是同样的，residual的模型各种optimization的方法都已经试过了，最后还是卡在了0.98左右。</li></ol><p>最后想想老师讲的课，突然明白，在一开始的时候，model的能力不够强，所以没有办法学好14个重要特征。因此选择前两天的确诊人数作为feature，性能有了很大的提升。这个时候的问题可能是baseline model 的model bias了，即模型的能力不够强。后来歪打正着换了一个模型，同样的数据和参数下训练，性能立马有了提升，所以确信是baseline模型的问题。</p><p>可是后来不管怎么调，residual的模型性能也上不去了。后来其实我也试了一下wide的模型，wide + residual的模型，最后性能都不是很好。这个时候我突然想起来，因为baseline里面是两个feature表现最好，所以我就直接用了两个dimension的feature来train residual的一系列model。后来换model单纯的只是希望能够得到能力更强的model。</p><p>但是问题却在于，能力更强的model确实能够得到更好的performance，但是我并不知道residual是否达到了他的上限，即有可能是我只用了前两天的确诊人数，这样的training data对residual太弱了，他完全学有余力。</p><p>刚好我也没有像baseline一样进行特征选择的测试，所以我其实并不知道residual的model是否达到他的上限了。所以今天我试着使用了更多的training data，即使用了所有大于5000分的数据，一共14个维度</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211213003527934.png" alt="用更多的数据来训练residual model"></p></li><li><p><strong>结果</strong>：最后经过训练之后提交，大进步<span class="github-emoji"><span>🎉</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f389.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211213003658575.png" alt="使用14个feature训练的结果"></p></li></ul><h4 id="2021-12-13-update2-temp-final"><a href="#2021-12-13-update2-temp-final" class="headerlink" title="2021-12-13 update2: temp final"></a>2021-12-13 update2: temp final</h4><p>搞到现在，做了一下，现在最优的成绩是下面的，基本上就是残差模块的数量问题，关于伪标签其实我感觉如果用test的data来做的话，就会有过拟合test数据的嫌疑。所以目前想的是等用generative的方法来做，目前暂时就先到这里</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211213015919490.png" alt="目前的最优成绩"></p><h2 id="4-My-Codes"><a href="#4-My-Codes" class="headerlink" title="4. My Codes"></a>4. My Codes</h2><p>下面是我的代码</p><h3 id="1-代码结构"><a href="#1-代码结构" class="headerlink" title="1. 代码结构"></a>1. 代码结构</h3><p>整个代码的结构如下</p><pre class="line-numbers language-shell"><code class="language-shell">(torch) jack@jack-Alienware-m15-R3:/media/jack/JackCode/project/deeplearning/hw1_1-regression$ tree -d -L 2.├── checkpoint│&nbsp;&nbsp; ├── Baseline│&nbsp;&nbsp; ├── DeeperNet│&nbsp;&nbsp; ├── DeeperNormalizedNet│&nbsp;&nbsp; ├── OtherNet│&nbsp;&nbsp; └── WideNet├── data├── log│&nbsp;&nbsp; ├── Baseline│&nbsp;&nbsp; ├── DeeperNet│&nbsp;&nbsp; ├── DeeperNormalizedNet│&nbsp;&nbsp; ├── OtherNet│&nbsp;&nbsp; └── WideNet├── src│&nbsp;&nbsp; ├── config│&nbsp;&nbsp; └── __pycache__└── submission    ├── Baseline    ├── DeeperNet    ├── DeeperNormalizedNet    ├── OtherNet    └── WideNet22 directories<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其中:</p><ul><li><p>src里都是源代码</p></li><li><p>checkpoint、log和submission都如其名</p></li><li><p>每次进行训练的时候，都会根据模型（网络）名创建一个文件夹，在里面放对应的训练日志、提交结果、参数文件等等。以log为例，每次得到的结果都是根据日期和时间创建的文件夹。只有正确训练结束才会三个文件，分别为训练摘要、训练图像以及训练的过程中的loss。</p><pre class="line-numbers language-shell"><code class="language-shell">(torch) jack@jack-Alienware-m15-R3:/media/jack/JackCode/project/deeplearning/hw1_1-regression$ tree log/DeeperNet/log/DeeperNet/├── 2021-12-12 16_52_47├── 2021-12-12 16_53_13├── 2021-12-12 16_53_38├── 2021-12-12 16_54_21├── 2021-12-12 16_55_03│&nbsp;&nbsp; └── message.txt├── 2021-12-12 16_56_25│&nbsp;&nbsp; └── message.txt├── 2021-12-12 16_56_50│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log1.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-12 17_12_44├── 2021-12-12 17_12_57│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-12 17_16_00│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-12 17_16_56│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-12 17_17_49│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-12 17_20_12├── 2021-12-12 17_20_34│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-12 17_41_30│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-12 18_17_42│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-12 18_21_58├── 2021-12-12 18_22_24│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-12 18_28_27│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-12 19_17_44│&nbsp;&nbsp; └── message.txt├── 2021-12-12 19_18_15│&nbsp;&nbsp; └── message.txt├── 2021-12-12 19_18_42│&nbsp;&nbsp; └── message.txt├── 2021-12-12 19_19_12│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-12 19_20_16│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-12 19_25_46│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-12 19_27_36│&nbsp;&nbsp; └── message.txt├── 2021-12-12 19_28_20│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-12 19_33_37│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-12 19_37_51│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-12 19_42_24│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-12 19_48_44│&nbsp;&nbsp; └── message.txt├── 2021-12-12 19_48_59│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-12 19_52_28│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-12 19_56_30│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-12 20_05_07├── 2021-12-12 20_05_46│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-12 20_10_02│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-12 20_12_20│&nbsp;&nbsp; └── message.txt├── 2021-12-12 20_13_33│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-12 20_16_43│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-12 20_21_37│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-13 00_46_42│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-13 00_59_08│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-13 01_34_47│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-13 01_39_11│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-13 01_48_12│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl├── 2021-12-13 01_51_22│&nbsp;&nbsp; ├── message.txt│&nbsp;&nbsp; ├── train_log.png│&nbsp;&nbsp; └── train_val.loss.pkl└── 2021-12-13 01_55_10    ├── message.txt    ├── train_log.png    └── train_val.loss.pkl48 directories, 104 files<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>直接提交submission中生成的文件即可</p></li></ul><h3 id="2-src中文件作用"><a href="#2-src中文件作用" class="headerlink" title="2. src中文件作用"></a>2. src中文件作用</h3><p>src中有这些文件</p><pre class="line-numbers language-shell"><code class="language-shell">(torch) jack@jack-Alienware-m15-R3:/media/jack/JackCode/project/deeplearning/hw1_1-regression$ tree src/ -L 1src/├── config├── dataset.py├── feature_selection.py├── gen_submission.py├── networks.py├── pathconfig.py├── __pycache__└── train.py2 directories, 6 files<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其中：</p><ul><li>train是训练代码</li><li>gen_submission是生成结果的代码</li><li>networks是所有的网络的代码</li><li>feature_selection 是做特征工程的时候代码</li></ul><p>具体的代码在下面给出来</p><h3 id="3-data中的数据"><a href="#3-data中的数据" class="headerlink" title="3. data中的数据"></a>3. data中的数据</h3><p>data中需要把训练、测试数据放进去就行了</p><pre class="line-numbers language-shell"><code class="language-shell">(torch) jack@jack-Alienware-m15-R3:/media/jack/JackCode/project/deeplearning/hw1_1-regression$ tree data/data/├── covid.test.csv├── covid.train.csv└── sampleSubmission.csv0 directories, 3 files<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其实最后只会用到test 和 train</p><h3 id="4-代码"><a href="#4-代码" class="headerlink" title="4. 代码"></a>4. 代码</h3><p>用的时候要注意，gen_submission要改参数文件的路径。此外自己想写网络的话需要继承_NetworkBase，然后重写dtype</p><p>训练网络和生成结果的时候一种网络一个函数即可</p><h4 id="1-pathconfig-py"><a href="#1-pathconfig-py" class="headerlink" title="1. pathconfig.py"></a>1. pathconfig.py</h4><p>自动决定所有的路径</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> sys<span class="token keyword">from</span> pathlib <span class="token keyword">import</span> Path<span class="token keyword">from</span> colorama <span class="token keyword">import</span> Fore<span class="token punctuation">,</span> Style<span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">:</span><span class="token operator">=</span>Path<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">.</span>resolve<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>parent<span class="token punctuation">)</span><span class="token punctuation">.</span>__str__<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token keyword">in</span> sys<span class="token punctuation">.</span>path<span class="token punctuation">:</span>    sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>append<span class="token punctuation">(</span>p<span class="token punctuation">.</span>__str__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">green</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> str<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> f<span class="token string">"{Fore.GREEN}{s}{Fore.RESET}"</span><span class="token keyword">def</span> <span class="token function">red</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> str<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> f<span class="token string">"{Fore.RED}{s}{Fore.RESET}"</span><span class="token keyword">def</span> <span class="token function">yellow</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> str<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> f<span class="token string">"{Fore.YELLOW}{s}{Fore.RESET}"</span><span class="token keyword">class</span> <span class="token class-name">Paths</span><span class="token punctuation">:</span>    base_path<span class="token punctuation">:</span> Path <span class="token operator">=</span> Path<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">.</span>resolve<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>parents<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>    src_path<span class="token punctuation">:</span> Path <span class="token operator">=</span> base_path<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">"src"</span><span class="token punctuation">)</span>    log_path<span class="token punctuation">:</span> Path <span class="token operator">=</span> base_path<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">"log"</span><span class="token punctuation">)</span>    data_path<span class="token punctuation">:</span> Path <span class="token operator">=</span> base_path<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">)</span>    checkpoint_path<span class="token punctuation">:</span> Path <span class="token operator">=</span> base_path<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">"checkpoint"</span><span class="token punctuation">)</span>    submission_path<span class="token punctuation">:</span> Path <span class="token operator">=</span> base_path<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">"submission"</span><span class="token punctuation">)</span>    train_path<span class="token punctuation">:</span> Path <span class="token operator">=</span> data_path <span class="token operator">/</span> <span class="token string">"covid.train.csv"</span>    test_path<span class="token punctuation">:</span> Path <span class="token operator">=</span> data_path <span class="token operator">/</span> <span class="token string">"covid.test.csv"</span>    config_path<span class="token punctuation">:</span> Path <span class="token operator">=</span> src_path <span class="token operator">/</span> <span class="token string">"config"</span><span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> Paths<span class="token punctuation">.</span>__dict__<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> key<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">"_path"</span><span class="token punctuation">)</span> <span class="token operator">and</span> <span class="token operator">not</span> value<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        value<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    pc <span class="token operator">=</span> Paths<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>pc<span class="token punctuation">.</span>base_path<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2-feature-selection-py"><a href="#2-feature-selection-py" class="headerlink" title="2. feature_selection.py"></a>2. feature_selection.py</h4><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd<span class="token keyword">from</span> sklearn <span class="token keyword">import</span> preprocessing<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>feature_selection <span class="token keyword">import</span> SelectKBest<span class="token punctuation">,</span> f_regression<span class="token keyword">from</span> pathconfig <span class="token keyword">import</span> Pathsdata <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>Paths<span class="token punctuation">.</span>train_path<span class="token punctuation">)</span>x<span class="token punctuation">,</span> y <span class="token operator">=</span> data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>x <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> x<span class="token punctuation">.</span>min<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>max<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> x<span class="token punctuation">.</span>min<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># 根据得分函数计算出来的分数选取前五个</span>bestfeatures <span class="token operator">=</span> SelectKBest<span class="token punctuation">(</span>score_func<span class="token operator">=</span>f_regression<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>fit <span class="token operator">=</span> bestfeatures<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span>dfscores <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>fit<span class="token punctuation">.</span>scores_<span class="token punctuation">)</span>dfcolumns <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>x<span class="token punctuation">.</span>columns<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#concat two dataframes for better visualization </span>featureScores <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>dfcolumns<span class="token punctuation">,</span>dfscores<span class="token punctuation">]</span><span class="token punctuation">,</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>featureScores<span class="token punctuation">.</span>columns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Specs'</span><span class="token punctuation">,</span><span class="token string">'Score'</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true">#naming the dataframe columns</span>pd<span class="token punctuation">.</span>set_option<span class="token punctuation">(</span><span class="token string">'display.max_rows'</span><span class="token punctuation">,</span> None<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>featureScores<span class="token punctuation">.</span>nlargest<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">,</span><span class="token string">'Score'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#print 15 best features</span><span class="token keyword">print</span><span class="token punctuation">(</span>featureScores<span class="token punctuation">.</span>nlargest<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">,</span> <span class="token string">"Score"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span>data<span class="token punctuation">.</span>columns<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="3-dataset-py"><a href="#3-dataset-py" class="headerlink" title="3. dataset.py"></a>3. dataset.py</h4><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> pickle<span class="token keyword">import</span> random<span class="token keyword">import</span> typing<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd<span class="token keyword">import</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">as</span> data<span class="token keyword">from</span> pathconfig <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">class</span> <span class="token class-name">CovidDataset</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> split<span class="token operator">=</span><span class="token string">"train"</span><span class="token punctuation">,</span> dim2use<span class="token punctuation">:</span> typing<span class="token punctuation">.</span>Iterable<span class="token punctuation">[</span>int<span class="token punctuation">]</span><span class="token operator">=</span>None<span class="token punctuation">,</span> val_ratio<span class="token punctuation">:</span> float<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> None<span class="token punctuation">:</span>        super<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        dim2use <span class="token operator">=</span> range<span class="token punctuation">(</span><span class="token number">93</span><span class="token punctuation">)</span> <span class="token keyword">if</span> dim2use <span class="token keyword">is</span> None <span class="token keyword">else</span> dim2use        <span class="token keyword">assert</span> split <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">"train"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">,</span> <span class="token string">"val"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> red<span class="token punctuation">(</span>f<span class="token string">"无效的数据集类别：{split}"</span><span class="token punctuation">)</span>        <span class="token keyword">assert</span> <span class="token punctuation">(</span>t<span class="token punctuation">:</span><span class="token operator">=</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>dim2use<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">93</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>all<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> red<span class="token punctuation">(</span>f<span class="token string">"无效的feature dimension， 最大只有 93 维(0-92), dim2use={dim2use[t]} > 92"</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># read file</span>        self<span class="token punctuation">.</span>split<span class="token punctuation">:</span> str <span class="token operator">=</span> split        <span class="token keyword">if</span> self<span class="token punctuation">.</span>split <span class="token operator">==</span> <span class="token string">"test"</span><span class="token punctuation">:</span>            raw_csv<span class="token punctuation">:</span> np<span class="token punctuation">.</span>ndarray <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token punctuation">:</span><span class="token operator">=</span>pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>Paths<span class="token punctuation">.</span>test_path<span class="token punctuation">,</span> header<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> index_col<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>float<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            raw_csv<span class="token punctuation">:</span> np<span class="token punctuation">.</span>ndarray <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>Paths<span class="token punctuation">.</span>train_path<span class="token punctuation">,</span> header<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> index_col<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>float<span class="token punctuation">)</span><span class="token punctuation">.</span>to_numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> <span class="token number">0</span> <span class="token operator">&lt;</span> val_ratio <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">:</span>                val_idx<span class="token punctuation">:</span> typing<span class="token punctuation">.</span>List<span class="token punctuation">[</span>int<span class="token punctuation">]</span> <span class="token operator">=</span> random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>population<span class="token operator">=</span>range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>raw_csv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> k<span class="token operator">=</span>int<span class="token punctuation">(</span>val_ratio <span class="token operator">*</span> len<span class="token punctuation">(</span>raw_csv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                train_idx<span class="token punctuation">:</span> typing<span class="token punctuation">.</span>List<span class="token punctuation">[</span>int<span class="token punctuation">]</span> <span class="token operator">=</span> list<span class="token punctuation">(</span>set<span class="token punctuation">(</span>range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>raw_csv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> set<span class="token punctuation">(</span>val_idx<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token keyword">if</span> Paths<span class="token punctuation">.</span>config_path<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">"train_val.pkl"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                    <span class="token keyword">print</span><span class="token punctuation">(</span>yellow<span class="token punctuation">(</span><span class="token string">"覆盖train_val.pkl"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token keyword">with</span> open<span class="token punctuation">(</span>Paths<span class="token punctuation">.</span>config_path<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">"train_val.pkl"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>                    pickle<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>obj<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"train"</span><span class="token punctuation">:</span>train_idx<span class="token punctuation">,</span> <span class="token string">"val"</span><span class="token punctuation">:</span>val_idx<span class="token punctuation">}</span><span class="token punctuation">,</span> file<span class="token operator">=</span>f<span class="token punctuation">)</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                <span class="token keyword">try</span><span class="token punctuation">:</span>                    <span class="token keyword">with</span> open<span class="token punctuation">(</span>Paths<span class="token punctuation">.</span>config_path<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">"train_val.pkl"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>                        p <span class="token operator">=</span> pickle<span class="token punctuation">.</span>load<span class="token punctuation">(</span>file<span class="token operator">=</span>f<span class="token punctuation">)</span>                        train_idx<span class="token punctuation">:</span> typing<span class="token punctuation">.</span>List<span class="token punctuation">[</span>int<span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token punctuation">[</span><span class="token string">"train"</span><span class="token punctuation">]</span>                        val_idx<span class="token punctuation">:</span> typing<span class="token punctuation">.</span>List<span class="token punctuation">[</span>int<span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token punctuation">[</span><span class="token string">"val"</span><span class="token punctuation">]</span>                <span class="token keyword">except</span> FileNotFoundError<span class="token punctuation">:</span>                    <span class="token keyword">assert</span> <span class="token boolean">False</span><span class="token punctuation">,</span> red<span class="token punctuation">(</span>f<span class="token string">"不存在train_validation的config文件，请先指定val_ratio生成train_val的config"</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> split <span class="token operator">==</span> <span class="token string">"val"</span><span class="token punctuation">:</span>                raw_csv <span class="token operator">=</span> raw_csv<span class="token punctuation">[</span>val_idx<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                raw_csv <span class="token operator">=</span> raw_csv<span class="token punctuation">[</span>train_idx<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>        <span class="token comment" spellcheck="true"># standard</span>        self<span class="token punctuation">.</span>mean <span class="token operator">=</span> raw_csv<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>std <span class="token operator">=</span> raw_csv<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>std<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>        raw_csv<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>raw_csv<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>mean<span class="token punctuation">)</span> <span class="token operator">/</span> self<span class="token punctuation">.</span>std        <span class="token keyword">if</span> self<span class="token punctuation">.</span>split <span class="token operator">!=</span> <span class="token string">"test"</span><span class="token punctuation">:</span>            self<span class="token punctuation">.</span>data<span class="token punctuation">:</span> np<span class="token punctuation">.</span>ndarray <span class="token operator">=</span> raw_csv<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> dim2use<span class="token punctuation">]</span>            self<span class="token punctuation">.</span>label<span class="token punctuation">:</span> np<span class="token punctuation">.</span>ndarray <span class="token operator">=</span> raw_csv<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            self<span class="token punctuation">.</span>data<span class="token punctuation">:</span> np<span class="token punctuation">.</span>ndarray <span class="token operator">=</span> raw_csv<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> dim2use<span class="token punctuation">]</span>        <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> int<span class="token punctuation">:</span>        <span class="token keyword">return</span> len<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span>        <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> index<span class="token punctuation">:</span> int<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> typing<span class="token punctuation">.</span>Tuple<span class="token punctuation">[</span>np<span class="token punctuation">.</span>ndarray<span class="token punctuation">]</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>split <span class="token operator">!=</span> <span class="token string">"test"</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>label<span class="token punctuation">[</span>index<span class="token punctuation">]</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># cd = CovidDataset(split="train", val_ratio=0.1)</span>    <span class="token comment" spellcheck="true"># cd = CovidDataset(split="val", dim2use=range(10))</span>    <span class="token comment" spellcheck="true"># cd = CovidDataset(split="test", dim2use=range(10))</span>    cd <span class="token operator">=</span> CovidDataset<span class="token punctuation">(</span>split<span class="token operator">=</span><span class="token string">"train"</span><span class="token punctuation">,</span> dim2use<span class="token operator">=</span>None<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>cd<span class="token punctuation">.</span>data<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>    <span class="token keyword">for</span> x<span class="token punctuation">,</span> y <span class="token keyword">in</span> cd<span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="4-networks-py"><a href="#4-networks-py" class="headerlink" title="4. networks.py"></a>4. networks.py</h4><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn<span class="token keyword">class</span> <span class="token class-name">_NetworkBase</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        super<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>dtype <span class="token operator">=</span> None        self<span class="token punctuation">.</span>net<span class="token punctuation">:</span> nn<span class="token punctuation">.</span>Module <span class="token operator">=</span> None<span class="token keyword">class</span> <span class="token class-name">Baseline</span><span class="token punctuation">(</span>_NetworkBase<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_features<span class="token punctuation">:</span>int<span class="token punctuation">)</span><span class="token punctuation">:</span>        super<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>net <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span>in_features<span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span>        <span class="token keyword">for</span> name<span class="token punctuation">,</span> son <span class="token keyword">in</span> self<span class="token punctuation">.</span>net<span class="token punctuation">.</span>named_children<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            weight<span class="token punctuation">:</span> nn<span class="token punctuation">.</span>parameter<span class="token punctuation">.</span>Parameter            <span class="token keyword">if</span> <span class="token punctuation">(</span>weight<span class="token punctuation">:</span><span class="token operator">=</span>getattr<span class="token punctuation">(</span>son<span class="token punctuation">,</span> <span class="token string">"weight"</span><span class="token punctuation">,</span> None<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token operator">not</span> None<span class="token punctuation">:</span>                self<span class="token punctuation">.</span>dtype<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>dtype <span class="token operator">=</span> weight<span class="token punctuation">.</span>dtype        <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment" spellcheck="true"># x: [batch, channel]</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>net<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">DeeperNet</span><span class="token punctuation">(</span>_NetworkBase<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_features<span class="token punctuation">:</span> int<span class="token punctuation">)</span><span class="token punctuation">:</span>        super<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>input_trainsform <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span>in_features<span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>LeakyReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true"># nn.BatchNorm1d(num_features=128),</span>            <span class="token comment" spellcheck="true"># nn.Dropout(),</span>        <span class="token punctuation">)</span>        self<span class="token punctuation">.</span>residual_block1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>LeakyReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true"># nn.BatchNorm1d(num_features=64),</span>            <span class="token comment" spellcheck="true"># nn.Dropout(),</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>LeakyReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true"># nn.BatchNorm1d(num_features=128),</span>            <span class="token comment" spellcheck="true"># nn.Dropout(),</span>        <span class="token punctuation">)</span>        self<span class="token punctuation">.</span>residual_block2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>LeakyReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true"># nn.BatchNorm1d(num_features=64),</span>            <span class="token comment" spellcheck="true"># nn.Dropout(),</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>LeakyReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true"># nn.BatchNorm1d(num_features=128),</span>            <span class="token comment" spellcheck="true"># nn.Dropout(),</span>        <span class="token punctuation">)</span>        self<span class="token punctuation">.</span>residual_block3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>LeakyReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true"># nn.BatchNorm1d(num_features=64),</span>            <span class="token comment" spellcheck="true"># nn.Dropout(),</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>LeakyReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true"># nn.BatchNorm1d(num_features=128),</span>            <span class="token comment" spellcheck="true"># nn.Dropout(),</span>        <span class="token punctuation">)</span>        self<span class="token punctuation">.</span>residual_block4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>LeakyReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true"># nn.BatchNorm1d(num_features=64),</span>            <span class="token comment" spellcheck="true"># nn.Dropout(),</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>LeakyReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true"># nn.BatchNorm1d(num_features=128),</span>            <span class="token comment" spellcheck="true"># nn.Dropout(),</span>        <span class="token punctuation">)</span>        self<span class="token punctuation">.</span>output <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true"># nn.LeakyReLU(),</span>            <span class="token comment" spellcheck="true"># nn.Linear(in_features=32, out_features=1)</span>        <span class="token punctuation">)</span>        <span class="token keyword">for</span> name<span class="token punctuation">,</span> son <span class="token keyword">in</span> self<span class="token punctuation">.</span>input_trainsform<span class="token punctuation">.</span>named_children<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            weight<span class="token punctuation">:</span> nn<span class="token punctuation">.</span>parameter<span class="token punctuation">.</span>Parameter            <span class="token keyword">if</span> <span class="token punctuation">(</span>weight<span class="token punctuation">:</span><span class="token operator">=</span>getattr<span class="token punctuation">(</span>son<span class="token punctuation">,</span> <span class="token string">"weight"</span><span class="token punctuation">,</span> None<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token operator">not</span> None<span class="token punctuation">:</span>                self<span class="token punctuation">.</span>dtype<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>dtype <span class="token operator">=</span> weight<span class="token punctuation">.</span>dtype        <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> raw_x<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">:</span>        x <span class="token operator">=</span> self<span class="token punctuation">.</span>input_trainsform<span class="token punctuation">(</span>raw_x<span class="token punctuation">)</span>        y1 <span class="token operator">=</span> self<span class="token punctuation">.</span>residual_block1<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> x        y2 <span class="token operator">=</span> self<span class="token punctuation">.</span>residual_block2<span class="token punctuation">(</span>y1<span class="token punctuation">)</span> <span class="token operator">+</span> y1         <span class="token comment" spellcheck="true"># y3 = self.residual_block3(y2) + y2</span>        <span class="token comment" spellcheck="true"># y4 = self.residual_block4(y3) + y3</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>output<span class="token punctuation">(</span>y2<span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">DeeperNormalizedNet</span><span class="token punctuation">(</span>_NetworkBase<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_features<span class="token punctuation">:</span> int<span class="token punctuation">)</span><span class="token punctuation">:</span>        super<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>input_trainsform <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span>in_features<span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span>        self<span class="token punctuation">.</span>residual_block1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true"># nn.BatchNorm1d(num_features=64),</span>            <span class="token comment" spellcheck="true"># nn.Dropout(),</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true"># nn.BatchNorm1d(num_features=128),</span>            <span class="token comment" spellcheck="true"># nn.Dropout(),</span>        <span class="token punctuation">)</span>        self<span class="token punctuation">.</span>residual_block2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true"># nn.BatchNorm1d(num_features=64),</span>            <span class="token comment" spellcheck="true"># nn.Dropout(),</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true"># nn.BatchNorm1d(num_features=128),</span>            <span class="token comment" spellcheck="true"># nn.Dropout(),</span>        <span class="token punctuation">)</span>        self<span class="token punctuation">.</span>output <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> name<span class="token punctuation">,</span> son <span class="token keyword">in</span> self<span class="token punctuation">.</span>input_trainsform<span class="token punctuation">.</span>named_children<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            weight<span class="token punctuation">:</span> nn<span class="token punctuation">.</span>parameter<span class="token punctuation">.</span>Parameter            <span class="token keyword">if</span> <span class="token punctuation">(</span>weight<span class="token punctuation">:</span><span class="token operator">=</span>getattr<span class="token punctuation">(</span>son<span class="token punctuation">,</span> <span class="token string">"weight"</span><span class="token punctuation">,</span> None<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token operator">not</span> None<span class="token punctuation">:</span>                self<span class="token punctuation">.</span>dtype<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>dtype <span class="token operator">=</span> weight<span class="token punctuation">.</span>dtype        <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> raw_x<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">:</span>        x <span class="token operator">=</span> self<span class="token punctuation">.</span>input_trainsform<span class="token punctuation">(</span>raw_x<span class="token punctuation">)</span>        y1 <span class="token operator">=</span> self<span class="token punctuation">.</span>residual_block1<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> x        y2 <span class="token operator">=</span> self<span class="token punctuation">.</span>residual_block2<span class="token punctuation">(</span>y1<span class="token punctuation">)</span> <span class="token operator">+</span> y1        <span class="token keyword">return</span> self<span class="token punctuation">.</span>output<span class="token punctuation">(</span>y2<span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">WideNet</span><span class="token punctuation">(</span>_NetworkBase<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_features<span class="token punctuation">:</span> int<span class="token punctuation">)</span><span class="token punctuation">:</span>        super<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>input_trainsform <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span>in_features<span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span>        self<span class="token punctuation">.</span>residual_block1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span>        self<span class="token punctuation">.</span>residual_block2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span>        self<span class="token punctuation">.</span>residual_block3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span>        self<span class="token punctuation">.</span>output <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> name<span class="token punctuation">,</span> son <span class="token keyword">in</span> self<span class="token punctuation">.</span>input_trainsform<span class="token punctuation">.</span>named_children<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            weight<span class="token punctuation">:</span> nn<span class="token punctuation">.</span>parameter<span class="token punctuation">.</span>Parameter            <span class="token keyword">if</span> <span class="token punctuation">(</span>weight<span class="token punctuation">:</span><span class="token operator">=</span>getattr<span class="token punctuation">(</span>son<span class="token punctuation">,</span> <span class="token string">"weight"</span><span class="token punctuation">,</span> None<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token operator">not</span> None<span class="token punctuation">:</span>                self<span class="token punctuation">.</span>dtype<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>dtype <span class="token operator">=</span> weight<span class="token punctuation">.</span>dtype        <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> raw_x<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">:</span>        x <span class="token operator">=</span> self<span class="token punctuation">.</span>input_trainsform<span class="token punctuation">(</span>raw_x<span class="token punctuation">)</span>        y11 <span class="token operator">=</span> self<span class="token punctuation">.</span>residual_block1<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> x        y12 <span class="token operator">=</span> self<span class="token punctuation">.</span>residual_block2<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> x        y1 <span class="token operator">=</span> <span class="token punctuation">(</span>y11 <span class="token operator">+</span> y12<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>        y2 <span class="token operator">=</span> self<span class="token punctuation">.</span>residual_block3<span class="token punctuation">(</span>y1<span class="token punctuation">)</span> <span class="token operator">+</span> y1        <span class="token keyword">return</span> self<span class="token punctuation">.</span>output<span class="token punctuation">(</span>y2<span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">OtherNet</span><span class="token punctuation">(</span>_NetworkBase<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_features<span class="token punctuation">:</span> int<span class="token punctuation">)</span><span class="token punctuation">:</span>        super<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>net <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span>in_features<span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>BatchNorm1d<span class="token punctuation">(</span>num_features<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>LeakyReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span>        <span class="token keyword">for</span> name<span class="token punctuation">,</span> son <span class="token keyword">in</span> self<span class="token punctuation">.</span>net<span class="token punctuation">.</span>named_children<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            weight<span class="token punctuation">:</span> nn<span class="token punctuation">.</span>parameter<span class="token punctuation">.</span>Parameter            <span class="token keyword">if</span> <span class="token punctuation">(</span>weight<span class="token punctuation">:</span><span class="token operator">=</span>getattr<span class="token punctuation">(</span>son<span class="token punctuation">,</span> <span class="token string">"weight"</span><span class="token punctuation">,</span> None<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token operator">not</span> None<span class="token punctuation">:</span>                self<span class="token punctuation">.</span>dtype<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>dtype <span class="token operator">=</span> weight<span class="token punctuation">.</span>dtype        <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment" spellcheck="true"># x: [batch, channel]</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>net<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    baseline <span class="token operator">=</span> Baseline<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">93</span><span class="token punctuation">)</span>    x <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">93</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>dtype<span class="token operator">=</span>baseline<span class="token punctuation">.</span>dtype<span class="token punctuation">,</span> device<span class="token operator">=</span>baseline<span class="token punctuation">.</span>device<span class="token punctuation">)</span>    baseline<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="5-train-py"><a href="#5-train-py" class="headerlink" title="5. train.py"></a>5. train.py</h4><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> datetime<span class="token keyword">import</span> typing<span class="token keyword">from</span> pathlib <span class="token keyword">import</span> Path<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd<span class="token keyword">import</span> matplotlib <span class="token keyword">as</span> mpl<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt<span class="token keyword">from</span> colorama <span class="token keyword">import</span> Fore<span class="token punctuation">,</span> Style<span class="token keyword">from</span> matplotlib<span class="token punctuation">.</span>axes <span class="token keyword">import</span> Axes<span class="token keyword">import</span> torch<span class="token keyword">import</span> torch<span class="token punctuation">.</span>cuda<span class="token keyword">import</span> torch<span class="token punctuation">.</span>backends<span class="token punctuation">.</span>cudnn<span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">as</span> optim<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn<span class="token keyword">from</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">import</span> optimizer<span class="token keyword">import</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">as</span> data<span class="token keyword">import</span> networks<span class="token keyword">from</span> pathconfig <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">from</span> dataset <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">class</span> <span class="token class-name">Trainer</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> network<span class="token punctuation">:</span> networks<span class="token punctuation">.</span>_NetworkBase<span class="token punctuation">,</span> dim2use<span class="token punctuation">:</span> typing<span class="token punctuation">.</span>List<span class="token punctuation">[</span>int<span class="token punctuation">]</span><span class="token operator">=</span>None<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> None<span class="token punctuation">:</span>        super<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>start_time<span class="token punctuation">:</span> str <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__str__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>        self<span class="token punctuation">.</span>select_device<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>reproducibile<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>network <span class="token operator">=</span> network<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>suffix<span class="token punctuation">:</span> str <span class="token operator">=</span> self<span class="token punctuation">.</span>network<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__        self<span class="token punctuation">.</span>log_folder<span class="token punctuation">:</span> Path <span class="token operator">=</span> Paths<span class="token punctuation">.</span>log_path <span class="token operator">/</span> self<span class="token punctuation">.</span>suffix <span class="token operator">/</span> self<span class="token punctuation">.</span>start_time<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">,</span> <span class="token string">"_"</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>checkpoint_path<span class="token punctuation">:</span> Path <span class="token operator">=</span> Paths<span class="token punctuation">.</span>checkpoint_path <span class="token operator">/</span> self<span class="token punctuation">.</span>suffix <span class="token operator">/</span> f<span class="token string">"{self.start_time}.pt"</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">,</span> <span class="token string">"_"</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token operator">not</span> self<span class="token punctuation">.</span>checkpoint_path<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            self<span class="token punctuation">.</span>checkpoint_path<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token operator">not</span> self<span class="token punctuation">.</span>log_folder<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            self<span class="token punctuation">.</span>log_folder<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># train</span>        self<span class="token punctuation">.</span>train_loader <span class="token operator">=</span> data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>CovidDataset<span class="token punctuation">(</span>split<span class="token operator">=</span><span class="token string">"train"</span><span class="token punctuation">,</span> dim2use<span class="token operator">=</span>dim2use<span class="token punctuation">)</span><span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>val_loader <span class="token operator">=</span> data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>CovidDataset<span class="token punctuation">(</span>split<span class="token operator">=</span><span class="token string">"val"</span><span class="token punctuation">,</span> dim2use<span class="token operator">=</span>dim2use<span class="token punctuation">)</span><span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># mse for regression</span>        self<span class="token punctuation">.</span>lossfunc <span class="token operator">=</span> nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span>reduction<span class="token operator">=</span><span class="token string">"mean"</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># self.lossfunc = nn.(reduction="mean")</span>        <span class="token comment" spellcheck="true"># visualize</span>        self<span class="token punctuation">.</span>train_loss<span class="token punctuation">:</span> typing<span class="token punctuation">.</span>List<span class="token punctuation">[</span>float<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        self<span class="token punctuation">.</span>val_loss<span class="token punctuation">:</span> typing<span class="token punctuation">.</span>List<span class="token punctuation">[</span>float<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        self<span class="token punctuation">.</span>min_val_loss<span class="token punctuation">:</span> float <span class="token operator">=</span> float<span class="token punctuation">(</span><span class="token string">"inf"</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>axes<span class="token punctuation">:</span> Axes        _<span class="token punctuation">,</span> self<span class="token punctuation">.</span>axes <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span>nrows<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> ncols<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">select_device</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>device <span class="token operator">=</span> <span class="token string">"cuda"</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span>        <span class="token keyword">def</span> <span class="token function">reproducibile</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> seed<span class="token punctuation">:</span> int<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span>seed<span class="token operator">=</span>seed<span class="token punctuation">)</span>        torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span>seed<span class="token operator">=</span>seed<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># no optimization for convolution</span>        torch<span class="token punctuation">.</span>backends<span class="token punctuation">.</span>cudnn<span class="token punctuation">.</span>benchmark <span class="token operator">=</span> <span class="token boolean">False</span>        <span class="token comment" spellcheck="true"># use default convolution algorithm</span>        torch<span class="token punctuation">.</span>backends<span class="token punctuation">.</span>cudnn<span class="token punctuation">.</span>deterministic <span class="token operator">=</span> <span class="token boolean">True</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>device <span class="token operator">==</span> <span class="token string">"cuda"</span><span class="token punctuation">:</span>            torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span>seed<span class="token operator">=</span>seed<span class="token punctuation">)</span>            torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span>seed<span class="token operator">=</span>seed<span class="token punctuation">)</span>        <span class="token keyword">def</span> <span class="token function">visualize</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> val_loss<span class="token punctuation">:</span> float<span class="token punctuation">,</span> train_loss<span class="token punctuation">:</span> float<span class="token punctuation">)</span><span class="token punctuation">:</span>        plt<span class="token punctuation">.</span>ion<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>axes<span class="token punctuation">.</span>cla<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>axes<span class="token punctuation">.</span>set_ylim<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">400.0</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>axes<span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">"steps"</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>axes<span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">"loss / MSE"</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>axes<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span>f<span class="token string">"{self.suffix}-{self.start_time}"</span><span class="token punctuation">)</span>                x_train <span class="token operator">=</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>self<span class="token punctuation">.</span>train_loss<span class="token punctuation">)</span><span class="token punctuation">)</span>        x_val <span class="token operator">=</span> x_train<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span>len<span class="token punctuation">(</span>self<span class="token punctuation">.</span>train_loss<span class="token punctuation">)</span> <span class="token operator">//</span> len<span class="token punctuation">(</span>self<span class="token punctuation">.</span>val_loss<span class="token punctuation">)</span><span class="token punctuation">]</span>        self<span class="token punctuation">.</span>axes<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x_train<span class="token punctuation">,</span> self<span class="token punctuation">.</span>train_loss<span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">"tab:red"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"train loss"</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>axes<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x_val<span class="token punctuation">,</span> self<span class="token punctuation">.</span>val_loss<span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">"tab:cyan"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"val loss"</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>axes<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> label<span class="token operator">=</span>f<span class="token string">"min_val_loss: {self.min_val_loss:>5.4f}"</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>axes<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> label<span class="token operator">=</span>f<span class="token string">"val/train loss: {val_loss:>5.4f}/{train_loss:>5.4f}"</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>axes<span class="token punctuation">.</span>text<span class="token punctuation">(</span>x<span class="token operator">=</span>len<span class="token punctuation">(</span>self<span class="token punctuation">.</span>train_loss<span class="token punctuation">)</span><span class="token operator">//</span><span class="token number">2</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span> s<span class="token operator">=</span>f<span class="token string">"Current loss: {self.train_loss[-1]:>5.4f}"</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">24</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>axes<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>        plt<span class="token punctuation">.</span>pause<span class="token punctuation">(</span><span class="token number">0.05</span><span class="token punctuation">)</span>        plt<span class="token punctuation">.</span>ioff<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">save</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> epoch<span class="token punctuation">:</span> int<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"Saving model at {Fore.GREEN}{Style.BRIGHT}{epoch}{Style.RESET_ALL} epoch, val_loss = {Fore.GREEN}{Style.BRIGHT}{self.min_val_loss}{Style.RESET_ALL}"</span><span class="token punctuation">)</span>        torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>self<span class="token punctuation">.</span>network<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token operator">=</span>self<span class="token punctuation">.</span>checkpoint_path<span class="token punctuation">)</span>        <span class="token keyword">def</span> <span class="token function">lossfunc_l2</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> target<span class="token punctuation">,</span> pred<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">:</span>        loss <span class="token operator">=</span> self<span class="token punctuation">.</span>lossfunc<span class="token punctuation">(</span>target<span class="token punctuation">,</span> pred<span class="token punctuation">)</span>        norm_loss <span class="token operator">=</span> <span class="token number">0</span>        <span class="token keyword">for</span> param <span class="token keyword">in</span> self<span class="token punctuation">.</span>network<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            norm_loss <span class="token operator">+=</span> torch<span class="token punctuation">.</span>sum<span class="token punctuation">(</span>param<span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> loss <span class="token operator">+</span> norm_loss <span class="token operator">*</span> <span class="token number">0.00075</span>        @torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">validation</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        loss <span class="token operator">=</span> <span class="token number">0</span>        x<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor        y<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor        self<span class="token punctuation">.</span>network<span class="token punctuation">.</span>eval<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> x<span class="token punctuation">,</span> y <span class="token keyword">in</span> self<span class="token punctuation">.</span>val_loader<span class="token punctuation">:</span>            x<span class="token punctuation">,</span> y <span class="token operator">=</span> x<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">,</span> dtype<span class="token operator">=</span>self<span class="token punctuation">.</span>network<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span><span class="token punctuation">,</span> y<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">,</span> dtype<span class="token operator">=</span>self<span class="token punctuation">.</span>network<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span>            y_pred<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor <span class="token operator">=</span> self<span class="token punctuation">.</span>network<span class="token punctuation">(</span>x<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true"># loss += self.lossfunc(y, y_pred.squeeze()).sqrt()</span>            <span class="token comment" spellcheck="true"># loss = self.lossfunc_l2(y, y_pred.squeeze())</span>            loss <span class="token operator">+=</span> self<span class="token punctuation">.</span>lossfunc<span class="token punctuation">(</span>y<span class="token punctuation">,</span> y_pred<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        l<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor        self<span class="token punctuation">.</span>val_loss<span class="token punctuation">.</span>append<span class="token punctuation">(</span>l<span class="token punctuation">:</span><span class="token operator">=</span><span class="token punctuation">(</span>loss<span class="token operator">/</span>len<span class="token punctuation">(</span>self<span class="token punctuation">.</span>val_loader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> l    <span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> lr<span class="token punctuation">:</span> float<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span> wd<span class="token punctuation">:</span> float<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span> n_epoch<span class="token punctuation">:</span> int<span class="token operator">=</span><span class="token number">3000</span><span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span> early_stop<span class="token punctuation">:</span> int<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        msg<span class="token punctuation">:</span> str <span class="token operator">=</span> input<span class="token punctuation">(</span><span class="token string">"请输入本次训练的日志记录："</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># optimizer = optim.SGD(self.network.parameters(), lr=lr, weight_decay=wd, momentum=momentum)</span>        optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span>AdamW<span class="token punctuation">(</span>self<span class="token punctuation">.</span>network<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>lr<span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>wd<span class="token punctuation">)</span>        <span class="token keyword">with</span> open<span class="token punctuation">(</span>self<span class="token punctuation">.</span>log_folder<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">"message.txt"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>msg<span class="token operator">+</span><span class="token string">"\n"</span><span class="token punctuation">)</span>            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>f<span class="token string">"epoch: {n_epoch}, lr: {lr}, wd: {wd}, early_stop: {early_stop}, optimizer: {optimizer.__class__.__name__}\n"</span><span class="token punctuation">)</span>        early_stop_cnt <span class="token operator">=</span> <span class="token number">0</span>        <span class="token keyword">for</span> epoch <span class="token keyword">in</span> range<span class="token punctuation">(</span>n_epoch<span class="token punctuation">)</span><span class="token punctuation">:</span>            x<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor            y<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor            self<span class="token punctuation">.</span>network<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>            train_loss<span class="token punctuation">:</span> float <span class="token operator">=</span> <span class="token number">0</span>            <span class="token keyword">for</span> x<span class="token punctuation">,</span> y <span class="token keyword">in</span> self<span class="token punctuation">.</span>train_loader<span class="token punctuation">:</span>                optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>                x<span class="token punctuation">,</span> y <span class="token operator">=</span> x<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">,</span> dtype<span class="token operator">=</span>self<span class="token punctuation">.</span>network<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span><span class="token punctuation">,</span> y<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">,</span> dtype<span class="token operator">=</span>self<span class="token punctuation">.</span>network<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span>                y_pred<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor <span class="token operator">=</span> self<span class="token punctuation">.</span>network<span class="token punctuation">(</span>x<span class="token punctuation">)</span>                loss<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor <span class="token operator">=</span> self<span class="token punctuation">.</span>lossfunc<span class="token punctuation">(</span>y<span class="token punctuation">,</span> y_pred<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token comment" spellcheck="true"># loss = self.lossfunc_l2(y, y_pred.squeeze())</span>                <span class="token comment" spellcheck="true"># loss = loss.sqrt()</span>                loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>                optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>                train_loss <span class="token operator">+=</span> loss<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>                self<span class="token punctuation">.</span>train_loss<span class="token punctuation">.</span>append<span class="token punctuation">(</span>loss<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            train_loss <span class="token operator">=</span> <span class="token punctuation">(</span>train_loss <span class="token operator">/</span> len<span class="token punctuation">(</span>self<span class="token punctuation">.</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">)</span>            val_loss <span class="token operator">=</span> self<span class="token punctuation">.</span>validation<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> val_loss <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>min_val_loss<span class="token punctuation">:</span>                self<span class="token punctuation">.</span>min_val_loss <span class="token operator">=</span> val_loss                early_stop_cnt <span class="token operator">=</span> <span class="token number">0</span>                self<span class="token punctuation">.</span>save<span class="token punctuation">(</span>epoch<span class="token operator">=</span>epoch<span class="token punctuation">)</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                early_stop_cnt <span class="token operator">+=</span> <span class="token number">1</span>            self<span class="token punctuation">.</span>visualize<span class="token punctuation">(</span>val_loss<span class="token operator">=</span>val_loss<span class="token punctuation">,</span> train_loss<span class="token operator">=</span>train_loss<span class="token punctuation">)</span>            <span class="token keyword">if</span> early_stop_cnt <span class="token operator">>=</span> early_stop<span class="token punctuation">:</span>                <span class="token keyword">break</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>green<span class="token punctuation">(</span>f<span class="token string">"Training stopped at {epoch}"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>green<span class="token punctuation">(</span><span class="token string">"Saving trainig log"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">with</span> open<span class="token punctuation">(</span>self<span class="token punctuation">.</span>log_folder<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">"train_val.loss.pkl"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>            pickle<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>                <span class="token punctuation">{</span>                    <span class="token string">"val"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>val_loss<span class="token punctuation">,</span>                    <span class="token string">"train"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>train_loss<span class="token punctuation">,</span>                    <span class="token string">"min_val"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>min_val_loss                <span class="token punctuation">}</span><span class="token punctuation">,</span> file<span class="token operator">=</span>f            <span class="token punctuation">)</span>        plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span>self<span class="token punctuation">.</span>log_folder<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">"train_log.png"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__str__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dpi<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># @torch.no_grad()</span>    <span class="token comment" spellcheck="true"># def get_presudo</span><span class="token keyword">def</span> <span class="token function">baseline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    b <span class="token operator">=</span> networks<span class="token punctuation">.</span>Baseline<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">93</span><span class="token punctuation">)</span>    t <span class="token operator">=</span> Trainer<span class="token punctuation">(</span>network<span class="token operator">=</span>b<span class="token punctuation">)</span>    t<span class="token punctuation">.</span>train<span class="token punctuation">(</span>wd<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">previous2day</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    dim2use <span class="token operator">=</span> list<span class="token punctuation">(</span>range<span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    dim2use<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">57</span><span class="token punctuation">,</span> <span class="token number">75</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    b <span class="token operator">=</span> networks<span class="token punctuation">.</span>Baseline<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span>    t <span class="token operator">=</span> Trainer<span class="token punctuation">(</span>network<span class="token operator">=</span>b<span class="token punctuation">,</span> dim2use<span class="token operator">=</span>dim2use<span class="token punctuation">)</span>    t<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">selected_feature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    dim2use <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">58</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>    b <span class="token operator">=</span> networks<span class="token punctuation">.</span>Baseline<span class="token punctuation">(</span>in_features<span class="token operator">=</span>len<span class="token punctuation">(</span>dim2use<span class="token punctuation">)</span><span class="token punctuation">)</span>    t <span class="token operator">=</span> Trainer<span class="token punctuation">(</span>network<span class="token operator">=</span>b<span class="token punctuation">,</span> dim2use<span class="token operator">=</span>dim2use<span class="token punctuation">)</span>    t<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">residual</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># dim2use = np.array([76, 58]) - 1</span>    dim2use <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">75</span><span class="token punctuation">,</span> <span class="token number">57</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">78</span><span class="token punctuation">,</span> <span class="token number">43</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">79</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">58</span><span class="token punctuation">,</span> <span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">41</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">,</span> <span class="token number">77</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># dim2use = np.array([76, 58, 43, 61, 79, 44, 62, 80, 41, 59, 77, 42, 60, 78, 93, 75, 57, 88, 70, 52, 84, 66, 48]) - 1</span>    <span class="token comment" spellcheck="true"># dim2use = np.array([75, 57, 61, 79, 43, 78, 60, 42, 91, 73, 83, 80, 68, 62, 40, 86, 65, 77, 85, 67, 55, 49])</span>    d <span class="token operator">=</span> networks<span class="token punctuation">.</span>DeeperNet<span class="token punctuation">(</span>in_features<span class="token operator">=</span>len<span class="token punctuation">(</span>dim2use<span class="token punctuation">)</span><span class="token punctuation">)</span>    t <span class="token operator">=</span> Trainer<span class="token punctuation">(</span>network<span class="token operator">=</span>d<span class="token punctuation">,</span> dim2use<span class="token operator">=</span>dim2use<span class="token punctuation">)</span>    t<span class="token punctuation">.</span>train<span class="token punctuation">(</span>wd<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    dim2use <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">58</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>    d <span class="token operator">=</span> networks<span class="token punctuation">.</span>DeeperNormalizedNet<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>    t <span class="token operator">=</span> Trainer<span class="token punctuation">(</span>network<span class="token operator">=</span>d<span class="token punctuation">,</span> dim2use<span class="token operator">=</span>dim2use<span class="token punctuation">)</span>    t<span class="token punctuation">.</span>train<span class="token punctuation">(</span>wd<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">wider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    dim2use <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">58</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>    w <span class="token operator">=</span> networks<span class="token punctuation">.</span>WideNet<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>    t <span class="token operator">=</span> Trainer<span class="token punctuation">(</span>network<span class="token operator">=</span>w<span class="token punctuation">,</span> dim2use<span class="token operator">=</span>dim2use<span class="token punctuation">)</span>    t<span class="token punctuation">.</span>train<span class="token punctuation">(</span>wd<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">other</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    dim2use <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">75</span><span class="token punctuation">,</span> <span class="token number">57</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">78</span><span class="token punctuation">,</span> <span class="token number">43</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">79</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">58</span><span class="token punctuation">,</span> <span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">41</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">,</span> <span class="token number">77</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    o <span class="token operator">=</span> networks<span class="token punctuation">.</span>OtherNet<span class="token punctuation">(</span>in_features<span class="token operator">=</span>len<span class="token punctuation">(</span>dim2use<span class="token punctuation">)</span><span class="token punctuation">)</span>    t <span class="token operator">=</span> Trainer<span class="token punctuation">(</span>network<span class="token operator">=</span>o<span class="token punctuation">,</span> dim2use<span class="token operator">=</span>dim2use<span class="token punctuation">)</span>    t<span class="token punctuation">.</span>train<span class="token punctuation">(</span>wd<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># baseline()</span>    <span class="token comment" spellcheck="true"># previous2day()</span>    <span class="token comment" spellcheck="true"># selected_feature()</span>    residual<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># other()</span>    <span class="token comment" spellcheck="true"># normalized()</span>    <span class="token comment" spellcheck="true"># wider()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="6-gen-submission-py"><a href="#6-gen-submission-py" class="headerlink" title="6. gen_submission.py"></a>6. gen_submission.py</h4><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> typing<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd<span class="token keyword">import</span> torch<span class="token keyword">import</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">as</span> data<span class="token keyword">from</span> dataset <span class="token keyword">import</span> CovidDataset<span class="token keyword">import</span> networks<span class="token keyword">from</span> pathconfig <span class="token keyword">import</span> <span class="token operator">*</span>@torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">gen_submission</span><span class="token punctuation">(</span>network<span class="token punctuation">:</span>networks<span class="token punctuation">.</span>_NetworkBase<span class="token punctuation">,</span> dim2use<span class="token operator">=</span>None<span class="token punctuation">,</span> save_path<span class="token punctuation">:</span> Path<span class="token operator">=</span>None<span class="token punctuation">)</span><span class="token punctuation">:</span>    test_loader <span class="token operator">=</span> data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>dataset<span class="token operator">=</span>CovidDataset<span class="token punctuation">(</span>split<span class="token operator">=</span><span class="token string">"test"</span><span class="token punctuation">,</span> dim2use<span class="token operator">=</span>dim2use<span class="token punctuation">)</span><span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span>    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    x<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor    <span class="token keyword">for</span> x <span class="token keyword">in</span> test_loader<span class="token punctuation">:</span>        x <span class="token operator">=</span> x<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token operator">=</span><span class="token string">"cuda"</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>network<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span>        y_pred<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor <span class="token operator">=</span> network<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        result<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>y_pred<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token operator">not</span> save_path<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        save_path<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    result <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>result<span class="token punctuation">)</span>    <span class="token keyword">with</span> open<span class="token punctuation">(</span>save_path<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>save_path<span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"id,tested_positive\n"</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> id<span class="token punctuation">,</span> r <span class="token keyword">in</span> enumerate<span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">:</span>            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>f<span class="token string">"{id},{r}\n"</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">gen_baseline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    net <span class="token operator">=</span> networks<span class="token punctuation">.</span>Baseline<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">93</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>    net<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>s<span class="token punctuation">:</span><span class="token operator">=</span>Paths<span class="token punctuation">.</span>checkpoint_path<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">"../checkpoint/Baseline/2021-12-12 15_29_31.pt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    gen_submission<span class="token punctuation">(</span>network<span class="token operator">=</span>net<span class="token punctuation">,</span> dim2use<span class="token operator">=</span>None<span class="token punctuation">,</span> save_path<span class="token operator">=</span>Paths<span class="token punctuation">.</span>submission_path<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span>net<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">,</span> s<span class="token punctuation">.</span>stem<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">".csv"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">gen2day</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    net <span class="token operator">=</span> networks<span class="token punctuation">.</span>Baseline<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>    net<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>s<span class="token punctuation">:</span><span class="token operator">=</span>Paths<span class="token punctuation">.</span>checkpoint_path<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">"../checkpoint/Baseline/2021-12-12 15_40_58.pt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    dim2use <span class="token operator">=</span> list<span class="token punctuation">(</span>range<span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    dim2use<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">57</span><span class="token punctuation">,</span> <span class="token number">75</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    gen_submission<span class="token punctuation">(</span>network<span class="token operator">=</span>net<span class="token punctuation">,</span> dim2use<span class="token operator">=</span>dim2use<span class="token punctuation">,</span> save_path<span class="token operator">=</span>Paths<span class="token punctuation">.</span>submission_path<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span>net<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">,</span> s<span class="token punctuation">.</span>stem<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">".csv"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">feature_selection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># dim2use = np.array([76, 58, 43, 61, 79, 44, 62, 80, 41, 59, 77, 42, 60, 78, 93]) - 1</span>    dim2use <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">58</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>    net <span class="token operator">=</span> networks<span class="token punctuation">.</span>Baseline<span class="token punctuation">(</span>in_features<span class="token operator">=</span>len<span class="token punctuation">(</span>dim2use<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>    net<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>s<span class="token punctuation">:</span><span class="token operator">=</span>Paths<span class="token punctuation">.</span>checkpoint_path<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">"../checkpoint/Baseline/2021-12-12 16_33_04.pt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    gen_submission<span class="token punctuation">(</span>network<span class="token operator">=</span>net<span class="token punctuation">,</span> dim2use<span class="token operator">=</span>dim2use<span class="token punctuation">,</span> save_path<span class="token operator">=</span>Paths<span class="token punctuation">.</span>submission_path<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span>net<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">,</span> s<span class="token punctuation">.</span>stem<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">".csv"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">residual</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># dim2use = np.array([76, 58, 43, 61, 79, 44, 62, 80, 41, 59, 77, 42, 60, 78, 93]) - 1</span>    <span class="token comment" spellcheck="true"># dim2use = np.array([76, 58]) - 1</span>    dim2use <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">75</span><span class="token punctuation">,</span> <span class="token number">57</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">78</span><span class="token punctuation">,</span> <span class="token number">43</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">79</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">58</span><span class="token punctuation">,</span> <span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">41</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">,</span> <span class="token number">77</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># dim2use = np.array([75, 57, 61, 79, 43, 78, 60, 42, 91, 73, 83, 80, 68, 62, 40, 86, 65, 77, 85, 67, 55, 49])</span>    <span class="token comment" spellcheck="true"># dim2use = np.array([76, 58, 43, 61, 79, 44, 62, 80, 41, 59, 77, 42, 60, 78, 93, 75, 57, 88, 70, 52, 84, 66, 48]) - 1</span>    <span class="token comment" spellcheck="true"># dim2use = np.array([75, 57])</span>    net <span class="token operator">=</span> networks<span class="token punctuation">.</span>DeeperNet<span class="token punctuation">(</span>in_features<span class="token operator">=</span>len<span class="token punctuation">(</span>dim2use<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>    net<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>s<span class="token punctuation">:</span><span class="token operator">=</span>Paths<span class="token punctuation">.</span>checkpoint_path<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">"../checkpoint/DeeperNet/2021-12-13 01_55_10.pt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    gen_submission<span class="token punctuation">(</span>network<span class="token operator">=</span>net<span class="token punctuation">,</span> dim2use<span class="token operator">=</span>dim2use<span class="token punctuation">,</span> save_path<span class="token operator">=</span>Paths<span class="token punctuation">.</span>submission_path<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span>net<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">,</span> s<span class="token punctuation">.</span>stem<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">".csv"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># dim2use = np.array([76, 58, 43, 61, 79, 44, 62, 80, 41, 59, 77, 42, 60, 78, 93]) - 1</span>    dim2use <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">58</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>    net <span class="token operator">=</span> networks<span class="token punctuation">.</span>DeeperNormalizedNet<span class="token punctuation">(</span>in_features<span class="token operator">=</span>len<span class="token punctuation">(</span>dim2use<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>    net<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>s<span class="token punctuation">:</span><span class="token operator">=</span>Paths<span class="token punctuation">.</span>checkpoint_path<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">"../checkpoint/DeeperNormalizedNet/2021-12-12 17_55_08.pt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    gen_submission<span class="token punctuation">(</span>network<span class="token operator">=</span>net<span class="token punctuation">,</span> dim2use<span class="token operator">=</span>dim2use<span class="token punctuation">,</span> save_path<span class="token operator">=</span>Paths<span class="token punctuation">.</span>submission_path<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span>net<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">,</span> s<span class="token punctuation">.</span>stem<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">".csv"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">wider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    dim2use <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">58</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>    net <span class="token operator">=</span> networks<span class="token punctuation">.</span>WideNet<span class="token punctuation">(</span>in_features<span class="token operator">=</span>len<span class="token punctuation">(</span>dim2use<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>    net<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>s<span class="token punctuation">:</span><span class="token operator">=</span>Paths<span class="token punctuation">.</span>checkpoint_path<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">"../checkpoint/WideNet/2021-12-12 18_12_38.pt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    gen_submission<span class="token punctuation">(</span>network<span class="token operator">=</span>net<span class="token punctuation">,</span> dim2use<span class="token operator">=</span>dim2use<span class="token punctuation">,</span> save_path<span class="token operator">=</span>Paths<span class="token punctuation">.</span>submission_path<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span>net<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">,</span> s<span class="token punctuation">.</span>stem<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">".csv"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">other</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    dim2use <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">75</span><span class="token punctuation">,</span> <span class="token number">57</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">78</span><span class="token punctuation">,</span> <span class="token number">43</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">79</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">58</span><span class="token punctuation">,</span> <span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">41</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">,</span> <span class="token number">77</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    net <span class="token operator">=</span> networks<span class="token punctuation">.</span>OtherNet<span class="token punctuation">(</span>in_features<span class="token operator">=</span>len<span class="token punctuation">(</span>dim2use<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>    net<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>s<span class="token punctuation">:</span><span class="token operator">=</span>Paths<span class="token punctuation">.</span>checkpoint_path<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">"../checkpoint/OtherNet/2021-12-13 00_49_48.pt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    gen_submission<span class="token punctuation">(</span>network<span class="token operator">=</span>net<span class="token punctuation">,</span> dim2use<span class="token operator">=</span>dim2use<span class="token punctuation">,</span> save_path<span class="token operator">=</span>Paths<span class="token punctuation">.</span>submission_path<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span>net<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">,</span> s<span class="token punctuation">.</span>stem<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">".csv"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># gen_baseline()</span>    <span class="token comment" spellcheck="true"># gen2day()</span>    <span class="token comment" spellcheck="true"># feature_selection()</span>    <span class="token comment" spellcheck="true"># other()</span>    residual<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># normalize()</span>    <span class="token comment" spellcheck="true"># wider()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 李宏毅ML2021 Spring Homeworks </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Deep Learning </tag>
            
            <tag> Hungyi Li </tag>
            
            <tag> Machine Learning </tag>
            
            <tag> Neural Network </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>李宏毅ML2021 Spring homeworks: hw0 -- 概述</title>
      <link href="/2021/12/11/li-hong-yi-ml2021-spring-hw0-gai-shu/"/>
      <url>/2021/12/11/li-hong-yi-ml2021-spring-hw0-gai-shu/</url>
      
        <content type="html"><![CDATA[<blockquote><p>本文讲解李宏毅ML2021 Spring homeworks系列文章的写作原因以及系列文章的写作目的</p></blockquote><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211207145714311.png" alt="课程官网"></p><span id="more"></span><h1 id="李宏毅ML2021-Spring-homeworks-hw0-–-概述"><a href="#李宏毅ML2021-Spring-homeworks-hw0-–-概述" class="headerlink" title="李宏毅ML2021 Spring homeworks: hw0 – 概述"></a>李宏毅ML2021 Spring homeworks: hw0 – 概述</h1><p>李宏毅老师的Machine Learning 2021 Spring的课程李宏毅老师以及上传到他的Youtube上了，并且系列作业也已经经过整理向公众开放。今年的ML课程完全关注Deep Learning，此外结合了Kaggle的许多实战。因此本系列文章记录了我在完成作业时候的心得与体会。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/44fe603d253c2586def6d0e832b5efd6_r.jpg" alt="ML与DL的关系"></p><h2 id="1-写作初心"><a href="#1-写作初心" class="headerlink" title="1. 写作初心"></a>1. 写作初心</h2><p>在2019年我刚进入大学的时候，那个时候深度学习已经火热起来了。在那个时候我就通过观看李宏毅老师的Machine Learning的系列课程从而对机器学习和深度学习入门了。</p><p>然而可惜的是，由于种种原因，在2019年的时候，李宏毅老师的ML系列课程我最终没有坚持下来全部看完。</p><p>一方面是受到了当时学识的限制。在那时候刚刚进入大学，刚刚开始学习线性代数，对概率论、图论、凸优化、计算机、多元高等数学等内容完全没有接触过。</p><p>另外一方面当时更加关注与计算机底层LInux等内容的学习；最后是大一时候的课是真的多。</p><p>因此最终没有听完2019年的课程，非常的可惜。</p><p>现在因为降级转入计算机专业的原因，有了很多的时间；此外自己在业余时间也已经把许多计算机的课程、深度学习的数学原理课程都已经学过了，编程能力也有了非常大的提升。</p><p>又恰逢2021年李宏毅老师的课程上架。因此决定这一次详细的学完所有课程并完成对应的作业。</p><p>所有的作业都以博客的形式来记录我炼丹的点滴。希望能够见证我这一段时间的投入和付出。</p><h2 id="2-Who-is-Hung-yi-Lee"><a href="#2-Who-is-Hung-yi-Lee" class="headerlink" title="2. Who is Hung-yi Lee"></a>2. Who is Hung-yi Lee</h2><p>As now we are going to have classes of Hung-yi Lee, we’d better have some knowledge of him.</p><p>首先是<code>Wikipedia</code>的介绍</p><blockquote><p><strong>From wikipedia</strong></p><p>李宏毅（1985年或1986年－），台湾地区计算机科学家，国立台湾大学电机工程学系副教授，研究领域包括语意理解、语音辨识、机器学习、深度学习等。</p><p>李宏毅在大学二年级时，因对电机系许多课程感到困惑，曾一度非常沮丧迷惘，甚至萌生了退学的念头。他当时选了一门“数字通信处理”课程，发现自己难以听懂，但他并未放弃，不弃选不退修，最终豁然开朗，“原来用手机拨电话给别人时，中间发生的事就是这些信号处理。”找到学习的兴趣后，李宏毅开始跟随中央研究院李琳山院士做项目，随后于2010年从国立台湾大学取得硕士学位，2012年取得博士学位。2012年9月至2013年8月间，李宏毅于中央研究院资讯科技创新研究中心担任博士后研究员。2013年9月以客座科学家身份前往麻省理工学院计算机科学暨人工智能实验室。2014年返台，担任台湾大学电机工程学系教师至今。</p><p>2015年，李宏毅开始在台湾大学讲授机器学习课程，选课人数通常爆满，有400多人来修。于是，李宏毅将学生分在两间教室，一间现场看老师上课，另一间同步看直播。由于直播上课的诸多限制，李宏毅养成了录制课程影片的习惯。一开始李宏毅将影片上传至个人主页，后来由于萤幕侧录软件的序号过期，无法导出MP4，但有导出至YouTube的选项，于是李宏毅开始将课程影片上传至YouTube。此举不仅帮助了台湾大学的学生，还意外嘉惠台湾大学以外的学生。在其影片下方，还有中国大陆的学生留言感谢，表示已经听完全部课程，并留下笔记连结。截至2021年9月30日，李宏毅的YouTube频道有8.99万位订阅者，最热门的影片有56万次观看。</p><p>李宏毅擅长用浅显易懂的语言，以学生喜爱的精灵宝可梦、凉宫春日等动漫来讲解复杂的机器学习技术，因此被亲切地称为“精灵宝可梦大师”。中华民国电脑学会称李宏毅为“第一个公开有系统地完整深入讲解深度学习技术的学者，使得华文的深度学习教学与英文世界并驾齐驱。”</p></blockquote><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211207143939983.png" alt="维基百科对老师的介绍"></p><p>从维基百科的介绍中能够看出来，李宏毅老师讲解机器学习的课程非常的有趣和生动，因此广受欢迎。我在当初也是受到了李宏毅老师早年的课程的熏陶，才进入了ML/DL的大门。</p><h2 id="3-Why-is-Hung-yi-Lee"><a href="#3-Why-is-Hung-yi-Lee" class="headerlink" title="3. Why is Hung-yi Lee"></a>3. Why is Hung-yi Lee</h2><p>为什么选择李宏毅老师的课程而非其他老师的课程？</p><p>首先是因为李宏毅老师的课程非常的通俗易懂，在讲课的时候老师会举各种各样的例子，宝可梦、全职猎人、凉宫春日等等，贴近与学生的距离。</p><p>其次是因为老师的ML的课程从16年到现在以及过去了5年时间了，在这五年中老师的课程已经经过了长久的打磨，因此会具备丰富的经验，所以学起来的时候体验会好很多。</p><p>最后就是关于我个人的原因，因为先前没有学完老师2019年的课程，感到非常遗憾，所想要在2021年完成老师的课程，弥补当年的遗憾。</p><h2 id="4-How-to-learn"><a href="#4-How-to-learn" class="headerlink" title="4. How to learn"></a>4. How to learn</h2><p>本系列文章将会记录每个作业的说明，我对每个作业的理解以及我在完成作业时的Update，在最后会附带上完整的项目代码。</p><p>所以每一个博客对应的一个作业，其结构大概类似于下面：</p><ol><li>作业介绍</li><li>我的作业动态</li><li>最终代码</li></ol>]]></content>
      
      
      <categories>
          
          <category> 李宏毅ML2021 Spring Homeworks </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Deep Learning </tag>
            
            <tag> Hungyi Li </tag>
            
            <tag> Machine Learning </tag>
            
            <tag> CNN </tag>
            
            <tag> Attention </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于hexo的个人技术博客搭建 Part 4 Markdown编辑器Typora的设置以及腾讯云图床设置</title>
      <link href="/2021/12/10/ji-yu-hexo-de-ge-ren-ji-zhu-bo-ke-da-jian-part-4-markdown-bian-ji-qi-typora-de-she-zhi-yi-ji-teng-xun-yun-tu-chuang-she-zhi/"/>
      <url>/2021/12/10/ji-yu-hexo-de-ge-ren-ji-zhu-bo-ke-da-jian-part-4-markdown-bian-ji-qi-typora-de-she-zhi-yi-ji-teng-xun-yun-tu-chuang-she-zhi/</url>
      
        <content type="html"><![CDATA[<blockquote><p>前面我们通过hexo在本地搭建出了静态博客网站的框架，那么我们还需要一个合适的Markdown编辑器来帮助我们快乐的写博客</p></blockquote><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211211015803341.png" alt="最终效果图:Nord主题"></p><span id="more"></span><h1 id="基于Hexo的个人技术博客搭建-——-Markdown编辑器Typora的设置以及腾讯云图床设置"><a href="#基于Hexo的个人技术博客搭建-——-Markdown编辑器Typora的设置以及腾讯云图床设置" class="headerlink" title="基于Hexo的个人技术博客搭建 ——  Markdown编辑器Typora的设置以及腾讯云图床设置"></a>基于Hexo的个人技术博客搭建 ——  Markdown编辑器Typora的设置以及腾讯云图床设置</h1><p>通过前面的几讲，我们已经成功的在本地搭建出来了一个博客网站，并且进行了美化。然而博客网站的目的在于发布我们自己的博客，因此我们还需要一个趁手的编辑器来帮助我们编写<code>Markdown</code>文章。</p><p>经过重重考虑，我最终的博客开发环境为：<code>Typora</code> + 腾讯云图床 + <code>Github</code>托管网页。</p><p>在本章将讲解Typora编辑器的设置和腾讯云图床的设置。下节将讲解腾讯云图床的设置。</p><h2 id="1-What-is-Typora-图床？"><a href="#1-What-is-Typora-图床？" class="headerlink" title="1. What is Typora/图床？"></a>1. What is Typora/图床？</h2><h3 id="1-Typora"><a href="#1-Typora" class="headerlink" title="1. Typora"></a>1. Typora</h3><p>首先是<code>维基百科</code>的介绍</p><blockquote><p><strong>From Wikipidia</strong></p><p>Typora是一款由Abner Lee开发的轻量级Markdown编辑器，适用于OS X、Windows和Linux三种操作系统。与其他Markdown编辑器不同的是，Typora没有采用源代码和预览双栏显示的方式，而是采用所见即所得的编辑方式，实现了即时预览的功能，但也可切换至源代码编辑模式。</p></blockquote><p>其实说白了，<code>Typora</code>和记事本没有任何的区别，都是拿来写文本文件的。只不过Typora是专门拿来写Markdown文件的。针对<code>Markdown</code>文件的编写，Typora的体验会非常好。</p><p>此外Typora是一个三平台通用的编辑器，而且非常轻量，因此对于大型的IDE而言打开速度会快很多</p><h3 id="2-图床"><a href="#2-图床" class="headerlink" title="2. 图床"></a>2. 图床</h3><p><code>百度百科</code>的介绍</p><blockquote><p><strong>From BaiduBaike</strong></p><p>图床一般是指储存图片的服务器，有国内和国外之分。国外的图床由于有空间距离等因素决定访问速度很慢影响图片显示速度。国内也分为单线空间、多线空间和cdn加速三种。</p></blockquote><p>其实说白了，图床就相当于一个相册，类似于百度云等云盘的相册功能。只不过图床里的图片都会有一个链接，通过链接就能够访问、看到这张图片。例如下面的这张图片</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211207132435763.png" alt="根据链接显示图像"></p><h2 id="2-Why-Typora-图床？"><a href="#2-Why-Typora-图床？" class="headerlink" title="2. Why Typora/图床？"></a>2. Why Typora/图床？</h2><h3 id="1-Typora-1"><a href="#1-Typora-1" class="headerlink" title="1. Typora"></a>1. Typora</h3><p>其实选择Typora的原因有很多，具体来说吸引我的原因有下面的几个：</p><ol><li><p><strong>好用</strong>：用Typora来写Markdown的体验非常流畅与直观。因为Markdown本身就是一个 标记语言，所以会有非常多的标记用来说明一段文本应该被展示的样子，具体来说效果就是下面的图片中我正在写的这篇文章的Markdown源码</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211210210326416.png" alt="Markdown的源代码"></p><p>但是在Typora中，源码形式的Markdown会被直接解析并显示出对应的效果，因此会非常直观，方便书写。具体效果如下</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211210210717942.png" alt="Typora中的即时显示"></p></li></ol><ol start="2"><li><p><strong>多平台互通</strong>：因为我本身是需要进行软件程序开发、深度学习模型训练的，因此在Linux进行这些操作就会非常的舒服。而有的时候需要我去处理一些Word文本、PPT等等。这个时候就还是需要Windows上的全家桶。因此多个平台上Typora都可以使用，结合Typora以文件的形式保存配置信息，我们可以做到三个平台上Typora的无缝切换，不存在任何体验的割裂，因此非常的舒服</p></li><li><p><strong>好看</strong>：Typora是基于Node.js的程序，因此支持自己编写css来定义样式。所以我们可以自己设置Typora的外观。此外Typora还有一个不错的皮肤市场，因此我们其实可以从这个市场中下载皮肤然后进行使用。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211207134405026.png" alt="Typora的皮肤市场"></p></li></ol><ol start="4"><li><p><strong>非常好的图床支持</strong>：稍后我们其实会讲到图床的好处和为什么需要图床，而<code>Typora</code>内置了<code>PicGo</code>，对各大主流的图床的支持都非常好，因此和图床搭配使用效果奇佳。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211210211710899.png" alt="Typora中的图床设置"></p></li><li><p>……</p></li></ol><p>总之，Typora有着多种多样的优点吸引我，因此我的博客中也是使用Typora作为Markdown的编辑器。事实上，我从2019年开始就已经使用Typora了，可谓是资深用户。</p><p>需要注意的是，Typora在之前全都是测试版，从2021年11月23日起发布了1.0版本，并且从1.0版本以后成为收费软件，售价14.99美元，约合89RMB。</p><p>不过官方也承诺过1.0版本以前的版本都将继续保持免费，而1.0版本以后的版本都将保持收费。其实在现在最新的Typora免费版（大概是0.11）的功能和1.0版本基本没有差别，因此再没有推出大的更新之前/足够吸引我的功能之前还是继续使用免费版。其实免费版也已经够大家使用了。</p><p>下面也会讲解如何下载免费版。</p><h3 id="2-图床-1"><a href="#2-图床-1" class="headerlink" title="2. 图床"></a>2. 图床</h3><p>我们通过hexo搭建的博客其实是一个静态博客。静态博客就意味着博客中所有的网页资源都是静态的，在用户点击请求文章的时候，文字和图片同时被发送过去。然而我们的博客资源在传输的过程中，博客资源所在的服务器的传输带宽有限，因此我们如果把图片和博客放在同一个服务器上，传输的速度就会很慢。此外我们后面也会讲解用Github托管博客资源，所以我们每次进行本地推送和异地同步就会很浪费时间。</p><p>而由于图床是我们把图片存放在图床商家的服务器，通过一个链接就可以访问，因此使用图床就可以使得用户访问文章的时候，图片的带宽需求由图床服务器承担。而图床服务器一般带宽都会非常大。因此就可以加速页面的加载速度，同时方便我们进行推送和同步。</p><p>对于我个人而言，我使用的是<strong>腾讯云存储桶作为图床</strong>，而主要原因就是我的服务器也是腾讯云的，所以我懒得换来换去。<strong>其实任何的图床厂商都是可以的。</strong></p><p>下面我们会讲解如何创建腾讯云图床，以及在Typora中设置图床。对于其他的图床在Typora中的设置其实查一下都会有。</p><h2 id="3-Typora设置"><a href="#3-Typora设置" class="headerlink" title="3. Typora设置"></a>3. Typora设置</h2><p>对于Typora的设置，主要包含四个方面：下载免费版， 换个皮肤，设置快捷键以及图床设置。不过由于图床设置是和图床有关的，因此最后的图床设置在图床创建后面讲</p><h3 id="1-下载免费版"><a href="#1-下载免费版" class="headerlink" title="1. 下载免费版"></a>1. 下载免费版</h3><p>免费版其实在官网中就有列出来。<a href="https://typora.io/">官网</a>：<a href="https://typora.io/">https://typora.io/</a></p><p>我们点进去官网翻到最底下，有一个<code>所有的历史文件</code></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211210214453168.png" alt="历史文件"></p><p>点进去之后点到开发测试版本</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211210214545807.png" alt="开发测试版本"></p><p>然后同样在最下面的old release</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211210215003642.png" alt="旧版本"></p><p>点进去之后就可以下载</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211210215114073.png" alt="下载旧版本"></p><p>点击之后下载即可</p><h3 id="2-设置皮肤"><a href="#2-设置皮肤" class="headerlink" title="2. 设置皮肤"></a>2. 设置皮肤</h3><p>安装之后，我们就可以安装皮肤。前面说过，我们可以在市场上下载皮肤，其实皮肤就是css文件加上资源文件。所以我们安装皮肤其实就是把下载的这些资源粘贴到皮肤文件夹中。</p><p>我们首先打开资源文件夹，在左上角的<code>file</code>–&gt; <code>preference</code>中选择<code>Apprence</code>，然后选择打开<code>Theme Folder</code></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211207141743141.png" alt="打开主题文件夹"></p><p>然后在皮肤市场中下载需要的皮肤，我下载的<code>Nord</code>，<code>Dracula</code>和<code>Mint</code></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211207141909886.png" alt="下载皮肤"></p><p>然后把下载下的皮肤压缩文件解压之后复制到打开的主题文件夹中即可，需要注意的是，皮肤最重要的是css文件，而皮肤名的文件夹中放的是一些资源，所以我们需要把css放到正确的位置</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211207142137820.png" alt="复制皮肤到皮肤文件夹中"></p><p>最后重启Typora就可以在左上角的Themes中选择皮肤</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211207142227515.png" alt="选择皮肤"></p><p>选择<code>Mint</code>主题看看效果</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211207142620434.png" alt="Mint主题效果"></p><h3 id="3-设置快捷键"><a href="#3-设置快捷键" class="headerlink" title="3. 设置快捷键"></a>3. 设置快捷键</h3><p>Typora的快捷键设置其实是通过一个json文件完成，因此我们在这个Json文件中编辑快捷键即可</p><p>需要注意的是，我们需要首先在英文版中查看需要设置快捷键的功能的名称，例如我们需要设置快捷插入代码框Code（我这里是以及设置过了）</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211207141509346.png" alt="查看功能名称"></p><p>然后我们打开Preference中的General，然后打开在keyBinding中设置功能和对应的键即可。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211210222113923.png" alt="image-20211210222113923"></p><h2 id="4-腾讯云图床创建以及Typora配置"><a href="#4-腾讯云图床创建以及Typora配置" class="headerlink" title="4. 腾讯云图床创建以及Typora配置"></a>4. 腾讯云图床创建以及Typora配置</h2><p>关于腾讯云图床的配置，参考这篇<a href="https://blog.51cto.com/u_15070902/3764737">文章</a>：<a href="https://blog.51cto.com/u_15070902/3764737">https://blog.51cto.com/u_15070902/3764737</a></p><p>最通过这样的配置，我们就完成了Typora的设置与图床的搭配，现在开始我们就可以快乐的开始写博客了 <span class="github-emoji"><span>😆</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f606.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p>]]></content>
      
      
      <categories>
          
          <category> Hexo博客搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ROS杂篇 Melodic下Python3中使用CV_Bridge与TF</title>
      <link href="/2021/11/23/ros-za-pian-melodic-xia-python3-zhong-shi-yong-cv-bridge-yu-tf/"/>
      <url>/2021/11/23/ros-za-pian-melodic-xia-python3-zhong-shi-yong-cv-bridge-yu-tf/</url>
      
        <content type="html"><![CDATA[<blockquote><p>TF与CV_Bridge是ROS中非常好用的工具，前者用于帮助我们进行坐标转换，后者帮助我们在ROS中使用OpenCV。然而在Melodic版本中Python3下使用这两个包却会报错，本文将解决这Python3CV_Bridge与TF的使用问题。</p></blockquote><span id="more"></span><h1 id="ROS杂篇-Melodic下Python3中使用CV-Bridge与TF"><a href="#ROS杂篇-Melodic下Python3中使用CV-Bridge与TF" class="headerlink" title="ROS杂篇 Melodic下Python3中使用CV_Bridge与TF"></a>ROS杂篇 Melodic下Python3中使用CV_Bridge与TF</h1><blockquote><p>前言：为什么要写这篇博客</p></blockquote><p>在使用ROS驱动机器人的时候，经常遇到的一个问题就是我们需要使用摄像头来获得视觉信息，并且在此基础上，指导机器人进行操作。</p><h2 id="Updates"><a href="#Updates" class="headerlink" title="Updates ! ! !"></a>Updates ! ! !</h2><p>由于最近一个周我的工作变动，目前需要在Ubuntu 20.04 LTS进行ROS开发，20.04中TF和CV_Bridge默认都支持Python3，因此目前我不需要解决这个问题。这篇文章以后更完</p>]]></content>
      
      
      <categories>
          
          <category> ROS杂篇 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ROS </tag>
            
            <tag> cv_bridge </tag>
            
            <tag> Ubuntu </tag>
            
            <tag> melodic </tag>
            
            <tag> OpenCv </tag>
            
            <tag> tf2 </tag>
            
            <tag> sensor_msgs </tag>
            
            <tag> roslaunch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ROS杂篇 ROS中使用Kinect V2 Part2：iai-kinect使用</title>
      <link href="/2021/11/19/ros-za-pian-ros-zhong-shi-yong-kinect-v2-iai-kinect-shi-yong/"/>
      <url>/2021/11/19/ros-za-pian-ros-zhong-shi-yong-kinect-v2-iai-kinect-shi-yong/</url>
      
        <content type="html"><![CDATA[<blockquote><p>本篇详细介绍了iai-kinect2功能包，在此基础上通过iai-kinect2获取深度图像，从而进行ROS中的开发。</p></blockquote><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211121155602208.png" alt="使用Kinect V2获取得到图像经过YOLO检测并与深度配准"></p><span id="more"></span><h1 id="ROS杂篇-ROS中使用Kinect-V2-Part2：iai-kinect2使用"><a href="#ROS杂篇-ROS中使用Kinect-V2-Part2：iai-kinect2使用" class="headerlink" title="ROS杂篇 ROS中使用Kinect V2 Part2：iai-kinect2使用"></a>ROS杂篇 ROS中使用Kinect V2 Part2：iai-kinect2使用</h1><blockquote><p>前言：为什么要写这篇博客</p></blockquote><p>在上一篇中，我们介绍了如何在<code>Ubuntu</code>上安装<code>Kinect V2</code>的开原驱动：<code>libfrenect2</code>，以及如何安装在<code>ROS</code>中使用<code>libfrenect2</code>获取深度图像的功能包<code>iai-kinect2</code>。然而在上一篇文章的最后，我们只是简单的使用了一下<code>iai-kinect2</code>功能包。但是我们通过<code>rostopic list</code>却看到了非常多的话题，那么这些话题之间到底是什么关系呢？又该如何基于<code>iai-kinect2</code>进行深度开发呢？</p><p>本节就将在上一篇的基础上，在介绍<code>iai-kinect2</code>的基础上，利用<code>iai-kinect2</code>进行开发。如果没有看过第一篇文章、没有配置好环境，先按照<a href="http://jackwang.cafe/2021/11/18/ros-za-pian-an-zhuang-kinect-v2-qu-dong/">第一篇文章中的教程</a>跟着来。</p><p>废话不多说，下面就开始吧。</p><h2 id="1-什么是iai-kinect2？"><a href="#1-什么是iai-kinect2？" class="headerlink" title="1. 什么是iai-kinect2？"></a>1. 什么是iai-kinect2？</h2><blockquote><p>我认为合理的学习方法：学什么前，先问是什么，再问为什么学（学习这个东西的目的），搞懂学了能为我们带来那些帮助，最后再开始学</p></blockquote><p>如果你有看过我的上一篇博客的话，你应该就会知道，<code>iai-kinect2</code>是<code>ROS</code>的一个功能包，他的作用在于调用了<code>libfreenect2</code>驱动来获得<code>Kinect V2</code>相机得到的深度图像以及通过<code>OpenGL</code>、<code>CUDA</code>、<code>CPU</code>等平台极大地提升了渲染速度和适应性。最终实现了多平台下深度图像30 FPS的性能。</p><p>下面是对<code>iai-kinect2</code>的更加详细的介绍</p><h3 id="A-谁开发的iai-kinect2"><a href="#A-谁开发的iai-kinect2" class="headerlink" title="A. 谁开发的iai-kinect2?"></a>A. 谁开发的iai-kinect2?</h3><p>iai-kinect2是由德国不莱梅大学（University of Bremen）的博士生Thiemo Wiedemeyer。他在2013年的时候去不莱梅大学的人工智能研究所读博的时候开发出了<code>iai-kinect2</code>。在2014年的时候，经过几个月的开发，他和他组里的另外一个负责串口相关部分的博士生合作，最终完成了这个非常好用的库，并在ROS的论坛上发布了这一消息。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211120010505103.png" alt="Thiemo Wiedemeyer在ROS论坛上发布这个功能包的帖子"></p><h3 id="B-iai-kinect2的组成"><a href="#B-iai-kinect2的组成" class="headerlink" title="B. iai-kinect2的组成"></a>B. iai-kinect2的组成</h3><p>前面我们只是从大体上直到了<code>iai-kinect2</code>是一个<code>ROS</code>的功能包，他调用了<code>libfreenect2</code>来获取深度图像。其实更准确的说，<code>iai-kinect2</code>是<code>ROS</code>的一个<strong>元功能包</strong>。</p><blockquote><p><strong>什么是元功能包？</strong></p><p><code>ROS</code>中有一些基础的概念：工作空间、源码空间、编译空间、开发空间、功能包、元功能包、发行版等等。</p><p>通常我们工作是在一个工作空间中，这个工作空间中包含了我们开发的一切：我们的源代码、生成的库文件、生成的头文件、得到的可执行文件……而我们写的代码都以功能包的形式组织起来，我们在发布代码的时候就是以功能包的形式进行发布。而通常几个具有相关功能的功能包组合在一起就是一个元功能包，我们通过元功能包将几个功能包组合起来，使得他们成为一个整体来进行发布。</p><p>在下图中，我们所有的代码都在catkin_workspace这个工作空间中（挖个坑，以后写写文章讲讲什么是<code>catkin</code>）。而具体来说，我们的源代码存放在<code>src</code>源码空间中，我们通过<code>catkin_make</code>会对我们所有的源代码进行编译，编译过程中产生的中间文件，例如<code>Cmake</code>的<code>module</code>以及<code>Makefile</code>等等都在<code>build</code>编译空间中。我们最后的可执行文件和我们自己写的库文件都在<code>devel</code>开发空间中。对于源码空间中，一个package就负责实现一个具体的功能，例如读取摄像头、抓取物体等等。如果package1和package2有所关联，例如package1是读取摄像头的功能包，而package2是驱动机械臂的功能包，那么他们两个在一起可以完成机器人抓取物体这个功能，那么这个时候，我们就可以新建一个功能包，这个功能包什么都没有，只有表明这两个功能包在一起组成一个元功能包的配置信息，即描述元功能包架构的功能包。在下面就是iai-kinect2这个功能包</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F.jpg" alt="ROS中的基础概念/文件系统"></p></blockquote><p>具体来说，<code>iai-kinect2</code>这个元功能包由几个功能包组成：<code>iai-kinect2</code>（元功能包描述功能包）、<code>kinect2_bridge</code>（负责调用libfreenect2、OpenGL获取图像的功能包）、<code>kinect_calibration</code>（提供了Kinect V2相机GUI校准的功能包）、<code>kinect_registration</code>（负责点云和深度图像配准的功能包）以及<code>kinect_viewer</code>（提供了简单的可视化功能的功能包）。</p><p>具体功能包的架构可以看下图</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211120012913705.png" alt="iai-kinect2元功能包的架构"></p><h3 id="C-iai-kinect2的功能"><a href="#C-iai-kinect2的功能" class="headerlink" title="C. iai-kinect2的功能"></a>C. iai-kinect2的功能</h3><p>关于<code>iai-kinect2</code>的功能，我们前面其实已经体验过了他的可视化和获取深度图像以及点云和彩色图像的配准。因此这里主要关注<code>iai-kinect2</code>中的标定功能。</p><blockquote><p>众所周知，我们利用相机除了拍照以外，还有一个重要的功能就是从相机获取的图像信息出发计算三维空间中物体的几何信息并由此重建和识别物体。这也是计算机视觉的基本任务之一。那么我们在进行推断的时候就存在一些问题，其中最主要的一个问题就是相机的镜头畸变，即由于相机的镜头是一个凹透镜导致物体间真实的距离被扭曲。因此我们需要通过一些手段来进行修正。进行修正之后会得到一些参数，利用这些参数我们就可以对畸变的图像进行修正，以实现获得物体间精准的位置。由于这个参数和相机的镜头、角度有关，因此他们又叫做相机参数。通过标定我们就能够获得这些参数。</p><p>例如在下图中，我们可以直到机器人和地板的线都应该是直线，但是由于畸变导致原本直的线歪曲，这个现象在图像边缘处尤为明显。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211120021326327.png" alt="相机畸变修正的例子"></p><p>当然除了畸变以外还有世界坐标转相机坐标等等问题，他们统称为相机参数。</p><p>关于相机标定的更多内容，推荐参考搜狐上的博客：<a href="https://www.sohu.com/a/336803765_120071391">https://www.sohu.com/a/336803765_120071391</a></p></blockquote><p><code>iai-kinect2</code>中直接提供了用于相机标定的程序，因此我们可以直接在命令行中进行调用即可。关于如何进行校准，参考<a href="https://github.com/code-iai/iai_kinect2/tree/master/kinect2_calibration#calibrating-the-kinect-one">github上的readme</a></p><p>最终通过标定，可以实现的效果如下。可以看出来，原本倾斜的图像被校准了。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/68747470733a2f2f61692e756e692d6272656d656e2e64652f5f6d656469612f6b696e656374325f636c6f75645f6e6f63616c69622e706e67" alt="未校准前的点云图像"></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/68747470733a2f2f61692e756e692d6272656d656e2e64652f5f6d656469612f6b696e656374325f636c6f75645f63616c69622e706e67" alt="校准后的点云图像"></p><h2 id="2-iai-kinect2的使用"><a href="#2-iai-kinect2的使用" class="headerlink" title="2. iai-kinect2的使用"></a>2. iai-kinect2的使用</h2><p>我们在下面将对<code>iai-kinect2</code>的使用进行介绍，不过需要说明的是：由于<code>iai-kinect2</code>的代码非常好，将自己尽可能的低耦合，因此其所有的依赖都是<code>ROS</code>的标准消息。因此，我们学习iai-kinect2的使用主要是从下面两个方面去学习</p><ul><li><code>iai-kinect2</code>中使用的<code>ROS</code>的标准消息：<code>Image</code>和<code>CompressedImage</code></li><li><code>iai-kinect2</code>中每个话题的含义和作用</li></ul><h3 id="A-ROS中Image和CompressedImage"><a href="#A-ROS中Image和CompressedImage" class="headerlink" title="A. ROS中Image和CompressedImage"></a>A. ROS中Image和CompressedImage</h3><p><code>ROS</code>中为图像数据提供了两个官方的消息类型：<code>Image</code>和<code>CompressedImage</code>。其中<code>Image</code>是没有经过压缩的图片而<code>CompressedImage</code>则是经过压缩的图片。由与<code>ROS</code>中的所有的消息其实都是基于<code>std_msgs</code>提供的基础数据类型上定义的，因此<code>Image</code>和<code>CompressedImage</code>也不例外。具体来说，图片本身是用一个装着字节流的数组保存的，而图片的<code>frame_id</code>和对应的相机信息等等都是有对应的项。</p><h4 id="消息定义"><a href="#消息定义" class="headerlink" title="消息定义"></a>消息定义</h4><p>首先是<code>Image</code>消息的定义，可以看到<code>header</code>中提供时间戳等信息，而图像的长宽、字节序、编码方式等等内容都是用于帮助解码<code>data</code>字节流的。此外也能够看到，<code>ROS</code>中的图像每一个像素都是用一个8位无符号整数描述的。</p><pre class="line-numbers language-msg"><code class="language-msg"># This message contains an uncompressed image# (0, 0) is at top-left corner of image#Header header        # Header timestamp should be acquisition time of image                     # Header frame_id should be optical frame of camera                     # origin of frame should be optical center of camera                     # +x should point to the right in the image                     # +y should point down in the image                     # +z should point into to plane of the image                     # If the frame_id here and the frame_id of the CameraInfo                     # message associated with the image conflict                     # the behavior is undefineduint32 height         # image height, that is, number of rowsuint32 width          # image width, that is, number of columns# The legal values for encoding are in file src/image_encodings.cpp# If you want to standardize a new string format, join# ros-users@lists.sourceforge.net and send an email proposing a new encoding.string encoding       # Encoding of pixels -- channel meaning, ordering, size                      # taken from the list of strings in include/sensor_msgs/image_encodings.huint8 is_bigendian    # is this data bigendian?uint32 step           # Full row length in bytesuint8[] data          # actual matrix data, size is (step * rows)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>类似的，<code>CompressedImage</code>则是经过压缩的图像，具体的压缩方式就是使用<code>jpg</code>、<code>png</code>等编码格式，因此图像的编码方式是固定的</p><pre class="line-numbers language-tmsg"><code class="language-tmsg">Header header        # Header timestamp should be acquisition time of image                     # Header frame_id should be optical frame of camera                     # origin of frame should be optical center of camera                     # +x should point to the right in the image                     # +y should point down in the image                     # +z should point into to plane of the imagestring format        # Specifies the format of the data                     #   Acceptable values:                     #     jpeg, pnguint8[] data         # Compressed image buffer<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后需要注意的是<code>iai-kinect2</code>中还用到了<code>camerainfo</code>这个<code>ROS</code>的官方消息，其内容如下，主要定义了相机的内外参数，获取图像的分辨率等信息</p><pre class="line-numbers language-msg"><code class="language-msg"># This message defines meta information for a camera. It should be in a# camera namespace on topic "camera_info" and accompanied by up to five# image topics named:##   image_raw - raw data from the camera driver, possibly Bayer encoded#   image            - monochrome, distorted#   image_color      - color, distorted#   image_rect       - monochrome, rectified#   image_rect_color - color, rectified## The image_pipeline contains packages (image_proc, stereo_image_proc)# for producing the four processed image topics from image_raw and# camera_info. The meaning of the camera parameters are described in# detail at http://www.ros.org/wiki/image_pipeline/CameraInfo.## The image_geometry package provides a user-friendly interface to# common operations using this meta information. If you want to, e.g.,# project a 3d point into image coordinates, we strongly recommend# using image_geometry.## If the camera is uncalibrated, the matrices D, K, R, P should be left# zeroed out. In particular, clients may assume that K[0] == 0.0# indicates an uncalibrated camera.########################################################################                     Image acquisition info                          ######################################################################### Time of image acquisition, camera coordinate frame IDHeader header    # Header timestamp should be acquisition time of image                 # Header frame_id should be optical frame of camera                 # origin of frame should be optical center of camera                 # +x should point to the right in the image                 # +y should point down in the image                 # +z should point into the plane of the image########################################################################                      Calibration Parameters                         ######################################################################### These are fixed during camera calibration. Their values will be the ## same in all messages until the camera is recalibrated. Note that    ## self-calibrating systems may "recalibrate" frequently.              ##                                                                     ## The internal parameters can be used to warp a raw (distorted) image ## to:                                                                 ##   1. An undistorted image (requires D and K)                        ##   2. A rectified image (requires D, K, R)                           ## The projection matrix P projects 3D points into the rectified image.######################################################################### The image dimensions with which the camera was calibrated. Normally# this will be the full camera resolution in pixels.uint32 heightuint32 width# The distortion model used. Supported models are listed in# sensor_msgs/distortion_models.h. For most cameras, "plumb_bob" - a# simple model of radial and tangential distortion - is sufficient.string distortion_model# The distortion parameters, size depending on the distortion model.# For "plumb_bob", the 5 parameters are: (k1, k2, t1, t2, k3).float64[] D# Intrinsic camera matrix for the raw (distorted) images.#     [fx  0 cx]# K = [ 0 fy cy]#     [ 0  0  1]# Projects 3D points in the camera coordinate frame to 2D pixel# coordinates using the focal lengths (fx, fy) and principal point# (cx, cy).float64[9]  K # 3x3 row-major matrix# Rectification matrix (stereo cameras only)# A rotation matrix aligning the camera coordinate system to the ideal# stereo image plane so that epipolar lines in both stereo images are# parallel.float64[9]  R # 3x3 row-major matrix# Projection/camera matrix#     [fx'  0  cx' Tx]# P = [ 0  fy' cy' Ty]#     [ 0   0   1   0]# By convention, this matrix specifies the intrinsic (camera) matrix#  of the processed (rectified) image. That is, the left 3x3 portion#  is the normal camera intrinsic matrix for the rectified image.# It projects 3D points in the camera coordinate frame to 2D pixel#  coordinates using the focal lengths (fx', fy') and principal point#  (cx', cy') - these may differ from the values in K.# For monocular cameras, Tx = Ty = 0. Normally, monocular cameras will#  also have R = the identity and P[1:3,1:3] = K.# For a stereo pair, the fourth column [Tx Ty 0]' is related to the#  position of the optical center of the second camera in the first#  camera's frame. We assume Tz = 0 so both cameras are in the same#  stereo image plane. The first camera always has Tx = Ty = 0. For#  the right (second) camera of a horizontal stereo pair, Ty = 0 and#  Tx = -fx' * B, where B is the baseline between the cameras.# Given a 3D point [X Y Z]', the projection (x, y) of the point onto#  the rectified image is given by:#  [u v w]' = P * [X Y Z 1]'#         x = u / w#         y = v / w#  This holds for both images of a stereo pair.float64[12] P # 3x4 row-major matrix########################################################################                      Operational Parameters                         ######################################################################### These define the image region actually captured by the camera       ## driver. Although they affect the geometry of the output image, they ## may be changed freely without recalibrating the camera.             ######################################################################### Binning refers here to any camera setting which combines rectangular#  neighborhoods of pixels into larger "super-pixels." It reduces the#  resolution of the output image to#  (width / binning_x) x (height / binning_y).# The default values binning_x = binning_y = 0 is considered the same#  as binning_x = binning_y = 1 (no subsampling).uint32 binning_xuint32 binning_y# Region of interest (subwindow of full camera resolution), given in#  full resolution (unbinned) image coordinates. A particular ROI#  always denotes the same window of pixels on the camera sensor,#  regardless of binning settings.# The default setting of roi (all values 0) is considered the same as#  full resolution (roi.width = width, roi.height = height).RegionOfInterest roi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>关于其他传感器消息，参考<code>roswiki</code>的文章：<a href="http://wiki.ros.org/sensor_msgs">http://wiki.ros.org/sensor_msgs</a></p><p>关于全部的官方消息，参考<code>roswiki</code>文章：<a href="http://wiki.ros.org/common_msgs?distro=noetic">http://wiki.ros.org/common_msgs?distro=noetic</a></p><h4 id="使用cv-bridge转接给OpenCV"><a href="#使用cv-bridge转接给OpenCV" class="headerlink" title="使用cv_bridge转接给OpenCV"></a>使用cv_bridge转接给OpenCV</h4><p>需要注意的是，上面的方式的到的图像都是<code>ROS</code>中定义的图像的消息，而<code>ROS</code>中的图像的消息和<code>OpenCV</code>的并不一样，因此如果我们后续还要对图像进行处理的话，就需要将<code>ROS</code>中的图像转变为<code>OpenCV</code>的图像。为此我们就需要使用<code>CV_bridge</code>。</p><p>ROS中的图像和OpenCV中的图像不一样的地方在于，<code>ROS</code>是通过字节流以及辅助的解码信息来表示一张图像，而OpenCV则是通过其核心的<code>lplImage</code>数据结构来表示一张图像（<code>lpl</code>表示 <code>Intel Image Processing Library</code>）。<code>lplImage</code>的定义如下，当然我们没必要全部搞懂，看看定义知道不同即可。</p><p>此外<code>Python</code>中<code>OpenCV</code>的图像的表示是基于<code>Num Py</code>的，因此还会存在不一样的地方。</p><pre class="line-numbers language-c++"><code class="language-c++">typedef struct _IplImage      {          int  nSize;         /* IplImage大小 */          int  ID;            /* 版本 (=0)*/          int  nChannels;     /* 大多数OPENCV函数支持1,2,3 或 4 个通道 */          int  alphaChannel;  /* 被OpenCV忽略 */          int  depth;         /* 像素的位深度: IPL_DEPTH_8U, IPL_DEPTH_8S, IPL_DEPTH_16U,                                IPL_DEPTH_16S, IPL_DEPTH_32S, IPL_DEPTH_32F and IPL_DEPTH_64F 可支持 */          char colorModel[4]; /* 被OpenCV忽略 */          char channelSeq[4]; /* 同上 */          int  dataOrder;     /* 0 - 交叉存取颜色通道, 1 - 分开的颜色通道.                                cvCreateImage只能创建交叉存取图像 */          int  origin;        /* 0 - 顶—左结构,                                1 - 底—左结构 (Windows bitmaps 风格) */          int  align;         /* 图像行排列 (4 or 8). OpenCV 忽略它，使用 widthStep 代替 */          int  width;         /* 图像宽像素数 */          int  height;        /* 图像高像素数*/          struct _IplROI *roi;/* 图像感兴趣区域. 当该值非空只对该区域进行处理 */          struct _IplImage *maskROI; /* 在 OpenCV中必须置NULL */          void  *imageId;     /* 同上*/          struct _IplTileInfo *tileInfo; /*同上*/          int  imageSize;     /* 图像数据大小(在交叉存取格式下imageSize=image->height*image->widthStep），单位字节*/          char *imageData;  /* 指向排列的图像数据 */          int  widthStep;   /* 排列的图像行大小，以字节为单位 */          int  BorderMode[4]; /* 边际结束模式, 被OpenCV忽略 */          int  BorderConst[4]; /* 同上 */          char *imageDataOrigin; /* 指针指向一个不同的图像数据结构（不是必须排列的），是为了纠正图像内存分配准备的 */      }      IplImage;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>所以<code>cv_bridge</code>的功能就是下面这张图中所表述的</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/cv_bridge" alt="cv_bridge的作用"></p><p>更多关于<code>cv_bridge</code>的问题，参考<code>roswiki</code>：<a href="https://wiki.ros.org/cv_bridge">https://wiki.ros.org/cv_bridge</a></p><p>此外，需要注意的是，在<code>Melodic</code>下在<code>Python</code>中使用cv_bridge会报错无法加载一个so/dynamic啥啥啥，关于这个问题的解决，先挖个坑，以后再补。</p><h3 id="B-iai-kinect2中每个话题的含义和作用"><a href="#B-iai-kinect2中每个话题的含义和作用" class="headerlink" title="B. iai-kinect2中每个话题的含义和作用"></a>B. iai-kinect2中每个话题的含义和作用</h3><p>当我们以<code>launch</code>文件的形式运行<code>iai-kinect2</code>后，我们会看到很多的话题，这些话题其实分成三组：<code>hd</code>、<code>qhd</code>和<code>sd</code>。需要注意的是，每组话题下的<code>points</code>话题都只是只有通过<code>launch</code>文件运行才会看到的。</p><h4 id="HD话题"><a href="#HD话题" class="headerlink" title="HD话题"></a>HD话题</h4><p>HD话题其实指的是高分辨率的图像，由于<code>Kinect V2</code>相比<code>Kinect V1</code>，其图像极限分辨率1920x1080，因此HD话题中所有的图像都是极限分辨率1920x1080的图像</p><p>此外，HD话题下发布的color表示是RGB彩色图像、<code>color_rect</code>则是经过畸变处理（rectified）的图像，<code>compressed</code>的则是经过压缩的图像。depth则是深度图，<code>mono</code>则是单色灰度图。</p><pre class="line-numbers language-text"><code class="language-text">/kinect2/hd/camera_info/kinect2/hd/image_color/kinect2/hd/image_color/compressed/kinect2/hd/image_color_rect/kinect2/hd/image_color_rect/compressed/kinect2/hd/image_depth_rect/kinect2/hd/image_depth_rect/compressed/kinect2/hd/image_mono/kinect2/hd/image_mono/compressed/kinect2/hd/image_mono_rect/kinect2/hd/image_mono_rect/compressed/kinect2/hd/points<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="QHD话题"><a href="#QHD话题" class="headerlink" title="QHD话题"></a>QHD话题</h4><p>QHD话题的全称是Quater HD，即该话题是HD话题的1/4。原因在于HD话题下的图片实在是太大了，因此无论是数据的传输还是处理都很慢。所以QHD中的图像是对HD的图像进行降采样之后的图像，长宽各自降采样一半，所以是512x424的图片。因此图像处理起来速度很快</p><pre class="line-numbers language-text"><code class="language-text">/kinect2/qhd/camera_info/kinect2/qhd/image_color/kinect2/qhd/image_color/compressed/kinect2/qhd/image_color_rect/kinect2/qhd/image_color_rect/compressed/kinect2/qhd/image_depth_rect/kinect2/qhd/image_depth_rect/compressed/kinect2/qhd/image_mono/kinect2/qhd/image_mono/compressed/kinect2/qhd/image_mono_rect/kinect2/qhd/image_mono_rect/compressed/kinect2/qhd/points<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="SD话题"><a href="#SD话题" class="headerlink" title="SD话题"></a>SD话题</h4><p>SD话题中的图像都是从相机获得的红外和深度图像，因此大小都是原本的大小：512x424，处理起来速度还是比较快的。</p><pre class="line-numbers language-text"><code class="language-text">/kinect2/sd/camera_info/kinect2/sd/image_color_rect/kinect2/sd/image_color_rect/compressed/kinect2/sd/image_depth/kinect2/sd/image_depth/compressed/kinect2/sd/image_depth_rect/kinect2/sd/image_depth_rect/compressed/kinect2/sd/image_ir/kinect2/sd/image_ir/compressed/kinect2/sd/image_ir_rect/kinect2/sd/image_ir_rect/compressed/kinect2/sd/points<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="C-launch启动节点时候指定参数"><a href="#C-launch启动节点时候指定参数" class="headerlink" title="C. launch启动节点时候指定参数"></a>C. launch启动节点时候指定参数</h3><p>由于iai-kinect2自成一套系统，因此我们没有必要也很难修改他的代码来完成我们需要的功能。为此<code>iai-kinect2</code>的<code>launch</code>文件支持在启动的时候指定参数，来实现不同的功能，具体所有的参数如下</p><pre class="line-numbers language-bash"><code class="language-bash">roslaunch kinect2_bridge kinect2_bridge.launch <span class="token punctuation">[</span>options:<span class="token operator">=</span>value<span class="token punctuation">]</span>base_name:<span class="token operator">=</span><span class="token operator">&lt;</span>string<span class="token operator">></span>    default: kinect2    info:    <span class="token keyword">set</span> base name <span class="token keyword">for</span> all topicssensor:<span class="token operator">=</span><span class="token operator">&lt;</span>string<span class="token operator">></span>    default:    info:    serial of the sensor to usefps_limit:<span class="token operator">=</span><span class="token operator">&lt;</span>double<span class="token operator">></span>    default: -1.0    info:    limit the frames per secondcalib_path:<span class="token operator">=</span><span class="token operator">&lt;</span>string<span class="token operator">></span>    default: /home/wiedemeyer/work/src/iai_kinect2/kinect2_bridge/data/    info:    path to the calibration filesuse_png:<span class="token operator">=</span><span class="token operator">&lt;</span>bool<span class="token operator">></span>    default: <span class="token boolean">false</span>    info:    Use PNG compression instead of TIFFjpeg_quality:<span class="token operator">=</span><span class="token operator">&lt;</span>int<span class="token operator">></span>    default: 90    info:    JPEG quality level from 0 to 100png_level:<span class="token operator">=</span><span class="token operator">&lt;</span>int<span class="token operator">></span>    default: 1    info:    PNG compression level from 0 to 9depth_method:<span class="token operator">=</span><span class="token operator">&lt;</span>string<span class="token operator">></span>    default: cuda    info:    Use specific depth processing: default, cpu, opengl, opencl, cuda, clkde, cudakdedepth_device:<span class="token operator">=</span><span class="token operator">&lt;</span>int<span class="token operator">></span>    default: -1    info:    openCL device to use <span class="token keyword">for</span> depth processingreg_method:<span class="token operator">=</span><span class="token operator">&lt;</span>string<span class="token operator">></span>    default: opencl    info:    Use specific depth registration: default, cpu, openclreg_device:<span class="token operator">=</span><span class="token operator">&lt;</span>int<span class="token operator">></span>    default: -1    info:    openCL device to use <span class="token keyword">for</span> depth registrationmax_depth:<span class="token operator">=</span><span class="token operator">&lt;</span>double<span class="token operator">></span>    default: 12.0    info:    max depth valuemin_depth:<span class="token operator">=</span><span class="token operator">&lt;</span>double<span class="token operator">></span>    default: 0.1    info:    min depth valuequeue_size:<span class="token operator">=</span><span class="token operator">&lt;</span>int<span class="token operator">></span>    default: 2    info:    queue size of publisherbilateral_filter:<span class="token operator">=</span><span class="token operator">&lt;</span>bool<span class="token operator">></span>    default: <span class="token boolean">true</span>    info:    <span class="token function">enable</span> bilateral filtering of depth imagesedge_aware_filter:<span class="token operator">=</span><span class="token operator">&lt;</span>bool<span class="token operator">></span>    default: <span class="token boolean">true</span>    info:    <span class="token function">enable</span> edge aware filtering of depth imagespublish_tf:<span class="token operator">=</span><span class="token operator">&lt;</span>bool<span class="token operator">></span>    default: <span class="token boolean">false</span>    info:    publish static tf transforms <span class="token keyword">for</span> camerabase_name_tf:<span class="token operator">=</span><span class="token operator">&lt;</span>string<span class="token operator">></span>    default: as base_name    info:    base name <span class="token keyword">for</span> the tf framesworker_threads:<span class="token operator">=</span><span class="token operator">&lt;</span>int<span class="token operator">></span>    default: 4    info:    number of threads used <span class="token keyword">for</span> processing the images<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-iai-kinect2使用示例"><a href="#3-iai-kinect2使用示例" class="headerlink" title="3. iai-kinect2使用示例"></a>3. iai-kinect2使用示例</h2><p>经过上面的介绍，我们对于如何使用iai-kinect2来获得深度图像和点云应该有了认识，下面我们就给出几个使用的例子。</p><p>其实使用的具体流程很简单，就是去订阅HD、QHD、SD话题中的消息，然后使用CV_Bridge转换成OpenCV的图像，然后再使用OpenCV进行视频图像的处理。</p><h3 id="A-图像显示"><a href="#A-图像显示" class="headerlink" title="A. 图像显示"></a>A. 图像显示</h3><p>下面的这个程序是通过接受命令行参数来实现显示的节点，利用这个程序可以显示每个话题下的图像。不过有一个小问题是我本来想做的是可以同一时间多个窗口显示多个图像，这样效果会好很多。但是由于我电脑性能的问题跑起来很卡，但是显示单独的话题倒是很不错</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#! /home/jack/anaconda3/envs/ros/bin/python</span><span class="token triple-quoted-string string">""" 命令行快捷查看iai-kinect2图像的节点 """</span><span class="token triple-quoted-string string">"""@author: Jack Wang@copyright: Jack Wang@date: 2021-11-20"""</span><span class="token keyword">from</span> os <span class="token keyword">import</span> read<span class="token keyword">import</span> sys<span class="token keyword">import</span> argparse<span class="token keyword">from</span> typing <span class="token keyword">import</span> List<span class="token keyword">import</span> cv2<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token keyword">for</span> path_idx <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">"2.7"</span> <span class="token keyword">in</span> sys<span class="token punctuation">.</span>path<span class="token punctuation">[</span>path_idx<span class="token punctuation">]</span><span class="token punctuation">:</span>        temp <span class="token operator">=</span> sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>path_idx<span class="token punctuation">)</span>        <span class="token keyword">break</span>sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token keyword">import</span> rospy<span class="token keyword">from</span> cv_bridge <span class="token keyword">import</span> CvBridge<span class="token keyword">from</span> sensor_msgs<span class="token punctuation">.</span>msg <span class="token keyword">import</span> Image<span class="token punctuation">,</span> CompressedImage<span class="token keyword">class</span> <span class="token class-name">iaiKinect2Viewer</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">:</span>    bridge <span class="token operator">=</span> CvBridge<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> None<span class="token punctuation">:</span>        super<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>subcribers<span class="token punctuation">:</span> List<span class="token punctuation">[</span>rospy<span class="token punctuation">.</span>Subscriber<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        self<span class="token punctuation">.</span>windows_idx <span class="token operator">=</span> <span class="token number">0</span>        <span class="token keyword">assert</span> len<span class="token punctuation">(</span>args<span class="token punctuation">.</span>topic<span class="token punctuation">)</span> <span class="token operator">%</span> len<span class="token punctuation">(</span>args<span class="token punctuation">.</span>quality<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> f<span class="token string">"话题数不匹配"</span>        group_num <span class="token operator">=</span> len<span class="token punctuation">(</span>args<span class="token punctuation">.</span>topic<span class="token punctuation">)</span> <span class="token operator">//</span> len<span class="token punctuation">(</span>args<span class="token punctuation">.</span>quality<span class="token punctuation">)</span>        <span class="token keyword">for</span> quality <span class="token keyword">in</span> args<span class="token punctuation">.</span>quality<span class="token punctuation">:</span>            <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>group_num<span class="token punctuation">)</span><span class="token punctuation">:</span>                temp_topic <span class="token operator">=</span> args<span class="token punctuation">.</span>topic<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                self<span class="token punctuation">.</span>add_subscriber<span class="token punctuation">(</span>quality<span class="token punctuation">,</span> temp_topic<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">add_subscriber</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> quality<span class="token punctuation">:</span> str<span class="token punctuation">,</span> topic<span class="token punctuation">:</span> str<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">assert</span> quality <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">"sd"</span><span class="token punctuation">,</span> <span class="token string">"qhd"</span><span class="token punctuation">,</span><span class="token string">"hd"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> f<span class="token string">"无效的话题组"</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>quality<span class="token punctuation">,</span> topic<span class="token punctuation">)</span>        topic <span class="token operator">=</span> topic<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span>        prefix <span class="token operator">=</span> <span class="token string">"/kinect2"</span>        <span class="token keyword">if</span> <span class="token string">"color"</span> <span class="token keyword">in</span> topic <span class="token operator">and</span> <span class="token string">"rect"</span> <span class="token keyword">in</span> topic <span class="token operator">and</span> <span class="token string">"compressed"</span> <span class="token operator">not</span> <span class="token keyword">in</span> topic<span class="token punctuation">:</span>            self<span class="token punctuation">.</span>subcribers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>rospy<span class="token punctuation">.</span>Subscriber<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>prefix<span class="token punctuation">,</span> quality<span class="token punctuation">,</span> <span class="token string">"image_color_rect"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data_class<span class="token operator">=</span>Image<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>show_images<span class="token punctuation">,</span> queue_size<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> callback_args<span class="token operator">=</span>self<span class="token punctuation">.</span>windows_idx<span class="token punctuation">)</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>windows_idx <span class="token operator">+=</span> <span class="token number">1</span>        <span class="token keyword">elif</span> <span class="token string">"color"</span> <span class="token keyword">in</span> topic <span class="token operator">and</span> <span class="token string">"rect"</span> <span class="token keyword">in</span> topic <span class="token operator">and</span> <span class="token string">"compressed"</span> <span class="token keyword">in</span> topic<span class="token punctuation">:</span>            self<span class="token punctuation">.</span>subcribers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>rospy<span class="token punctuation">.</span>Subscriber<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>prefix<span class="token punctuation">,</span> quality<span class="token punctuation">,</span> <span class="token string">"image_color_rect"</span><span class="token punctuation">,</span><span class="token string">"compressed"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data_class<span class="token operator">=</span>CompressedImage<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>show_compressed_image<span class="token punctuation">,</span> queue_size<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> callback_args<span class="token operator">=</span>self<span class="token punctuation">.</span>windows_idx<span class="token punctuation">)</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>windows_idx <span class="token operator">+=</span> <span class="token number">1</span>        <span class="token keyword">elif</span> <span class="token string">"color"</span> <span class="token keyword">in</span> topic <span class="token operator">and</span> <span class="token string">"rect"</span> <span class="token operator">not</span> <span class="token keyword">in</span>  topic <span class="token operator">and</span> <span class="token string">"compressed"</span> <span class="token operator">not</span> <span class="token keyword">in</span> topic<span class="token punctuation">:</span>            self<span class="token punctuation">.</span>subcribers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>rospy<span class="token punctuation">.</span>Subscriber<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>prefix<span class="token punctuation">,</span> quality<span class="token punctuation">,</span> <span class="token string">"image_color"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data_class<span class="token operator">=</span>Image<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>show_images<span class="token punctuation">,</span> queue_size<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> callback_args<span class="token operator">=</span>self<span class="token punctuation">.</span>windows_idx<span class="token punctuation">)</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>windows_idx <span class="token operator">+=</span> <span class="token number">1</span>        <span class="token keyword">elif</span> <span class="token string">"color"</span> <span class="token keyword">in</span> topic <span class="token operator">and</span> <span class="token string">"rect"</span> <span class="token operator">not</span> <span class="token keyword">in</span>  topic <span class="token operator">and</span> <span class="token string">"compressed"</span> <span class="token keyword">in</span> topic<span class="token punctuation">:</span>            self<span class="token punctuation">.</span>subcribers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>rospy<span class="token punctuation">.</span>Subscriber<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>prefix<span class="token punctuation">,</span> quality<span class="token punctuation">,</span> <span class="token string">"image_color"</span><span class="token punctuation">,</span> <span class="token string">"compressed"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data_class<span class="token operator">=</span>CompressedImage<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>show_compressed_image<span class="token punctuation">,</span> queue_size<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> callback_args<span class="token operator">=</span>self<span class="token punctuation">.</span>windows_idx<span class="token punctuation">)</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>windows_idx <span class="token operator">+=</span> <span class="token number">1</span>        <span class="token keyword">elif</span> <span class="token string">"depth"</span> <span class="token keyword">in</span> topic <span class="token operator">and</span> <span class="token string">"compressed"</span> <span class="token operator">not</span> <span class="token keyword">in</span> topic<span class="token punctuation">:</span>            self<span class="token punctuation">.</span>subcribers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>rospy<span class="token punctuation">.</span>Subscriber<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>prefix<span class="token punctuation">,</span> quality<span class="token punctuation">,</span> <span class="token string">"image_depth_rect"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data_class<span class="token operator">=</span>Image<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>show_images<span class="token punctuation">,</span> queue_size<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> callback_args<span class="token operator">=</span>self<span class="token punctuation">.</span>windows_idx<span class="token punctuation">)</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>windows_idx <span class="token operator">+=</span> <span class="token number">1</span>        <span class="token keyword">elif</span> <span class="token string">"depth"</span> <span class="token keyword">in</span> topic <span class="token operator">and</span> <span class="token string">"compressed"</span> <span class="token keyword">in</span> topic<span class="token punctuation">:</span>            self<span class="token punctuation">.</span>subcribers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>rospy<span class="token punctuation">.</span>Subscriber<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>prefix<span class="token punctuation">,</span> quality<span class="token punctuation">,</span> <span class="token string">"image_depth_rect"</span><span class="token punctuation">,</span> <span class="token string">"compressed"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data_class<span class="token operator">=</span>CompressedImage<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>show_compressed_image<span class="token punctuation">,</span> queue_size<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> callback_args<span class="token operator">=</span>self<span class="token punctuation">.</span>windows_idx<span class="token punctuation">)</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>windows_idx <span class="token operator">+=</span> <span class="token number">1</span>        <span class="token keyword">elif</span> <span class="token string">"mono"</span> <span class="token keyword">in</span> topic <span class="token operator">and</span> <span class="token string">"rect"</span> <span class="token keyword">in</span> topic <span class="token operator">and</span> <span class="token string">"compressed"</span> <span class="token operator">not</span> <span class="token keyword">in</span> topic<span class="token punctuation">:</span>            self<span class="token punctuation">.</span>subcribers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>rospy<span class="token punctuation">.</span>Subscriber<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>prefix<span class="token punctuation">,</span> quality<span class="token punctuation">,</span> <span class="token string">"image_mono_rect"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data_class<span class="token operator">=</span>Image<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>show_images<span class="token punctuation">,</span> queue_size<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> callback_args<span class="token operator">=</span>self<span class="token punctuation">.</span>windows_idx<span class="token punctuation">)</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>windows_idx <span class="token operator">+=</span> <span class="token number">1</span>        <span class="token keyword">elif</span> <span class="token string">"mono"</span> <span class="token keyword">in</span> topic <span class="token operator">and</span> <span class="token string">"rect"</span> <span class="token keyword">in</span> topic <span class="token operator">and</span> <span class="token string">"compressed"</span> <span class="token keyword">in</span> topic<span class="token punctuation">:</span>            self<span class="token punctuation">.</span>subcribers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>rospy<span class="token punctuation">.</span>Subscriber<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>prefix<span class="token punctuation">,</span> quality<span class="token punctuation">,</span> <span class="token string">"image_mono_rect"</span><span class="token punctuation">,</span><span class="token string">"compressed"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data_class<span class="token operator">=</span>CompressedImage<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>show_compressed_image<span class="token punctuation">,</span> queue_size<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> callback_args<span class="token operator">=</span>self<span class="token punctuation">.</span>windows_idx<span class="token punctuation">)</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>windows_idx <span class="token operator">+=</span> <span class="token number">1</span>        <span class="token keyword">elif</span> <span class="token string">"mono"</span> <span class="token keyword">in</span> topic <span class="token operator">and</span> <span class="token string">"rect"</span> <span class="token operator">not</span> <span class="token keyword">in</span>  topic <span class="token operator">and</span> <span class="token string">"compressed"</span> <span class="token operator">not</span> <span class="token keyword">in</span> topic<span class="token punctuation">:</span>            self<span class="token punctuation">.</span>subcribers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>rospy<span class="token punctuation">.</span>Subscriber<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>prefix<span class="token punctuation">,</span> quality<span class="token punctuation">,</span> <span class="token string">"image_mono"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data_class<span class="token operator">=</span>Image<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>show_images<span class="token punctuation">,</span> queue_size<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> callback_args<span class="token operator">=</span>self<span class="token punctuation">.</span>windows_idx<span class="token punctuation">)</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>windows_idx <span class="token operator">+=</span> <span class="token number">1</span>        <span class="token keyword">elif</span> <span class="token string">"mono"</span> <span class="token keyword">in</span> topic <span class="token operator">and</span> <span class="token string">"rect"</span> <span class="token operator">not</span> <span class="token keyword">in</span>  topic <span class="token operator">and</span> <span class="token string">"compressed"</span> <span class="token keyword">in</span> topic<span class="token punctuation">:</span>            self<span class="token punctuation">.</span>subcribers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>rospy<span class="token punctuation">.</span>Subscriber<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>prefix<span class="token punctuation">,</span> quality<span class="token punctuation">,</span> <span class="token string">"image_mono"</span><span class="token punctuation">,</span> <span class="token string">"compressed"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data_class<span class="token operator">=</span>CompressedImage<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>show_compressed_image<span class="token punctuation">,</span> queue_size<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> callback_args<span class="token operator">=</span>self<span class="token punctuation">.</span>windows_idx<span class="token punctuation">)</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>windows_idx <span class="token operator">+=</span> <span class="token number">1</span>        <span class="token keyword">elif</span> <span class="token string">"ir"</span> <span class="token keyword">in</span> topic <span class="token operator">and</span> <span class="token string">"rect"</span> <span class="token keyword">in</span> topic <span class="token operator">and</span> <span class="token string">"compressed"</span> <span class="token operator">not</span> <span class="token keyword">in</span> topic<span class="token punctuation">:</span>            self<span class="token punctuation">.</span>subcribers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>rospy<span class="token punctuation">.</span>Subscriber<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>prefix<span class="token punctuation">,</span> quality<span class="token punctuation">,</span> <span class="token string">"image_ir_rect"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data_class<span class="token operator">=</span>Image<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>show_images<span class="token punctuation">,</span> queue_size<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> callback_args<span class="token operator">=</span>self<span class="token punctuation">.</span>windows_idx<span class="token punctuation">)</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>windows_idx <span class="token operator">+=</span> <span class="token number">1</span>        <span class="token keyword">elif</span> <span class="token string">"ir"</span> <span class="token keyword">in</span> topic <span class="token operator">and</span> <span class="token string">"rect"</span> <span class="token keyword">in</span> topic <span class="token operator">and</span> <span class="token string">"compressed"</span> <span class="token keyword">in</span> topic<span class="token punctuation">:</span>            self<span class="token punctuation">.</span>subcribers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>rospy<span class="token punctuation">.</span>Subscriber<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>prefix<span class="token punctuation">,</span> quality<span class="token punctuation">,</span> <span class="token string">"image_ir_rect"</span><span class="token punctuation">,</span><span class="token string">"compressed"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data_class<span class="token operator">=</span>CompressedImage<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>show_compressed_image<span class="token punctuation">,</span> queue_size<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> callback_args<span class="token operator">=</span>self<span class="token punctuation">.</span>windows_idx<span class="token punctuation">)</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>windows_idx <span class="token operator">+=</span> <span class="token number">1</span>        <span class="token keyword">elif</span> <span class="token string">"ir"</span> <span class="token keyword">in</span> topic <span class="token operator">and</span> <span class="token string">"rect"</span> <span class="token operator">not</span> <span class="token keyword">in</span>  topic <span class="token operator">and</span> <span class="token string">"compressed"</span> <span class="token operator">not</span> <span class="token keyword">in</span> topic<span class="token punctuation">:</span>            self<span class="token punctuation">.</span>subcribers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>rospy<span class="token punctuation">.</span>Subscriber<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>prefix<span class="token punctuation">,</span> quality<span class="token punctuation">,</span> <span class="token string">"image_ir"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data_class<span class="token operator">=</span>Image<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>show_images<span class="token punctuation">,</span> queue_size<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> callback_args<span class="token operator">=</span>self<span class="token punctuation">.</span>windows_idx<span class="token punctuation">)</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>windows_idx <span class="token operator">+=</span> <span class="token number">1</span>        <span class="token keyword">elif</span> <span class="token string">"ir"</span> <span class="token keyword">in</span> topic <span class="token operator">and</span> <span class="token string">"rect"</span> <span class="token operator">not</span> <span class="token keyword">in</span>  topic <span class="token operator">and</span> <span class="token string">"compressed"</span> <span class="token keyword">in</span> topic<span class="token punctuation">:</span>            self<span class="token punctuation">.</span>subcribers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>rospy<span class="token punctuation">.</span>Subscriber<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>prefix<span class="token punctuation">,</span> quality<span class="token punctuation">,</span> <span class="token string">"image_ir"</span><span class="token punctuation">,</span> <span class="token string">"compressed"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data_class<span class="token operator">=</span>CompressedImage<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>show_compressed_image<span class="token punctuation">,</span> queue_size<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> callback_args<span class="token operator">=</span>self<span class="token punctuation">.</span>windows_idx<span class="token punctuation">)</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>windows_idx <span class="token operator">+=</span> <span class="token number">1</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">assert</span> <span class="token boolean">False</span><span class="token punctuation">,</span> f<span class="token string">"无效的参数：qualitt={quality}, topic={topic}"</span>    <span class="token keyword">def</span> <span class="token function">show_images</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> img<span class="token punctuation">,</span> window_idx<span class="token punctuation">)</span><span class="token punctuation">:</span>        cv_img <span class="token operator">=</span> self<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>imgmsg_to_cv2<span class="token punctuation">(</span>img_msg<span class="token operator">=</span>img<span class="token punctuation">)</span>        cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>f<span class="token string">"viewer_{window_idx}"</span><span class="token punctuation">,</span> cv_img<span class="token punctuation">)</span>        <span class="token keyword">if</span> cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">27</span><span class="token punctuation">:</span>            cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>            rospy<span class="token punctuation">.</span>signal_shutdown<span class="token punctuation">(</span>reason<span class="token operator">=</span><span class="token string">"pressed esc"</span><span class="token punctuation">)</span>        <span class="token keyword">def</span> <span class="token function">show_compressed_image</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> img<span class="token punctuation">:</span> CompressedImage<span class="token punctuation">,</span> windows_idx<span class="token punctuation">)</span><span class="token punctuation">:</span>        cv_img <span class="token operator">=</span> self<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>compressed_imgmsg_to_cv2<span class="token punctuation">(</span>cmprs_img_msg<span class="token operator">=</span>img<span class="token punctuation">)</span>        cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>f<span class="token string">"viewer_{windows_idx}"</span><span class="token punctuation">,</span> cv_img<span class="token punctuation">)</span>        <span class="token keyword">if</span> cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">27</span><span class="token punctuation">:</span>            cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>            rospy<span class="token punctuation">.</span>signal_shutdown<span class="token punctuation">(</span>reason<span class="token operator">=</span><span class="token string">"pressed esc"</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">arg_parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> argparse<span class="token punctuation">.</span>Namespace<span class="token punctuation">:</span>    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"本程序用于可视化显示iai-kinect2的不同话题中的图片，以对比他们的不同"</span><span class="token punctuation">)</span>    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"-q"</span><span class="token punctuation">,</span> <span class="token string">"--quality"</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">"quality"</span><span class="token punctuation">,</span> nargs<span class="token operator">=</span><span class="token string">"*"</span><span class="token punctuation">,</span> type<span class="token operator">=</span>str<span class="token punctuation">,</span> help<span class="token operator">=</span><span class="token string">"指定需要显示图像的话题组"</span><span class="token punctuation">)</span>    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"-t"</span><span class="token punctuation">,</span> <span class="token string">"--topic"</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">"topic"</span><span class="token punctuation">,</span> nargs<span class="token operator">=</span><span class="token string">"+"</span><span class="token punctuation">,</span> type<span class="token operator">=</span>str<span class="token punctuation">,</span> help<span class="token operator">=</span><span class="token string">"指定需要显示图像的话题"</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    args <span class="token operator">=</span> arg_parser<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>quality<span class="token punctuation">,</span> args<span class="token punctuation">.</span>topic<span class="token punctuation">)</span>    rospy<span class="token punctuation">.</span>init_node<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"ini_kinect2_viewer"</span><span class="token punctuation">)</span>    viewer <span class="token operator">=</span> iaiKinect2Viewer<span class="token punctuation">(</span>args<span class="token operator">=</span>args<span class="token punctuation">)</span>    rospy<span class="token punctuation">.</span>spin<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用的话则在命令行中加上参数，<code>-q</code>表示图像的质量，即<code>qhd</code>、<code>sd</code>还是<code>hd</code>，<code>-t</code>表示显示的话题。写的时候是支持多个话题同时显示的，但是不知道哪里出问题了显示不出来</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 显示单个话题的图像：1/4 大小的灰度图</span><span class="token punctuation">(</span>ros<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/install_iai_kinect2$ rosrun look_kenect2 look_images.py -q qhd -t mono<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211120152240529.png" alt="qhd中mono里的黑白图像"></p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 显示单个话题的图像：1/4 大小的彩色图</span><span class="token punctuation">(</span>ros<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/install_iai_kinect2$ rosrun look_kenect2 look_images.py -q qhd -t color<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211120152424998.png" alt="qhd中color里的彩色图像"></p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 显示单个话题的图像：1/4 大小的深度图</span><span class="token punctuation">(</span>ros<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/install_iai_kinect2$ rosrun look_kenect2 look_images.py -q qhd -t depth_compressed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>需要说明的是，qhd和hd中的深度图像如果不用compressed，即直接用的kinect采集到的的点的话，那么显示的非常卡，因为点云的数据实在是太大了，用而compressed中的数据则是iai-kinect2经过OpenCL、CUDA加速渲染之后得到的，因此帧率比较高。此外获取到的深度图每个像素都是一个以毫米为单位的距离值，因此使用OpenCV直接显示的话被做了归一化，所以越近的地方越黑，越远的地方越白，一些异常点，即没有反射的点距离被认为是摄像头获取距离的极限值（&gt;1200，即超过12米），因此这些异常点使得归一化之后基本都是黑的，我们自己使用的时候一定要先处理异常点然后再归一化，最后再显示</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211120153143101.png" alt="qhd里的深度图"></p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 显示单个话题的图像：sd大小的红外图像</span><span class="token punctuation">(</span>ros<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/install_iai_kinect2$ rosrun look_kenect2 look_images.py -q sd -t ir_rect<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>需要说明的是，Kinect V2相机有一个红外发射器，一个红外接收器，因此距离越近，表面越光滑，接收器接收到反射的红外线越强，数值越高，对应就越白</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211120154330718.png" alt="sd里的红外图"></p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 显示单个话题的图像：sd大小的色彩图</span>^<span class="token punctuation">(</span>ros<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/install_iai_kinect2$ rosrun look_kenect2 look_images.py -q sd -t color_rect<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>理论上来说，sd话题里显示的都是红外相机拍摄得到的图片，因此不会存在颜色，所以这里其实是把RGB相机拍到的图片和红外相机图片配准之后的结果</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211120154705830.png" alt="sd里的color_rect"></p><h3 id="B-YOLO-V5进行物体检测"><a href="#B-YOLO-V5进行物体检测" class="headerlink" title="B. YOLO V5进行物体检测"></a>B. YOLO V5进行物体检测</h3><p>利用之前写好的YOLO V5，可以实现物体检测，然后根据深度图像来标注出物体的距离</p><p>YOLO V5的代码后面整理出来会放出来，这里先用一用，下面的代码需要注意的是rospy中的message_filter如果消息频率速度过快，甚至快过了message_filter处理的速度，那么就会导致两个消息无法对应起来，因此就永远不会调用回调函数，因此cv2.waitkey需要等10毫秒左右</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#! /home/jack/anaconda3/envs/ros/bin/python</span><span class="token keyword">import</span> sys<span class="token keyword">import</span> time<span class="token keyword">from</span> pathlib <span class="token keyword">import</span> Path<span class="token keyword">import</span> cv2<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token keyword">from</span> colorama <span class="token keyword">import</span> Fore<span class="token punctuation">,</span> Style<span class="token keyword">from</span> libyolo <span class="token keyword">import</span> YoloV5stemp_path <span class="token operator">=</span> None<span class="token keyword">for</span> path_idx <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">"2.7"</span> <span class="token keyword">in</span> sys<span class="token punctuation">.</span>path<span class="token punctuation">[</span>path_idx<span class="token punctuation">]</span><span class="token punctuation">:</span>        temp_path <span class="token operator">=</span> sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>path_idx<span class="token punctuation">)</span>        <span class="token keyword">break</span><span class="token keyword">if</span> temp_path <span class="token keyword">is</span> <span class="token operator">not</span> None<span class="token punctuation">:</span>    sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp_path<span class="token punctuation">)</span><span class="token keyword">import</span> rospy<span class="token keyword">import</span> message_filters<span class="token keyword">from</span> sensor_msgs<span class="token punctuation">.</span>msg <span class="token keyword">import</span> CompressedImage<span class="token keyword">from</span> cv_bridge <span class="token keyword">import</span> CvBridge<span class="token keyword">class</span> <span class="token class-name">DetectYoloKinect</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">:</span>    yolo <span class="token operator">=</span> YoloV5s<span class="token punctuation">(</span>weight_path<span class="token operator">=</span>Path<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">.</span>resolve<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">"models"</span><span class="token punctuation">,</span> <span class="token string">"yolov5s.pt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    bridge <span class="token operator">=</span> CvBridge<span class="token punctuation">(</span><span class="token punctuation">)</span>    font <span class="token operator">=</span> cv2<span class="token punctuation">.</span>FONT_HERSHEY_DUPLEX    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> rgb_img_topic<span class="token punctuation">:</span> str<span class="token punctuation">,</span> depth_img_topic<span class="token punctuation">:</span> str<span class="token punctuation">,</span> if_detection_only<span class="token punctuation">:</span> bool <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> None<span class="token punctuation">:</span>        super<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        rospy<span class="token punctuation">.</span>loginfo<span class="token punctuation">(</span>msg<span class="token operator">=</span>f<span class="token string">"{Fore.GREEN}启动物体检测节点！{Style.RESET_ALL}"</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> if_detection_only<span class="token punctuation">:</span>            rospy<span class="token punctuation">.</span>Subscriber<span class="token punctuation">(</span>name<span class="token operator">=</span>rgb_img_topic<span class="token punctuation">,</span> data_class<span class="token operator">=</span>CompressedImage<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>_detect_only_cb<span class="token punctuation">,</span>                             queue_size<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            rgb_subscriber <span class="token operator">=</span> message_filters<span class="token punctuation">.</span>Subscriber<span class="token punctuation">(</span>rgb_img_topic<span class="token punctuation">,</span> CompressedImage<span class="token punctuation">)</span>            depth_subscriber <span class="token operator">=</span> message_filters<span class="token punctuation">.</span>Subscriber<span class="token punctuation">(</span>depth_img_topic<span class="token punctuation">,</span> CompressedImage<span class="token punctuation">)</span>            sync <span class="token operator">=</span> message_filters<span class="token punctuation">.</span>ApproximateTimeSynchronizer<span class="token punctuation">(</span>fs<span class="token operator">=</span><span class="token punctuation">[</span>rgb_subscriber<span class="token punctuation">,</span> depth_subscriber<span class="token punctuation">]</span><span class="token punctuation">,</span> queue_size<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span>                                                               slop<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>            sync<span class="token punctuation">.</span>registerCallback<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_multi_cb<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>last_time_rgb <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">_detect_only_cb</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> img<span class="token punctuation">:</span> CompressedImage<span class="token punctuation">)</span><span class="token punctuation">:</span>        cv_image<span class="token punctuation">:</span> np<span class="token punctuation">.</span>ndarray <span class="token operator">=</span> self<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>compressed_imgmsg_to_cv2<span class="token punctuation">(</span>cmprs_img_msg<span class="token operator">=</span>img<span class="token punctuation">)</span>        result_dict<span class="token punctuation">,</span> draw_img <span class="token operator">=</span> self<span class="token punctuation">.</span>yolo<span class="token punctuation">.</span>inference<span class="token punctuation">(</span>cv_image<span class="token punctuation">,</span> if_absolute<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> if_show<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>        t2 <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>        draw_img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>draw_img<span class="token punctuation">,</span> f<span class="token string">"fps: {1 / (t2 - self.last_time_rgb):>5.2f}, seq_id: {img.header.seq}"</span><span class="token punctuation">,</span>                               <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>font<span class="token punctuation">,</span> <span class="token number">0.8</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>last_time_rgb <span class="token operator">=</span> t2        cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">"color_detections"</span><span class="token punctuation">,</span> draw_img<span class="token punctuation">)</span>        <span class="token keyword">if</span> cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">27</span><span class="token punctuation">:</span>            cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>            rospy<span class="token punctuation">.</span>logwarn<span class="token punctuation">(</span><span class="token string">"按下了ESC键，终止节点..."</span><span class="token punctuation">)</span>            rospy<span class="token punctuation">.</span>signal_shutdown<span class="token punctuation">(</span>reason<span class="token operator">=</span><span class="token string">"pressed esc"</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">_multi_cb</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> rgb_img<span class="token punctuation">:</span> CompressedImage<span class="token punctuation">,</span> depth_img<span class="token punctuation">:</span> CompressedImage<span class="token punctuation">)</span><span class="token punctuation">:</span>        rospy<span class="token punctuation">.</span>loginfo<span class="token punctuation">(</span><span class="token string">"Getting into _multi_cb"</span><span class="token punctuation">)</span>        cv_rgb<span class="token punctuation">:</span> np<span class="token punctuation">.</span>ndarray <span class="token operator">=</span> self<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>compressed_imgmsg_to_cv2<span class="token punctuation">(</span>cmprs_img_msg<span class="token operator">=</span>rgb_img<span class="token punctuation">)</span>        cv_depth<span class="token punctuation">:</span> np<span class="token punctuation">.</span>ndarray <span class="token operator">=</span> self<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>compressed_imgmsg_to_cv2<span class="token punctuation">(</span>cmprs_img_msg<span class="token operator">=</span>depth_img<span class="token punctuation">)</span>        cv_depth_draw<span class="token punctuation">:</span> np<span class="token punctuation">.</span>ndarray <span class="token operator">=</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>cv_depth<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># to BGR</span>        cv_depth_draw <span class="token operator">=</span> <span class="token punctuation">(</span>cv_depth_draw <span class="token operator">-</span> cv_depth_draw<span class="token punctuation">.</span>min<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>cv_depth_draw<span class="token punctuation">.</span>max<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> cv_depth_draw<span class="token punctuation">.</span>min<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># inference</span>        result_dict<span class="token punctuation">,</span> cv_rgb_draw <span class="token operator">=</span> self<span class="token punctuation">.</span>yolo<span class="token punctuation">.</span>inference<span class="token punctuation">(</span>cv_rgb<span class="token punctuation">,</span> if_absolute<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> if_show<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># log time</span>        t <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>        fps <span class="token operator">=</span> round<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> <span class="token punctuation">(</span>t <span class="token operator">-</span> self<span class="token punctuation">.</span>last_time_rgb<span class="token punctuation">)</span><span class="token punctuation">,</span> ndigits<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>last_time_rgb <span class="token operator">=</span> t        rospy<span class="token punctuation">.</span>loginfo<span class="token punctuation">(</span>msg<span class="token operator">=</span><span class="token string">"Done inference, start to draw"</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># draw basic info</span>        cv_rgb_draw <span class="token operator">=</span> cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>cv_rgb_draw<span class="token punctuation">,</span> f<span class="token string">"FPS:{fps}, seq:{depth_img.header.seq}"</span><span class="token punctuation">,</span>                                  org<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fontFace<span class="token operator">=</span>self<span class="token punctuation">.</span>font<span class="token punctuation">,</span> fontScale<span class="token operator">=</span><span class="token number">0.8</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> thickness<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>        cv_depth_draw <span class="token operator">=</span> cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>cv_depth_draw<span class="token punctuation">,</span> f<span class="token string">"FPS:{fps}, seq:{depth_img.header.seq}"</span><span class="token punctuation">,</span>                                    org<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fontFace<span class="token operator">=</span>self<span class="token punctuation">.</span>font<span class="token punctuation">,</span> fontScale<span class="token operator">=</span><span class="token number">0.8</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> thickness<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># draw depth</span>        rospy<span class="token punctuation">.</span>loginfo<span class="token punctuation">(</span>msg<span class="token operator">=</span><span class="token string">"Done draw basic, start draw depth"</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> d_type<span class="token punctuation">,</span> items <span class="token keyword">in</span> result_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">for</span> item <span class="token keyword">in</span> items<span class="token punctuation">:</span>                <span class="token comment" spellcheck="true"># 周围100个点的平均，yolo的结果已经确保点在图像内</span>                depth <span class="token operator">=</span> self<span class="token punctuation">.</span>__get_depth<span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token punctuation">:</span><span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>y <span class="token punctuation">:</span><span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> depth_image<span class="token operator">=</span>cv_depth<span class="token punctuation">,</span> area_size<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>                x<span class="token punctuation">,</span> y <span class="token operator">=</span> int<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> int<span class="token punctuation">(</span>y<span class="token punctuation">)</span>                cv_depth_draw <span class="token operator">=</span> cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>cv_depth_draw<span class="token punctuation">,</span> text<span class="token operator">=</span>f<span class="token string">"{d_type}, {depth / 10:>.2f}m"</span><span class="token punctuation">,</span> org<span class="token operator">=</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token number">-5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                            fontFace<span class="token operator">=</span>self<span class="token punctuation">.</span>font<span class="token punctuation">,</span> fontScale<span class="token operator">=</span><span class="token number">0.8</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lineType<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>                cv_depth_draw <span class="token operator">=</span> cv2<span class="token punctuation">.</span>circle<span class="token punctuation">(</span>cv_depth_draw<span class="token punctuation">,</span> center<span class="token operator">=</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> radius<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                           thickness<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> lineType<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>        rospy<span class="token punctuation">.</span>loginfo<span class="token punctuation">(</span>msg<span class="token operator">=</span>f<span class="token string">"Done Drawing"</span><span class="token punctuation">)</span>        cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">"detection_result"</span><span class="token punctuation">,</span> cv_rgb_draw<span class="token punctuation">)</span>        cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">"depth_result"</span><span class="token punctuation">,</span> cv_depth_draw<span class="token punctuation">)</span>        <span class="token keyword">if</span> cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">27</span><span class="token punctuation">:</span>            cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>            rospy<span class="token punctuation">.</span>logwarn<span class="token punctuation">(</span>msg<span class="token operator">=</span>f<span class="token string">"按下了ESC键，手动关闭了节点"</span><span class="token punctuation">)</span>            rospy<span class="token punctuation">.</span>signal_shutdown<span class="token punctuation">(</span>reason<span class="token operator">=</span><span class="token string">"pressed esc"</span><span class="token punctuation">)</span>    @staticmethod    <span class="token keyword">def</span> <span class="token function">__get_depth</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> float<span class="token punctuation">,</span> y<span class="token punctuation">:</span> float<span class="token punctuation">,</span> depth_image<span class="token punctuation">:</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">,</span> area_size<span class="token punctuation">:</span> int <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> float<span class="token punctuation">:</span>        boundary <span class="token operator">=</span> <span class="token punctuation">[</span>int<span class="token punctuation">(</span>position<span class="token punctuation">)</span> <span class="token keyword">for</span> position <span class="token keyword">in</span>                    <span class="token punctuation">[</span>y <span class="token operator">-</span> area_size <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> y <span class="token operator">+</span> area_size <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> x <span class="token operator">-</span> area_size <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> x <span class="token operator">+</span> area_size <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>        <span class="token keyword">return</span> depth_image<span class="token punctuation">[</span>boundary<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>boundary<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> boundary<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">:</span>boundary<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    rospy<span class="token punctuation">.</span>init_node<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"detect_yolo_kinect2"</span><span class="token punctuation">,</span> anonymous<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>    dyk <span class="token operator">=</span> DetectYoloKinect<span class="token punctuation">(</span>rgb_img_topic<span class="token operator">=</span><span class="token string">"/kinect2/qhd/image_color/compressed"</span><span class="token punctuation">,</span>                           depth_img_topic<span class="token operator">=</span><span class="token string">"/kinect2/qhd/image_depth_rect/compressed"</span><span class="token punctuation">,</span> if_detection_only<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>    rospy<span class="token punctuation">.</span>spin<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后得到的效果如下，可以看到YOLO还是可以的，不过有的时候会识别错误，例如把纸板识别成了沙发。而且在深度图中，越靠近边缘实际上越不准确，如果没有反射回来的话距离就被记为0。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211121155602208.png" alt="YOLO和深度图配准"></p>]]></content>
      
      
      <categories>
          
          <category> ROS杂篇 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ROS </tag>
            
            <tag> cv_bridge </tag>
            
            <tag> Ubuntu </tag>
            
            <tag> melodic </tag>
            
            <tag> OpenCv </tag>
            
            <tag> sensor_msgs </tag>
            
            <tag> roslaunch </tag>
            
            <tag> Kinect V2 </tag>
            
            <tag> iai-kinect2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ROS杂篇 ROS中使用Kinect V2 Part1：安装+使用</title>
      <link href="/2021/11/18/ros-za-pian-an-zhuang-kinect-v2-qu-dong/"/>
      <url>/2021/11/18/ros-za-pian-an-zhuang-kinect-v2-qu-dong/</url>
      
        <content type="html"><![CDATA[<blockquote><p>Kinect是非常流行的获取深度、彩色、点云的相机。本文介绍了Kinect相机的具体性能，以及如何在ROS调用Kinect相机。</p></blockquote><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211118214830894.png" alt="最终效果图"></p><span id="more"></span><h1 id="ROS杂篇-ROS中使用Kinect-V2-Part1：安装-使用"><a href="#ROS杂篇-ROS中使用Kinect-V2-Part1：安装-使用" class="headerlink" title="ROS杂篇 ROS中使用Kinect V2 Part1：安装+使用"></a>ROS杂篇 ROS中使用Kinect V2 Part1：安装+使用</h1><blockquote><p>前言：为什么要写这篇博客</p></blockquote><p>由于我目前的工作需要我编写服务机器人的代码，而服务机器人就免不了需要视觉信息来指导机器人完成服务。包括RGB彩色相机获得的彩色图像、深度相机获得的深度图像等等各种视觉传感器。对于简单的RGB相机拍摄到的RGB彩色图像，由于全球统一的接口，因此有很多工具都可以帮助我们从<code>/dev/video*</code>中读取到彩色图像。通过OpenCV的<code>VideoCapture</code>就可以读到。然而问题的关键在于，针对一些特定的设备，例如深度相机，目前全球尚无统一的标准，因此在数据流中图像的格式各个厂家都是不一样的。因此这个时候想要读取到这些特殊相机的图像就需要花一番功夫了。尤其是在硬件厂商不提供Linux的驱动的时候更难受。</p><p>由于我具体的开发平台配置就是 <code>Ubuntu 18.04</code> + <code>ROS Melodic</code> + <code>Kinect V2</code>相机。<strong>所以特地写这篇博客记录一下ROS中如何配置Kinect V2相机</strong></p><p><strong>下文针对Ubutnu 18.04 + ROS Melodic 验证可行</strong></p><h2 id="1-什么是-Kinect-相机？"><a href="#1-什么是-Kinect-相机？" class="headerlink" title="1. 什么是 Kinect 相机？"></a>1. 什么是 Kinect 相机？</h2><blockquote><p>正如我一向的态度，学什么、做什么前先问问为什么要学/做，再问问自己学/做的是什么。为什么要做上面已经回答了，因为我需要用它。那接下来就是要做的是什么？</p></blockquote><p>个人的角度来说，<code>Kinect</code> 相机就是一款特殊的相机，他可以读取到RGB彩色图像和深度图像，通过<code>Kinect</code>相机采集到的图像和深度信息，我们就能够快乐的进行开发~</p><p>虽然<code>Kinect V2</code>在2017年由于<code>Xbox</code>取消了<code>Kinect</code>的接口而停产，但是发现到<code>Kinect</code>相机价值的微软随后推出的 <code>Kinect V3</code> 和 <code>Kinect DK</code> 都是专门为科研推出的设备。（我有幸用过 <code>Kinect DK</code>，上面部署了现成的 <code>Human Motion Estimation</code> 的模型，可以直接获得人体的关键点，非常好用）</p><blockquote><p>摘自<code>维基百科</code></p><p><strong>Kinect</strong>是由<a href="https://zh.wikipedia.org/wiki/%E5%BE%AE%E8%BB%9F">微软</a>开发，应用于<a href="https://zh.wikipedia.org/wiki/Xbox_360">Xbox 360</a>和<a href="https://zh.wikipedia.org/wiki/Xbox_One">Xbox One</a>主机的周边设备。它让玩家不需要手持或踩踏<a href="https://zh.wikipedia.org/wiki/%E6%8E%A7%E5%88%B6%E5%99%A8">控制器</a>，而是使用<a href="https://zh.wikipedia.org/wiki/%E8%AF%AD%E9%9F%B3%E6%8C%87%E4%BB%A4">语音指令</a>或<a href="https://zh.wikipedia.org/wiki/%E6%89%8B%E5%8A%BF">手势</a>来操作Xbox 360和Xbox One的系统界面。它也能捕捉玩家全身上下的动作，用身体来进行游戏，带给玩家“免控制器的游戏与娱乐体验”。此设备是<a href="https://zh.wikipedia.org/wiki/%E5%BE%AE%E8%BB%9F%E7%A0%94%E7%A9%B6%E9%99%A2">微软研究院</a>的研究成果之一。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211118142428272.png" alt="维基百科上对Kinect相机的介绍"></p></blockquote><p>可以看得出来，<code>Kinect</code>相机最初其实是由Windows为<code>Xbox</code>游戏机准备的外设，通过Kinect相机可以玩一些体感游戏。不过多好的设备当然是要我们来折腾的，拿来单纯玩游戏就有点太奢侈了。</p><p>不过正式用于Kinect相机是微软家的产品，按照微软的尿性大概是不会给开源驱动的（虽然这几年微软逐渐在拥抱开源，可是KinectV1、V2都是2010年的产品啊），事实也的确如此。Kinect目前微软官方的驱动只有在Windows上才有。这也就是为什么我们稍后等下需要安装<code>Kinect V2</code>的驱动。</p><h2 id="2-Kinect-相机介绍"><a href="#2-Kinect-相机介绍" class="headerlink" title="2. Kinect 相机介绍"></a>2. Kinect 相机介绍</h2><blockquote><p>以下内容参考博客：<a href="https://www.cnblogs.com/traceplus/p/4136297.html">https://www.cnblogs.com/traceplus/p/4136297.html</a></p></blockquote><h3 id="A-Kinect-V1"><a href="#A-Kinect-V1" class="headerlink" title="A. Kinect V1"></a>A. Kinect V1</h3><p>2012年美国微软发售的<code>Kinect V1</code>，因为可以很方便就能取得Depth（深度）和 skeleton（人物姿势）等信息，被全世界的开发者和研究人员关注。</p><p><code>Kinect V1</code>的Depth传感器，采用了<code>Light Coding</code>的方式，读取投射的红外线的<code>pattern</code>，通过<code>pattern</code>的变形来取得Depth的信息。为此，Depth传感器分为投射红外线的IR Projector（左）和读取的IR Camera（右）。此外还有<code>Kinect V1</code>中间还搭载了RGB相机。</p><p><code>Light Coding</code>是以色列的<code>PrimeSense</code>公司的Depth传感器技术，于2013年被美国苹果公司收购。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/012317367015237.jpg" alt="Kinect V1的图片"></p><h3 id="B-Kinect-V2"><a href="#B-Kinect-V2" class="headerlink" title="B. Kinect V2"></a>B. Kinect V2</h3><p><code>Kinect V2</code>获得Depth信息采用的则是<code>Time of Flight(TOF)</code>的方式，通过从投射的红外线反射后返回的时间来取得Depth信息。红外发射器和接收器在面板底部，因此看不到外观，不过<code>Color Camera</code>旁边是红外线<code>Camera</code>(左)和投射脉冲变调红外线的<code>Porjector</code>（右）。</p><p>微软过去收购过基于<code>TOF</code>方式的深度传感器技术的公司（注：应该是指的3DV），已经在使用这个技术，不过没有详细的公布。</p><p>（额外插一句，TOF是目前大多数点云数据获取的方式）</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/012317384052450.jpg" alt="Kinect V2"></p><h3 id="C-两者对比"><a href="#C-两者对比" class="headerlink" title="C.两者对比"></a>C.两者对比</h3><p><strong>首先是两者的参数</strong></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211118144936589.png" alt="Kinect V1 和 V2 性能对比"></p><p><strong>然后需要注意的是两者的接口</strong></p><ul><li>V1的要求是USB2.0理论传输速率是60MB/s，v2是USB3.0理论传输速率是500MB/s。</li><li>对于<code>Kinect V1</code>，对XRGB四通道图像，30fps的帧率下每秒所需传输的数据大小为640 x 480 x 4 x 30约为35M；再加上USHORT格式的深度图，30fps，每秒传输数据量为320 x 240 x 2 x 30约为4M。总计约为40MB/s，因为带宽有限，所以在保证画面帧率稳定的情况下，分辨率只能如此，而且基本上必须独占一个USB接口。</li><li>对于<code>Kinect V2</code>的情况，彩色图像1920 x 1080 x 4 x 30 约为237M，深度图像512 x 424 x 2 x 30约为12M，总计约为250M/s。所以非USB3.0不可，否则传输不了这么大的数据量。</li></ul><h2 id="3-安装Kinect驱动-ROS中间件"><a href="#3-安装Kinect驱动-ROS中间件" class="headerlink" title="3. 安装Kinect驱动+ROS中间件"></a>3. 安装Kinect驱动+ROS中间件</h2><h3 id="A-概述"><a href="#A-概述" class="headerlink" title="A. 概述"></a>A. 概述</h3><p>首先需要说明的是开发的方式，因为Kinect相机是物理硬件，所以获取到的是二进制数据流，我们首先需要使用驱动将二进制数据流转换为有意义的图像，然后在我们自己的程序针在这些图像的基础上去进行开发。</p><ul><li><strong>将二进制数据流转换为图像的程序对应下图的Kinect Driver</strong></li><li><strong>我们自己的程序对应下图的<code>Application</code></strong></li><li><strong>需要注意的是，在ROS中通常只会有一个程序调用Kinect Driver，因此不考虑右边的工作模型。右边的模型只有多人、多任务同时要调用Kinect</strong> <strong>Driver时候才会有用，针对单任务其实没有啥影响</strong></li></ul><p>在<code>Kinect</code>标准的<code>Windows</code>上，<code>Kinect</code>的驱动是Windows上直接下载的，然后<code>Windows</code>还提供了<code>Kinect</code>的SDK，里面有现成的人体骨架识别的<code>API</code>，所以可以直接用。<strong>但是在Linux的ROS上想要使用Kinect相机的话，把二进制数据流转换为图像的驱动需要我们自己写，然后SDK+程序得自己开发</strong>。</p><ul><li>幸运的是，已经有人写好了<code>Kinect</code>的驱动，因此我们直接下载驱动即可。但是<code>Kinect</code>驱动只能帮助我们能在<code>Ubuntu</code>上获得Kinect的图像，所以接下来我们需要做的第二件事就是编写一个<code>ROS</code>调用<code>Kinect</code>的节点来调用<code>Kinect</code>驱动，并将获得的图像以话题的形式发布到<code>ROS</code>中去。</li><li>更加幸运的是，这一步也已经有人帮我们做好了，我们需要需要做的下载、编译这个调用Kinect驱动获得图像、并以<code>ROS</code>话题形式发布的<code>ROS</code>功能包（相当于中间件）。</li></ul><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/012317438589516.png" alt="开发方式"></p><p>因此，整个安装流程分成两步，</p><ol><li>安装 <code>Kinect</code> 的驱动</li><li>安装<code>ROS</code>功能包</li></ol><h3 id="B-安装Kinect-V2驱动——libfreenect2"><a href="#B-安装Kinect-V2驱动——libfreenect2" class="headerlink" title="B. 安装Kinect V2驱动——libfreenect2"></a>B. 安装Kinect V2驱动——libfreenect2</h3><p>首先需要安装<code>Kinect</code>在<code>Ubuntu</code>上的驱动：<code>libfreenect2</code>。</p><p>这个驱动是<code>Github</code>上开源的用<code>C++</code>和<code>Cmake</code>写的<code>Kinect V2</code>的驱动，所以我们稍后克隆下来之后安装一下依赖，然后配置<code>CMake</code>生成<code>Makefile</code>、然后make编译，最后make install安装库即可。</p><h4 id="1-安装依赖"><a href="#1-安装依赖" class="headerlink" title="1. 安装依赖"></a>1. 安装依赖</h4><p>实现用apt包管理器安装下稍后编译时候的依赖</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> build-essential cmake pkg-config libturbojpeg libjpeg-turbo8-dev mesa-common-dev freeglut3-dev libxrandr-dev libxi-dev libglfw3-dev libglfw3-dev libopenni2-dev libusb-dev libturbojpeg0-dev<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>由于我已经安装过了，所以这一步我不会安装任何东西。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211118172852901.png" alt="安装依赖"></p><h4 id="2-下载源码"><a href="#2-下载源码" class="headerlink" title="2. 下载源码"></a>2. 下载源码</h4><p><code>git</code>直接下载源码即可，如果下载的慢的话，要么科学上网，要么先用国内的码云gitee克隆一下，然后再下载码云的仓库。关于如何使用码云加速<code>github</code>下载可以参考我的这篇文章（挖个坑，以后补）</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project$ <span class="token function">git</span> clone https://github.com/OpenKinect/libfreenect2.git<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211118173143020.png" alt="下载源码"></p><p>下载之后的项目文件结构，可以看出来，是一个非常经典的<code>CMake</code>的项目</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211118173557080.png" alt="下载后的项目结构"></p><h4 id="3-配置-amp-编译"><a href="#3-配置-amp-编译" class="headerlink" title="3. 配置&amp;编译"></a>3. 配置&amp;编译</h4><p>对于一个<code>CMake</code>工程，得到项目最后的成果，即最终的动态链接库/共享库、可执行文件一共需要两步。第一步是配置（<code>Config</code>），第二步是构建（<code>Build</code>）。配置指的是设置项目的一些配置，比如说编译器使用的语法标准、是否禁止编译器在编译阶段优化代码等等。这里不展开讲了，具体内容可以参考我的<code>CMake</code>系列文章（挖个坑）。</p><p>首先创建一个编译空间</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project$ <span class="token function">cd</span> libfreenect2/<span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/libfreenect2$ <span class="token function">mkdir</span> build<span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/libfreenect2$ <span class="token function">cd</span> build/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>接下来再使用<code>CMake</code>针对<code>build</code>文件夹外的<code>CMakeLists</code>进行配置，需要注意的是，由于我已经配好了<code>Nvidia</code>的显卡驱动和<code>CUDA</code>，因此我指定使用<code>CUDA</code>编译，这样运行的时候就会有加速。此外配置的时候要指定安装到的位置，这个安装到的位置稍后安装ROS功能包的时候会用到，所以不建议修改，用默认的就行。</p><p>具体来说我们都是在命令行使用-D参数来指定<code>CMake</code>的宏及其值(D=define)，<code>CMakeLists</code>中会检查这些宏的值。如果你不是<code>CUDA</code>的话就把后面指定<code>CUDA</code>的宏删掉即可</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/libfreenect2/build$ cmake <span class="token punctuation">..</span> -DCMAKE_INSTALL_PREFIX<span class="token operator">=</span><span class="token variable">$HOME</span>/freenect2 -DENABLE_CXX11<span class="token operator">=</span>ON -DCUDA_PROPAGATE_HOST_FLAGS<span class="token operator">=</span>off<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211118184945046.png" alt="CMake配置工程"></p><p>可以看到<code>CMake</code>配置的流程还是很清晰的，首先会去寻找系统中的编译器版本然后再去检查当前编译器是否至此指定版本的语法，接下来去寻找包等等。全部配置过程没有问题的话就会显示最后的三句话，当前<code>build</code>编译空间下也多出来很多中间文件。<code>Makefile</code>就是稍后<code>make</code>解析的对象。</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/libfreenect2/build$ <span class="token function">ls</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211118185449344.png" alt="配置的结果"></p><p>然后我们make编译即可</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/libfreenect2/build$ <span class="token function">make</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>我这里的编译可以说是顺风顺水，主要原因其实是我已经配置过一遍了，这是写教程时候删掉了全部的文件重头再来的结果。<strong>其实在第一次配的时候在编译这里遇到了两三个问题</strong>，不过我都解决掉了，现在没有办法把这些问题复现出来。这里挖个坑，下一次装机补上。主要的两个问题是第一次会报错不存在一个叫<code>libGL.so</code>的共享库，第二次则是在最后编译到100%之后链接的时候报错说没有定义的引用：<code>undefined reference to _glapi_tls_Current</code>。</p><p>其实这两个问题都和<code>OpenGL</code>这个图形库有关（<code>Graphic Librar</code>y）。图形负责渲染材质等等，是将数据显示到我们的显示器上的库，包括看到的桌面、窗口等等都是用图形库渲染出来的。而<code>Kinect</code>捕获到的数据要转成图片显示，就必然会用到<code>OpenGL</code>这个库。第一个报错是因为管道断开（<code>libGL.so</code>是一个软连接），重新链接就行，第二个报错则是因为<code>libGL.so</code>链接到的共享库版本太老，指定一个更新的即可。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211118185715177.png" alt="编译的过程"></p><p>最后，由于<code>libfreenect2</code>最终生成的是一个驱动，因此他最终生成的结果不仅有可执行文件，还有共享库，我们需要<code>make install</code>来安装一下共享库。说是安装，其实就是把共享库复制到指定的位置去，一般的项目都是把共享库复制到系统链接时候的搜索路径，这样编译的时候系统会自动的去搜索。<strong>不过由于我们上面CMake在配置的时候指定了安装位置，因此他其实会安装到我们的家目录下面</strong></p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/libfreenect2/build$ <span class="token function">make</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>从命令的输出确实能够看到安装的位置就是我们的家目录</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211118190908729.png" alt="安装的结果"></p><h4 id="4-设置USB规则"><a href="#4-设置USB规则" class="headerlink" title="4. 设置USB规则"></a>4. 设置USB规则</h4><p>由于<code>libfreenect2</code>是一个驱动，因此他需要和底层的硬件做交互，所以需要设置一下<code>USB</code>规则。在<code>Linux</code>中所有的串口都是由一个叫<code>udev</code>的程序负责的，他相当于<code>Windows</code>的设备管理器。这里挖个坑，以后补上关于<code>udev</code>的内容。更多细节可以参考<a href="https://www.jianshu.com/p/dd6cecd7755a">这篇简书的博客</a></p><blockquote><p><strong>以下内容引用自简书博客</strong></p><p><strong>udev在linux的那个位置</strong></p><p>udev的守护进程在linux的位置在systemd中的位置如下所示，举个例子：如果向pc中插入一个usb设备，kernel在总线上发现这个设备，使用dirver初始化，在sysfs创建device目录等操作之后，将通知用户空间的udev，然后上层的显示层才能看到这个usb设备，并最终将它显示在desktop上：</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/330043-6ecf51d6a519b4fe.png" alt="Systemd守护进程所处的位置"></p></blockquote><p>我们直接把规则文件复制到<code>udev</code>的配置文件夹下即可</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">cp</span> <span class="token punctuation">..</span>/platform/linux/udev/90-kinect2.rules /etc/udev/rules.d/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="5-验证安装"><a href="#5-验证安装" class="headerlink" title="5. 验证安装"></a>5. 验证安装</h4><p>最后上面的步骤一步步做下来，应该是没有问题的，不过在编译驱动的时候我们观察到make最后在生成一个叫做<code>Protonect</code>的可执行文件。这个程序其实就是验证安装的程序。我们接上<code>Kinect</code>的连接线，然后运行这个程序，如果安装成功就能够看到下面的图片</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/libfreenect2/build$ ./bin/Protonect <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>四张图中左上角是深度图，左下角是RGB图像，右下角是点云的图像，右上角是带有RGB的点云的图像。需要注意的是，点云的图像是通过深度图推算出来的。深度图只有一个Depth通道，数值越大表示越远，看起来就越黑。而点云图是XYZ三个通道，分别表示点相对相机的的XYZ坐标。而右上角的点云则是RGBXYZ六个通道图片。右边看到，有<code>CUDA</code>加速喧嚷延迟基本都在10ms左右，速度还是非常快的</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211118193300100.png" alt="验证程序的运行结果"></p><h4 id="6-安装驱动可能遇到的问题"><a href="#6-安装驱动可能遇到的问题" class="headerlink" title="6. 安装驱动可能遇到的问题"></a>6. 安装驱动可能遇到的问题</h4><p>暂时没有，留待下次重装系统时候补充。</p><h3 id="C-安装ROS-Kinect深度相机功能包——iai-kinect2"><a href="#C-安装ROS-Kinect深度相机功能包——iai-kinect2" class="headerlink" title="C. 安装ROS Kinect深度相机功能包——iai_kinect2"></a>C. 安装ROS Kinect深度相机功能包——iai_kinect2</h3><p>就像在<code>Melodic</code>上使用<code>CV_Bridge</code>一样（挖个<code>Melodic</code>编译<code>CV_Bridge</code>的坑，以后补上），<code>iai_kinect2</code>也需要我们从<code>github</code>上下载源码然后编译。</p><p>在编译之后，我们想要通过Kinect获得深度图像、点云图像等等直接启动这个<code>iai_kinect2</code>中的节点就行。这个节点将会调用libfreenect，并将获取到的图像发布到指定的话题里，因此我们订阅指定的话题即可得到数据。</p><h4 id="1-下载并编译功能包"><a href="#1-下载并编译功能包" class="headerlink" title="1. 下载并编译功能包"></a>1. 下载并编译功能包</h4><p>由于iai-<code>kinect2</code>本质上是<code>ROS</code>的一个功能包，而<code>ROS</code>的功能包的发布都是以功能包的形式发布的，因此我们只需要把这个功能包下载到工作空间中并进行编译即可。为了不污染我们自己的工作空间，避免每次都要编译这个包，我们新创建一个叫做<code>install_iai_kinect</code>的工作空间的安装这个包</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>ros<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project$ <span class="token function">mkdir</span> install_iai_kinect2<span class="token punctuation">(</span>ros<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project$ <span class="token function">cd</span> install_iai_kinect2/<span class="token punctuation">(</span>ros<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/install_iai_kinect2$ <span class="token function">mkdir</span> src<span class="token punctuation">(</span>ros<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/install_iai_kinect2$ <span class="token function">cd</span> src/<span class="token punctuation">(</span>ros<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/install_iai_kinect2/src$ catkin_init_workspace <span class="token punctuation">(</span>ros<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/install_iai_kinect2/src$ <span class="token function">cd</span> <span class="token punctuation">..</span><span class="token punctuation">(</span>ros<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/install_iai_kinect2$ catkin_make<span class="token punctuation">(</span>ros<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/install_iai_kinect2$ ll<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211118205323865.png" alt="初始化之后的工作空间"></p><p>然后git下载功能并安装依赖，注意这里如果前面改了<code>libfreenect</code>的安装路径的话，这里编译的时候要添加一个<code>CMake</code>的宏来指定<code>libfreenect</code>的路径，参考<a href="https://github.com/code-iai/iai_kinect2#install">文章</a>。</p><p>此外，在使用<code>rosdep</code>安装的时候会遇到一个“报错”（见下），这个其实是正常的，因为<code>kinect2_brideg</code>、<code>kinect2_cailbration</code>、<code>kinect2_caliration</code>、<code>kinect2_viewer</code>这四个节点被<code>rosdep</code>认为是功能包了，但他们其实都只是<code>iai_kinect2</code>的一部分。</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>ros<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/install_iai_kinect2$ <span class="token function">cd</span> src/<span class="token punctuation">(</span>ros<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/install_iai_kinect2/src$ <span class="token function">git</span> clone https://github.com/code-iai/iai_kinect2.git<span class="token punctuation">(</span>ros<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/install_iai_kinect2/src$ <span class="token function">cd</span> iai_kinect2<span class="token punctuation">(</span>ros<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/install_iai_kinect2/src/iai_kinect2$ rosdep <span class="token function">install</span> -r --from-paths <span class="token keyword">.</span><span class="token punctuation">(</span>ros<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/install_iai_kinect2/src/iai_kinect2$ <span class="token function">cd</span> <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">(</span>ros<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/install_iai_kinect2$ catkin_make -DCMAKE_BUILD_TYPE<span class="token operator">=</span><span class="token string">"Release"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>ERROR: the following packages/stacks could not have their rosdepc keys resolved<br>to system dependencies:<br>kinect2_bridge: Cannot locate rosdep definition for [kinect2_registration]<br>kinect2_calibration: Cannot locate rosdep definition for [kinect2_bridge]<br>kinect2_viewer: Cannot locate rosdep definition for [kinect2_bridge]<br>iai_kinect2: Cannot locate rosdep definition for [kinect2_registration]</p></blockquote><p>最后没有error就成功安装功能包了，但是不要忘记<code>source</code>一下，因为这个功能包不在<code>ROS</code>的元功能包中。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211118205948236.png" alt="编译的结果"></p><h4 id="2-验证安装"><a href="#2-验证安装" class="headerlink" title="2. 验证安装"></a>2. 验证安装</h4><p>同样，经历过上面的步骤之后，我们脸上<code>Kinect V2</code>的连接线来跑跑节点，看看有没有问题。类似于<code>cv_bridge</code>，<code>iai-kinect2</code>编译之后会得到一个<code>kinect_bridge</code>，我们利用其中的launch文件来测试一下。</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>ros<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/install_iai-kinect$ <span class="token function">source</span> devel/setup.bash <span class="token punctuation">(</span>ros<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/install_iai-kinect$ roslaunch kinect2_bridge kinect2_bridge.launch<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211118204334851.png" alt="launch启动整个kinect_bridge"></p><p>然后我们再开一个终端来看看节点图</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/install_iai-kinect$ rqt_graph <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>看起来还不错，可以看到<code>kinect_bridge</code>其实只是一个交互的节点，他的后端数据处理都是依靠的其他的节点，<code>kinect2</code>负责调用<code>libfreenect</code>驱动，剩下的hd、sd、qhd分别负责处理高中低分辨率的图像。</p><p>不过由于rqt是通过rosmaster中的注册信息来画节点图的，因此没有被订阅的话题无法被显示出来，我们看看所有的话题</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211118203224904.png" alt="Kinect_Bridge节点图"></p><p>新开一个终端</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~$ rostopic list <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>可以看到有很多的话题，不过其实所有的话题分成三组，<code>hd</code>表示高分辨率，<code>qhd</code>表示中分辨率，<code>sd</code>表示低分辨率</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211118203435667.png" alt="Kinect_Bridge发布的所有的画图"></p><p>最后其实<code>kinect_bridge</code>提供了可视化的节点，不过首先需要对kinect相机进行校准，否则是有偏差的，不过我们这里只是为了验证，因此跑起来看看</p><pre class="line-numbers language-bash"><code class="language-bash">rosrun kinect2_viewer kinect2_viewer kinect2 sd cloud<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>看起来效果还不错，不过由于订阅的是低分辨的图片，因此图片放大之后实际上像素间就会出现一些缺失的黑色点</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211118203934128.png" alt="可视化的结果"></p><h4 id="3-安装时候的一些说明"><a href="#3-安装时候的一些说明" class="headerlink" title="3. 安装时候的一些说明"></a>3. 安装时候的一些说明</h4><blockquote><h4 id="1-编译的时候弹出来警告"><a href="#1-编译的时候弹出来警告" class="headerlink" title="1. 编译的时候弹出来警告"></a>1. 编译的时候弹出来警告</h4><p>具体的警告如下图。只是警告而已，不是错误，不用管。因为<code>catkin</code>作为<code>cmake</code>的上级编译系统，最后还是调用的<code>g++</code>，<code>g++</code>在编译的是帮我们检查代码，警告我们哪里语法不规范啥的，没必要管，能用就行。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211118202235817.png" alt="编译时候的警告"></p></blockquote><h4 id="4-安装功能包可能会遇到的问题"><a href="#4-安装功能包可能会遇到的问题" class="headerlink" title="4. 安装功能包可能会遇到的问题"></a>4. 安装功能包可能会遇到的问题</h4><blockquote><h4 id="1-CMake-Error-at-usr-lib-x86-64-linux-gnu-cmake-Qt5Gui-Qt5GuiConfig-cmake-27-message-：Qt5的报错"><a href="#1-CMake-Error-at-usr-lib-x86-64-linux-gnu-cmake-Qt5Gui-Qt5GuiConfig-cmake-27-message-：Qt5的报错" class="headerlink" title="1. **CMake Error at /usr/lib/x86_64-linux-gnu/cmake/Qt5Gui/Qt5GuiConfig.cmake:27 (message)**：Qt5的报错"></a>1. **CMake Error at /usr/lib/x86_64-linux-gnu/cmake/Qt5Gui/Qt5GuiConfig.cmake:27 (message)**：Qt5的报错</h4><p>具体报错如下图，即缺少了<code>libEGL.so</code>这个共享库</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211118200845339.png" alt="Qt5报错"></p><p><strong>解决方法：</strong></p><p>和上面安装驱动时候遇到的报错差不多，估计是一个尿性，即软连接断了，先去<code>/usr/lib/x86-linux-gnu</code>下看看。果然，红色的字体，断开的链接。即<code>/usr/lib/x86_64-linux-gnu/libEGL.so</code>这个软连接本来指向的文件没了。不过看这个样子有一个1.1.0版本的，估计是某次<code>apt upgrade</code>时候更新了这个库。</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/install_iai-kinect$ ll /usr/lib/x86_64-linux-gnu/libEGL.so* <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211118201305342.png" alt="libEGL.so断开的软连接"></p><p>那么解决思路就很简单了，我们先删掉原有的断掉的链接，然后让他再指向新版本就行了，毕竟新版本一般都是向后兼容的。除了<code>Python2</code>到<code>Python3</code></p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/install_iai-kinect$ <span class="token function">sudo</span> <span class="token function">rm</span> /usr/lib/x86_64-linux-gnu/libEGL.so <span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/install_iai-kinect$ <span class="token function">sudo</span> <span class="token function">ln</span> -s /usr/lib/x86_64-linux-gnu/libEGL.so.1.1.0 /usr/lib/x86_64-linux-gnu/libEGL.so<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>现在看着就没问题了，管道对了</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211118201854870.png" alt="重置libEGL.so的指向"></p><p>然后再进行编译即可</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211118202028422.png" alt="功能包可以正常编译"></p></blockquote><h2 id="4-使用kinect-bridge"><a href="#4-使用kinect-bridge" class="headerlink" title="4. 使用kinect_bridge"></a>4. 使用kinect_bridge</h2><p>使用<code>kinect_bridge</code>其实特别简单，就是订阅话题而已，为此我们快速写一个<code>Python</code>脚本测试，注意测试时候新建的功能包的依赖不要加<code>iai_kinect2</code>，因为<code>kinect_bridge</code>实现了低耦合性，所有的消息全部都是<code>ROS</code>中的标准消息类型，因此没有提供任何ROS编译之后可以引用的库。<strong>下面是是一个错误的示例</strong>。（挖个坑，以后出一个关于<code>Vscode</code>开发<code>ROS</code>的环境搭建，真的<code>VScode</code>越用越爽）</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211118210715487.png" alt="功能包的依赖"></p><p>正因为<code>kinect_bridge</code>中的消息全部都是<code>ROS</code>的标准消息，所有的图像都是<code>sensor_msgs/Image</code>或者<code>sensor_msgs/CompressedImage</code>。而点云则是<code>sensor_msgs/PointCloud2</code>，我们可以非常快速的写一个测试代码，代码见下（<strong>注意如果你要写C++的话不要在iai_bridge的工作空间中编译，会报错，因为Kinect_Bridge没有提供ROS编译、安装相关的CMake指令</strong>）</p><p>关于<code>ROS</code>中使用<code>conda</code>、还有<code>cv_bridge</code>、<code>ROS</code>使用<code>Python</code>等问题先挖个坑，后面补上文章</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#! /home/jack/anaconda3/envs/ros/bin/python</span><span class="token triple-quoted-string string">"""rospy 中使用 通过 kinect 获取点云的示例代码 """</span><span class="token triple-quoted-string string">"""@author: Jack Wang@copyright: Jack Wang@time: 2021-11-18"""</span><span class="token keyword">import</span> sys<span class="token keyword">import</span> datetime<span class="token keyword">import</span> time<span class="token keyword">import</span> cv2<span class="token keyword">from</span> colorama <span class="token keyword">import</span> Fore<span class="token punctuation">,</span> Style<span class="token comment" spellcheck="true"># 我在 Python3 下编译了cv_bridge，所以要避免import了下载ROS时候一并下载的系统的Python2.7的cv_bridge</span><span class="token keyword">for</span> path_idx <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">"2.7"</span> <span class="token keyword">in</span> sys<span class="token punctuation">.</span>path<span class="token punctuation">[</span>path_idx<span class="token punctuation">]</span><span class="token punctuation">:</span>        temp <span class="token operator">=</span> sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>path_idx<span class="token punctuation">)</span>        <span class="token keyword">break</span>sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token keyword">import</span> rospy<span class="token keyword">from</span> sensor_msgs<span class="token punctuation">.</span>msg <span class="token keyword">import</span> Image<span class="token keyword">from</span> cv_bridge <span class="token keyword">import</span> CvBridge<span class="token keyword">class</span> <span class="token class-name">MyKinectViewer</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">:</span>    bridge <span class="token operator">=</span> CvBridge<span class="token punctuation">(</span><span class="token punctuation">)</span>    today<span class="token punctuation">:</span> str <span class="token operator">=</span> datetime<span class="token punctuation">.</span>date<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__str__<span class="token punctuation">(</span><span class="token punctuation">)</span>    start_sec<span class="token punctuation">:</span> float <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>    font <span class="token operator">=</span> cv2<span class="token punctuation">.</span>FONT_HERSHEY_DUPLEX    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> None<span class="token punctuation">:</span>        super<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        rospy<span class="token punctuation">.</span>loginfo<span class="token punctuation">(</span>msg<span class="token operator">=</span>f<span class="token string">"{Fore.GREEN}启动KinectBridge订阅节点！{Style.RESET_ALL}"</span><span class="token punctuation">)</span>        subcriber <span class="token operator">=</span> rospy<span class="token punctuation">.</span>Subscriber<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"/kinect2/sd/image_color_rect"</span><span class="token punctuation">,</span> data_class<span class="token operator">=</span>Image<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>image_cb<span class="token punctuation">,</span> queue_size<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">image_cb</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> msg<span class="token punctuation">:</span> Image<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> None<span class="token punctuation">:</span>        cv_img <span class="token operator">=</span> self<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>imgmsg_to_cv2<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>        cv_img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>cv_img<span class="token punctuation">,</span> f<span class="token string">"{self.today}, start times: {time.time()-self.start_sec:>.2f}"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">380</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>font<span class="token punctuation">,</span> <span class="token number">0.8</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">)</span>        cv_img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>cv_img<span class="token punctuation">,</span> f<span class="token string">"-- by Jack Wang"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">270</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>font<span class="token punctuation">,</span> <span class="token number">0.8</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">)</span>        cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">"kinect_test"</span><span class="token punctuation">,</span> cv_img<span class="token punctuation">)</span>        <span class="token keyword">if</span> cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">27</span><span class="token punctuation">:</span>            rospy<span class="token punctuation">.</span>loginfo<span class="token punctuation">(</span>f<span class="token string">"{Fore.GREEN}关闭节点{Style.RESET_ALL}"</span><span class="token punctuation">)</span>            rospy<span class="token punctuation">.</span>signal_shutdown<span class="token punctuation">(</span>reason<span class="token operator">=</span><span class="token string">"pressed esc"</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    rospy<span class="token punctuation">.</span>init_node<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"kinect_test"</span><span class="token punctuation">,</span> anonymous<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>    mkv <span class="token operator">=</span> MyKinectViewer<span class="token punctuation">(</span><span class="token punctuation">)</span>    rospy<span class="token punctuation">.</span>spin<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看出来，效果还不错</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211118214830894.png" alt="节点效果图"></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211118214855870.png" alt="按下ESC键退出节点"></p><p>结合我之前写的<code>YOLO V5</code>的<code>ROS</code>图像处理节点，最后可以实现的效果（<code>Yolo V5</code>的<code>ROS</code>节点代码后面会发出来）</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211118220436969.png" alt="image-20211118220436969"></p><p>至此，本文全部结束，我们首先介绍了什么是<code>Kinect</code>相机；然后就<code>Kinect</code>相机的参数、工作原理进行了介绍；接下来讲解了如何在<code>Linux(Ubuntu)</code>上安装<code>Kinect V2</code>相机的驱动：<code>libfreenect2</code>和安装<code>ROS</code>中的<code>Kinect</code>相机调用节点；在最后我们给出了一个简单的小例子，来演示如何使用<code>iai-kinect2</code>功能包得到的图像数据。</p><p>关于iai-kinect2的更多使用教程，请看下一篇文章：<code>ROS</code>中<code>iai-kinect2</code>功能包的使用。</p><p>6200字，码字不易~，欢迎打赏~，一起推动开源事业进步</p>]]></content>
      
      
      <categories>
          
          <category> ROS杂篇 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ROS </tag>
            
            <tag> Ubuntu </tag>
            
            <tag> melodic </tag>
            
            <tag> Kinect V2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于hexo的个人技术博客搭建 —— Part-3 matery主题下的Hexo博客优化.md</title>
      <link href="/2021/11/14/ji-yu-hexo-de-ge-ren-ji-zhu-bo-ke-da-jian-part-3-matery-zhu-ti-xia-de-hexo-you-hua-md-md/"/>
      <url>/2021/11/14/ji-yu-hexo-de-ge-ren-ji-zhu-bo-ke-da-jian-part-3-matery-zhu-ti-xia-de-hexo-you-hua-md-md/</url>
      
        <content type="html"><![CDATA[<blockquote><p>hexo本身只是提供了一个博客的框架，博客网站的美化和优化还是需要靠自己配置主题。本讲将带领读者利用Matery主题对Hexo搭建的博客进行深度优化</p></blockquote><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211207132452913.png" alt="最终效果展示图"></p><span id="more"></span><h1 id="基于Hexo的个人技术博客搭建-——-Part-3-matery主题下的Hexo博客优化"><a href="#基于Hexo的个人技术博客搭建-——-Part-3-matery主题下的Hexo博客优化" class="headerlink" title="基于Hexo的个人技术博客搭建 ——  Part 3 matery主题下的Hexo博客优化"></a>基于Hexo的个人技术博客搭建 ——  Part 3 matery主题下的Hexo博客优化</h1><p>在前面的一章中，我们已经通过<code>hexo</code>在本地搭建出了一个博客。但是目前，这个博客还存在一些问题</p><ol><li><strong>目前博客网站运行在本地，所以只有我们自己能看到</strong></li><li><strong>Hexo默认的博客不够美观、功能不够多</strong></li></ol><p>针对上面两个我们，本章和下一章就将进行解决。本章首先解决第二个问题，即优化Hexo博客。</p><h2 id="1-为什么使用其他的Hexo主题？"><a href="#1-为什么使用其他的Hexo主题？" class="headerlink" title="1. 为什么使用其他的Hexo主题？"></a>1. 为什么使用其他的Hexo主题？</h2><p>在前面一章中我们讲过，<code>Hexo</code>主题的工作原理其实就是<code>Hexo</code>的主题里面写的<code>JavaScript</code>和<code>CSS</code>覆盖掉了<code>hexo</code>的<code>JavaScript</code>和<code>CSS</code>。而CSS决定了<code>Hexo</code>博客的外观，因此是否美观实际上取决于主题里的<code>CSS</code>。同样JavaScript决定了网页和我们的交互，因此网页的功能如何实际上也取决与我们的主题。因此，一个优秀的主题是有一个完美的<code>Hexo</code>博客的先决条件。有了一个优秀的主题，我们的博客不仅更加美观，功能也会更加强大。</p><p>因此我们对<code>Hexo</code>博客进行优化，实际上就是使用其他主题，并对这些主题进行配置、</p><p>后面，就将以<code>Hexo</code>的<code>matery</code>主题为例，进行优化</p><h2 id="2-基于Matery主题的Hexo博客优化"><a href="#2-基于Matery主题的Hexo博客优化" class="headerlink" title="2. 基于Matery主题的Hexo博客优化"></a>2. 基于Matery主题的Hexo博客优化</h2><p><code>Matery</code>主题是由国内的闪烁之狐（blinkfox）制作的一款美观的主题，包括我在写这篇博客时候我的博客所用的主题就是<code>Matery</code>。</p><p>之所以使用<code>Matery</code>主题，美观只是一个方面，更重要的是<code>Matery</code>以插件的形式提供了非常多优秀的程序，通过这些程序使得我们能够极大地优化我们的网站。</p><p>访问闪烁之狐的<a href="http://blinkfox.com/">Hexo博客</a>和他的<code>Matery</code>主题的<a href="https://github.com/blinkfox/hexo-theme-matery">Github</a>查看更多的信息</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211115010655463.png" alt="闪烁之狐的Matery主题示例"></p><p>接下来我们就将基于<code>Matery</code>主题来对我们的<code>Hexo</code>博客进行优化</p><blockquote><p>注意，下面的很多教程在<code>Matery</code>的<code>Github</code>上已经有介绍了，因此下面的介绍更多的是关注<code>Matery Github</code>上没有讲到的点</p></blockquote><h3 id="1-安装Matery"><a href="#1-安装Matery" class="headerlink" title="1. 安装Matery"></a>1. 安装Matery</h3><p><code>Matery</code>的<code>Github</code>中的中文说明已经讲过了，在<code>Hexo</code>博客文件夹下的<code>theme</code>文件夹<code>clone</code> 下<code>Matery</code>项目即可</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/blog-test$ <span class="token function">cd</span> themes/<span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/blog-test/themes$ <span class="token function">git</span> clone https://github.com/blinkfox/hexo-theme-matery.git<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>安装完成之后，我们hexo博客看看效果</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/blog-test/themes$ <span class="token function">cd</span> <span class="token punctuation">..</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/blog-test$ hexo s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><strong>发现和之前的博客并没有任何变化</strong>，这是因为我们需要在<code>Hexo</code>的配置文件中指定使用<code>Matery</code>主题</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211115011512753.png" alt="博客没有任何变化"></p><h3 id="2-切换Matery主题"><a href="#2-切换Matery主题" class="headerlink" title="2. 切换Matery主题"></a>2. 切换Matery主题</h3><p><code>vim</code>修改<code>hexo</code>博客根目录下的<code>_config.yml</code>，将<code>theme</code>的值改为 <code>hexo-theme-matery</code>，这样就启用了Matery主题</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211115011735922.png" alt="修改之后的值"></p><p>接下来运行一下博客，就能够看到效果了</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/blog-test$ hexo s<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>可以看到，默认配置就已经非常漂亮了</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211115011929561.png" alt="Matery主题的首页"></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211115012203467.png" alt="Matery主题的底部"></p><p>但是这个默认的主题也有一些小问题，需要我们去修改，比如说网站的左上角的logo，中间浮动打印的语句，中间的github链接需要修改成我们自己的，我的梦想栏的语句需要修改成自己的，右下角的联系方式需要改成我们自己的……</p><p>除了这些个人信息配置以外，还有最关键的一点就是右上角选项卡除了<code>首页</code>以外，其他的点击都会直接没有对应的界面显示。<strong>这是因为Matery默认没有这些界面，需要我们自己配置</strong></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211115012428235.png" alt="点击后显示错误"></p><h3 id="3-添加缺失的页面"><a href="#3-添加缺失的页面" class="headerlink" title="3. 添加缺失的页面"></a>3. 添加缺失的页面</h3><p>在前面的一章中，我们讲到<code>hexo</code>中一篇博客的源文件是一个<code>.md</code>文件，通过使用<code>hexo generta</code>命令，hexo自动的为我们的博文生成一个网页以及对应的资源文件。而其实在<code>hexo</code>，中一个页面对应的也是一个<code>.md</code>文件，同样我们稍后使用<code>hexo generta</code>来生成新的页面。只不过页面对应的<code>.md</code>文件会和博客的<code>.md</code>存在一些不同</p><p>下面就将以添加<code>关于</code>界面为例，讲解Hexo的页面工作原理的同时带领读者配置<code>Matery</code>的页面</p><h4 id="A-添加关于About页面"><a href="#A-添加关于About页面" class="headerlink" title="A. 添加关于About页面"></a>A. 添加<code>关于About</code>页面</h4><p>我们首先在根目录下使用<code>hexo new page xxx</code>命令来生成一个新的页面。同样为了后续的讲解，我们首先保存下现在的目录结构</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/blog-test$ <span class="token function">touch</span> before_about.txt<span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/blog-test$ <span class="token function">touch</span> after_about.txt<span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/blog-test$ tree <span class="token operator">>></span> before_about.txt <span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/blog-test$ hexo new page <span class="token string">"about"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>接下来我们需要修改刚刚新生成的<code>.md</code>来说明这个是一个页面而非博客，这样稍后生成博客的时候就会生成出来一个新的页面</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/blog-test$ vim source/about/index.md <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>将<code>index.md</code>修改为如下内容，当然日期可以按照你自己的来</p><pre class="line-numbers language-markdown"><code class="language-markdown"><span class="token hr punctuation">---</span>title: aboutdate: 2021-11-15 01:37:51type: "about"<span class="token title important">layout: "about"<span class="token punctuation">---</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211115014047478.png" alt="修改后的index.md"></p><p>接下来我们生成一下添加后的博客，别忘了生成之前<code>clean</code>一下，清除掉之前的博客。同时下面由于要讲解原理，因此生成后我们输出一下生成之后的目录结构</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/blog-test$ hexo clean<span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/blog-test$ hexo gen<span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/blog-test$ tree <span class="token operator">>></span> after_about.txt <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>然后我们运行下博客看看效果</p><p>可以看到，此时点击<code>关于</code>就可以正常显示处页面了，底部则显示出我们的制作的项目</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211115014533558.png" alt="正常显示的关于页面"></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211115014620968.png" alt="关于页面的底部"></p><p>当然，这些信息都是默认的信息，我们稍后是肯定需要修改成我们自己的。不过在这之前，先别着急，我们先了解一下<code>hexo</code>是怎么样新生成一个页面的</p><h4 id="B-Hexo是怎么样生成新的页面的？"><a href="#B-Hexo是怎么样生成新的页面的？" class="headerlink" title="B. Hexo是怎么样生成新的页面的？"></a>B. Hexo是怎么样生成新的页面的？</h4><p>我们利用上面两次输出的目录结构，来看看添加、生成页面之后博客目录结构的变化</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/blog-test$ vim -d before_about.txt after_about.txt <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>首先是发布的博客的<code>public</code>文件夹下多了非常多的东西。除了我们之前添加的第一篇博客外，还多出了<code>about</code>、<code>css</code>、<code>js</code>等一些文件夹</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211115015145727.png" alt="Public文件夹的变化"></p><p>此外，我们的源代码文件夹中也多了<code>about</code>文件夹和在其下面的<code>index.md</code></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211115015222432.png" alt="source文件夹下的不同"></p><p>实际上到这里你应该能够猜出来了，<code>hexo</code>和<code>matery</code>生成新的页面的工作原理就是：</p><ul><li>首先<code>hexo</code>认为<code>source</code>文件夹下的一个文件夹就是一个页面，这个页面必须要有一个<code>index.md</code>来说明这个页面的信息，例如上面指定生成页面使用的模板</li><li>其次，<code>matery</code>在生成项目的时候，会在public下生成新的网站的配置文件来修改默认的页面。因此我们的确可以修改这个<code>public</code>下面的<code>matery</code>生成的资源文件。但是并不推荐这样做，因为所有的修改在后续<code>generate</code>之后就会丢失。与此相比，下面会介绍更好的修改、配置<code>matery</code>主题的方式</li></ul><p>最后，我们依照<code>Matery Github</code>（<a href="https://github.com/blinkfox/hexo-theme-matery/blob/develop/README_CN.md">链接</a>）中的<code>README</code>的指引，如法炮制添加剩下的所有页面。</p><p>完成了之后，你可以尽情的探索一下新得到的页面。</p><h3 id="4-配置Matery主题"><a href="#4-配置Matery主题" class="headerlink" title="4. 配置Matery主题"></a>4. 配置Matery主题</h3><p>上面我们通过简单的Matery主题的配置得到了一些界面，下面我们就将进一步配置Matery主题。</p><p>授人以鱼不如授人以渔，因此下面我会首先讲解Matery主题的配置是如何工作的而非单纯的罗列，在讲解完原理之后会留下我参考过的不错的链接，读者可以去里面根据自己的需求配置。</p><p>下面将以安装文章字数插件为例进行讲解。</p><h4 id="A-文章字数统计"><a href="#A-文章字数统计" class="headerlink" title="A. 文章字数统计"></a>A. 文章字数统计</h4><p>细心地读者已经发现，在我们上面的博客底部其实是没有文章字数统计的，而闪烁之狐的实例网页中却具有文章字数统计。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211115021145362.png" alt="我们的界面"></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211115021216163.png" alt="闪烁之狐的网站"></p><p>实际上，这个功能是依靠第三方插件<code>+Matery</code>配置完成的。我们首先下载这个插件，不过注意，我们在前面安装了<code>cnpm</code>，因此使用<code>cnpm</code>安装即可</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/blog-test$ cnpm i --save hexo-wordcount<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>安装完成之后，我们还要修改<code>theme</code>文件夹下<code>Matery</code>主题的配置文件来激活插件，<strong>注意是Matey主题的配置文件</strong>。因为页面的样式信息都是Matery负责的。</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/blog-test$ vim themes/hexo-theme-matery/_config.yml <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>修改为</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">postInfo</span><span class="token punctuation">:</span>  <span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">update</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">wordCount</span><span class="token punctuation">:</span> <span class="token boolean important">true </span><span class="token comment" spellcheck="true"># 设置文章字数统计为 true.</span>  <span class="token key atrule">totalCount</span><span class="token punctuation">:</span> <span class="token boolean important">true </span><span class="token comment" spellcheck="true"># 设置站点文章总字数统计为 true.</span>  <span class="token key atrule">min2read</span><span class="token punctuation">:</span> <span class="token boolean important">true </span><span class="token comment" spellcheck="true"># 阅读时长.</span>  <span class="token key atrule">readCount</span><span class="token punctuation">:</span> <span class="token boolean important">true </span><span class="token comment" spellcheck="true"># 阅读次数.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211115021824246.png" alt="修改后的_config.yml"></p><p>然后我们同样clean之后generate看看效果</p><p>可以看到，已经出现统计信息了</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211115021949461.png" alt="底部具有了统计信息"></p><h4 id="B-Matery的配置是如何工作的？"><a href="#B-Matery的配置是如何工作的？" class="headerlink" title="B. Matery的配置是如何工作的？"></a>B. Matery的配置是如何工作的？</h4><p>事实上，<code>Matery</code>主题依靠其主题文件夹下的<code>_config.yml</code>来进行配置。这个文件中提供了诸如：网站上方选项卡的选项、个人信息、头像、logo等资源文件位置这类的配置，还有是否激活xx插件、xx效果等配置。因此我们通过<code>Matery</code>的<code>_config.yml</code>来进行配置。</p><p>在我们配置完了之后，在<code>generate</code>的过程中，<code>matery</code>就会根据我们的配置来生成对应的文件。可以说是非常方便。</p><p>例如我们修改在关于页面中显示的个人信息</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211115023301903.png" alt="修改个人信息"></p><p>同样，我们修改之后clean、gen、server来看看效果</p><p>可以看到，相关信息已经被修改了，不过由于我没有改头像，因此头像没有变</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211115023432763.png" alt="修改后的效果"></p><p>此外，由于闪烁之狐大佬良好的代码风格，因此在<code>Matery</code>的配置文件夹下，几乎可以看到所有的配置以及修改方式~。大家可以多试试</p><p>此外，推荐一个我参考过的博客，他也是基于<code>Matery</code>进行了配置和优化，并且自己改了一些<code>JavaScript</code>，以实现更好的效果，<a href="https://m3df.xyz/2020/06/13/e9fff968/">零下三度的极寒的博客</a></p><p>最后，本章到了这里就结束了。在本章我们首先讲解了为什么要使用第三方的<code>Hexo</code>主题，以及为什么使用<code>Matery</code>主题。接下来我们结合两个案例讲解了如何对<code>Matery</code>主题进行配置并解释了<code>Matery</code>配置的工作原理，在明白工作原理之后，大家去修改自己的博客网站就会得心应手很多。最后我们提供了其他的参考链接来帮助大家配置自己的博客网站。</p><p>在下一章中，我们将讲解如何低成本的把自己的博客部署到公网上去，使得所有人都能够访问你的博客。</p><p>码字不易，3100字，欢迎打赏~，一起推动开源事业~</p>]]></content>
      
      
      <categories>
          
          <category> Hexo博客搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于Hexo的个人技术博客搭建 —— Part 2 Hexo快速建站以网站基础信息配置</title>
      <link href="/2021/11/13/ji-yu-hexo-de-ge-ren-ji-zhu-bo-ke-da-jian-part-2-hexo-shi-yong-he-ji-chu-pei-zhi-md/"/>
      <url>/2021/11/13/ji-yu-hexo-de-ge-ren-ji-zhu-bo-ke-da-jian-part-2-hexo-shi-yong-he-ji-chu-pei-zhi-md/</url>
      
        <content type="html"><![CDATA[<blockquote><p>本文主要讲解如何使用Hexo快速搭建出一个博客网站，接下来对<code>Hexo</code>搭建的博客网站进行介绍，最后对Hexo搭建的博客网站进行网站基础信息的设置。</p></blockquote><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211113193858319.png" alt="快速建站最终实现的效果"></p><span id="more"></span><h1 id="基于Hexo的个人技术博客搭建-——-Part-2-Hexo快速建站以网站基础信息配置"><a href="#基于Hexo的个人技术博客搭建-——-Part-2-Hexo快速建站以网站基础信息配置" class="headerlink" title="基于Hexo的个人技术博客搭建 —— Part 2 Hexo快速建站以网站基础信息配置"></a>基于Hexo的个人技术博客搭建 —— Part 2 Hexo快速建站以网站基础信息配置</h1><p>在前面的章节中，我们已经讲解了配置<code>Hexo</code>的开发环境，本节将讲解如何使用Hexo快速建立自己的个人博客以及对个人博客进行基本信息设置</p><h2 id="1-Hexo快速建站"><a href="#1-Hexo快速建站" class="headerlink" title="1. Hexo快速建站"></a>1. Hexo快速建站</h2><blockquote><p>前面说过，<code>Hexo</code>搭建得到的博客本质上就是一个文件夹，因此<code>Hexo</code>进行的各种操作都是对这个文件夹里的文件进行操作。</p></blockquote><h3 id="1-初始化博客-——-hexo-init"><a href="#1-初始化博客-——-hexo-init" class="headerlink" title="1. 初始化博客 ——  hexo init"></a>1. 初始化博客 ——  <code>hexo init</code></h3><p><code>Hexo</code>提供了init命令来初始化一个博客，为此我们首先新建一个目录用来存放博客的所有文件</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project$ <span class="token function">mkdir</span> blog-test<span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project$ hexo init blog-test/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p><code>hexo init</code>本质上就是去<code>github</code>上克隆<code>hexo starter</code>项目</p></blockquote><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211113194931504.png" alt="hexo init初始化博客的过程"></p><h3 id="2-运行博客-——-hexo-server"><a href="#2-运行博客-——-hexo-server" class="headerlink" title="2. 运行博客 —— hexo server"></a>2. 运行博客 —— <code>hexo server</code></h3><p>接下来，在博客所在的文件夹的根目录下运行<code>hexo server</code>，来启动<code>hexo</code>的服务程序，这样就可以显示出我们的博客网站。<code>hexo</code>默认是带有一个欢迎界面的，因此即便我们什么都不做也可以正常的运行</p><pre><code>(base) jack@jack-Alienware-m15-R3:~/project$ cd blog-test/(base) jack@jack-Alienware-m15-R3:~/project/blog-test$ hexo server</code></pre><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211113195611688.png" alt="image-20211113195611688"></p><p>运行之后浏览器中访问该端口就能够看到默认的界面，不过默认的界面的问题还是比较多的，比如网站用的默认主题并不是非常好看、网站的信息都不是，后面我们会慢慢优化。这里看到的效果如下</p><p>可以看到左下角的版权信息是默认的人名，左上角的选项卡选项也很少，右侧的菜单栏消息也很少，下一步我们就将慢慢改掉默认的界面</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211113205754034.png" alt="朴素的Hexo"></p><p>为了等下讲解<code>Hexo</code>的原理，我们这里先创建三个文件</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/blog-test$ <span class="token function">touch</span> before_gen.txt<span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/blog-test$ <span class="token function">touch</span> after_gen.txt<span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/blog-test$ <span class="token function">touch</span> added_gen.txt<span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/blog-test$ tree <span class="token operator">>></span> before_gen.txt <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-生成博客-——-hexo-clean-amp-hexo-generate"><a href="#3-生成博客-——-hexo-clean-amp-hexo-generate" class="headerlink" title="3. 生成博客 —— hexo clean &amp; hexo generate"></a>3. 生成博客 —— <code>hexo clean</code> &amp; <code>hexo generate</code></h3><p>前面说道，<code>Hexo</code>的工作原理是通过<code>Markdown</code>引擎将<code>Markdown</code>格式的文本渲染成<code>HTML</code>，因此每一次我们在写完文章之后都需要生成一下博文，注意<code>hexo</code>提供了简写命令，因此g、gen、generate都是可以的</p><pre><code>(base) jack@jack-Alienware-m15-R3:~/project/blog-test$ hexo gen</code></pre><p>可以看到生成了不少文件内容</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211113215116668.png" alt="hexo gen生成博文"></p><p>最后输出一下目录方便后面查看hexo的运行原理</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/blog-test$ tree <span class="token operator">>></span> after_gen.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="4-新加一篇博客-——-hexo-new"><a href="#4-新加一篇博客-——-hexo-new" class="headerlink" title="4. 新加一篇博客 —— hexo new"></a>4. 新加一篇博客 —— <code>hexo new</code></h3><p>我们自己添加博客，需要使用<code>hexo new 文章名</code>，如果文章名称中含有特殊字符，需要用<code>''</code>包裹起来</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/blog-test$ hexo new 第一篇博文<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>新添加的博客在<code>source/_posts/</code>下，使用编辑器打开即可，后面会写一个<code>Typora + 腾讯云床</code>的博客编写环境教程，挖个坑</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/blog-test$ <span class="token keyword">echo</span> <span class="token string">"# 大标题"</span> <span class="token operator">>></span> source/_posts/第一篇博文.md <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>接下来继续生成博客，然后我们启动server来看看我们新写的博文，server的简写是s</p><p>注意，在生成前需要用clean清除一下中间的文件</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/blog-test$ hexo clean<span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/blog-test$ hexo gen<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211113220005285.png" alt="新添加一篇博文"></p><p>可以看到多了一篇文章</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211113220330894.png" alt="添加文章之后的结果"></p><p>同样，我们记录一下，方便后面讲解原理</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/blog-test$ tree <span class="token operator">>></span> added_gen.txt <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>以上就是关于<code>Hexo</code>的一些基础命令使用</p><h2 id="2-Hexo的运行原理"><a href="#2-Hexo的运行原理" class="headerlink" title="2. Hexo的运行原理"></a>2. Hexo的运行原理</h2><h3 id="1-Hexo的目录结构"><a href="#1-Hexo的目录结构" class="headerlink" title="1. Hexo的目录结构"></a>1. Hexo的目录结构</h3><p>我们通过<code>tree</code>命令来查看</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/blog-test$ tree -L 1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>其中，每个文件/文件夹的作用为：</p><ul><li><code>_config.yml</code>：网站的<strong>基础配置</strong>信息，可以在这里配置网站的一些基本参数，例如作者等等。<strong>之所以是基础配置信息，是因为使用不同的主题将会在极大程度上修改、覆盖这里的配置信息</strong>。</li><li><code>package.json</code>：Hexo生成网页、运行服务器等的应用程序信息。<code>EJS</code>, <code>Stylus</code> 和 <code>Markdown renderer</code> 已默认安装，可以由我们自由移除。</li><li><code>scaffolds</code>：模版文件夹。当您生成、新建文章时，<code>Hexo</code> 会根据 <code>scaffold</code> 来建立文件。<strong>不建议修改</strong></li><li><code>source</code>：资源文件夹是存放用户资源的地方。除 <code>_posts</code> 文件夹之外，开头命名为 <code>_</code> (下划线)的文件 / 文件夹和隐藏的文件将会被忽略。<code>Markdown</code> 和 <code>HTML</code> 文件会被解析并放到 <code>public</code> 文件夹，而其他文件会被拷贝过去。</li><li><code>themes</code>：主题文件夹。<code>Hexo</code> 会根据主题来生成静态页面。</li></ul><p>这些文件、文件夹中对我们而言最重要的就是<code>_config.yml</code>、<code>themes</code>、<code>source</code>这三个，其他的其实一般我们用不到也不需要改</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211114095916621.png" alt="Hexo博客的架构"></p><h3 id="2-Hexo是如何生成和发布的博文"><a href="#2-Hexo是如何生成和发布的博文" class="headerlink" title="2. Hexo是如何生成和发布的博文"></a>2. Hexo是如何生成和发布的博文</h3><p>上面从整体上介绍了<code>Hexo</code>的目录结构。下面我们将深入了解一下<code>Hexo</code>生成博文的原理。</p><p>我们上面使用tree生成了三次目录结构，接下来我们查看下生成博文和添加博文之后博客项目的变化，使用<code>vim -d</code>比较下三个文件的内容</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/blog-test$ vim -d before_gen.txt after_gen.txt added_gen.txt <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>可以看到，我们编写的博客都被添加到了<code>source/_posts</code>文件夹下，而我们运行<code>hexo generate</code>后生成的静态博文网页资源就都放在<code>public</code>文件夹下，具体来说，文章放在以日期为名的系列文件夹下，<code>CSS</code>等资源文件则是单独放置</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211113223040926.png" alt="hexo new、add之后文件目录的变化"></p><h3 id="3-Hexo是如何管理主题的"><a href="#3-Hexo是如何管理主题的" class="headerlink" title="3. Hexo是如何管理主题的"></a>3. Hexo是如何管理主题的</h3><p>下面我们通过我当前的这个博客来了解下<code>Hexo</code>是如何管理主题的，以及主题是如何工作的</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/hexo-blogs$ tree themes/  -L 3<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>可以看到，<code>theme</code>文件夹下，一个文件夹就是一个主题。一个主题内部又有其自身的结构，不同的目录有不同的作用。例如<code>language</code>负责不同语言的博文的设置，<code>source</code>则存放主题的<code>css</code>、<code>js</code>等资源文件，<code>_config.yml</code>则负责主题的配置。</p><p><strong>因此在后续我们美化、深度定制Hexo时候就是修改下载好的主题</strong></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211114021748798.png" alt="Hexo的主题目录"></p><h2 id="3-Hexo-基础信息配置"><a href="#3-Hexo-基础信息配置" class="headerlink" title="3. Hexo 基础信息配置"></a>3. Hexo 基础信息配置</h2><p>前面我们讲到，<code>Hexo</code>自身的<code>_config.yml</code>虽然负责整个项目的配置，但是通常会被我们自己下载的主题的<code>_config.yml</code>所覆盖，因此我们只在Hexo的<code>_config.yml</code>中进行一些基础信息的配置，以便于我们为我们的博客打上自己的信息。</p><p>首先通过<code>vim</code>或者其他编辑器打开根目录下的<code>_config.yml</code></p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/project/blog-test$ vim _config.yml <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211114022512202.png" alt="Hexo 根目录下的配置文件"></p><h3 id="1-个人信息设置"><a href="#1-个人信息设置" class="headerlink" title="1. 个人信息设置"></a>1. 个人信息设置</h3><p>我们只需要修改 <code># Site</code>中的信息即可，这样将网站的默认信息改为我们自己的信息</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211114023546668.png" alt="修改后的个人信息"></p><h3 id="2-URL修改"><a href="#2-URL修改" class="headerlink" title="2. URL修改"></a>2. URL修改</h3><p>注意，<code># URL</code>下的内容修改则在未来将会在别人从我们的网站中复制内容之后作为后续的内容提醒版权，此外也会在文章底部说明版权。</p><p>我们暂时先不做这个修改，等后续博客上线、具有具体的域名/网址后再进行修改。</p><p>进行完上面所有的配置之后，我们就可以查看最终的效果了，我们开启下server查看效果</p><p>可以看到首页的文字和页脚的信息已经改掉了，当然，每篇文章里作者的信息也已经改变了。</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211114023717905.png" alt="修改后的首页"></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211114023757242.png" alt="修改后的页脚信息"></p><p>至此，本章就已经结束了。本章我们首先讲解了<code>Hexo</code>的基础命令，然后研究了<code>Hexo</code>的目录结构和工作原理，方便我们后续修改，最后我们对网站的基础信息做了修改，更多的网站内容和信息的设置详见下一章~</p><p>码字不易，2200多字，欢迎打赏~，一起推动开源事业进步~</p>]]></content>
      
      
      <categories>
          
          <category> Hexo博客搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于Hexo的个人技术博客搭建-Part 1 Hexo介绍以及环境搭建</title>
      <link href="/2021/11/13/ji-yu-hexo-de-ge-ren-ji-zhu-bo-ke-da-jian-part-1-hexo-jie-shao-yi-ji-huan-jing-da-jian-md/"/>
      <url>/2021/11/13/ji-yu-hexo-de-ge-ren-ji-zhu-bo-ke-da-jian-part-1-hexo-jie-shao-yi-ji-huan-jing-da-jian-md/</url>
      
        <content type="html"><![CDATA[<blockquote><p>本文主要介绍什么是Hexo，为什么我们要使用Hexo搭建我们的博客以及Hexo环境搭建</p></blockquote><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211113024418805.png" alt="Hexo官网"></p><span id="more"></span><h1 id="基于Hexo的个人技术博客搭建-Part-1-Hexo介绍以及环境搭建-md"><a href="#基于Hexo的个人技术博客搭建-Part-1-Hexo介绍以及环境搭建-md" class="headerlink" title="基于Hexo的个人技术博客搭建-Part 1 Hexo介绍以及环境搭建.md"></a>基于Hexo的个人技术博客搭建-Part 1 Hexo介绍以及环境搭建.md</h1><p>在前一章概述中，我们讲解了为什么我认为一个Geek需要一个个人技术博客，并且简单的展示了最终效果，在接下来的章节里，我将一步步的介绍如何打造这样的效果。</p><h2 id="1-What-is-Hexo"><a href="#1-What-is-Hexo" class="headerlink" title="1. What is Hexo"></a>1. What is Hexo</h2><blockquote><p>等等，什么是<code>Hexo</code>？</p></blockquote><p>在开始学习前，我们需要<strong>首先</strong>知道我们将要学的东西是什么以及学习它能带来的好处（为什么要学他），这样我们学起来会轻松很多。因为这样做我们首先对需要学的东西搭建了一个大的框架，后续的学习都是在填充它，不断丰满这个框架，并且也有了充足的动力去学习。</p><ul><li>正如<code>Hexo</code>官网上所说：<strong>Hexo是一个快速、简洁且高效的博客框架</strong>。（<del>虽然这个官网充满了不少广告</del>）</li></ul><p>所谓框架，即指已经为我们构建了基本的博客工具和博客结构（框架），我们后续只需要在这个框架上不断的填充（发布自己的文章）、修改（修改<code>Hexo</code>的代码）。因为<code>Hexo</code>开源，因此我们实际上可以针对<code>Hexo</code>进行任意程度的自定义修改，只有你想不到，没有你改不了。非常庆幸的是，<code>Hexo</code>的作者是台湾人，因此他的官方文档的中文支持是非常好的，这也为我们使用<code>Hexo</code>提供了便利。</p><ol><li><code>Hexo</code>是基于<code>Node.js</code>开发的应用（因此我们稍后在安装的时候会安装<code>Node.js</code>的环境）。借助于<code>Node.js</code>，<code>Hexo</code>可以快速的渲染出漂亮的文章</li></ol><blockquote><p><strong>什么是<code>Node.js</code></strong></p><p>说清这个问题，要说的可不少。接触过网络的人都应该知道，前端页面是由<code>HTML</code>、<code>CSS</code>、<code>JavaScript</code>三大技术/三件套支持的，其中<code>HTML</code>负责定义网页改在哪个地方显示什么内容，<code>CSS</code>定义哪个地方的哪个内容该以什么样的方式显示，<code>JavaScript</code>则定义当你与这个内容交互的时候会有什么样的效果。</p><p>举个简单例子，在<a href="https://www.baidu.com/">百度</a>的首页，</p><ol><li>为什么百度的Logo会显示在中间，而备案等网站信息显示在底部？–&gt; <code>HTML</code></li><li>为什么百度的背景是白色的，而不是黑色？  –&gt; <code>CSS</code></li><li>为什么鼠标悬停在左上角的更多的时候会弹出来浮窗？  –&gt; <code>JavaScript</code></li></ol><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211113031023828.png" alt="百度的首页"></p><p>正是因为有了这三件套，我们的网页变得多姿多彩了起来，有有价值的信息(<code>HTML</code>)、漂亮的页面(<code>CSS</code>)和友好的交互(<code>JavaScript</code>)。</p><p>然而，渐渐地，<strong>本来地位平等的三件套逐渐开始出现区别</strong>。<code>HTML</code>和<code>CSS</code>都是静态的，在编写结束之后用户能看到的内容就已经固定（关于模板稍后再说），当用户访问这个网页，看到的就是其中的内容；然而<code>JavaScript</code>却由于需要处理的用户的操作不同而做不同的处理，例如在百度的页面中，如果我不是悬浮而是右击怎么办？如果我不是悬浮而是掠过怎么办？正是由于需要处理诸多用户导致的多种多样的Event，<code>JavaScript</code>也具有了if-else等编程语言常见的语句。<strong>渐渐地，随着技术的进步，JavaScript需要处理的问题越来越多，在其能力变强的同时，JavaScript也变得越来越像一门编程语言</strong>。</p><p>然而，这个时候的<code>JavaScript</code>还并不能独当一面。因为在最早的网页中，<code>JavaScript</code>、<code>HTML</code>、<code>CSS</code>是绑定的三件套，当用户访问某个网页，服务器会将该网页的三件套发送给用户，然后由<strong>用户的浏览器解析、渲染、执行HTML、CSS、JavaScript三件套</strong>，从而显示网页。因此这个时候的<code>JavaScript</code>是无法脱离浏览器的。我们从另一个角度考虑，由于JavaScript是由浏览器解析执行的，因此其可以看做是一门解释性语言，在执行<code>JavaScript</code>的时候，CPU执行的机器码来自于其<code>解释器</code>——浏览器。</p><p>后来随着，<code>JavaScript</code>的功能越来越强大，简单的在网页中进行交互已经完全发挥其能力了。因此就出现了诸多项目，这些项目独立于传统浏览器，基于浏览器的<code>JavaScript</code>解析器内核（学名：引擎）亦或是自己编写了<code>JavaScript</code>的解析器来执行<code>JavaScript</code>。至此，<code>JavaScript</code>已经能够独立于浏览器被单独执行了，而非必须在浏览器中以网页的形式打开。</p><p>在前面介绍了那么多之后，终于，到了我们的主角，<code>Node.js</code>。大名鼎鼎的<code>Node.js</code>其实就是基于<code>Chrome V8</code> 引擎的 <code>JavaScript</code> 运行时环境。简单的来说，它能够利用<code>Chrome V8</code>引擎来解析、执行<code>JavaScript</code>。<code>Node.js</code>可以粗暴的理解成<code>JavaScript</code>的解释器。基于此，<code>JavaScript</code>在很多方面都很像<code>Python</code>，包括包管理器、解释器等等</p></blockquote><ol start="2"><li><code>Hexo</code>利用<code>Markdown</code>来作为源文章，其内置<code>Markdown</code>的渲染引擎，我们只需要书写Markdown，而后通过<code>Hexo</code>就能够生成<code>HTML</code>等前端文件，非常方便</li></ol><blockquote><p>正如下面这张图，这篇文章也是我用Markdown写出来的，在后续部分除了网站搭建以外，还会讲讲如何搭建写作环境，以实现畅快写作</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211113110048831.png" alt="我的Markdown写作环境：Typora+腾讯云图床+Dracula主题"></p></blockquote><ol start="3"><li>Hexo搭建出的博客网站是一个静态网站，这就意味着单纯<code>Hexo</code>本身只能提供博客的显示、有限的交互，如果需要登录、发表评论这类需要后端程序支持的运用，就需要第三方插件了。如果非常需要这些功能，要么使用<code>WordPress</code>，要么折腾<code>Hexo</code>的插件</li></ol><p>到这里，你应该明白了<code>Hexo</code>是一个基于<code>Node.js</code>的程序，他帮助我们渲染文章、管理文章，通过这个<code>Hexo</code>我们可以快速、低成本的部署自己的博客</p><h2 id="2-Why-is-Hexo"><a href="#2-Why-is-Hexo" class="headerlink" title="2. Why is Hexo"></a>2. Why is Hexo</h2><blockquote><p>Ok，我知道了什么<code>Hexo</code>，可是为什么要用它它？</p></blockquote><p>事实上，选取<code>Hexo</code>作为我们的博客网站框架来帮助我们搭建技术博客有很多好处：</p><ol><li><code>Hexo</code>框架的学习成本非常低，学起来非常快速，命令行几条语句就能够学会。在整个<code>博客搭建过程</code>中，学习<code>Hexo</code>可能只占很少的时间，主要时间在于挑选一个好看的主题并自己修改、添加自己的个人信息</li><li><code>Hexo</code>搭建的博客非常易于管理。<code>Hexo</code>管理的博客本质上是一个文件夹。因为Hexo搭建出的只是静态博客网站，因此不需要后端程序，所以网站所有的资源（<code>HTML</code>、<code>CSS</code>、<code>JavaScript</code>）都放在一个文件夹里就行。如果中间配置出问题了，那么直接删掉整个文件夹就行。</li><li><code>Hexo</code>搭建的博客部署、迁移非常方便。同样是由于Hexo管理的博客网站是一个文件夹，因此我们可利用Git<code>来保存</code>、同步你的博客。此外，由于<code>Github</code>和<code>Gitee</code>提供静态网页的<code>Page</code>服务，所以我们其实可以利用<code>Github</code>和<code>Gitee</code>等<code>Git</code>托管网站来托管我们的网站。防止网络攻击这些都由他们帮我们做好了。</li><li><code>Hexo</code>搭建的博客成本非常低。正是因为我们利用<code>Github</code>和<code>Gitee</code>来托管我们的网站，因此我们只需要花钱买域名和图床即可，买公网服务器什么的全部省掉了。</li><li><code>Hexo</code>具有非常多美观的主题。通过这些主题，我们只需要进行配置和有限的修改就能够做出来非常美观的博客网站。</li></ol><blockquote><p><code>Hexo</code>的官网上提供了非常多的主题（<a href="https://hexo.io/themes/">点击查看</a>），截止我写这篇文章的时候一共有348个官方收录的主题。除此以外还有非常多的未被收录的主题，强推我现在正在用的由<code>闪烁之狐</code>制作的<code>Matery</code>主题，后面也会讲解如何配置<code>Matery</code>主题，这是Matery主题的<a href="http://blinkfox.com/">展示网站</a></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211113112326777.png" alt="Hexo官网收录的主题"></p></blockquote><ol start="6"><li>……（暂时只想到这几个点）</li></ol><h2 id="3-Hexo环境搭建"><a href="#3-Hexo环境搭建" class="headerlink" title="3. Hexo环境搭建"></a>3. Hexo环境搭建</h2><blockquote><p>开发第一步：搭建环境</p></blockquote><p>注意，由于我本人长期使用<code>Debian/Ubuntu</code>来做开发，因此以下教程都将是基于<code>Ubuntu</code>编写的教程。如果你是其他<code>Linux</code>发行版用户，适度修改即可；如果你是<code>Windows</code>用户，那么你还需要配置不少东西，知乎、简书上你还得查查。</p><p>下面我们就将一步步搭建Hexo环境出来</p><h3 id="1-安装Node-js环境"><a href="#1-安装Node-js环境" class="headerlink" title="1. 安装Node.js环境"></a>1. 安装Node.js环境</h3><p>前面说道，<code>Hexo</code>是基于<code>Node.js</code>开发的程序，因此其运行就需要<code>Node.js</code>，所以我们第一步就是安装<code>Node.js</code></p><blockquote><p>注意：官网上说明，<code>Hexo</code>需要的<code>Node.js</code>的版本不低于<strong>10.13</strong>，强烈建议<code>Node.js</code><strong>12.0</strong>以上的版本</p></blockquote><p>我们首先用<code>apt</code>查一下Ubuntu的仓库里的nodejs的版本</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~$ <span class="token function">sudo</span> apt search nodejs<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211113124733292.png" alt="apt搜索nodejs的结果"></p><p>不难看出来，<code>apt</code>仓库里的<code>nodejs</code>的版本过低，因此我们需要自己从<code>nodejs</code>官网上下载新版本的<code>nodejs</code>，<a href="https://nodejs.org/zh-cn/">官网传送门</a></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211113124918179.png" alt="Node.js的官网"></p><p>在我写这篇文章的时候最新版是16.13，由于遵循Linux的传统，双数版本是LTS（Long Time Supported）版本，而单数版本都是尝鲜（Beta）版本，所以选择<strong>稳定版即可</strong></p><p>下载之后解压会得到一个文件夹，这个文件夹里<code>bin</code>目录放的就是官方替我们已经编译好了的二进制可执行文件，可以看到除了node，别的都是软连接</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/桌面/node-v16.13.0-linux-x64$ tree -L 2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>注意，我这里是已经安装过了<code>Node.js</code>，正常情况下是没有<code>cnpm</code>的，稍后会安装<code>cnpm</code></p></blockquote><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211113125500195.png" alt="解压之后的文件夹"></p><p>由于后续需要在命令行中调用<code>Node.js</code>，因此还要把这个<code>bin</code>文件的路径加入到<code>Shell</code>搜索可执行文件路径的<code>PATH</code>环境变量中，这里图方便直接在.<code>bashrc</code>中添加了</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/桌面/node-v16.13.0-linux-x64$ vim ~/.bashrc  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211113125903583.png" alt="添加了Node.js的PATH"></p><p>这样未来在命令行就可以正常的调用<code>node.js</code>和附带的<code>npm</code>了，测试一波</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/桌面/node-v16.13.0-linux-x64$ node <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211113130048060.png" alt="测试Node.js"></p><p>OK，装完了<code>Node.js</code>，下一步</p><h3 id="2-安装cnpm"><a href="#2-安装cnpm" class="headerlink" title="2. 安装cnpm"></a>2. 安装cnpm</h3><p>前面讲到，Node.js中利用了Chrome V8引擎从而实现了JavaScript的运行时环境，从而做到了类似于解释器的效果。做过<code>Python</code>的人应该都会知道<code>pip</code>和<code>conda</code>，他们都是<code>Python</code>的包管理器（当然conda还可以管理环境）。通过<code>pip install xxx</code>或者<code>conda install xxx</code>就能安装Python的第三方库。</p><p><code>Node.js</code>也提供了类似的包管理工具，即<code>npm（Node.js Package Management）</code>，通过npm我们就能够安装<code>Node.js</code>的第三方库。</p><p>但是这些包管理工具的共性就是下载的这些库都是在包管理工具官网上维护的包，我们使用<code>xxx install xxx</code>的时候，会去<code>xxx</code>的包管理网站上搜索<code>xxx</code>包，然后下载。问题的关键就出在了下载这一步，由于这些包管理网站服务器都在国外，因此国内下载就会很慢。为此，我们通过换源来解决，即指定去国内的包管理网站上下载。在<code>pip</code>中我们可以指定<code>-i</code>参数，从而指定去清华源或者中科大源下载<code>Python</code>第三方包。而<code>npm</code>我们同样也可以指定<code>--registry</code>参数，从而指定国内的源（一般都是淘宝源）。</p><p>但是每次都使用<code>--registry</code>参数有点蠢，我们直接使用淘宝做好的<code>cnpm</code>包管理工具就行。<code>cnpm</code>和<code>npm</code>在作用上是一样的，不过对国内用户做了很不错的优化。</p><p>我们首先通过npm指定<code>--registry</code>参数来安装<code>cnpm</code></p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/桌面/node-v16.13.0-linux-x64$ <span class="token function">npm</span> <span class="token function">install</span> -g cnpm --registry<span class="token operator">=</span><span class="token string">"https://registry.npm.taobao.org"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>稍等片刻即可，警告是已经安装的别的包报的错，都后面没啥影响，因为我已经安装过了cnpm，所以下面的截图和你的可能不一样</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211113131609169.png" alt="安装cnpm"></p><p>安装之后检查下安装是否成功，当然由于路径等环境不一样，输出结果也不太一样，但是能够正常输出就表示安装对了</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/桌面/node-v16.13.0-linux-x64$ cnpm --version<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211113131849887.png" alt="检查cnpm是否安装成功"></p><p>OK，下一步安装Git</p><h3 id="3-安装git"><a href="#3-安装git" class="headerlink" title="3. 安装git"></a>3. 安装git</h3><p>由于<code>Hexo</code>内置了博客的同步、部署等功能，因此<code>Hexo</code>依赖于<code>git</code>，所以我们首先需要安装<code>git</code></p><p>安装git就简单了，直接<code>apt</code>安装即可，同样由于我已经安装过了，所以输出会不一样</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/桌面/node-v16.13.0-linux-x64$ <span class="token function">sudo</span> apt <span class="token function">install</span> <span class="token function">git</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211113132146054.png" alt="apt安装git"></p><p>同样，查看下<code>git</code>的版本确认安装成功</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/桌面/node-v16.13.0-linux-x64$ <span class="token function">git</span> --version<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211113132257442.png" alt="确认git安装成功"></p><h3 id="4-安装Hexo"><a href="#4-安装Hexo" class="headerlink" title="4. 安装Hexo"></a>4. 安装Hexo</h3><p>在前面所有必备的环境安装成功后，下面将安装<code>Hexo</code></p><p>前面由于已经安装了<code>cnpm</code>，因此我们直接使用<code>cnpm</code>来安装<code>Hexo</code></p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/桌面/node-v16.13.0-linux-x64$ cnpm <span class="token function">install</span> -g hexo-cli<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>稍等片刻就安装好了</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211113132546043.png" alt="安装hexo"></p><p>为了后续我们能够直接在命令行调用<code>hexo</code>的命令，我们把<code>hexo</code>的可执行文件添加到<code>PATH</code>中去</p><p>注意，<code>npm</code>和<code>cnpm</code>的工作原理都是把下载的包放到<code>node.js</code>所在的根目录的<code>lib</code>中，和<code>pip</code>是异曲同工之秒，我们打开之前node.js在的文件夹就能看到</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211113133034708.png" alt="hexo的安装位置"></p><p>同样用<code>vim</code>编辑<code>.bashrc</code></p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211113133331507.png" alt="添加hexo可执行文件"></p><p>最后命令行查看下hexo的版本确认成功</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> jack@jack-Alienware-m15-R3:~/桌面/node-v16.13.0-linux-x64$ hexo --version<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211113133455333.png" alt="确认hexo安装成功"></p><p>至此，我们已经成功搭建了Hexo的环境。</p><p>本章结束~</p><p>本章我们首先讲解了什么是<code>hexo</code>，然后讲解了为什么我们要使用<code>hexo</code>，最后讲解了如何安装<code>hexo</code>。</p><p>下一节预告：<code>Hexo使用以及配置</code></p><p>码字不易，4000字，欢迎打赏~，一起为开源事业做贡献~</p>]]></content>
      
      
      <categories>
          
          <category> Hexo博客搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于Hexo的个人技术博客搭建 —— Part 0 概述</title>
      <link href="/2021/11/12/ji-yu-hexo-de-ge-ren-ji-zhu-bo-ke-da-jian-part-0-gai-shu/"/>
      <url>/2021/11/12/ji-yu-hexo-de-ge-ren-ji-zhu-bo-ke-da-jian-part-0-gai-shu/</url>
      
        <content type="html"><![CDATA[<blockquote><p>本系列文章面向前端小白，希望以尽量简单而又不啰嗦的语言介绍如何搭建<code>基于Hexo的个人技术博客</code></p></blockquote><span id="more"></span><h1 id="基于Hexo的个人技术博客搭建-——-Part-0-概述"><a href="#基于Hexo的个人技术博客搭建-——-Part-0-概述" class="headerlink" title="基于Hexo的个人技术博客搭建 —— Part 0 概述"></a>基于Hexo的个人技术博客搭建 —— Part 0 概述</h1><p>作为一个热爱开源的技术爱好者，我热爱学习新的技术、也热衷分享自己掌握的技术。然而分享却并非易事，想要将你的开源技术以个人技术博客的形式分享到互联网上需要有以下的诸多步骤：</p><ol><li>掌握HTML、CSS、JavaScript、Vue.js、Node.js等前端技术，至少能够写出来一个静态网站；或者在静态网页的基础上掌握Nginx、Apache等等后端技术，为前端提供登陆等功能以实现一个动态网站。</li><li>购买具有公网IP的服务器以运行你的网站，使得任何想要访问你网站的人都能够通过公网上的服务器来访问你的网站。</li><li>购买一个域名并为其添加DNS解析、安装SSL证书</li><li>Optional：中国域名<strong>xxxx.xxxx.cn</strong>下的网站需要进行备案</li><li>配置你的服务器以避免来自公网上的攻击</li><li>……</li></ol><p>完成了以上诸多步骤，你的技术网站才能够被其他人访问，别人才能够正常的来阅读你的技术博客。<strong>如此繁琐的程序，往往在前几步就吓退了不少人</strong>。也正是因为如此，就出现了不少帮助我们分享技术的工具，例如：帮助我们快速搭建博客而不需要自己掌握前端技术的<code>WordPress</code>、帮助我们维护文章的<code>CSDN</code>、<code>知乎</code>、<code>简书</code>等等；然而这些工具，也有他们的缺点</p><ul><li><code>WordPress</code>：尽管<code>WordPress</code>使得我们可以可视化的建立、管理前端页面。但是首先，上面的流程中诸多步骤仍然需要自己来完成，购买公网服务器、购买域名等等都是不小的开销；其次<code>WordPress</code>类似于<code>Vscode</code>，具有一个强大的插件系统，即软件本身只具有一定的功能，更多的功能需要靠插件来实现。然而和<code>Vscode</code>不同的是<code>WordPress</code>上好用的插件是要收费的，而且价格不菲（<del>忽略掉万能的淘宝</del>）</li><li><code>CSDN</code>、<code>简书</code>、<code>博客园</code>：尽管类似于<code>CSDN</code>、<code>简书</code>、<code>博客园</code>等这类博客网站已经帮助我们完成了网站安全防护、搜索引擎优化、文章编辑发布和管理等功能，他们的问题存在于盗帖实在太过于严重，很多时候搜索自己需要解决的问题，结果搜出来的全都是一模一样的、爬虫复制粘贴的文章，对解决问题毫无帮助，自己的文章和这些垃圾文章在一起，实在是于心不忍；其次，作为<strong>一名优秀的程序员，拥有自己的技术博客网站将会极大地帮助自己的未来，无论是求职也好亦或是求学……</strong></li></ul><p>因此自己搭建一个博客就非常有必要了。</p><p>本系列最终将通过一系列文章，来帮助你低成本（<strong>可能也就几块钱</strong>）的构建出属于你自己的、美观的个人技术博客</p><p><img src="https://jack-1307599355.cos.ap-shanghai.myqcloud.com/img/image-20211112180102412.png" alt="最终效果展示"></p>]]></content>
      
      
      <categories>
          
          <category> Hexo博客搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
